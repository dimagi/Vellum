/*! Vellum 18-02-2014 
    Copyright 2009-2014, Dimagi Inc., and individual contributors 
    See http://github.com/dimagi/Vellum for license */

function BigInteger(n,s){if(!(this instanceof BigInteger))return n instanceof BigInteger?n:"undefined"==typeof n?BigInteger.ZERO:BigInteger.parse(n);for(n=n||[];n.length&&!n[n.length-1];)--n.length;this._d=n,this._s=n.length?s||1:0}function diff_match_patch(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32}function XMLWriter(encoding,version){encoding&&(this.encoding=encoding),version&&(this.version=version)}function ItextItem(options){this.forms=options.forms||[],this.id=options.id||""}Array.prototype.map||(Array.prototype.map=function(fun){var len=this.length>>>0;if("function"!=typeof fun)throw new TypeError;for(var res=new Array(len),thisp=arguments[1],i=0;len>i;i++)i in this&&(res[i]=fun.call(thisp,this[i],i,this));return res}),BigInteger.base=1e7,BigInteger.base_log10=7,BigInteger.ZERO=new BigInteger([],0),BigInteger.ONE=new BigInteger([1],1),BigInteger.M_ONE=new BigInteger(BigInteger.ONE._d,-1),BigInteger._0=BigInteger.ZERO,BigInteger._1=BigInteger.ONE,BigInteger.small=[BigInteger.ZERO,BigInteger.ONE,new BigInteger([2],1),new BigInteger([3],1),new BigInteger([4],1),new BigInteger([5],1),new BigInteger([6],1),new BigInteger([7],1),new BigInteger([8],1),new BigInteger([9],1),new BigInteger([10],1),new BigInteger([11],1),new BigInteger([12],1),new BigInteger([13],1),new BigInteger([14],1),new BigInteger([15],1),new BigInteger([16],1),new BigInteger([17],1),new BigInteger([18],1),new BigInteger([19],1),new BigInteger([20],1),new BigInteger([21],1),new BigInteger([22],1),new BigInteger([23],1),new BigInteger([24],1),new BigInteger([25],1),new BigInteger([26],1),new BigInteger([27],1),new BigInteger([28],1),new BigInteger([29],1),new BigInteger([30],1),new BigInteger([31],1),new BigInteger([32],1),new BigInteger([33],1),new BigInteger([34],1),new BigInteger([35],1),new BigInteger([36],1)],BigInteger.digits="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),BigInteger.prototype.toString=function(base){if(base=+base||10,2>base||base>36)throw new Error("illegal radix "+base+".");if(0===this._s)return"0";if(10===base){var str=this._s<0?"-":"";str+=this._d[this._d.length-1].toString();for(var i=this._d.length-2;i>=0;i--){for(var group=this._d[i].toString();group.length<BigInteger.base_log10;)group="0"+group;str+=group}return str}var numerals=BigInteger.digits;base=BigInteger.small[base];for(var digit,sign=this._s,n=this.abs(),digits=[];0!==n._s;){var divmod=n.divRem(base);n=divmod[0],digit=divmod[1],digits.push(numerals[digit.valueOf()])}return(0>sign?"-":"")+digits.reverse().join("")},BigInteger.radixRegex=[/^$/,/^$/,/^[01]*$/,/^[012]*$/,/^[0-3]*$/,/^[0-4]*$/,/^[0-5]*$/,/^[0-6]*$/,/^[0-7]*$/,/^[0-8]*$/,/^[0-9]*$/,/^[0-9aA]*$/,/^[0-9abAB]*$/,/^[0-9abcABC]*$/,/^[0-9a-dA-D]*$/,/^[0-9a-eA-E]*$/,/^[0-9a-fA-F]*$/,/^[0-9a-gA-G]*$/,/^[0-9a-hA-H]*$/,/^[0-9a-iA-I]*$/,/^[0-9a-jA-J]*$/,/^[0-9a-kA-K]*$/,/^[0-9a-lA-L]*$/,/^[0-9a-mA-M]*$/,/^[0-9a-nA-N]*$/,/^[0-9a-oA-O]*$/,/^[0-9a-pA-P]*$/,/^[0-9a-qA-Q]*$/,/^[0-9a-rA-R]*$/,/^[0-9a-sA-S]*$/,/^[0-9a-tA-T]*$/,/^[0-9a-uA-U]*$/,/^[0-9a-vA-V]*$/,/^[0-9a-wA-W]*$/,/^[0-9a-xA-X]*$/,/^[0-9a-yA-Y]*$/,/^[0-9a-zA-Z]*$/],BigInteger.parse=function(s,base){function expandExponential(str){return str=str.replace(/\s*[*xX]\s*10\s*(\^|\*\*)\s*/,"e"),str.replace(/^([+\-])?(\d+)\.?(\d*)[eE]([+\-]?\d+)$/,function(x,s,n,f,c){c=+c;var l=0>c,i=n.length+c;x=(l?n:f).length,c=(c=Math.abs(c))>=x?c-x+l:0;var z=new Array(c+1).join("0"),r=n+f;return(s||"")+(l?r=z+r:r+=z).substr(0,i+=l?z.length:0)+(i<r.length?"."+r.substr(i):"")})}s=s.toString(),("undefined"==typeof base||10===+base)&&(s=expandExponential(s));var parts=/^([+\-]?)(0[xXcCbB])?([0-9A-Za-z]*)(?:\.\d*)?$/.exec(s);if(parts){var sign=parts[1]||"+",baseSection=parts[2]||"",digits=parts[3]||"";if("undefined"==typeof base)base="0x"===baseSection||"0X"===baseSection?16:"0c"===baseSection||"0C"===baseSection?8:"0b"===baseSection||"0B"===baseSection?2:10;else if(2>base||base>36)throw new Error("Illegal radix "+base+".");if(base=+base,!BigInteger.radixRegex[base].test(digits))throw new Error("Bad digit for radix "+base);if(digits=digits.replace(/^0+/,"").split(""),0===digits.length)return BigInteger.ZERO;if(sign="-"===sign?-1:1,10==base){for(var d=[];digits.length>=BigInteger.base_log10;)d.push(parseInt(digits.splice(-BigInteger.base_log10).join(""),10));return d.push(parseInt(digits.join(""),10)),new BigInteger(d,sign)}if(base===BigInteger.base)return new BigInteger(digits.map(Number).reverse(),sign);var d=BigInteger.ZERO;base=BigInteger.small[base];for(var small=BigInteger.small,i=0;i<digits.length;i++)d=d.multiply(base).add(small[parseInt(digits[i],36)]);return new BigInteger(d._d,sign)}throw new Error("Invalid BigInteger format: "+s)},BigInteger.prototype.add=function(n){if(0===this._s)return BigInteger(n);if(n=BigInteger(n),0===n._s)return this;if(this._s!==n._s)return n=n.negate(),this.subtract(n);for(var digit,a=this._d,b=n._d,al=a.length,bl=b.length,sum=new Array(Math.max(al,bl)+1),size=Math.min(al,bl),carry=0,i=0;size>i;i++)digit=a[i]+b[i]+carry,sum[i]=digit%BigInteger.base,carry=digit/BigInteger.base|0;for(bl>al&&(a=b,al=bl),i=size;carry&&al>i;i++)digit=a[i]+carry,sum[i]=digit%BigInteger.base,carry=digit/BigInteger.base|0;for(carry&&(sum[i]=carry);al>i;i++)sum[i]=a[i];return new BigInteger(sum,this._s)},BigInteger.prototype.negate=function(){return new BigInteger(this._d,-this._s)},BigInteger.prototype.abs=function(){return this._s<0?this.negate():this},BigInteger.prototype.subtract=function(n){if(0===this._s)return BigInteger(n).negate();if(n=BigInteger(n),0===n._s)return this;if(this._s!==n._s)return n=n.negate(),this.add(n);var t,m=this;this._s<0&&(t=m,m=new BigInteger(n._d,1),n=new BigInteger(t._d,1));var sign=m.compareAbs(n);if(0===sign)return BigInteger.ZERO;0>sign&&(t=n,n=m,m=t);var i,digit,a=m._d,b=n._d,al=a.length,bl=b.length,diff=new Array(al),borrow=0;for(i=0;bl>i;i++)digit=a[i]-borrow-b[i],0>digit?(digit+=BigInteger.base,borrow=1):borrow=0,diff[i]=digit;for(i=bl;al>i;i++){if(digit=a[i]-borrow,!(0>digit)){diff[i++]=digit;break}digit+=BigInteger.base,diff[i]=digit}for(;al>i;i++)diff[i]=a[i];return new BigInteger(diff,sign)},function(){function addOne(n,sign){for(var a=n._d,sum=a.slice(),i=0;;){var digit=(a[i]||0)+1;if(sum[i]=digit%BigInteger.base,digit<=BigInteger.base-1)break;++i}return new BigInteger(sum,sign)}function subtractOne(n,sign){for(var a=n._d,sum=a.slice(),i=0;;){var digit=(a[i]||0)-1;if(!(0>digit)){sum[i]=digit;break}sum[i]=digit+BigInteger.base,++i}return new BigInteger(sum,sign)}BigInteger.prototype.next=function(){switch(this._s){case 0:return BigInteger.ONE;case-1:return subtractOne(this,-1);default:return addOne(this,1)}},BigInteger.prototype.prev=function(){switch(this._s){case 0:return BigInteger.M_ONE;case-1:return addOne(this,-1);default:return subtractOne(this,1)}}}(),BigInteger.prototype.compareAbs=function(n){if(this===n)return 0;if(!(n instanceof BigInteger)){if(!isFinite(n))return isNaN(n)?n:-1;n=BigInteger(n)}if(0===this._s)return 0!==n._s?-1:0;if(0===n._s)return 1;var l=this._d.length,nl=n._d.length;if(nl>l)return-1;if(l>nl)return 1;for(var a=this._d,b=n._d,i=l-1;i>=0;i--)if(a[i]!==b[i])return a[i]<b[i]?-1:1;return 0},BigInteger.prototype.compare=function(n){if(this===n)return 0;if(n=BigInteger(n),0===this._s)return-n._s;if(this._s===n._s){var cmp=this.compareAbs(n);return cmp*this._s}return this._s},BigInteger.prototype.isUnit=function(){return this===BigInteger.ONE||this===BigInteger.M_ONE||1===this._d.length&&1===this._d[0]},BigInteger.prototype.multiply=function(n){if(0===this._s)return BigInteger.ZERO;if(n=BigInteger(n),0===n._s)return BigInteger.ZERO;if(this.isUnit())return this._s<0?n.negate():n;if(n.isUnit())return n._s<0?this.negate():this;if(this===n)return this.square();var i,r=this._d.length>=n._d.length,a=(r?this:n)._d,b=(r?n:this)._d,al=a.length,bl=b.length,pl=al+bl,partial=new Array(pl);for(i=0;pl>i;i++)partial[i]=0;for(i=0;bl>i;i++){for(var digit,carry=0,bi=b[i],jlimit=al+i,j=i;jlimit>j;j++)digit=partial[j]+bi*a[j-i]+carry,carry=digit/BigInteger.base|0,partial[j]=digit%BigInteger.base|0;carry&&(digit=partial[j]+carry,carry=digit/BigInteger.base|0,partial[j]=digit%BigInteger.base)}return new BigInteger(partial,this._s*n._s)},BigInteger.prototype.multiplySingleDigit=function(n){if(0===n||0===this._s)return BigInteger.ZERO;if(1===n)return this;var digit;if(1===this._d.length)return digit=this._d[0]*n,digit>=BigInteger.base?new BigInteger([digit%BigInteger.base|0,digit/BigInteger.base|0],1):new BigInteger([digit],1);if(2===n)return this.add(this);if(this.isUnit())return new BigInteger([n],1);for(var a=this._d,al=a.length,pl=al+1,partial=new Array(pl),i=0;pl>i;i++)partial[i]=0;for(var carry=0,j=0;al>j;j++)digit=n*a[j]+carry,carry=digit/BigInteger.base|0,partial[j]=digit%BigInteger.base|0;return carry&&(digit=carry,carry=digit/BigInteger.base|0,partial[j]=digit%BigInteger.base),new BigInteger(partial,1)},BigInteger.prototype.square=function(){if(0===this._s)return BigInteger.ZERO;if(this.isUnit())return BigInteger.ONE;var product,carry,k,i,digits=this._d,length=digits.length,imult1=new Array(length+length+1);for(i=0;length>i;i++)k=2*i,product=digits[i]*digits[i],carry=product/BigInteger.base|0,imult1[k]=product%BigInteger.base,imult1[k+1]=carry;for(i=0;length>i;i++){carry=0,k=2*i+1;for(var j=i+1;length>j;j++,k++)product=digits[j]*digits[i]*2+imult1[k]+carry,carry=product/BigInteger.base|0,imult1[k]=product%BigInteger.base;k=length+i;var digit=carry+imult1[k];carry=digit/BigInteger.base|0,imult1[k]=digit%BigInteger.base,imult1[k+1]+=carry}return new BigInteger(imult1,1)},BigInteger.prototype.quotient=function(n){return this.divRem(n)[0]},BigInteger.prototype.divide=BigInteger.prototype.quotient,BigInteger.prototype.remainder=function(n){return this.divRem(n)[1]},BigInteger.prototype.divRem=function(n){if(n=BigInteger(n),0===n._s)throw new Error("Divide by zero");if(0===this._s)return[BigInteger.ZERO,BigInteger.ZERO];if(1===n._d.length)return this.divRemSmall(n._s*n._d[0]);switch(this.compareAbs(n)){case 0:return[this._s===n._s?BigInteger.ONE:BigInteger.M_ONE,BigInteger.ZERO];case-1:return[BigInteger.ZERO,this]}var guess,sign=this._s*n._s,a=n.abs(),b_digits=this._d.slice(),quot=(n._d.length,b_digits.length,[]),part=new BigInteger([],1);for(part._s=1;b_digits.length;)if(part._d.unshift(b_digits.pop()),part=new BigInteger(part._d,1),part.compareAbs(n)<0)quot.push(0);else{if(0===part._s)guess=0;else{var xlen=part._d.length,ylen=a._d.length,highx=part._d[xlen-1]*BigInteger.base+part._d[xlen-2],highy=a._d[ylen-1]*BigInteger.base+a._d[ylen-2];part._d.length>a._d.length&&(highx=(highx+1)*BigInteger.base),guess=Math.ceil(highx/highy)}do{var check=a.multiplySingleDigit(guess);if(check.compareAbs(part)<=0)break;guess--}while(guess);if(quot.push(guess),guess){var diff=part.subtract(check);part._d=diff._d.slice()}}return[new BigInteger(quot.reverse(),sign),new BigInteger(part._d,this._s)]},BigInteger.prototype.divRemSmall=function(n){var r;if(n=+n,0===n)throw new Error("Divide by zero");var n_s=0>n?-1:1,sign=this._s*n_s;if(n=Math.abs(n),1>n||n>=BigInteger.base)throw new Error("Argument out of range");if(0===this._s)return[BigInteger.ZERO,BigInteger.ZERO];if(1===n||-1===n)return[1===sign?this.abs():new BigInteger(this._d,sign),BigInteger.ZERO];if(1===this._d.length){var q=new BigInteger([this._d[0]/n|0],1);return r=new BigInteger([this._d[0]%n|0],1),0>sign&&(q=q.negate()),this._s<0&&(r=r.negate()),[q,r]}for(var guess,digits=this._d.slice(),quot=new Array(digits.length),part=0,diff=0,i=0;digits.length;)if(part=part*BigInteger.base+digits[digits.length-1],n>part)quot[i++]=0,digits.pop(),diff=BigInteger.base*diff+part;else{guess=0===part?0:part/n|0;var check=n*guess;diff=part-check,quot[i++]=guess,guess?(digits.pop(),part=diff):digits.pop()}return r=new BigInteger([diff],1),this._s<0&&(r=r.negate()),[new BigInteger(quot.reverse(),sign),r]},BigInteger.prototype.isEven=function(){var digits=this._d;return 0===this._s||0===digits.length||digits[0]%2===0},BigInteger.prototype.isOdd=function(){return!this.isEven()},BigInteger.prototype.sign=function(){return this._s},BigInteger.prototype.isPositive=function(){return this._s>0},BigInteger.prototype.isNegative=function(){return this._s<0},BigInteger.prototype.isZero=function(){return 0===this._s},BigInteger.prototype.exp10=function(n){if(n=+n,0===n)return this;if(Math.abs(n)>Number(BigInteger.MAX_EXP))throw new Error("exponent too large in BigInteger.exp10");if(n>0){for(var k=new BigInteger(this._d.slice(),this._s);n>=BigInteger.base_log10;n-=BigInteger.base_log10)k._d.unshift(0);return 0==n?k:(k._s=1,k=k.multiplySingleDigit(Math.pow(10,n)),this._s<0?k.negate():k)}if(-n>=this._d.length*BigInteger.base_log10)return BigInteger.ZERO;var k=new BigInteger(this._d.slice(),this._s);for(n=-n;n>=BigInteger.base_log10;n-=BigInteger.base_log10)k._d.shift();return 0==n?k:k.divRemSmall(Math.pow(10,n))[0]},BigInteger.prototype.pow=function(n){if(this.isUnit())return this._s>0?this:BigInteger(n).isOdd()?this:this.negate();if(n=BigInteger(n),0===n._s)return BigInteger.ONE;if(n._s<0){if(0===this._s)throw new Error("Divide by zero");return BigInteger.ZERO}if(0===this._s)return BigInteger.ZERO;if(n.isUnit())return this;if(n.compareAbs(BigInteger.MAX_EXP)>0)throw new Error("exponent too large in BigInteger.pow");for(var x=this,aux=BigInteger.ONE,two=BigInteger.small[2];n.isPositive();){if(n.isOdd()&&(aux=aux.multiply(x),n.isUnit()))return aux;x=x.square(),n=n.quotient(two)}return aux},BigInteger.prototype.modPow=function(exponent,modulus){for(var result=BigInteger.ONE,base=this;exponent.isPositive();)exponent.isOdd()&&(result=result.multiply(base).remainder(modulus)),exponent=exponent.quotient(BigInteger.small[2]),exponent.isPositive()&&(base=base.square().remainder(modulus));return result},BigInteger.prototype.log=function(){switch(this._s){case 0:return-1/0;case-1:return 0/0}var l=this._d.length;if(l*BigInteger.base_log10<30)return Math.log(this.valueOf());var N=Math.ceil(30/BigInteger.base_log10),firstNdigits=this._d.slice(l-N);return Math.log(new BigInteger(firstNdigits,1).valueOf())+(l-N)*Math.log(BigInteger.base)},BigInteger.prototype.valueOf=function(){return parseInt(this.toString(),10)},BigInteger.prototype.toJSValue=function(){return parseInt(this.toString(),10)},BigInteger.MAX_EXP=BigInteger(2147483647),function(){function makeUnary(fn){return function(a){return fn.call(BigInteger(a))}}function makeBinary(fn){return function(a,b){return fn.call(BigInteger(a),BigInteger(b))}}function makeTrinary(fn){return function(a,b,c){return fn.call(BigInteger(a),BigInteger(b),BigInteger(c))}}!function(){var i,fn,unary="toJSValue,isEven,isOdd,sign,isZero,isNegative,abs,isUnit,square,negate,isPositive,toString,next,prev,log".split(","),binary="compare,remainder,divRem,subtract,add,quotient,divide,multiply,pow,compareAbs".split(","),trinary=["modPow"];for(i=0;i<unary.length;i++)fn=unary[i],BigInteger[fn]=makeUnary(BigInteger.prototype[fn]);for(i=0;i<binary.length;i++)fn=binary[i],BigInteger[fn]=makeBinary(BigInteger.prototype[fn]);for(i=0;i<trinary.length;i++)fn=trinary[i],BigInteger[fn]=makeTrinary(BigInteger.prototype[fn]);BigInteger.exp10=function(x,n){return BigInteger(x).exp10(n)}}()}(),"undefined"!=typeof exports&&(exports.BigInteger=BigInteger);var BigInteger;if(BigInteger="undefined"!=typeof require?require("biginteger").BigInteger:this.BigInteger,!BigInteger)if("undefined"!=typeof load)load("biginteger.js");else{if(!this.readFile)throw new Error("BigInteger is not defined.");eval(this.readFile("biginteger.js"))}var SchemeNumber=function(){function assert(x){if(!x)throw new Error("assertion failed")}function retFalse(){return!1}function retTrue(){return!0}function retFirst(a){return a}function retThis(){return this}function unimpl(){throw new Error("BUG: unimplemented")}function pureVirtual(){throw new Error("BUG: Abstract method not overridden")}function N(){}function C(){}function R(){}function ER(){}function EQ(){}function EI(){}function retZero(){return ZERO}function retOne(){return ONE}function divisionByExactZero(){raise("&assertion","division by exact zero")}function SN(obj){if(obj instanceof N)return obj;var ret=obj;if("string"!=typeof ret){if("number"==typeof ret)return toFlonum(ret);if(ret instanceof Number)return toFlonum(+ret);if(null==ret)return null===ret?INEXACT_ZERO:NAN;if(ret=ret.valueOf(),"number"==typeof ret)return toFlonum(ret);ret=String(ret)}return ret=stringToNumber(ret),ret===!1&&raise("&assertion","not a number",obj),ret}function stringToNumber(s,radix,exact){function lose(){throw PARSE_ERROR}function setExact(value){void 0!==exact&&lose(),exact=value}function setRadix(value){radix&&lose(),radix=value}function parseUinteger(s,sign){return uintegerPattern[radix].test(s)||lose(),exact===!1?toFlonum(sign*_parseInt(s,radix)):parseEI(sign,s,radix)}function parseReal(s){if(nanInfPattern.test(s))switch(exact&&lose(),s){case"+inf.0":return INFINITY;case"-inf.0":return M_INFINITY;default:return NAN}var sign=1;switch(s[0]){case"-":sign=-1;case"+":s=s.substring(1)}var slash=s.indexOf("/");if(-1!=slash)return parseUinteger(s.substring(0,slash),sign).SN_divide(parseUinteger(s.substring(slash+1),1));10!==radix&&lose();var pipe=s.indexOf("|");if(-1!==pipe){var afterPipe=s.substring(pipe+1);uintegerPattern[10].test(afterPipe)||lose(),s=s.substring(0,pipe);var precision=_parseInt(afterPipe);if(0===precision)s="0.0";else if(53>precision)return parseWithWidth(s,precision,exact)}s=s.replace(exponentMarkerPattern,"e");var dot=s.indexOf("."),e=s.indexOf("e");if(-1===dot&&-1===e)return parseUinteger(s,sign);if(decimal10Pattern.test(s)||lose(),!exact)return toFlonum(sign*_parseFloat(s));var fraction,integer=s.substring(0,-1===dot?e:dot),exponent=0;return-1===e?fraction=s.substring(dot+1):(fraction=-1===dot?"":s.substring(dot+1,e),exponent=_parseInt(s.substring(e+1))),parseDecimal(sign,integer+fraction,exponent-fraction.length)}function parseComplex(s){var a=s.indexOf("@");if(-1!==a){var ret=makePolar(parseReal(s.substring(0,a)),parseReal(s.substring(a+1)));return exact&&ret.SN_isInexact()&&(ret=ret.SN_toExact()),ret}if("i"!==s[s.length-1])return parseReal(s);if("i"===s)return exact===!1?inexactRectangular(INEXACT_ZERO,toFlonum(1)):I;if("-i"===s)return exact===!1?inexactRectangular(INEXACT_ZERO,toFlonum(-1)):M_I;var x,y,match=(10===radix?decimalComplex:radixComplex).exec(s);return match?(x=match[1],y=match[2],x=x?parseReal(x):exact===!1?INEXACT_ZERO:ZERO,y="+"===y?ONE:"-"===y?M_ONE:parseReal(y)):(x=exact===!1?INEXACT_ZERO:ZERO,y=parseReal(s.substring(0,s.length-1))),makeRectangular(x,y)}function parseWithWidth(s,precision){var x=stringToNumber(s,radix,!0);if(x!==!1&&x.SN_isReal()||lose(),!x.SN_isZero()){var xabs=x.SN_abs(),shift=precision-floor(xabs.SN_log()/LN2)-1,scale=TWO.SN_expt(toEINative(abs(shift)));0>shift&&(scale=scale.SN_reciprocal());for(var shifted=xabs.SN_multiply(scale),denom=TWO.SN_expt(toEINative(precision));shifted.SN_ge(denom);)shifted=shifted.SN_divide(TWO),scale=scale.SN_divide(TWO);for(var twiceShifted=shifted.SN_add(shifted);twiceShifted.SN_lt(denom);twiceShifted=shifted.SN_add(shifted))shifted=twiceShifted,scale=scale.SN_add(scale);var rounded=shifted.SN_round().SN_divide(scale);x.SN_isNegative()&&(rounded=rounded.SN_negate()),x=rounded}return exact||(x=x.SN_toInexact()),x}if(!radix||10==radix){if(/^-?[0-9]{1,15}$/.test(s))return exact===!1?toFlonum(_parseInt(s)):toEINative(_parseInt(s));radix=10}var i=0;try{for(;"#"===s[i];){switch(s[i+1]){case"i":case"I":setExact(!1);break;case"e":case"E":setExact(!0);break;case"b":case"B":setRadix(2);break;case"o":case"O":setRadix(8);break;case"d":case"D":setRadix(10);break;case"x":case"X":setRadix(16);break;default:return!1}i+=2}return parseComplex(s.substring(i))}catch(e){if(e===PARSE_ERROR)return!1;throw void 0==s&&raise("&assertion","missing argument"),e}}function makeRectangular(x,y){return x.SN_isExact()&&y.SN_isExact()?exactRectangular(x,y):inexactRectangular(x.SN_toInexact(),y.SN_toInexact())}function makePolar(r,theta){return inexactRectangular(r.SN_multiply(theta.SN_cos()),r.SN_multiply(theta.SN_sin()))}function assertReal(x){return x.SN_isReal()||raise("&assertion","not a real number",x),x}function toReal(x){return x=SN(x),x.SN_isReal()||assertReal(x),x}function assertInteger(n){return n=SN(n),n.SN_isInteger()||raise("&assertion","not an integer",n),n}function toInteger(n){return n=SN(n),n.SN_isInteger()||assertInteger(n),n}function assertRational(q){return q.SN_isRational()||raise("&assertion","not a rational number",q),q}function assertNonNegative(n){return n.SN_isNegative()&&raise("&assertion","negative number",n),n}function assertExact(z){return z.SN_isInexact()&&raise("&assertion","inexact number",z),z}function defaultRaise(conditionType,message,irritant){var msg="SchemeNumber: "+conditionType+": "+message;throw arguments.length>2&&(isNumber(irritant)&&(irritant=irritant.SN_numberToString()),msg+=": "+irritant),new Error(msg)}function raise(){for(var len=arguments.length,args=new Array(len);len--;)args[len]=arguments[len];SN.raise.apply(SN,args),defaultRaise.apply(this,args)}function wrongArgCount(expected,a){var msg="Function";for(name in fn)if(fn[name]===a.callee){msg+=" '"+name+"'";break}raise("&assertion",msg+" expected "+expected+" argument"+("1"==expected?"":"s")+", got "+a.length)}function args1(a){1===a.length||wrongArgCount(1,a)}function args2(a){2===a.length||wrongArgCount(2,a)}function args1plus(a){a.length>0||wrongArgCount("1 or more",a)}function args2plus(a){a.length>1||wrongArgCount("2 or more",a)}function fn_isEqv(a,b){return 2===arguments.length||args2(arguments),a===b?!0:(a=SN(a),b=SN(b),a.SN_eq(b)&&a.SN_isExact()===b.SN_isExact())}function fn_isNumber(x){return 1===arguments.length||args1(arguments),isNumber(x)}function fn_isComplex(x){return 1===arguments.length||args1(arguments),isNumber(x)&&x.SN_isComplex()}function fn_isReal(x){return 1===arguments.length||args1(arguments),isNumber(x)&&x.SN_isReal()}function fn_isRational(x){return 1===arguments.length||args1(arguments),isNumber(x)&&x.SN_isRational()}function fn_isInteger(x){return 1===arguments.length||args1(arguments),isNumber(x)&&x.SN_isInteger()}function fn_isRealValued(x){return 1===arguments.length||args1(arguments),isNumber(x)&&x.SN_imagPart().SN_isZero()}function fn_isRationalValued(x){return 1===arguments.length||args1(arguments),fn_isRealValued(x)&&x.SN_realPart().SN_isRational()}function fn_isIntegerValued(x){return 1===arguments.length||args1(arguments),fn_isRealValued(x)&&x.SN_realPart().SN_isInteger()}function fn_equals(a){var len=arguments.length;len>1||args2plus(arguments),a=SN(a);for(var i=1;len>i;i++)if(!a.SN_eq(SN(arguments[i])))return!1;return!0}function makeUnary(method){function unary(a){return 1===arguments.length||args1(arguments),SN(a)[method]()}return unary}function makeBinary(method){function binary(a,b){return 2===arguments.length||args2(arguments),SN(a)[method](SN(b))}return binary}function makeComparator(cmp){function comparator(a,b){var len=arguments.length;if(len>1||args2plus(arguments),b=toReal(b),!toReal(a)[cmp](b))return!1;for(var i=2;len>i;i++){var c=toReal(arguments[i]);if(!b[cmp](c))return!1;b=c}return!0}return comparator}function makeMaxMin(cmp){function maxMin(a){var len=arguments.length;len>0||args1plus(arguments);for(var ret=toReal(a),exact=ret.SN_isExact(),i=1;len>i;i++){var x=toReal(arguments[i]);if(x.SN_isNaN())return x;exact&&(exact=x.SN_isExact(),exact||(ret=ret.SN_toInexact())),x[cmp](ret)!==!1&&(ret=x)}return exact?ret:ret.SN_toInexact()}return maxMin}function divModArg2Zero(arg){raise("&assertion","div/mod second argument is zero",arg)}function makeDivMod(is0,which){function divMod(x,y){if(2===arguments.length||args2(arguments),x=toReal(x),y=toReal(y),x.SN_isFinite()||raise("&assertion","div/mod first argument is not finite",x),y.SN_isZero()&&divModArg2Zero(y),!is0)switch(which){case 0:return x.SN_div(y);case 1:return x.SN_mod(y);case 2:default:return x.SN_divAndMod(y)}var dm=x.SN_divAndMod(y),m=dm[1],yabs=y.SN_abs();if(m.SN_add(m).SN_ge(yabs))switch(which){case 0:return dm[0].SN_add(y.SN_isNegative()?M_ONE:ONE);case 1:return m.SN_subtract(yabs);case 2:default:return[dm[0].SN_add(y.SN_isNegative()?M_ONE:ONE),m.SN_subtract(yabs)]}switch(which){case 0:return dm[0];case 1:return m;case 2:default:return dm}}return divMod}function rationalize(x,delta){if(args2(arguments),x=SN(x),delta=SN(delta),!x.SN_isFinite()||!delta.SN_isFinite())return assertReal(x),assertReal(delta),delta.SN_isInfinite()?x.SN_isFinite()?INEXACT_ZERO:NAN:delta.SN_isNaN()?delta:x;if(delta.SN_isZero())return x;delta=delta.SN_abs();var x0=x.SN_subtract(delta),x1=x.SN_add(delta),a=x0.SN_floor(),b=x1.SN_floor();if(a.SN_ne(b)){var negative=a.SN_isNegative();return b.SN_isNegative()!=negative?a.SN_isExact()?ZERO:INEXACT_ZERO:negative?b:x0.SN_ceiling()}for(var cf=[];;){if(x0=x0.SN_subtract(a),x0.SN_isZero())break;if(x1=x1.SN_subtract(a),x1.SN_isZero())break;switch(x0=x0.SN_reciprocal(),x1=x1.SN_reciprocal(),a=x0.SN_floor(),a.SN_compare(x1.SN_floor())){case-1:cf.push(x0.SN_ceiling());break;case 1:cf.push(x1.SN_ceiling());break;case 0:default:cf.push(a);continue}break}for(var ret=ZERO,i=cf.length;i--;)ret=ret.SN_add(cf[i]).SN_reciprocal();return ret.SN_add(b)}function numberToBinary(x){return x.toString(2)}function nativeDenominatorLog2(x){var s=numberToBinary(abs(x)),i=s.indexOf(".");return-1===i?0:s.length-i-1}function nativeDenominator(x){return pow(2,nativeDenominatorLog2(x))}function numberToEI(n){return 9007199254740992>n&&n>-9007199254740992?toEINative(n):new EIBig(numberToBigInteger(n))}function nativeToExact(x){_isFinite(x)||raise("&implementation-violation","inexact argument has no reasonably close exact equivalent",x);var n,d=nativeDenominator(x);if(1===d)return numberToEI(x);if(_isFinite(d))n=x*d,d=numberToEI(d);else{var dl2=nativeDenominatorLog2(x);n=9007199254740992*x,n*=pow(2,dl2-53),d=TWO.SN_expt(toEINative(dl2))}return canonicalEQ(numberToEI(n),d)}function div_Flonum_R(x,y){return y>0?floor(x/y):0>y?ceil(x/y):(0==y&&divModArg2Zero(toFlonum(y)),0/0)}function funcToMeth(fn){return function(){return fn(this)}}function cplxFuncToMeth(mathFunc,complexFunc){return function(){var ret=mathFunc(this);return _isNaN(ret)?complexFunc(this):toFlonum(ret)}}function complexLog(z){return makeRectangular(z.SN_magnitude().SN_log(),z.SN_angle())}function complexAsin(z){return M_I.SN_multiply(I.SN_multiply(z).SN_add(ONE.SN_subtract(z.SN_square()).SN_sqrt()).SN_log())}function complexAcos(z){return PI.SN_divide(TWO).SN_subtract(complexAsin(z))}function complexAtan(z){var iz=I.SN_multiply(z);return ONE.SN_add(iz).SN_log().SN_subtract(ONE.SN_subtract(iz).SN_log()).SN_divide(TWO).SN_divide(I)}function complexExpt(b,p){if(b.SN_isZero()){if(p.SN_isZero())return toFlonum(1);if(p.SN_realPart().SN_isPositive())return INEXACT_ZERO;raise("&implementation-restriction","invalid power for zero expt",p)}return b.SN_log().SN_multiply(p).SN_exp()}function divAndMod_R_R(x,y){var div=div_R_R(x,y);return[div,x.SN_subtract(div.SN_multiply(y))]}function div_R_R(x,y){return y.SN_isNegative()?x.SN_divide(y).SN_ceiling():x.SN_divide(y).SN_floor()}function mod_R_R(x,y){return x.SN_subtract(div_R_R(x,y).SN_multiply(y))}function exactRectangular(x,y){return y.SN_isZero()?x:x.SN_isZero()&&y.SN_isUnit()?y.SN_isPositive()?I:M_I:new Rectangular(x,y)}function inexactRectangular(x,y){return new Rectangular(x,y)}function toRectangular(x,y){return x.SN_isExact()?exactRectangular(x,y):new Rectangular(x,y)}function Rectangular(x,y){this._x=x,this._y=y}function xyToString(xString,yString){return"-"===yString[0]||"+"===yString[0]?xString+yString+"i":xString+"+"+yString+"i"}function rectMagnitude2(z){return z._x.SN_square().SN_add(z._y.SN_square())}function complexMultiply(ax,ay,bx,by){return toRectangular(ax.SN_multiply(bx).SN_subtract(ay.SN_multiply(by)),ax.SN_multiply(by).SN_add(ay.SN_multiply(bx)))}function complexDivide(x,y,z){var m2=rectMagnitude2(z);return complexMultiply(x,y,z._x.SN_divide(m2),z._y.SN_divide(m2).SN_negate())}function zeroes(count){var ret="000000000000000".substring(0,15&count);return count>15&&(ret+=new Array((count>>4)+1).join("0000000000000000")),ret}function parseDecimal(sign,significand,exponent){return parseEI(sign,significand).SN__exp10(exponent)}function reduceEQ(n,d){d.SN_isZero()&&divisionByExactZero();var g=gcdNonneg(n.SN_abs(),d.SN_abs());return n=n.SN_div(g),d=d.SN_div(g),d.SN_isNegative()?canonicalEQ(n.SN_negate(),d.SN_negate()):canonicalEQ(n,d)}function canonicalEQ(n,d){return d===ONE?n:new EQFraction(n,d)}function EQFraction(n,d){this._n=n,this._d=d}function parseEI(sign,string,radix){var n=_parseInt(string,radix);return 9007199254740992>n?toEINative(sign*n):parseEIBig(string,sign,radix)}function expt_E_EI(z,n){for(var bits=n.SN_abs(),squarer=z,ret=ONE;bits.SN_isPositive();)bits.SN_isOdd()&&(ret=ret.SN_multiply(squarer)),squarer=squarer.SN_square(),bits=bits.SN_div(TWO);return n.SN_isNegative()?ret.SN_reciprocal():ret}function EINative(x){this._=x}function toEINative(n){return EINativeSmall[n]||(-1==n?M_ONE:new EINative(n))}function negate(z){return z.SN_negate()}function reciprocal(z){return z.SN_reciprocal()}function add_EINative_EINative(a,b){var ret=a+b;return ret>-9007199254740992&&9007199254740992>ret?toEINative(ret):new EIBig(BigInteger.add(a,b))}function divAndMod_EINative(t,x,which){0===x&&divisionByExactZero();var div=x>0?floor(t/x):ceil(t/x);if(0===which)return toEINative(div);var mod,tmp=x*div;return mod=tmp>-9007199254740992?t-tmp:div>0?t-x-x*(div-1):t+x-x*(div+1),mod=toEINative(mod),1===which?mod:[toEINative(div),mod]}function reduceBigInteger(n){return n.compareAbs(FIRST_BIG_INTEGER)>=0?new EIBig(n):toEINative(n.toJSValue())}function EIBig(n){this._=n}function parseEIBig(s,sign,radix){return n=BigInteger.parse(s,radix),0>sign&&(n=n.negate()),new EIBig(n)}function gcdNative(a,b){for(var c;0!==a;)c=a,a=b%a,b=c;return toEINative(b)}function gcdNonneg(a,b){if(a instanceof EINative&&b instanceof EINative)return gcdNative(a.valueOf(),b.valueOf());if(a=a.SN__toBigInteger(),a.isZero())return b;b=b.SN__toBigInteger();for(var c;;){if(c=a,a=b.remainder(a),a.isZero())return new EIBig(c);if(b=c,b.compareAbs(FIRST_BIG_INTEGER)<0)return gcdNative(a.valueOf(),b.valueOf())}}function numberToBigInteger(n){return BigInteger.parse(n.toString(16),16)}function resolveOverload(className){function resolve(subclasses,prefix,method){function resolveSub(subclass){proto[prefix+subclass]||(newMethods[prefix+subclass]=method,resolve(HIERARCHY[subclass],prefix,method))}subclasses&&subclasses.forEach(resolveSub)}var proto=DISP[className],newMethods={};for(var oldName in proto)if(/^SN_/.test(oldName)){var underscore=oldName.lastIndexOf("_");if(-1!==underscore){var oldMethod=proto[oldName];if(oldMethod){var oldClass=oldName.substring(underscore+1);resolve(HIERARCHY[oldClass],oldName.substring(0,underscore+1),oldMethod)}}}for(var methodName in newMethods)proto[methodName]=newMethods[methodName]}function checkPureVirtual(handler){var e="";for(var className in CLASSES)if(/[a-z]/.test(className)){var proto=CLASSES[className].prototype;for(methodName in proto)proto[methodName]===pureVirtual&&(e+="Pure virtual: "+className+"."+methodName+"\n")}e&&handler(e)}var abs=Math.abs,floor=Math.floor,ceil=Math.ceil,round=Math.round,pow=Math.pow,sqrt=Math.sqrt,atan2=Math.atan2,exp=(Math.log,Math.exp),LN2=(Math.atan,Math.cos,Math.sin,Math.tan,Math.LN2),LN10=Math.LN10,_isFinite=isFinite,_isNaN=isNaN,_parseInt=parseInt,_parseFloat=parseFloat;N.prototype=new Number,C.prototype=new N,R.prototype=new C,ER.prototype=new R,EQ.prototype=new ER,EI.prototype=new EQ;var Flonum,decimalComplex=/^(.*[^a-zA-Z]|)([-+].*)i$/,radixComplex=/^(.*)([-+].*)i$/,nanInfPattern=/^[-+](nan|inf)\.0$/,exponentMarkerPattern=/[eEsSfFdDlL]/,decimal10Pattern=/^([0-9]+\.?|[0-9]*\.[0-9]+)([eEsSfFdDlL][-+]?[0-9]+)?$/,uintegerPattern={2:/^[01]+$/,8:/^[0-7]+$/,10:/^[0-9]+$/,16:/^[0-9a-fA-F]+$/};
Flonum=function(x){this._=x};var toFlonum,isNumber,flo={},FLO_FUNCS=[[],["log","floor","ceil","sqrt","abs","atan","cos","sin","tan","exp"],["pow","atan2"]];Flonum===Number?(toFlonum=retFirst,isNumber=function(x){return x instanceof Number||"number"==typeof x},FLO_FUNCS[1].concat(FLO_FUNCS[2]).forEach(function(name){flo[name]=Math[name]})):(Flonum.prototype=new R,function(){var inexactZero=new Flonum(0);toFlonum=function(x){return 0===x?inexactZero:new Flonum(x)}}(),isNumber=function(x){return x instanceof N},FLO_FUNCS[1].forEach(function(name){var math=Math[name];flo[name]=function(a){return toFlonum(math(a))}}),FLO_FUNCS[2].forEach(function(name){var math=Math[name];flo[name]=function(a,b){return toFlonum(math(a,b))}}),["toFixed","toExponential","toPrecision"].forEach(function(name){var number=Number.prototype[name];Flonum.prototype[name]=function(a){return number.call(this._,a)}}),Flonum.prototype.valueOf=function(){return this._});var SchemeNumber=SN;SchemeNumber.VERSION=[1,1,4];var floPow=flo.pow,floLog=flo.log,floFloor=flo.floor,floCeil=flo.ceil,floSqrt=flo.sqrt,floAtan2=flo.atan2,floAbs=flo.abs,floAtan=flo.atan,floCos=flo.cos,floSin=flo.sin,floTan=flo.tan,floExp=flo.exp,HIERARCHY={C:["Rectangular","R"],R:["Flonum","ER"],ER:["EQ"],EQ:["EQFraction","EI"],EI:["EINative","EIBig"]},CLASSES={C:C,R:R,ER:ER,EQ:EQ,EI:EI,Rectangular:Rectangular,Flonum:Flonum,EQFraction:EQFraction,EINative:EINative,EIBig:EIBig},DISP={};for(var className in CLASSES)DISP[className]={};var PARSE_ERROR=new Object;SchemeNumber.raise=defaultRaise,SN.maxIntegerDigits=1e6,SchemeNumber.fn={"eqv?":fn_isEqv,"number?":fn_isNumber,"complex?":fn_isComplex,"real?":fn_isReal,"rational?":fn_isRational,"integer?":fn_isInteger,"real-valued?":fn_isRealValued,"rational-valued?":fn_isRationalValued,"integer-valued?":fn_isIntegerValued,"exact?":makeUnary("SN_isExact"),"inexact?":makeUnary("SN_isInexact"),inexact:makeUnary("SN_toInexact"),exact:makeUnary("SN_toExact"),"=":fn_equals,"<":makeComparator("SN_lt"),">":makeComparator("SN_gt"),"<=":makeComparator("SN_le"),">=":makeComparator("SN_ge"),"zero?":makeUnary("SN_isZero"),"positive?":makeUnary("SN_isPositive"),"negative?":makeUnary("SN_isNegative"),"odd?":makeUnary("SN_isOdd"),"even?":makeUnary("SN_isEven"),"finite?":makeUnary("SN_isFinite"),"infinite?":makeUnary("SN_isInfinite"),"nan?":makeUnary("SN_isNaN"),max:makeMaxMin("SN_gt"),min:makeMaxMin("SN_lt"),"+":function(){for(var ret=ZERO,len=arguments.length,i=0;len>i;)ret=ret.SN_add(SN(arguments[i++]));return ret},"*":function(){for(var ret=ONE,len=arguments.length,i=0;len>i;)ret=ret.SN_multiply(SN(arguments[i++]));return ret},"-":function(a){var len=arguments.length;switch(len){case 0:args1plus(arguments);case 1:return SN(a).SN_negate()}for(var ret=SN(a),i=1;len>i;)ret=ret.SN_subtract(SN(arguments[i++]));return ret},"/":function(a){var len=arguments.length;switch(len){case 0:args1plus(arguments);case 1:return SN(a).SN_reciprocal();case 2:return SN(a).SN_divide(SN(arguments[1]))}for(var product=ONE,i=1;len>i;)product=product.SN_multiply(SN(arguments[i++]));return SN(a).SN_divide(product)},abs:makeUnary("SN_abs"),"div-and-mod":makeDivMod(!1,2),div:makeDivMod(!1,0),mod:makeDivMod(!1,1),"div0-and-mod0":makeDivMod(!0,2),div0:makeDivMod(!0,0),mod0:makeDivMod(!0,1),gcd:function(){for(var ret=ZERO,len=arguments.length,exact=!0,i=0;len>i;i++){var arg=toInteger(arguments[i]);exact=exact&&arg.SN_isExact(),ret=gcdNonneg(ret,arg.SN_abs().SN_toExact())}return ret=ret.SN_abs(),exact?ret:ret.SN_toInexact()},lcm:function(){for(var ret=ONE,len=arguments.length,exact=!0,i=0;len>i;i++){var arg=toInteger(arguments[i]);exact=exact&&arg.SN_isExact(),arg=arg.SN_abs().SN_toExact(),ret=ret.SN_multiply(arg).SN_divide(gcdNonneg(ret,arg.SN_abs()))}return exact?ret:ret.SN_toInexact()},numerator:makeUnary("SN_numerator"),denominator:makeUnary("SN_denominator"),floor:makeUnary("SN_floor"),ceiling:makeUnary("SN_ceiling"),truncate:makeUnary("SN_truncate"),round:makeUnary("SN_round"),rationalize:rationalize,exp:makeUnary("SN_exp"),log:function(z,base){var ret=SN(z).SN_log();switch(arguments.length){case 2:ret=ret.SN_divide(SN(base).SN_log());case 1:return ret;default:wrongArgCount("1-2",arguments)}},sin:makeUnary("SN_sin"),cos:makeUnary("SN_cos"),tan:makeUnary("SN_tan"),asin:makeUnary("SN_asin"),acos:makeUnary("SN_acos"),atan:function(y,x){switch(arguments.length){case 1:return SN(y).SN_atan();case 2:return toReal(y).SN_atan2(toReal(x));default:wrongArgCount("1-2",arguments)}},sqrt:makeUnary("SN_sqrt"),"exact-integer-sqrt":makeUnary("SN_exactIntegerSqrt"),expt:makeBinary("SN_expt"),"make-rectangular":function(x,y){return 2===arguments.length||args2(arguments),makeRectangular(toReal(x),toReal(y))},"make-polar":function(r,theta){return 2===arguments.length||args2(arguments),makePolar(toReal(r),toReal(theta))},"real-part":makeUnary("SN_realPart"),"imag-part":makeUnary("SN_imagPart"),magnitude:makeUnary("SN_magnitude"),angle:makeUnary("SN_angle"),"number->string":function(z,radix,precision){var r=radix;switch(arguments.length){case 3:precision=toInteger(precision),assertExact(precision);case 2:r=assertExact(toInteger(r)).valueOf(),uintegerPattern[r]||raise("&assertion","invalid radix",radix);case 1:break;default:wrongArgCount("1-3",arguments)}return SN(z).SN_numberToString(r,precision)},"string->number":function(s,radix){switch(arguments.length){case 1:case 2:return stringToNumber(String(s),radix);default:wrongArgCount("1-2",arguments)}}},DISP.Flonum.SN_isExact=retFalse,DISP.Flonum.SN_isInexact=retTrue,DISP.Flonum.SN_isComplex=retTrue,DISP.Flonum.SN_isReal=retTrue,DISP.Flonum.SN_debug=function(){return"Flonum("+this.SN_numberToString()+")"},DISP.Flonum.SN_numberToString=function(radix,precision){if(radix&&10!=radix&&_isFinite(this))return"#i"+this.SN_toExact().SN_numberToString(radix);if(!_isFinite(this))return _isNaN(this)?"+nan.0":this>0?"+inf.0":"-inf.0";var s=(+this).toString();if(-1===s.indexOf(".")){var e=s.indexOf("e");-1===e?s+=".":s=s.substring(0,e)+"."+s.substring(e)}if(void 0!=precision){if(53>precision){var bits=numberToBinary(+this).replace(/[-+.]/g,"").replace(/^0+/,"").replace(/0+$/,"").length;bits>precision&&(precision=bits)}s+="|"+precision}return s},DISP.Flonum.SN_realPart=retThis,DISP.Flonum.SN_imagPart=function(){return ZERO},DISP.Flonum.SN_denominator=function(){return floPow(2,nativeDenominatorLog2(+assertRational(this)))},DISP.Flonum.SN_numerator=function(){return toFlonum(this*nativeDenominator(+assertRational(this)))},DISP.Flonum.SN_isInteger=function(){return _isFinite(this)&&this==floor(this)},DISP.Flonum.SN_isFinite=function(){return _isFinite(this)},DISP.Flonum.SN_isRational=DISP.Flonum.SN_isFinite,DISP.Flonum.SN_isZero=function(){return 0==this},DISP.Flonum.SN_isPositive=function(){return this>0},DISP.Flonum.SN_isNegative=function(){return 0>this},DISP.Flonum.SN_sign=function(){return 0==this?0:this>0?1:-1},DISP.Flonum.SN_isUnit=function(){return 1==this||-1==this},DISP.Flonum.SN_isInfinite=function(){return!_isFinite(this)&&!_isNaN(this)},DISP.Flonum.SN_isNaN=function(){return _isNaN(this)},DISP.Flonum.SN_isEven=function(){return 0===(1&this)},DISP.Flonum.SN_isOdd=function(){return 1===(1&this)},DISP.Flonum.SN_eq=function(z){return z.SN__eq_Flonum(this)},DISP.Flonum.SN_ne=function(z){return z.SN__ne_Flonum(this)},DISP.Flonum.SN_gt=function(x){return assertReal(x).SN__gt_Flonum(this)},DISP.Flonum.SN_lt=function(x){return assertReal(x).SN__lt_Flonum(this)},DISP.Flonum.SN_ge=function(x){return assertReal(x).SN__ge_Flonum(this)},DISP.Flonum.SN_le=function(x){return assertReal(x).SN__le_Flonum(this)},DISP.Flonum.SN_compare=function(x){return assertReal(x).SN__compare_Flonum(this)},DISP.Flonum.SN__eq_R=function(x){return+x==this},DISP.Flonum.SN__ne_R=function(x){return+x!=this},DISP.Flonum.SN__gt_R=function(x){return x>this},DISP.Flonum.SN__lt_R=function(x){return this>x},DISP.Flonum.SN__ge_R=function(x){return x>=this},DISP.Flonum.SN__le_R=function(x){return this>=x},DISP.Flonum.SN__compare_R=function(x){return+x==this?0:this>x?-1:x>this?1:0/0},DISP.Flonum.SN_toExact=function(){return nativeToExact(+this)},DISP.Flonum.SN_toInexact=retThis,DISP.Flonum.SN_add=function(z){return z.SN__add_Flonum(this)},DISP.Flonum.SN_subtract=function(z){return z.SN__subtract_Flonum(this)},DISP.Flonum.SN_multiply=function(z){return z.SN__multiply_Flonum(this)},DISP.Flonum.SN_divide=function(z){return z.SN__divide_Flonum(this)},DISP.Flonum.SN__add_R=function(x){return toFlonum(x+this)},DISP.Flonum.SN__subtract_R=function(x){return toFlonum(x-this)},DISP.Flonum.SN__multiply_R=function(x){return toFlonum(x*this)},DISP.Flonum.SN__divide_R=function(x){return toFlonum(x/this)},DISP.Flonum.SN_negate=function(){return toFlonum(-this)},DISP.Flonum.SN_abs=function(){return 0>this?toFlonum(-this):this},DISP.Flonum.SN_reciprocal=function(){return toFlonum(1/this)},DISP.Flonum.SN_divAndMod=function(x){x=+x;var div=div_Flonum_R(this,x);return[toFlonum(div),toFlonum(this-x*div)]},DISP.Flonum.SN_div=function(x){return toFlonum(div_Flonum_R(this,x))},DISP.Flonum.SN_mod=function(x){return toFlonum(this-x*div_Flonum_R(this,x))},DISP.Flonum.SN_square=function(){return toFlonum(this*this)},DISP.Flonum.SN_round=function(){var ret=floor(this),diff=this-ret;return toFlonum(.5>diff?ret:diff>.5?ret+1:2*round(this/2))},DISP.Flonum.SN_truncate=function(){return 0>this?floCeil(this):floFloor(this)},DISP.Flonum.SN_ceiling=function(){return floCeil(this)},DISP.Flonum.SN_abs=funcToMeth(floAbs),DISP.Flonum.SN_atan=funcToMeth(floAtan),DISP.Flonum.SN_cos=funcToMeth(floCos),DISP.Flonum.SN_exp=funcToMeth(floExp),DISP.Flonum.SN_floor=funcToMeth(floFloor),DISP.Flonum.SN_sin=funcToMeth(floSin),DISP.Flonum.SN_tan=funcToMeth(floTan),DISP.Flonum.SN_acos=cplxFuncToMeth(Math.acos,complexAcos),DISP.Flonum.SN_asin=cplxFuncToMeth(Math.asin,complexAsin),DISP.Flonum.SN_log=function(){return 0>this?complexLog(this):floLog(this)},DISP.Flonum.SN_sqrt=function(){return this>=0?toFlonum(sqrt(this)):_isNaN(this)?this:inexactRectangular(INEXACT_ZERO,floSqrt(-this))},DISP.Flonum.SN_atan2=function(x){return floAtan2(this,x)},DISP.Flonum.SN_expt=function(z){return z.SN__expt_Flonum(this)};var INEXACT_ZERO=toFlonum(0),INFINITY=toFlonum(Number.POSITIVE_INFINITY),M_INFINITY=toFlonum(Number.NEGATIVE_INFINITY),NAN=toFlonum(Number.NaN),PI=toFlonum(Math.PI);DISP.C.SN_isReal=retFalse,DISP.C.SN_isRational=retFalse,DISP.C.SN_isInteger=retFalse,DISP.C.SN_isZero=retFalse,DISP.C.SN_isUnit=retFalse,DISP.C.SN_isComplex=retTrue,DISP.C.SN_numberToString=pureVirtual,DISP.C.toString=function(radix){return this.SN_numberToString(radix)},DISP.C.valueOf=function(){return this.SN_imagPart().SN_isZero()?this.SN_realPart().valueOf():0/0},DISP.C.toFixed=pureVirtual,DISP.C.toExponential=pureVirtual,DISP.C.toPrecision=pureVirtual,DISP.C.toLocaleString=function(){return this.toString()},DISP.C.SN_debug=function(){return"C"},DISP.C.SN_sqrt=function(){return makePolar(this.SN_magnitude().SN_sqrt(),this.SN_angle().SN_divide(TWO))},DISP.C.SN_log=function(){return complexLog(this)},DISP.C.SN_asin=function(){return complexAsin(this)},DISP.C.SN_acos=function(){return complexAcos(this)},DISP.C.SN_atan=function(){return complexAtan(this)},DISP.C.SN_sin=function(){var iz=I.SN_multiply(this);return iz.SN_exp().SN_subtract(iz.SN_negate().SN_exp()).SN_divide(TWO).SN_divide(I)},DISP.C.SN_cos=function(){var iz=I.SN_multiply(this);return iz.SN_exp().SN_add(iz.SN_negate().SN_exp()).SN_divide(TWO)},DISP.C.SN_tan=function(){return this.SN_sin().SN_divide(this.SN_cos())},DISP.R.SN_isReal=retTrue,DISP.R.SN_debug=function(){return"R"},DISP.R.SN_realPart=retThis,DISP.R.SN_magnitude=function(){return this.SN_abs()},DISP.R.SN_angle=function(){return this.SN_isNegative()?PI:ZERO},DISP.R.SN__eq_Flonum=DISP.Flonum.SN__eq_R,DISP.R.SN__ne_Flonum=DISP.Flonum.SN__ne_R,DISP.R.SN__eq_Rectangular=function(z){return z._y.SN_isZero()&&z._x.SN_eq(this)},DISP.R.SN__ne_Rectangular=function(z){return!z._y.SN_isZero()||z._x.SN_ne(this)},DISP.R.SN__gt_Flonum=DISP.Flonum.SN__gt_R,DISP.R.SN__lt_Flonum=DISP.Flonum.SN__lt_R,DISP.R.SN__ge_Flonum=DISP.Flonum.SN__ge_R,DISP.R.SN__le_Flonum=DISP.Flonum.SN__le_R,DISP.R.SN__compare_Flonum=DISP.Flonum.SN__compare_R,DISP.R.SN_compare=pureVirtual,DISP.R.SN_gt=function(x){return this.SN_compare(x)>0},DISP.R.SN_lt=function(x){return this.SN_compare(x)<0},DISP.R.SN_ge=function(x){return this.SN_compare(x)>=0},DISP.R.SN_le=function(x){return this.SN_compare(x)<=0},DISP.R.SN_add=function(z){return z.SN__add_R(this)},DISP.R.SN__add_Flonum=DISP.Flonum.SN__add_R,DISP.R.SN_subtract=function(z){return z.SN__subtract_R(this)},DISP.R.SN__subtract_Flonum=DISP.Flonum.SN__subtract_R,DISP.R.SN_multiply=function(z){return z.SN__multiply_R(this)},DISP.R.SN__multiply_Flonum=DISP.Flonum.SN__multiply_R,DISP.R.SN_divide=function(z){return z.SN__divide_R(this)},DISP.R.SN__divide_Flonum=DISP.Flonum.SN__divide_R,DISP.R.SN__expt_R=function(x){return x.SN_isNegative()?complexExpt(x,this):floPow(x,this)},DISP.R.SN__expt_EI=DISP.R.SN__expt_R,DISP.R.SN__expt_EQ=function(q){if(q.SN_isNegative())return complexExpt(q,this);var num=q.SN_numerator().SN_expt(this),den=q.SN_denominator().SN_expt(this);return num.SN_isExact()&&num.SN_isInteger()&&den.SN_isExact()&&den.SN_isInteger()?new EQFraction(num,den):num.SN_divide(den)},DISP.R.SN_divAndMod=function(x){return divAndMod_R_R(this,x)},DISP.R.SN_div=function(x){return div_R_R(this,x)},DISP.R.SN_mod=function(x){return mod_R_R(this,x)},DISP.R.SN__divAndMod_R=function(x){return divAndMod_R_R(x,this)},DISP.R.SN__div_R=function(x){return div_R_R(x,this)},DISP.R.SN__mod_R=function(x){return mod_R_R(x,this)},["sqrt","exp","log","sin","cos","tan","asin","acos","atan","atan2"].forEach(function(name){DISP.R["SN_"+name]=DISP.Flonum["SN_"+name]}),Rectangular.prototype=new C,DISP.Rectangular.SN_numberToString=function(radix,precision){return xyToString(this._x.SN_numberToString(radix,precision),this._y.SN_numberToString(radix,precision))},DISP.Rectangular.toString=function(radix){return radix=radix||10,xyToString(this._x.toString(radix),this._y.toString(radix))},DISP.Rectangular.SN_debug=function(){return"Rectangular("+this._x.SN_debug()+", "+this._y.SN_debug()+")"},DISP.Rectangular.toFixed=function(dig){return xyToString(this._x.toFixed(dig),this._y.toFixed(dig))},DISP.Rectangular.toExponential=function(dig){return xyToString(this._x.toExponential(dig),this._y.toExponential(dig))},DISP.Rectangular.toPrecision=function(prec){return xyToString(this._x.toPrecision(prec),this._y.toPrecision(prec))},DISP.Rectangular.SN_realPart=function(){return this._x},DISP.Rectangular.SN_imagPart=function(){return this._y},DISP.Rectangular.SN_isExact=function(){return this._x.SN_isExact()},DISP.Rectangular.SN_isInexact=function(){return this._x.SN_isInexact()},DISP.Rectangular.SN_toInexact=function(){return this._x.SN_isInexact()?this:inexactRectangular(this._x.SN_toInexact(),this._y.SN_toInexact())},DISP.Rectangular.SN_toExact=function(){return this._x.SN_isExact()?this:exactRectangular(this._x.SN_toExact(),this._y.SN_toExact())},DISP.Rectangular.SN_isZero=function(){return this._x.SN_isZero()&&this._y.SN_isZero()},DISP.Rectangular.SN_isUnit=function(){return rectMagnitude2(this).SN_eq(ONE)},DISP.Rectangular.SN_magnitude=function(){return this._x.SN_isZero()?this._y.SN_abs():rectMagnitude2(this).SN_sqrt()},DISP.Rectangular.SN_angle=function(){return this._y.SN_atan2(this._x)},DISP.C.SN__eq_Rectangular=pureVirtual,DISP.Rectangular.SN_eq=function(z){return z.SN__eq_Rectangular(this)},DISP.Rectangular.SN__eq_Rectangular=function(z){return z._x.SN_eq(this._x)&&z._y.SN_eq(this._y)},DISP.Rectangular.SN__eq_R=function(x){return this._y.SN_isZero()&&x.SN_eq(this._x)},DISP.C.SN__ne_Rectangular=pureVirtual,DISP.Rectangular.SN_ne=function(z){return z.SN__ne_Rectangular(this)},DISP.Rectangular.SN__ne_Rectangular=function(z){return z._x.SN_ne(this._x)||z._y.SN_ne(this._y)},DISP.Rectangular.SN__ne_R=function(x){return!this._y.SN_isZero()||x.SN_ne(this._x)},DISP.Flonum.SN__add_Rectangular=function(z){return inexactRectangular(toFlonum(z._x+this),z._y.SN_toInexact())},DISP.Flonum.SN__subtract_Rectangular=function(z){return inexactRectangular(toFlonum(z._x-this),z._y.SN_toInexact())},DISP.Flonum.SN__multiply_Rectangular=function(z){return inexactRectangular(toFlonum(z._x*this),toFlonum(z._y*this))},DISP.Flonum.SN__divide_Rectangular=function(z){return inexactRectangular(toFlonum(z._x/this),toFlonum(z._y/this))},DISP.Flonum.SN__expt_Rectangular=function(z){return makePolar(floPow(rectMagnitude2(z),this/2),toFlonum(atan2(z._y,z._x)*this))},DISP.R.SN__add_Rectangular=function(z){return makeRectangular(z._x.SN_add(this),z._y)},DISP.R.SN__subtract_Rectangular=function(z){return makeRectangular(z._x.SN_subtract(this),z._y)},DISP.R.SN__multiply_Rectangular=function(z){return toRectangular(z._x.SN_multiply(this),z._y.SN_multiply(this))},DISP.R.SN__divide_Rectangular=function(z){return toRectangular(z._x.SN_divide(this),z._y.SN_divide(this))},DISP.C.SN__add_Rectangular=pureVirtual,DISP.Rectangular.SN_add=function(z){return z.SN__add_Rectangular(this)},DISP.Rectangular.SN__add_R=function(x){return makeRectangular(x.SN_add(this._x),this._y)},DISP.Rectangular.SN__add_Rectangular=function(z){var x=z._x.SN_add(this._x),y=z._y.SN_add(this._y);return(x.SN_isExact()?exactRectangular:inexactRectangular)(x,y)},DISP.Rectangular.SN_negate=function(){return toRectangular(this._x.SN_negate(),this._y.SN_negate())},DISP.C.SN__subtract_Rectangular=pureVirtual,DISP.Rectangular.SN_subtract=function(z){return z.SN__subtract_Rectangular(this)},DISP.Rectangular.SN__subtract_R=function(x){return makeRectangular(x.SN_subtract(this._x),this._y.SN_negate())},DISP.Rectangular.SN__subtract_Rectangular=function(z){var x=z._x.SN_subtract(this._x),y=z._y.SN_subtract(this._y);return(x.SN_isExact()?exactRectangular:inexactRectangular)(x,y)},DISP.C.SN__multiply_Rectangular=pureVirtual,DISP.Rectangular.SN_multiply=function(z){return z.SN__multiply_Rectangular(this)},DISP.Rectangular.SN__multiply_R=function(x){return toRectangular(x.SN_multiply(this._x),x.SN_multiply(this._y))},DISP.Rectangular.SN__multiply_Rectangular=function(z){return complexMultiply(z._x,z._y,this._x,this._y)},DISP.Rectangular.SN_square=function(){return toRectangular(this._x.SN_square().SN_subtract(this._y.SN_square()),this._x.SN_multiply(this._y).SN_multiply(TWO))},DISP.Rectangular.SN_reciprocal=function(){var m2=rectMagnitude2(this);return toRectangular(this._x.SN_divide(m2),this._y.SN_divide(m2).SN_negate())},DISP.C.SN__divide_Rectangular=pureVirtual,DISP.Rectangular.SN_divide=function(z){return z.SN__divide_Rectangular(this)},DISP.Rectangular.SN__divide_R=function(x){return complexDivide(x,x.SN_isExact()?ZERO:INEXACT_ZERO,this)},DISP.Rectangular.SN__divide_Rectangular=function(z){return complexDivide(z._x,z._y,this)},DISP.Rectangular.SN_expt=function(z){return z.SN__expt_Rectangular(this)},DISP.Rectangular.SN__expt_C=function(z){return complexExpt(z,this)},DISP.C.SN__expt_Rectangular=DISP.Rectangular.SN__expt_C,DISP.Rectangular.SN_exp=function(){return makePolar(this._x.SN_exp(),this._y)},DISP.ER.SN_isExact=retTrue,DISP.ER.SN_isInexact=retFalse,DISP.ER.SN_toExact=retThis,DISP.ER.SN_toInexact=function(){return toFlonum(+this)},DISP.ER.SN_isNaN=retFalse,DISP.ER.SN_isFinite=retTrue,DISP.ER.SN_isInfinite=retFalse,DISP.ER.SN_imagPart=retZero,DISP.ER.toFixed=function(fractionDigits){var f=void 0===fractionDigits?0:_parseInt(fractionDigits);if(f>SN.maxIntegerDigits)throw new RangeError("fractionDigits exceeds SchemeNumber.maxIntegerDigits: "+fractionDigits);var x=this,s="";x.SN_isNegative()&&(x=x.SN_negate(),s="-");var p=ONE.SN__exp10(-f),dm=x.SN_divAndMod(p),n=dm[0];if(dm[1].SN_add(dm[1]).SN_ge(p)&&(n=ONE.SN_add(n)),n.SN_isZero())return s+"0"+(fractionDigits>0?"."+zeroes(fractionDigits):"");if(n=n.SN_numberToString(),0===f)return s+n;var z=f-n.length;if(f>0){z>=0&&(n=zeroes(z+1)+n);var point=n.length-f;return s+n.substring(0,point)+"."+n.substring(point)}return s+n+zeroes(-f)},DISP.ER.toExponential=function(fractionDigits){var f=void 0===fractionDigits?20:_parseInt(fractionDigits);if(0>f)throw new RangeError("SchemeNumber toExponential: negative argument: "+f);if(f>SN.maxIntegerDigits)throw new RangeError("fractionDigits exceeds SchemeNumber.maxIntegerDigits: "+fractionDigits);var x=this,s="";if(x.SN_isNegative())x=x.SN_negate(),s="-";else if(x.SN_isZero())return"0"+(fractionDigits>0?"."+zeroes(f):"")+"e+0";var e=floor(x.SN_log()/LN10),p=ONE.SN__exp10(e-f),dm=x.SN_divAndMod(p),n=dm[0];if(dm[1].SN_add(dm[1]).SN_ge(p)&&(n=ONE.SN_add(n)),n=n.SN_numberToString(),n.length!=f+1&&(e+=n.length-(f+1),p=ONE.SN__exp10(e-f),dm=x.SN_divAndMod(p),n=dm[0],dm[1].SN_add(dm[1]).SN_ge(p)&&(n=ONE.SN_add(n)),n=n.SN_numberToString(),n.length!=f+1))throw new Error("Can not format as exponential: "+this.SN_numberToString());return void 0===fractionDigits&&(n=n.replace(/(\d)0+$/,"$1")),n.length>1&&(n=n[0]+"."+n.substring(1)),s+n+"e"+(0>e?"":"+")+e},DISP.ER.toPrecision=function(precision){var p,x;if(void 0===precision){if(x=this.SN_toInexact(),x.SN_isFinite())return(+x).toString();p=21}else{if(p=_parseInt(precision),1>p)throw new RangeError("SchemeNumber toPrecision: expected a positive precision, got: "+precision);if(p>SN.maxIntegerDigits)throw new RangeError("precision exceeds SchemeNumber.maxIntegerDigits: "+precision)}x=this;var s="";if(x.SN_isNegative())x=x.SN_negate(),s="-";else if(x.SN_isZero())return"0"+(p>1?"."+zeroes(p-1):"");var ret=x.toExponential(p-1),eIndex=ret.indexOf("e"),exponent=_parseInt(ret.substring(eIndex+1));return exponent>=-6&&p>exponent?0===exponent?ret=ret.substring(0,eIndex):(ret=ret.substring(0,1)+(-1===ret.indexOf(".")?"":ret.substring(2,eIndex)),0>exponent?ret="0."+zeroes(-1-exponent)+ret:p-1>exponent&&(ret=ret.substring(0,exponent+1)+"."+ret.substring(exponent+1))):void 0===precision&&(ret=ret.substring(0,eIndex).replace(/\.?0+/,"")+ret.substring(eIndex)),s+ret},DISP.EQ.SN_isRational=retTrue,DISP.EQ.SN_eq=function(z){return z.SN__eq_EQ(this)},DISP.EQ.SN__eq_EQ=pureVirtual,DISP.EQ.SN_ne=function(z){return z.SN__ne_EQ(this)},DISP.EQ.SN__ne_EQ=pureVirtual,DISP.EQ.SN_compare=function(x){return x.SN__compare_EQ(this)},DISP.EQ.SN__compare_EQ=pureVirtual,DISP.EQ.SN_add=function(z){return z.SN__add_EQ(this)},DISP.EQ.SN__add_EQ=pureVirtual,DISP.EQ.SN_subtract=function(z){return z.SN__subtract_EQ(this)},DISP.EQ.SN__subtract_EQ=pureVirtual,DISP.EQ.SN_multiply=function(z){return z.SN__multiply_EQ(this)},DISP.EQ.SN__multiply_EQ=pureVirtual,DISP.EQ.SN_divide=function(z){return z.SN__divide_EQ(this)},DISP.EQ.SN__divide_EQ=pureVirtual,DISP.EQ.SN_expt=function(z){return z.SN__expt_EQ(this)},EQFraction.prototype=new EQ,DISP.EQFraction.SN_numberToString=function(radix){return this._n.SN_numberToString(radix)+"/"+this._d.SN_numberToString(radix)},DISP.EQFraction.valueOf=function(){var n=this._n,d=this._d,ret=n/d;return _isNaN(ret)?n.SN_isNegative()?-exp(n.SN_negate().SN_log()-d.SN_log()):exp(n.SN_log()-d.SN_log()):ret},DISP.EQFraction.SN_debug=function(){return"EQFraction("+this._n.SN_debug()+" / "+this._d.SN_debug()+")"},DISP.EQFraction.SN_numerator=function(){return this._n},DISP.EQFraction.SN_denominator=function(){return this._d},DISP.EQFraction.SN_isPositive=function(){return this._n.SN_isPositive()},DISP.EQFraction.SN_isNegative=function(){return this._n.SN_isNegative()},DISP.EQFraction.SN__eq_EQ=function(q){return q.SN_numerator().SN_eq(this._n)&&q.SN_denominator().SN_eq(this._d)},DISP.EQFraction.SN__ne_EQ=function(q){return q.SN_numerator().SN_ne(this._n)||q.SN_denominator().SN_ne(this._d)},DISP.EQFraction.SN__compare_EQ=function(q){var qn=q.SN_numerator(),signDiff=q.SN_sign()-this._n.SN_sign();if(0!==signDiff)return signDiff>0?1:-1;var qd=q.SN_denominator();return qd===this._d?qn.SN_compare(this._n):qn.SN_multiply(this._d).SN_compare(qd.SN_multiply(this._n))},DISP.EQFraction.SN_negate=function(){return new EQFraction(this._n.SN_negate(),this._d)},DISP.EQFraction.SN_square=function(){return new EQFraction(this._n.SN_square(),this._d.SN_square())},DISP.EQFraction.SN_reciprocal=function(){switch(this._n.SN_sign()){case-1:return canonicalEQ(this._d.SN_negate(),this._n.SN_negate());case 1:return canonicalEQ(this._d,this._n);case 0:default:divisionByExactZero()}},DISP.EQFraction.SN_floor=function(){return this._n.SN_div(this._d)},DISP.EQFraction.SN_ceiling=function(){return this._n.SN_div(this._d).SN_add(ONE)},DISP.EQFraction.SN_round=function(){if(this._d.SN_eq(TWO)){var ret=this._n.SN_div(TWO);return ret.SN_isEven()?ret:ret.SN_add(ONE)}var dm=this._n.SN_divAndMod(this._d),mod=dm[1];return mod.SN_add(mod).SN_lt(this._d)?dm[0]:dm[0].SN_add(ONE)},DISP.EQFraction.SN_truncate=function(){return this._n.SN_isPositive()?this._n.SN_div(this._d):this._d.SN_isUnit()?this._n:this._n.SN_div(this._d).SN_add(ONE)},DISP.EQFraction.SN_sign=function(){return this._n.SN_sign()},DISP.EQFraction.SN_abs=function(){return this._n.SN_sign()>=0?this:this.SN_negate()},DISP.EQFraction.SN__add_EQ=function(q){var n1=q.SN_numerator(),d1=q.SN_denominator(),n2=this._n,d2=this._d;return reduceEQ(n1.SN_multiply(d2).SN_add(n2.SN_multiply(d1)),d1.SN_multiply(d2))},DISP.EQFraction.SN__subtract_EQ=function(q){var n1=q.SN_numerator(),d1=q.SN_denominator(),n2=this._n,d2=this._d;return reduceEQ(n1.SN_multiply(d2).SN_subtract(n2.SN_multiply(d1)),d1.SN_multiply(d2))},DISP.EQFraction.SN__multiply_EQ=function(q){return reduceEQ(q.SN_numerator().SN_multiply(this._n),q.SN_denominator().SN_multiply(this._d))},DISP.EQFraction.SN__divide_EQ=function(q){return reduceEQ(q.SN_numerator().SN_multiply(this._d),q.SN_denominator().SN_multiply(this._n))},DISP.EQFraction.SN__add_EI=function(n){return canonicalEQ(n.SN_multiply(this._d).SN_add(this._n),this._d)},DISP.EQFraction.SN__subtract_EI=function(n){return canonicalEQ(n.SN_multiply(this._d).SN_subtract(this._n),this._d)},DISP.EQFraction.SN__multiply_EI=function(n){return reduceEQ(n.SN_multiply(this._n),this._d)},DISP.EQFraction.SN__divide_EI=function(n){return reduceEQ(n.SN_multiply(this._d),this._n)},DISP.EQFraction.SN_sqrt=function(){return this._n.SN_sqrt().SN_divide(this._d.SN_sqrt())},DISP.EQFraction.SN_log=function(){return this._n.SN_log().SN_subtract(this._d.SN_log())},DISP.EI.SN_isInteger=retTrue,DISP.EI.SN_debug=function(){return"EI"},DISP.EI.SN_numerator=retThis,DISP.EI.SN_denominator=function(){return ONE},DISP.EI.SN_floor=retThis,DISP.EI.SN_ceiling=retThis,DISP.EI.SN_round=retThis,DISP.EI.SN_truncate=retThis,DISP.EI.SN__toBigInteger=pureVirtual,DISP.EI.SN_eq=function(z){return z.SN__eq_EI(this)},DISP.EI.SN__eq_EI=function(n){return 0===n.SN__toBigInteger().compare(this.SN__toBigInteger())},DISP.EI.SN__eq_EQ=function(q){return q.SN_numerator().SN_eq(this)&&q.SN_denominator().SN_eq(ONE)},DISP.EI.SN_ne=function(z){return z.SN__ne_EI(this)},DISP.EI.SN__ne_EI=function(n){return 0!==n.SN__toBigInteger().compare(this.SN__toBigInteger())},DISP.EI.SN__ne_EQ=function(q){return q.SN_numerator().SN_ne(this)||q.SN_denominator().SN_ne(ONE)},DISP.EI.SN_compare=function(x){return x.SN__compare_EI(this)},DISP.EI.SN__compare_EQ=function(q){return q.SN_numerator().SN_compare(q.SN_denominator().SN_multiply(this))},DISP.EI.SN__compare_EI=function(n){return n.SN__toBigInteger().compare(this.SN__toBigInteger())},DISP.EI.SN_add=function(z){return z.SN__add_EI(this)},DISP.EI.SN_subtract=function(z){return z.SN__subtract_EI(this)},DISP.EI.SN_multiply=function(z){return z.SN__multiply_EI(this)},DISP.EI.SN_reciprocal=function(){return this.SN_isNegative()?canonicalEQ(M_ONE,this.SN_negate()):canonicalEQ(ONE,this)},DISP.EI.SN_divAndMod=function(x){return x.SN__divAndMod_EI(this)},DISP.EI.SN_div=function(x){return x.SN__div_EI(this)},DISP.EI.SN_mod=function(x){return x.SN__mod_EI(this)},DISP.EI.SN__add_EI=function(n){return reduceBigInteger(n.SN__toBigInteger().add(this.SN__toBigInteger()))},DISP.EI.SN__subtract_EI=function(n){return reduceBigInteger(n.SN__toBigInteger().subtract(this.SN__toBigInteger()))},DISP.EI.SN__multiply_EI=function(n){return reduceBigInteger(n.SN__toBigInteger().multiply(this.SN__toBigInteger()))},DISP.EI.SN__divAndMod_EI=function(n){var t=this.SN__toBigInteger(),dm=n.SN__toBigInteger().divRem(t),div=dm[0],mod=dm[1];return mod.isNegative()&&(mod=mod.add(t),div=div.prev()),[reduceBigInteger(div),reduceBigInteger(mod)]},DISP.EI.SN__div_EI=function(n){return this.SN__divAndMod_EI(n)[0]},DISP.EI.SN__mod_EI=function(n){return this.SN__divAndMod_EI(n)[1]},DISP.EI.SN__add_EQ=function(q){var d=q.SN_denominator();return canonicalEQ(q.SN_numerator().SN_add(d.SN_multiply(this)),d)},DISP.EI.SN__subtract_EQ=function(q){var d=q.SN_denominator();return canonicalEQ(q.SN_numerator().SN_subtract(d.SN_multiply(this)),d)},DISP.EI.SN__multiply_EQ=function(q){return reduceEQ(q.SN_numerator().SN_multiply(this),q.SN_denominator())},DISP.EI.SN__divide_EQ=function(q){return reduceEQ(q.SN_numerator(),q.SN_denominator().SN_multiply(this))},DISP.EI.SN_expt=function(z){return z.SN__expt_EI(this)},DISP.EI.SN__expt_EI=function(n){var a,s=this.SN_sign(),p=this.SN_abs().valueOf(),result=pow(n,p);if(result>-9007199254740992&&9007199254740992>result)a=toEINative(result);else{var newLog=n.SN_log()*p;newLog>SN.maxIntegerDigits*LN10&&raise("&implementation-restriction","exact integer would exceed limit of "+ +SN.maxIntegerDigits+" digits; adjust SchemeNumber.maxIntegerDigits",newLog/LN10),a=new EIBig(n.SN__toBigInteger().pow(p))}return s>0?a:a.SN_reciprocal()},DISP.EI.SN__expt_ER=function(x){return expt_E_EI(x,this)},DISP.EI.SN__expt_C=function(z){return z.SN_isExact()?expt_E_EI(z,this):complexExpt(z,this)},EINative.prototype=new EI;var ZERO=SN.ZERO=new EINative(0),ONE=SN.ONE=new EINative(1),M_ONE=SN.M_ONE=new EINative(-1),TWO=SN.TWO=new EINative(2),EINativeSmall=[ZERO,ONE,TWO],I=SN.I=new Rectangular(ZERO,ONE),M_I=SN.M_I=new Rectangular(ZERO,M_ONE);ZERO.SN_isZero=retTrue,ZERO.SN_isPositive=retFalse,ZERO.SN_isNegative=retFalse,ZERO.SN_compare=function(x){return-x.SN_sign()},ZERO.SN_add=SN,ZERO.SN_negate=retThis,ZERO.SN_abs=retThis,ZERO.SN_multiply=retThis,ZERO.SN_square=retThis,ZERO.SN_reciprocal=divisionByExactZero,ZERO.SN_subtract=function(z){return z.SN_negate()},ZERO.SN_divide=function(z){return z.SN_isZero()&&z.SN_isExact()&&divisionByExactZero(),this},ZERO.SN_expt=function(z){switch(z.SN_realPart().SN_sign()){case 1:return this;case 0:return ONE;case-1:default:divisionByExactZero()}},ZERO.SN_sqrt=retThis,ZERO.SN_exp=retOne,ZERO.SN_sin=retThis,ZERO.SN_cos=retOne,ZERO.SN_tan=retThis,ZERO.SN_asin=retThis,ZERO.SN_atan=retThis,ONE.SN_isUnit=retTrue,ONE.SN_abs=retThis,ONE.SN_multiply=SN,ONE.SN_reciprocal=retThis,ONE.SN_square=retThis,ONE.SN_expt=ZERO.SN_multiply,ONE.SN_sqrt=retThis,ONE.SN_log=retZero,ONE.SN_acos=retZero,M_ONE.SN_isUnit=retTrue,M_ONE.SN_abs=retOne,M_ONE.SN_multiply=ZERO.SN_subtract,M_ONE.SN_reciprocal=retThis,M_ONE.SN_square=retOne,M_ONE.SN_sqrt=function(){return I},M_ONE.SN_expt=function(z){if(!z.SN_isInteger())return complexExpt(this,z);var ret=z.SN_isEven()?ONE:M_ONE;return z.SN_isExact()?ret:ret.SN_toInexact()};for(className in CLASSES)ZERO["SN__add_"+className]=retFirst,ZERO["SN__subtract_"+className]=retFirst,ZERO["SN__multiply_"+className]=retThis,ZERO["SN__divide_"+className]=divisionByExactZero,ZERO["SN__expt_"+className]=retOne,ONE["SN__multiply_"+className]=retFirst,ONE["SN__divide_"+className]=retFirst,ONE["SN__expt_"+className]=retFirst,M_ONE["SN__multiply_"+className]=negate,M_ONE["SN__divide_"+className]=negate,M_ONE["SN__expt_"+className]=reciprocal;DISP.EINative.valueOf=function(){return this._},DISP.EINative.SN_numberToString=function(radix){return this._.toString(radix||10)},DISP.EINative.SN_debug=function(){return"EINative("+this._+")"},DISP.EINative.SN__toBigInteger=function(){return BigInteger(this._)},DISP.EINative.SN_isPositive=function(){return this._>0},DISP.EINative.SN_isNegative=function(){return this._<0},DISP.EINative.SN_sign=function(){return this._>0?1:0==this._?0:-1},DISP.EINative.SN_isEven=function(){return 0===(1&this._)},DISP.EINative.SN_isOdd=function(){return 1===(1&this._)
},DISP.EINative.SN_eq=function(z){return z.SN__eq_EINative(this)},DISP.EINative.SN__eq_EINative=function(n){return n._===this._},DISP.EINative.SN_ne=function(z){return z.SN__ne_EINative(this)},DISP.EINative.SN__ne_EINative=function(n){return n._!==this._},DISP.EINative.SN_compare=function(x){return x.SN__compare_EINative(this)},DISP.EINative.SN__compare_EINative=function(n){return n._===this._?0:n._>this._?1:-1},DISP.EINative.SN_add=function(z){return z.SN__add_EINative(this)},DISP.EINative.SN__add_EINative=function(n){return add_EINative_EINative(n._,this._)},DISP.EINative.SN_negate=function(){return toEINative(-this._)},DISP.EINative.SN_abs=function(){return this._<0?toEINative(-this._):this},DISP.EINative.SN_subtract=function(z){return z.SN__subtract_EINative(this)},DISP.EINative.SN__subtract_EINative=function(n){return add_EINative_EINative(n._,-this._)},DISP.EINative.SN_multiply=function(z){return z.SN__multiply_EINative(this)},DISP.EINative.SN__multiply_EINative=function(n){var ret=n._*this._;return ret>-9007199254740992&&9007199254740992>ret?toEINative(ret):new EIBig(BigInteger(n._).multiply(this._))},DISP.EINative.SN_square=function(){var ret=this._*this._;return 9007199254740992>ret?toEINative(ret):new EIBig(BigInteger(this._).square())},DISP.EINative.SN_reciprocal=function(){var x=this._;return assert(0!==x),0>x?canonicalEQ(M_ONE,toEINative(-x)):canonicalEQ(ONE,this)},DISP.EINative.SN_div=function(x){return x.SN__div_EINative(this)},DISP.EINative.SN__div_EINative=function(n){return divAndMod_EINative(n._,this._,0)},DISP.EINative.SN_mod=function(x){return x.SN__mod_EINative(this)},DISP.EINative.SN__mod_EINative=function(n){return divAndMod_EINative(n._,this._,1)},DISP.EINative.SN_divAndMod=function(x){return x.SN__divAndMod_EINative(this)},DISP.EINative.SN__divAndMod_EINative=function(n){return divAndMod_EINative(n._,this._,2)},DISP.EINative.SN__exp10=function(n){if(0===this._||0===n)return this;if(0>n){var num=String(this._),i=num.length-1;if("0"===num[i]){for(;"0"===num[i]&&0>n;)n+=1,i-=1;if(num=toEINative(Number(num.substring(0,i+1))),0===n)return num}else num=this;var den;return den=-15>n?new EIBig(BigInteger.ONE.exp10(-n)):toEINative(Number("1000000000000000".substring(0,1-n))),reduceEQ(num,den)}if(16>n){var result=_parseInt("1000000000000000".substring(0,n+1))*this._;if(result>-9007199254740992&&9007199254740992>result)return toEINative(result)}return new EIBig(BigInteger(this._).exp10(n))},DISP.EINative.SN_exactIntegerSqrt=function(){var n=floor(sqrt(assertNonNegative(this)._));return[toEINative(n),toEINative(this._-n*n)]};var FIRST_BIG_INTEGER=BigInteger(9007199254740992);EIBig.prototype=new EI,DISP.EIBig.SN_numberToString=function(radix){return this._.toString(radix)},DISP.EIBig.valueOf=function(){return this._.valueOf()},["isZero","isEven","isOdd","sign","isUnit","isPositive","isNegative"].forEach(function(fn){DISP.EIBig["SN_"+fn]=function(){return this._[fn]()}}),DISP.EIBig.SN_log=function(){var x=toFlonum(this._.abs().log());return this._.isPositive()?x:inexactRectangular(x,PI)},DISP.EIBig.SN_debug=function(){return"EIBig("+this._.toString()+")"},DISP.EIBig.SN__toBigInteger=function(){return this._},DISP.EIBig.SN_add=function(z){return z.SN__add_EIBig(this)},DISP.EIBig.SN_negate=function(){return new EIBig(this._.negate())},DISP.EIBig.SN_abs=function(){return new EIBig(this._.abs())},DISP.EIBig.SN_subtract=function(z){return z.SN__subtract_EIBig(this)},DISP.EIBig.SN_multiply=function(z){return z.SN__multiply_EIBig(this)},DISP.EIBig.SN_square=function(){return new EIBig(this._.square())},DISP.EIBig.SN__exp10=function(n){return 0===n?this:n>0?new EIBig(this._.exp10(n)):reduceEQ(this,ONE.SN__exp10(-n))},DISP.EIBig.SN_sqrt=function(){var mag=toFlonum(exp(this._.abs().log()/2));return this._.isNegative()?inexactRectangular(INEXACT_ZERO,mag):mag},DISP.EIBig.SN_exactIntegerSqrt=function(){function doit(n,a){for(;;){var dm=n.divRem(a),b=dm[0],diff=a.subtract(b);if(diff.isZero())return[b,dm[1]];if(diff.isUnit())return diff.isPositive()?[b,b.add(dm[1])]:[a,a.add(dm[1])];a=b.add(diff.quotient(2))}}var l=assertNonNegative(this)._.log()/2/LN10,a=BigInteger(pow(10,l-floor(l)).toString()+"e"+floor(l));return doit(this._,a).map(reduceBigInteger)};for(var className in CLASSES)resolveOverload(className);if(Flonum===Number){for(var methodName in DISP.R)/^SN_/.test(methodName)&&!DISP.Flonum[methodName]&&(DISP.Flonum[methodName]=DISP.R[methodName]);for(var methodName in DISP.C)/^SN_/.test(methodName)&&!DISP.Flonum[methodName]&&(DISP.Flonum[methodName]=DISP.C[methodName]);for(var methodName in DISP.Flonum)DISP.C[methodName]||(DISP.C[methodName]=unimpl)}for(var className in CLASSES)for(var methodName in DISP[className])CLASSES[className].prototype[methodName]=DISP[className][methodName];return checkPureVirtual(this.alert||this.print||function(e){throw e}),SN}();if("undefined"!=typeof exports){exports.SchemeNumber=SchemeNumber;for(var name in SchemeNumber.fn)exports[name]=SchemeNumber.fn[name]}xpathmodels={},xpathmodels.DEBUG_MODE=!1,debuglog=function(){xpathmodels.DEBUG_MODE&&console.log(arguments)},function(){var xpm=xpathmodels,objToXPath=(xpm.validateAxisName=function(name){for(var i in xpm.XPathAxisEnum)if(xpm.XPathAxisEnum.hasOwnProperty(i)&&xpm.XPathAxisEnum[i]===name)return xpm.XPathAxisEnum[i];throw name+" is not a valid axis name!"},function(something){return something.toXPath()});xpm.XPathNumericLiteral=function(value){return this.value=SchemeNumber(value),this.toString=function(){return"{num:"+this.value.toString()+"}"},this.toXPath=function(){var toFixed=function(x){var e;return 1>x?(e=parseInt(x.toString().split("e-")[1]),e&&(x*=Math.pow(10,e-1),x="0."+new Array(e).join("0")+x.toString().substring(2))):(e=parseInt(x.toString().split("+")[1]),e>20&&(e-=20,x/=Math.pow(10,e),x+=new Array(e+1).join("0"))),x};return toFixed(this.value.toString())},this.getChildren=function(){return[]},this},xpm.XPathStringLiteral=function(value){this.value=value;var toXPathString=function(value){return-1!==value.indexOf("'")?'"'+value+'"':"'"+value+"'"};return this.valueDisplay=toXPathString(value),this.toString=function(){return"{str:"+this.valueDisplay+"}"},this.toXPath=function(){return this.valueDisplay},this.getChildren=function(){return[]},this},xpm.XPathVariableReference=function(value){this.value=value,this.toString=function(){return"{var:"+String(this.value)+"}"},this.toXPath=function(){return"$"+String(this.value)},this.getChildren=function(){return[]}},xpm.XPathAxisEnum={CHILD:"child",DESCENDANT:"descendant",PARENT:"parent",ANCESTOR:"ancestor",FOLLOWING_SIBLING:"following-sibling",PRECEDING_SIBLING:"preceding-sibling",FOLLOWING:"following",PRECEDING:"preceding",ATTRIBUTE:"attribute",NAMESPACE:"namespace",SELF:"self",DESCENDANT_OR_SELF:"descendant-or-self",ANCESTOR_OR_SELF:"ancestor-or-self"},xpm.XPathTestEnum={NAME:"name",NAME_WILDCARD:"*",NAMESPACE_WILDCARD:":*",TYPE_NODE:"node()",TYPE_TEXT:"text()",TYPE_COMMENT:"comment()",TYPE_PROCESSING_INSTRUCTION:"processing-instruction"},xpm.XPathStep=function(definition){return this.axis=definition.axis,this.test=definition.test,this.predicates=definition.predicates||[],this.name=definition.name,this.namespace=definition.namespace,this.literal=definition.literal,this.testString=function(){switch(this.test){case xpm.XPathTestEnum.NAME:return String(this.name);case xpm.XPathTestEnum.TYPE_PROCESSING_INSTRUCTION:return"processing-instruction("+(this.literal?"'"+this.literal+"'":"")+")";case xpm.XPathTestEnum.NAMESPACE_WILDCARD:return this.namespace+":*";default:return this.test||null}},this.toString=function(){var stringArray=[];return stringArray.push("{step:"),stringArray.push(String(this.axis)),stringArray.push(","),stringArray.push(this.testString()),this.predicates.length>0&&(stringArray.push(",{"),stringArray.push(this.predicates.join(",")),stringArray.push("}")),stringArray.push("}"),stringArray.join("")},this.mainXPath=function(){var axisPrefix=this.axis+"::";switch(this.axis){case xpm.XPathAxisEnum.DESCENDANT_OR_SELF:if(this.test===xpm.XPathTestEnum.TYPE_NODE)return"//";break;case xpm.XPathAxisEnum.CHILD:axisPrefix="";break;case xpm.XPathAxisEnum.ATTRIBUTE:axisPrefix="@";break;case xpm.XPathAxisEnum.SELF:if(this.test===xpm.XPathTestEnum.TYPE_NODE)return".";break;case xpm.XPathAxisEnum.PARENT:if(this.test===xpm.XPathTestEnum.TYPE_NODE)return".."}return axisPrefix+this.testString()},this.predicateXPath=function(){return this.predicates.length>0?"["+this.predicates.map(objToXPath).join("][")+"]":""},this.toXPath=function(){return this.mainXPath()+this.predicateXPath()},this.getChildren=function(){return[]},this},xpm.XPathInitialContextEnum={ROOT:"abs",RELATIVE:"rel",EXPR:"expr"},xpm.XPathPathExpr=function(definition){var self=this;this.initial_context=definition.initial_context,this.steps=definition.steps||[],this.filter=definition.filter,this.toString=function(){var stringArray=[];return stringArray.push("{path-expr:"),stringArray.push(this.initial_context===xpm.XPathInitialContextEnum.EXPR?String(this.filter):this.initial_context),stringArray.push(",{"),stringArray.push(this.steps.join(",")),stringArray.push("}}"),stringArray.join("")};var _combine=function(func){var curPart,prevPart,sep,parts=self.steps.map(func),ret=[],root=self.initial_context===xpm.XPathInitialContextEnum.ROOT?"/":"";if(0===parts.length)return root;for(var i=0;i<parts.length;i++)curPart=parts[i],"//"!==curPart&&"//"!==prevPart&&(sep=0===i?root:"/",ret.push(sep)),ret.push(curPart),prevPart=curPart;return ret.join("")};return this.toXPath=function(){return _combine(objToXPath)},this.pathWithoutPredicates=function(){return _combine(function(step){return step.mainXPath()})},this.getChildren=function(){return this.steps},this},xpm.XPathFuncExpr=function(definition){return this.id=definition.id,this.args=definition.args||[],this.toString=function(){var stringArray=[];return stringArray.push("{func-expr:",String(this.id),",{"),stringArray.push(this.args.join(",")),stringArray.push("}}"),stringArray.join("")},this.toXPath=function(){return this.id+"("+this.args.map(objToXPath).join(", ")+")"},this.getChildren=function(){return this.args},this},xpm.XPathExpressionTypeEnum={AND:"and",OR:"or",EQ:"==",NEQ:"!=",LT:"<",LTE:"<=",GT:">",GTE:">=",PLUS:"+",MINUS:"-",MULT:"*",DIV:"/",MOD:"%",UMINUS:"num-neg",UNION:"union"};var expressionTypeEnumToXPathLiteral=xpm.expressionTypeEnumToXPathLiteral=function(val){switch(val){case xpm.XPathExpressionTypeEnum.EQ:return"=";case xpm.XPathExpressionTypeEnum.MOD:return"mod";case xpm.XPathExpressionTypeEnum.DIV:return"div";case xpm.XPathExpressionTypeEnum.UMINUS:return"-";case xpm.XPathExpressionTypeEnum.UNION:return"|";default:return val}},binOpToString=function(){return"{binop-expr:"+this.type+","+String(this.left)+","+String(this.right)+"}"},getOrdering=function(type){switch(type){case xpm.XPathExpressionTypeEnum.OR:case xpm.XPathExpressionTypeEnum.AND:return"right";case xpm.XPathExpressionTypeEnum.EQ:case xpm.XPathExpressionTypeEnum.NEQ:case xpm.XPathExpressionTypeEnum.LT:case xpm.XPathExpressionTypeEnum.LTE:case xpm.XPathExpressionTypeEnum.GT:case xpm.XPathExpressionTypeEnum.GTE:case xpm.XPathExpressionTypeEnum.PLUS:case xpm.XPathExpressionTypeEnum.MINUS:case xpm.XPathExpressionTypeEnum.MULT:case xpm.XPathExpressionTypeEnum.DIV:case xpm.XPathExpressionTypeEnum.MOD:case xpm.XPathExpressionTypeEnum.UNION:return"left";case xpm.XPathExpressionTypeEnum.UMINUS:return"nonassoc";default:throw"No order for "+type}},getPrecedence=function(type){switch(type){case xpm.XPathExpressionTypeEnum.OR:return 0;case xpm.XPathExpressionTypeEnum.AND:return 1;case xpm.XPathExpressionTypeEnum.EQ:case xpm.XPathExpressionTypeEnum.NEQ:return 2;case xpm.XPathExpressionTypeEnum.LT:case xpm.XPathExpressionTypeEnum.LTE:case xpm.XPathExpressionTypeEnum.GT:case xpm.XPathExpressionTypeEnum.GTE:return 3;case xpm.XPathExpressionTypeEnum.PLUS:case xpm.XPathExpressionTypeEnum.MINUS:return 4;case xpm.XPathExpressionTypeEnum.MULT:case xpm.XPathExpressionTypeEnum.DIV:case xpm.XPathExpressionTypeEnum.MOD:return 5;case xpm.XPathExpressionTypeEnum.UMINUS:return 6;case xpm.XPathExpressionTypeEnum.UNION:return 7;default:throw"No precedence for "+type}},isOp=xpm.isOp=function(someToken){var str=someToken.toString();return 0===str.indexOf("{binop-expr:")||0===str.indexOf("{unop-expr:")},isLiteral=xpm.isLiteral=function(someToken){return someToken instanceof xpm.XPathNumericLiteral||someToken instanceof xpm.XPathStringLiteral||someToken instanceof xpm.XPathPathExpr},binOpToXPath=(xpm.isSimpleOp=function(someToken){return isOp(someToken)&&isLiteral(someToken.left)&&isLiteral(someToken.right)},function(){var lprec,rprec,lString,rString,prec=getPrecedence(this.type),lneedsParens=!1,rneedsParens=!1;return isOp(this.left)&&(lprec=getPrecedence(this.left.type),lneedsParens=lprec>prec?!1:lprec!==prec?!0:"right"===getOrdering(this.type)),isOp(this.right)&&(rprec=getPrecedence(this.right.type),rneedsParens=rprec>prec?!1:rprec!==prec?!0:"left"===getOrdering(this.type)),lString=lneedsParens?"("+this.left.toXPath()+")":this.left.toXPath(),rString=rneedsParens?"("+this.right.toXPath()+")":this.right.toXPath(),lString+" "+expressionTypeEnumToXPathLiteral(this.type)+" "+rString}),binOpChildren=function(){return[this.left,this.right]};xpm.XPathBoolExpr=function(definition){return this.type=definition.type,this.left=definition.left,this.right=definition.right,this.toString=binOpToString,this.toXPath=binOpToXPath,this.getChildren=binOpChildren,this},xpm.XPathEqExpr=function(definition){return this.type=definition.type,this.left=definition.left,this.right=definition.right,this.toString=binOpToString,this.toXPath=binOpToXPath,this.getChildren=binOpChildren,this},xpm.XPathCmpExpr=function(definition){return this.type=definition.type,this.left=definition.left,this.right=definition.right,this.toString=binOpToString,this.toXPath=binOpToXPath,this.getChildren=binOpChildren,this},xpm.XPathArithExpr=function(definition){return this.type=definition.type,this.left=definition.left,this.right=definition.right,this.toString=binOpToString,this.toXPath=binOpToXPath,this.getChildren=binOpChildren,this},xpm.XPathUnionExpr=function(definition){return this.type=definition.type,this.left=definition.left,this.right=definition.right,this.toString=binOpToString,this.toXPath=binOpToXPath,this.getChildren=binOpChildren,this},xpm.XPathNumNegExpr=function(definition){return this.type=definition.type,this.value=definition.value,this.toString=function(){return"{unop-expr:"+this.type+","+String(this.value)+"}"},this.toXPath=function(){return"-"+this.value.toXPath()},this.getChildren=function(){return[this.value]},this}}();var xpath=function(){var parser={trace:function(){},yy:{},symbols_:{error:2,xpath_expr:3,expr:4,EOF:5,base_expr:6,op_expr:7,path_expr:8,LPAREN:9,RPAREN:10,func_call:11,VAR:12,literal:13,OR:14,AND:15,EQ:16,NEQ:17,LT:18,LTE:19,GT:20,GTE:21,PLUS:22,MINUS:23,MULT:24,DIV:25,MOD:26,UNION:27,QNAME:28,arg_list:29,COMMA:30,loc_path:31,predicate:32,LBRACK:33,RBRACK:34,rel_loc_path:35,SLASH:36,DBL_SLASH:37,step:38,step_unabbr:39,DOT:40,DBL_DOT:41,step_body:42,node_test:43,axis_specifier:44,DBL_COLON:45,AT:46,WILDCARD:47,NSWILDCARD:48,NODETYPE_NODE:49,NODETYPE_TEXT:50,NODETYPE_COMMENT:51,NODETYPE_PROCINSTR:52,STR:53,NUM:54,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",9:"LPAREN",10:"RPAREN",12:"VAR",14:"OR",15:"AND",16:"EQ",17:"NEQ",18:"LT",19:"LTE",20:"GT",21:"GTE",22:"PLUS",23:"MINUS",24:"MULT",25:"DIV",26:"MOD",27:"UNION",28:"QNAME",30:"COMMA",33:"LBRACK",34:"RBRACK",36:"SLASH",37:"DBL_SLASH",40:"DOT",41:"DBL_DOT",45:"DBL_COLON",46:"AT",47:"WILDCARD",48:"NSWILDCARD",49:"NODETYPE_NODE",50:"NODETYPE_TEXT",51:"NODETYPE_COMMENT",52:"NODETYPE_PROCINSTR",53:"STR",54:"NUM"},productions_:[0,[3,2],[4,1],[4,1],[4,1],[6,3],[6,1],[6,1],[6,1],[7,3],[7,3],[7,3],[7,3],[7,3],[7,3],[7,3],[7,3],[7,3],[7,3],[7,3],[7,3],[7,3],[7,2],[7,3],[11,4],[11,3],[29,3],[29,1],[8,1],[32,3],[31,1],[31,2],[31,2],[31,1],[35,1],[35,3],[35,3],[38,1],[38,1],[38,1],[39,2],[39,1],[42,1],[42,2],[44,2],[44,1],[43,1],[43,1],[43,1],[43,3],[43,3],[43,3],[43,3],[43,4],[13,1],[13,1]],performAction:function(yytext,yyleng,yylineno,yy,yystate,$$){var $0=$$.length-1;switch(yystate){case 1:return $$[$0-1];case 2:this.$=$$[$0];break;case 3:this.$=$$[$0];break;case 4:this.$=$$[$0];break;case 5:this.$=$$[$0-1];break;case 7:this.$=new xpathmodels.XPathVariableReference($$[$0]);break;case 9:this.$=new xpathmodels.XPathBoolExpr({type:"or",left:$$[$0-2],right:$$[$0]});break;case 10:this.$=new xpathmodels.XPathBoolExpr({type:"and",left:$$[$0-2],right:$$[$0]});break;case 11:this.$=new xpathmodels.XPathEqExpr({type:"==",left:$$[$0-2],right:$$[$0]});break;case 12:this.$=new xpathmodels.XPathEqExpr({type:"!=",left:$$[$0-2],right:$$[$0]});break;case 13:this.$=new xpathmodels.XPathCmpExpr({type:"<",left:$$[$0-2],right:$$[$0]});break;case 14:this.$=new xpathmodels.XPathCmpExpr({type:"<=",left:$$[$0-2],right:$$[$0]});break;case 15:this.$=new xpathmodels.XPathCmpExpr({type:">",left:$$[$0-2],right:$$[$0]});break;case 16:this.$=new xpathmodels.XPathCmpExpr({type:">=",left:$$[$0-2],right:$$[$0]});break;case 17:this.$=new xpathmodels.XPathArithExpr({type:"+",left:$$[$0-2],right:$$[$0]});break;case 18:this.$=new xpathmodels.XPathArithExpr({type:"-",left:$$[$0-2],right:$$[$0]});break;case 19:this.$=new xpathmodels.XPathArithExpr({type:"*",left:$$[$0-2],right:$$[$0]});break;case 20:this.$=new xpathmodels.XPathArithExpr({type:"/",left:$$[$0-2],right:$$[$0]});break;case 21:this.$=new xpathmodels.XPathArithExpr({type:"%",left:$$[$0-2],right:$$[$0]});break;case 22:this.$=new xpathmodels.XPathNumNegExpr({type:"num-neg",value:$$[$0]});break;case 23:this.$=new xpathmodels.XPathUnionExpr({type:"union",left:$$[$0-2],right:$$[$0]});break;case 24:this.$=new xpathmodels.XPathFuncExpr({id:$$[$0-3],args:$$[$0-1]});break;case 25:this.$=new xpathmodels.XPathFuncExpr({id:$$[$0-2],args:[]});break;case 26:var args=$$[$0-2];args.push($$[$0]),this.$=args;break;case 27:this.$=[$$[$0]];break;case 29:this.$=$$[$0-1];break;case 30:this.$=new xpathmodels.XPathPathExpr({initial_context:xpathmodels.XPathInitialContextEnum.RELATIVE,steps:$$[$0]});break;case 31:this.$=new xpathmodels.XPathPathExpr({initial_context:xpathmodels.XPathInitialContextEnum.ROOT,steps:$$[$0]});break;case 32:var steps=$$[$0];steps.splice(0,0,new xpathmodels.XPathStep({axis:xpathmodels.XPathAxisEnum.DESCENDANT_OR_SELF,test:xpathmodels.XPathTestEnum.TYPE_NODE})),this.$=new xpathmodels.XPathPathExpr({initial_context:xpathmodels.XPathInitialContextEnum.ROOT,steps:steps});break;case 33:this.$=new xpathmodels.XPathPathExpr({initial_context:xpathmodels.XPathInitialContextEnum.ROOT,steps:[]});break;case 34:this.$=[$$[$0]];break;case 35:var path=$$[$0-2];path.push($$[$0]),this.$=path;break;case 36:var path=$$[$0-2];path.push(new xpathmodels.XPathStep({axis:xpathmodels.XPathAxisEnum.DESCENDANT_OR_SELF,test:xpathmodels.XPathTestEnum.TYPE_NODE})),path.push($$[$0]),this.$=path;break;case 37:this.$=$$[$0];break;case 38:this.$=new xpathmodels.XPathStep({axis:xpathmodels.XPathAxisEnum.SELF,test:xpathmodels.XPathTestEnum.TYPE_NODE});break;case 39:this.$=new xpathmodels.XPathStep({axis:xpathmodels.XPathAxisEnum.PARENT,test:xpathmodels.XPathTestEnum.TYPE_NODE});break;case 40:var step=$$[$0-1];step.predicates.push($$[$0]),this.$=step;break;case 41:this.$=$$[$0];break;case 42:var nodeTest=$$[$0];nodeTest.axis=xpathmodels.XPathAxisEnum.CHILD,this.$=new xpathmodels.XPathStep(nodeTest);break;case 43:var nodeTest=$$[$0];nodeTest.axis=$$[$0-1],this.$=new xpathmodels.XPathStep(nodeTest);break;case 44:this.$=xpathmodels.validateAxisName($$[$0-1]);break;case 45:this.$=xpathmodels.XPathAxisEnum.ATTRIBUTE;break;case 46:this.$={test:xpathmodels.XPathTestEnum.NAME,name:$$[$0]};break;case 47:this.$={test:xpathmodels.XPathTestEnum.NAME_WILDCARD};break;case 48:this.$={test:xpathmodels.XPathTestEnum.NAMESPACE_WILDCARD,namespace:$$[$0]};break;case 49:this.$={test:xpathmodels.XPathTestEnum.TYPE_NODE};break;case 50:this.$={test:xpathmodels.XPathTestEnum.TYPE_TEXT};break;case 51:this.$={test:xpathmodels.XPathTestEnum.TYPE_COMMENT};break;case 52:this.$={test:xpathmodels.XPathTestEnum.TYPE_PROCESSING_INSTRUCTION,literal:null};break;case 53:this.$={test:xpathmodels.XPathTestEnum.TYPE_PROCESSING_INSTRUCTION,literal:$$[$0-1]};break;case 54:this.$=new xpathmodels.XPathStringLiteral($$[$0]);break;case 55:this.$=new xpathmodels.XPathNumericLiteral($$[$0])}},table:[{3:1,4:2,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{1:[3]},{5:[1,32],14:[1,33],15:[1,34],16:[1,35],17:[1,36],18:[1,37],19:[1,38],20:[1,39],21:[1,40],22:[1,41],23:[1,42],24:[1,43],25:[1,44],26:[1,45],27:[1,46]},{5:[2,2],10:[2,2],14:[2,2],15:[2,2],16:[2,2],17:[2,2],18:[2,2],19:[2,2],20:[2,2],21:[2,2],22:[2,2],23:[2,2],24:[2,2],25:[2,2],26:[2,2],27:[2,2],30:[2,2],34:[2,2]},{5:[2,3],10:[2,3],14:[2,3],15:[2,3],16:[2,3],17:[2,3],18:[2,3],19:[2,3],20:[2,3],21:[2,3],22:[2,3],23:[2,3],24:[2,3],25:[2,3],26:[2,3],27:[2,3],30:[2,3],34:[2,3]},{5:[2,4],10:[2,4],14:[2,4],15:[2,4],16:[2,4],17:[2,4],18:[2,4],19:[2,4],20:[2,4],21:[2,4],22:[2,4],23:[2,4],24:[2,4],25:[2,4],26:[2,4],27:[2,4],30:[2,4],34:[2,4]},{4:47,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{5:[2,6],10:[2,6],14:[2,6],15:[2,6],16:[2,6],17:[2,6],18:[2,6],19:[2,6],20:[2,6],21:[2,6],22:[2,6],23:[2,6],24:[2,6],25:[2,6],26:[2,6],27:[2,6],30:[2,6],34:[2,6]},{5:[2,7],10:[2,7],14:[2,7],15:[2,7],16:[2,7],17:[2,7],18:[2,7],19:[2,7],20:[2,7],21:[2,7],22:[2,7],23:[2,7],24:[2,7],25:[2,7],26:[2,7],27:[2,7],30:[2,7],34:[2,7]},{5:[2,8],10:[2,8],14:[2,8],15:[2,8],16:[2,8],17:[2,8],18:[2,8],19:[2,8],20:[2,8],21:[2,8],22:[2,8],23:[2,8],24:[2,8],25:[2,8],26:[2,8],27:[2,8],30:[2,8],34:[2,8]},{4:48,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{5:[2,28],10:[2,28],14:[2,28],15:[2,28],16:[2,28],17:[2,28],18:[2,28],19:[2,28],20:[2,28],21:[2,28],22:[2,28],23:[2,28],24:[2,28],25:[2,28],26:[2,28],27:[2,28],30:[2,28],34:[2,28]},{5:[2,46],9:[1,49],10:[2,46],14:[2,46],15:[2,46],16:[2,46],17:[2,46],18:[2,46],19:[2,46],20:[2,46],21:[2,46],22:[2,46],23:[2,46],24:[2,46],25:[2,46],26:[2,46],27:[2,46],30:[2,46],33:[2,46],34:[2,46],36:[2,46],37:[2,46],45:[1,50]},{5:[2,54],10:[2,54],14:[2,54],15:[2,54],16:[2,54],17:[2,54],18:[2,54],19:[2,54],20:[2,54],21:[2,54],22:[2,54],23:[2,54],24:[2,54],25:[2,54],26:[2,54],27:[2,54],30:[2,54],34:[2,54]},{5:[2,55],10:[2,55],14:[2,55],15:[2,55],16:[2,55],17:[2,55],18:[2,55],19:[2,55],20:[2,55],21:[2,55],22:[2,55],23:[2,55],24:[2,55],25:[2,55],26:[2,55],27:[2,55],30:[2,55],34:[2,55]},{5:[2,30],10:[2,30],14:[2,30],15:[2,30],16:[2,30],17:[2,30],18:[2,30],19:[2,30],20:[2,30],21:[2,30],22:[2,30],23:[2,30],24:[2,30],25:[2,30],26:[2,30],27:[2,30],30:[2,30],34:[2,30],36:[1,51],37:[1,52]},{5:[2,33],10:[2,33],14:[2,33],15:[2,33],16:[2,33],17:[2,33],18:[2,33],19:[2,33],20:[2,33],21:[2,33],22:[2,33],23:[2,33],24:[2,33],25:[2,33],26:[2,33],27:[2,33],28:[1,54],30:[2,33],34:[2,33],35:53,38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30]},{28:[1,54],35:55,38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30]},{5:[2,34],10:[2,34],14:[2,34],15:[2,34],16:[2,34],17:[2,34],18:[2,34],19:[2,34],20:[2,34],21:[2,34],22:[2,34],23:[2,34],24:[2,34],25:[2,34],26:[2,34],27:[2,34],30:[2,34],34:[2,34],36:[2,34],37:[2,34]},{5:[2,37],10:[2,37],14:[2,37],15:[2,37],16:[2,37],17:[2,37],18:[2,37],19:[2,37],20:[2,37],21:[2,37],22:[2,37],23:[2,37],24:[2,37],25:[2,37],26:[2,37],27:[2,37],30:[2,37],32:56,33:[1,57],34:[2,37],36:[2,37],37:[2,37]},{5:[2,38],10:[2,38],14:[2,38],15:[2,38],16:[2,38],17:[2,38],18:[2,38],19:[2,38],20:[2,38],21:[2,38],22:[2,38],23:[2,38],24:[2,38],25:[2,38],26:[2,38],27:[2,38],30:[2,38],34:[2,38],36:[2,38],37:[2,38]},{5:[2,39],10:[2,39],14:[2,39],15:[2,39],16:[2,39],17:[2,39],18:[2,39],19:[2,39],20:[2,39],21:[2,39],22:[2,39],23:[2,39],24:[2,39],25:[2,39],26:[2,39],27:[2,39],30:[2,39],34:[2,39],36:[2,39],37:[2,39]},{5:[2,41],10:[2,41],14:[2,41],15:[2,41],16:[2,41],17:[2,41],18:[2,41],19:[2,41],20:[2,41],21:[2,41],22:[2,41],23:[2,41],24:[2,41],25:[2,41],26:[2,41],27:[2,41],30:[2,41],33:[2,41],34:[2,41],36:[2,41],37:[2,41]},{5:[2,42],10:[2,42],14:[2,42],15:[2,42],16:[2,42],17:[2,42],18:[2,42],19:[2,42],20:[2,42],21:[2,42],22:[2,42],23:[2,42],24:[2,42],25:[2,42],26:[2,42],27:[2,42],30:[2,42],33:[2,42],34:[2,42],36:[2,42],37:[2,42]},{28:[1,59],43:58,47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30]},{5:[2,47],10:[2,47],14:[2,47],15:[2,47],16:[2,47],17:[2,47],18:[2,47],19:[2,47],20:[2,47],21:[2,47],22:[2,47],23:[2,47],24:[2,47],25:[2,47],26:[2,47],27:[2,47],30:[2,47],33:[2,47],34:[2,47],36:[2,47],37:[2,47]},{5:[2,48],10:[2,48],14:[2,48],15:[2,48],16:[2,48],17:[2,48],18:[2,48],19:[2,48],20:[2,48],21:[2,48],22:[2,48],23:[2,48],24:[2,48],25:[2,48],26:[2,48],27:[2,48],30:[2,48],33:[2,48],34:[2,48],36:[2,48],37:[2,48]},{9:[1,60]},{9:[1,61]},{9:[1,62]},{9:[1,63]},{28:[2,45],47:[2,45],48:[2,45],49:[2,45],50:[2,45],51:[2,45],52:[2,45]},{1:[2,1]},{4:64,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{4:65,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{4:66,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{4:67,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{4:68,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{4:69,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{4:70,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{4:71,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{4:72,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{4:73,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{4:74,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{4:75,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{4:76,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{4:77,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{10:[1,78],14:[1,33],15:[1,34],16:[1,35],17:[1,36],18:[1,37],19:[1,38],20:[1,39],21:[1,40],22:[1,41],23:[1,42],24:[1,43],25:[1,44],26:[1,45],27:[1,46]},{5:[2,22],10:[2,22],14:[2,22],15:[2,22],16:[2,22],17:[2,22],18:[2,22],19:[2,22],20:[2,22],21:[2,22],22:[2,22],23:[2,22],24:[2,22],25:[2,22],26:[2,22],27:[1,46],30:[2,22],34:[2,22]},{4:81,6:3,7:4,8:5,9:[1,6],10:[1,80],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],29:79,31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{28:[2,44],47:[2,44],48:[2,44],49:[2,44],50:[2,44],51:[2,44],52:[2,44]},{28:[1,54],38:82,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30]},{28:[1,54],38:83,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30]},{5:[2,31],10:[2,31],14:[2,31],15:[2,31],16:[2,31],17:[2,31],18:[2,31],19:[2,31],20:[2,31],21:[2,31],22:[2,31],23:[2,31],24:[2,31],25:[2,31],26:[2,31],27:[2,31],30:[2,31],34:[2,31],36:[1,51],37:[1,52]},{5:[2,46],10:[2,46],14:[2,46],15:[2,46],16:[2,46],17:[2,46],18:[2,46],19:[2,46],20:[2,46],21:[2,46],22:[2,46],23:[2,46],24:[2,46],25:[2,46],26:[2,46],27:[2,46],30:[2,46],33:[2,46],34:[2,46],36:[2,46],37:[2,46],45:[1,50]},{5:[2,32],10:[2,32],14:[2,32],15:[2,32],16:[2,32],17:[2,32],18:[2,32],19:[2,32],20:[2,32],21:[2,32],22:[2,32],23:[2,32],24:[2,32],25:[2,32],26:[2,32],27:[2,32],30:[2,32],34:[2,32],36:[1,51],37:[1,52]},{5:[2,40],10:[2,40],14:[2,40],15:[2,40],16:[2,40],17:[2,40],18:[2,40],19:[2,40],20:[2,40],21:[2,40],22:[2,40],23:[2,40],24:[2,40],25:[2,40],26:[2,40],27:[2,40],30:[2,40],33:[2,40],34:[2,40],36:[2,40],37:[2,40]},{4:84,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{5:[2,43],10:[2,43],14:[2,43],15:[2,43],16:[2,43],17:[2,43],18:[2,43],19:[2,43],20:[2,43],21:[2,43],22:[2,43],23:[2,43],24:[2,43],25:[2,43],26:[2,43],27:[2,43],30:[2,43],33:[2,43],34:[2,43],36:[2,43],37:[2,43]},{5:[2,46],10:[2,46],14:[2,46],15:[2,46],16:[2,46],17:[2,46],18:[2,46],19:[2,46],20:[2,46],21:[2,46],22:[2,46],23:[2,46],24:[2,46],25:[2,46],26:[2,46],27:[2,46],30:[2,46],33:[2,46],34:[2,46],36:[2,46],37:[2,46]},{10:[1,85]},{10:[1,86]},{10:[1,87]},{10:[1,88],53:[1,89]},{5:[2,9],10:[2,9],14:[1,33],15:[1,34],16:[1,35],17:[1,36],18:[1,37],19:[1,38],20:[1,39],21:[1,40],22:[1,41],23:[1,42],24:[1,43],25:[1,44],26:[1,45],27:[1,46],30:[2,9],34:[2,9]},{5:[2,10],10:[2,10],14:[2,10],15:[1,34],16:[1,35],17:[1,36],18:[1,37],19:[1,38],20:[1,39],21:[1,40],22:[1,41],23:[1,42],24:[1,43],25:[1,44],26:[1,45],27:[1,46],30:[2,10],34:[2,10]},{5:[2,11],10:[2,11],14:[2,11],15:[2,11],16:[2,11],17:[2,11],18:[1,37],19:[1,38],20:[1,39],21:[1,40],22:[1,41],23:[1,42],24:[1,43],25:[1,44],26:[1,45],27:[1,46],30:[2,11],34:[2,11]},{5:[2,12],10:[2,12],14:[2,12],15:[2,12],16:[2,12],17:[2,12],18:[1,37],19:[1,38],20:[1,39],21:[1,40],22:[1,41],23:[1,42],24:[1,43],25:[1,44],26:[1,45],27:[1,46],30:[2,12],34:[2,12]},{5:[2,13],10:[2,13],14:[2,13],15:[2,13],16:[2,13],17:[2,13],18:[2,13],19:[2,13],20:[2,13],21:[2,13],22:[1,41],23:[1,42],24:[1,43],25:[1,44],26:[1,45],27:[1,46],30:[2,13],34:[2,13]},{5:[2,14],10:[2,14],14:[2,14],15:[2,14],16:[2,14],17:[2,14],18:[2,14],19:[2,14],20:[2,14],21:[2,14],22:[1,41],23:[1,42],24:[1,43],25:[1,44],26:[1,45],27:[1,46],30:[2,14],34:[2,14]},{5:[2,15],10:[2,15],14:[2,15],15:[2,15],16:[2,15],17:[2,15],18:[2,15],19:[2,15],20:[2,15],21:[2,15],22:[1,41],23:[1,42],24:[1,43],25:[1,44],26:[1,45],27:[1,46],30:[2,15],34:[2,15]},{5:[2,16],10:[2,16],14:[2,16],15:[2,16],16:[2,16],17:[2,16],18:[2,16],19:[2,16],20:[2,16],21:[2,16],22:[1,41],23:[1,42],24:[1,43],25:[1,44],26:[1,45],27:[1,46],30:[2,16],34:[2,16]},{5:[2,17],10:[2,17],14:[2,17],15:[2,17],16:[2,17],17:[2,17],18:[2,17],19:[2,17],20:[2,17],21:[2,17],22:[2,17],23:[2,17],24:[1,43],25:[1,44],26:[1,45],27:[1,46],30:[2,17],34:[2,17]},{5:[2,18],10:[2,18],14:[2,18],15:[2,18],16:[2,18],17:[2,18],18:[2,18],19:[2,18],20:[2,18],21:[2,18],22:[2,18],23:[2,18],24:[1,43],25:[1,44],26:[1,45],27:[1,46],30:[2,18],34:[2,18]},{5:[2,19],10:[2,19],14:[2,19],15:[2,19],16:[2,19],17:[2,19],18:[2,19],19:[2,19],20:[2,19],21:[2,19],22:[2,19],23:[2,19],24:[2,19],25:[2,19],26:[2,19],27:[1,46],30:[2,19],34:[2,19]},{5:[2,20],10:[2,20],14:[2,20],15:[2,20],16:[2,20],17:[2,20],18:[2,20],19:[2,20],20:[2,20],21:[2,20],22:[2,20],23:[2,20],24:[2,20],25:[2,20],26:[2,20],27:[1,46],30:[2,20],34:[2,20]},{5:[2,21],10:[2,21],14:[2,21],15:[2,21],16:[2,21],17:[2,21],18:[2,21],19:[2,21],20:[2,21],21:[2,21],22:[2,21],23:[2,21],24:[2,21],25:[2,21],26:[2,21],27:[1,46],30:[2,21],34:[2,21]},{5:[2,23],10:[2,23],14:[2,23],15:[2,23],16:[2,23],17:[2,23],18:[2,23],19:[2,23],20:[2,23],21:[2,23],22:[2,23],23:[2,23],24:[2,23],25:[2,23],26:[2,23],27:[2,23],30:[2,23],34:[2,23]},{5:[2,5],10:[2,5],14:[2,5],15:[2,5],16:[2,5],17:[2,5],18:[2,5],19:[2,5],20:[2,5],21:[2,5],22:[2,5],23:[2,5],24:[2,5],25:[2,5],26:[2,5],27:[2,5],30:[2,5],34:[2,5]},{10:[1,90],30:[1,91]},{5:[2,25],10:[2,25],14:[2,25],15:[2,25],16:[2,25],17:[2,25],18:[2,25],19:[2,25],20:[2,25],21:[2,25],22:[2,25],23:[2,25],24:[2,25],25:[2,25],26:[2,25],27:[2,25],30:[2,25],34:[2,25]},{10:[2,27],14:[1,33],15:[1,34],16:[1,35],17:[1,36],18:[1,37],19:[1,38],20:[1,39],21:[1,40],22:[1,41],23:[1,42],24:[1,43],25:[1,44],26:[1,45],27:[1,46],30:[2,27]},{5:[2,35],10:[2,35],14:[2,35],15:[2,35],16:[2,35],17:[2,35],18:[2,35],19:[2,35],20:[2,35],21:[2,35],22:[2,35],23:[2,35],24:[2,35],25:[2,35],26:[2,35],27:[2,35],30:[2,35],34:[2,35],36:[2,35],37:[2,35]},{5:[2,36],10:[2,36],14:[2,36],15:[2,36],16:[2,36],17:[2,36],18:[2,36],19:[2,36],20:[2,36],21:[2,36],22:[2,36],23:[2,36],24:[2,36],25:[2,36],26:[2,36],27:[2,36],30:[2,36],34:[2,36],36:[2,36],37:[2,36]},{14:[1,33],15:[1,34],16:[1,35],17:[1,36],18:[1,37],19:[1,38],20:[1,39],21:[1,40],22:[1,41],23:[1,42],24:[1,43],25:[1,44],26:[1,45],27:[1,46],34:[1,92]},{5:[2,49],10:[2,49],14:[2,49],15:[2,49],16:[2,49],17:[2,49],18:[2,49],19:[2,49],20:[2,49],21:[2,49],22:[2,49],23:[2,49],24:[2,49],25:[2,49],26:[2,49],27:[2,49],30:[2,49],33:[2,49],34:[2,49],36:[2,49],37:[2,49]},{5:[2,50],10:[2,50],14:[2,50],15:[2,50],16:[2,50],17:[2,50],18:[2,50],19:[2,50],20:[2,50],21:[2,50],22:[2,50],23:[2,50],24:[2,50],25:[2,50],26:[2,50],27:[2,50],30:[2,50],33:[2,50],34:[2,50],36:[2,50],37:[2,50]},{5:[2,51],10:[2,51],14:[2,51],15:[2,51],16:[2,51],17:[2,51],18:[2,51],19:[2,51],20:[2,51],21:[2,51],22:[2,51],23:[2,51],24:[2,51],25:[2,51],26:[2,51],27:[2,51],30:[2,51],33:[2,51],34:[2,51],36:[2,51],37:[2,51]},{5:[2,52],10:[2,52],14:[2,52],15:[2,52],16:[2,52],17:[2,52],18:[2,52],19:[2,52],20:[2,52],21:[2,52],22:[2,52],23:[2,52],24:[2,52],25:[2,52],26:[2,52],27:[2,52],30:[2,52],33:[2,52],34:[2,52],36:[2,52],37:[2,52]},{10:[1,93]},{5:[2,24],10:[2,24],14:[2,24],15:[2,24],16:[2,24],17:[2,24],18:[2,24],19:[2,24],20:[2,24],21:[2,24],22:[2,24],23:[2,24],24:[2,24],25:[2,24],26:[2,24],27:[2,24],30:[2,24],34:[2,24]},{4:94,6:3,7:4,8:5,9:[1,6],11:7,12:[1,8],13:9,23:[1,10],28:[1,12],31:11,35:15,36:[1,16],37:[1,17],38:18,39:19,40:[1,20],41:[1,21],42:22,43:23,44:24,46:[1,31],47:[1,25],48:[1,26],49:[1,27],50:[1,28],51:[1,29],52:[1,30],53:[1,13],54:[1,14]},{5:[2,29],10:[2,29],14:[2,29],15:[2,29],16:[2,29],17:[2,29],18:[2,29],19:[2,29],20:[2,29],21:[2,29],22:[2,29],23:[2,29],24:[2,29],25:[2,29],26:[2,29],27:[2,29],30:[2,29],33:[2,29],34:[2,29],36:[2,29],37:[2,29]},{5:[2,53],10:[2,53],14:[2,53],15:[2,53],16:[2,53],17:[2,53],18:[2,53],19:[2,53],20:[2,53],21:[2,53],22:[2,53],23:[2,53],24:[2,53],25:[2,53],26:[2,53],27:[2,53],30:[2,53],33:[2,53],34:[2,53],36:[2,53],37:[2,53]},{10:[2,26],14:[1,33],15:[1,34],16:[1,35],17:[1,36],18:[1,37],19:[1,38],20:[1,39],21:[1,40],22:[1,41],23:[1,42],24:[1,43],25:[1,44],26:[1,45],27:[1,46],30:[2,26]}],defaultActions:{32:[2,1]},parseError:function(str){throw new Error(str)
},parse:function(input){function popStack(n){stack.length=stack.length-2*n,vstack.length=vstack.length-n,lstack.length=lstack.length-n}function lex(){var token;return token=self.lexer.lex()||1,"number"!=typeof token&&(token=self.symbols_[token]||token),token}var self=this,stack=[0],vstack=[null],lstack=[],table=this.table,yytext="",yylineno=0,yyleng=0,recovering=0,TERROR=2,EOF=1;this.lexer.setInput(input),this.lexer.yy=this.yy,this.yy.lexer=this.lexer,"undefined"==typeof this.lexer.yylloc&&(this.lexer.yylloc={});var yyloc=this.lexer.yylloc;lstack.push(yyloc),"function"==typeof this.yy.parseError&&(this.parseError=this.yy.parseError);for(var symbol,preErrorSymbol,state,action,r,p,len,newState,expected,yyval={};;){if(state=stack[stack.length-1],this.defaultActions[state]?action=this.defaultActions[state]:(null==symbol&&(symbol=lex()),action=table[state]&&table[state][symbol]),"undefined"==typeof action||!action.length||!action[0]){if(!recovering){expected=[];for(p in table[state])this.terminals_[p]&&p>2&&expected.push("'"+this.terminals_[p]+"'");var errStr="";errStr=this.lexer.showPosition?"Parse error on line "+(yylineno+1)+":\n"+this.lexer.showPosition()+"\nExpecting "+expected.join(", "):"Parse error on line "+(yylineno+1)+": Unexpected "+(1==symbol?"end of input":"'"+(this.terminals_[symbol]||symbol)+"'"),this.parseError(errStr,{text:this.lexer.match,token:this.terminals_[symbol]||symbol,line:this.lexer.yylineno,loc:yyloc,expected:expected})}if(3==recovering){if(symbol==EOF)throw new Error(errStr||"Parsing halted.");yyleng=this.lexer.yyleng,yytext=this.lexer.yytext,yylineno=this.lexer.yylineno,yyloc=this.lexer.yylloc,symbol=lex()}for(;;){if(TERROR.toString()in table[state])break;if(0==state)throw new Error(errStr||"Parsing halted.");popStack(1),state=stack[stack.length-1]}preErrorSymbol=symbol,symbol=TERROR,state=stack[stack.length-1],action=table[state]&&table[state][TERROR],recovering=3}if(action[0]instanceof Array&&action.length>1)throw new Error("Parse Error: multiple actions possible at state: "+state+", token: "+symbol);switch(action[0]){case 1:stack.push(symbol),vstack.push(this.lexer.yytext),lstack.push(this.lexer.yylloc),stack.push(action[1]),symbol=null,preErrorSymbol?(symbol=preErrorSymbol,preErrorSymbol=null):(yyleng=this.lexer.yyleng,yytext=this.lexer.yytext,yylineno=this.lexer.yylineno,yyloc=this.lexer.yylloc,recovering>0&&recovering--);break;case 2:if(len=this.productions_[action[1]][1],yyval.$=vstack[vstack.length-len],yyval._$={first_line:lstack[lstack.length-(len||1)].first_line,last_line:lstack[lstack.length-1].last_line,first_column:lstack[lstack.length-(len||1)].first_column,last_column:lstack[lstack.length-1].last_column},r=this.performAction.call(yyval,yytext,yyleng,yylineno,this.yy,action[1],vstack,lstack),"undefined"!=typeof r)return r;len&&(stack=stack.slice(0,-1*len*2),vstack=vstack.slice(0,-1*len),lstack=lstack.slice(0,-1*len)),stack.push(this.productions_[action[1]][0]),vstack.push(yyval.$),lstack.push(yyval._$),newState=table[stack[stack.length-2]][stack[stack.length-1]],stack.push(newState);break;case 3:return!0}}return!0}},lexer=function(){var lexer={EOF:1,parseError:function(str,hash){if(!this.yy.parseError)throw new Error(str);this.yy.parseError(str,hash)},setInput:function(input){return this._input=input,this._more=this._less=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this},input:function(){var ch=this._input[0];this.yytext+=ch,this.yyleng++,this.match+=ch,this.matched+=ch;var lines=ch.match(/\n/);return lines&&this.yylineno++,this._input=this._input.slice(1),ch},unput:function(ch){return this._input=ch+this._input,this},more:function(){return this._more=!0,this},pastInput:function(){var past=this.matched.substr(0,this.matched.length-this.match.length);return(past.length>20?"...":"")+past.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var next=this.match;return next.length<20&&(next+=this._input.substr(0,20-next.length)),(next.substr(0,20)+(next.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var pre=this.pastInput(),c=new Array(pre.length+1).join("-");return pre+this.upcomingInput()+"\n"+c+"^"},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var token,match,lines;this._more||(this.yytext="",this.match="");for(var rules=this._currentRules(),i=0;i<rules.length;i++)if(match=this._input.match(this.rules[rules[i]]))return lines=match[0].match(/\n.*/g),lines&&(this.yylineno+=lines.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:lines?lines[lines.length-1].length-1:this.yylloc.last_column+match[0].length},this.yytext+=match[0],this.match+=match[0],this.matches=match,this.yyleng=this.yytext.length,this._more=!1,this._input=this._input.slice(match[0].length),this.matched+=match[0],token=this.performAction.call(this,this.yy,this,rules[i],this.conditionStack[this.conditionStack.length-1]),token?token:void 0;return""===this._input?this.EOF:void this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var r=this.next();return"undefined"!=typeof r?r:this.lex()},begin:function(condition){this.conditionStack.push(condition)},popState:function(){return this.conditionStack.pop()},_currentRules:function(){return this.conditions[this.conditionStack[this.conditionStack.length-1]].rules}};return lexer.performAction=function(yy,yy_,$avoiding_name_collisions,YY_START){switch($avoiding_name_collisions){case 0:break;case 1:return debuglog("NODETYPE",yy_.yytext),"NODETYPE_NODE";case 2:return debuglog("NODETYPE",yy_.yytext),"NODETYPE_TEXT";case 3:return debuglog("NODETYPE",yy_.yytext),"NODETYPE_COMMENT";case 4:return debuglog("NODETYPE",yy_.yytext),"NODETYPE_PROCINSTR";case 5:return this.begin("OP_CONTEXT"),yy_.yytext=yy_.yytext.substr(1,yy_.yyleng-1),debuglog("VAR",yy_.yytext),"VAR";case 6:return this.begin("OP_CONTEXT"),yy_.yytext=yy_.yytext.substr(0,yy_.yyleng-2),debuglog("NSWILDCARD",yy_.yytext),"NSWILDCARD";case 7:return this.begin("OP_CONTEXT"),debuglog("QNAME",yy_.yytext),"QNAME";case 8:return this.begin("OP_CONTEXT"),debuglog("WILDCARD",yy_.yytext),"WILDCARD";case 9:return this.begin("VAL_CONTEXT"),debuglog("MULT",yy_.yytext),"MULT";case 10:return this.begin("VAL_CONTEXT"),debuglog("AND",yy_.yytext),"AND";case 11:return this.begin("VAL_CONTEXT"),debuglog("OR",yy_.yytext),"OR";case 12:return this.begin("VAL_CONTEXT"),debuglog("DIV",yy_.yytext),"DIV";case 13:return this.begin("VAL_CONTEXT"),debuglog("MOD",yy_.yytext),"MOD";case 14:return this.begin("OP_CONTEXT"),debuglog("NUM",yy_.yytext),"NUM";case 15:return this.begin("VAL_CONTEXT"),debuglog("EQ",yy_.yytext),"EQ";case 16:return this.begin("VAL_CONTEXT"),debuglog("NEQ",yy_.yytext),"NEQ";case 17:return this.begin("VAL_CONTEXT"),debuglog("LTE",yy_.yytext),"LTE";case 18:return this.begin("VAL_CONTEXT"),debuglog("LT",yy_.yytext),"LT";case 19:return this.begin("VAL_CONTEXT"),debuglog("GTE",yy_.yytext),"GTE";case 20:return this.begin("VAL_CONTEXT"),debuglog("GT",yy_.yytext),"GT";case 21:return this.begin("VAL_CONTEXT"),debuglog("PLUS",yy_.yytext),"PLUS";case 22:return this.begin("VAL_CONTEXT"),debuglog("MINUS",yy_.yytext),"MINUS";case 23:return this.begin("VAL_CONTEXT"),debuglog("UNION",yy_.yytext),"UNION";case 24:return this.begin("VAL_CONTEXT"),debuglog("DBL",yy_.yytext),"DBL_SLASH";case 25:return this.begin("VAL_CONTEXT"),debuglog("SLASH",yy_.yytext),"SLASH";case 26:return this.begin("VAL_CONTEXT"),debuglog("LBRACK",yy_.yytext),"LBRACK";case 27:return this.begin("OP_CONTEXT"),debuglog("RBRACK",yy_.yytext),"RBRACK";case 28:return this.begin("VAL_CONTEXT"),debuglog("LPAREN",yy_.yytext),"LPAREN";case 29:return this.begin("OP_CONTEXT"),debuglog("RPAREN",yy_.yytext),"RPAREN";case 30:return this.begin("OP_CONTEXT"),debuglog("DBL",yy_.yytext),"DBL_DOT";case 31:return this.begin("OP_CONTEXT"),debuglog("DOT",yy_.yytext),"DOT";case 32:return this.begin("VAL_CONTEXT"),debuglog("AT",yy_.yytext),"AT";case 33:return this.begin("VAL_CONTEXT"),debuglog("DBL",yy_.yytext),"DBL_COLON";case 34:return this.begin("VAL_CONTEXT"),debuglog("COMMA",yy_.yytext),"COMMA";case 35:return this.begin("OP_CONTEXT"),yy_.yytext=yy_.yytext.substr(1,yy_.yyleng-2),debuglog("STR",yy_.yytext),"STR";case 36:return 5}},lexer.rules=[/^(\s+)/,/^node(?=((\s+)?\())/,/^text(?=((\s+)?\())/,/^comment(?=((\s+)?\())/,/^processing-instruction(?=((\s+)?\())/,/^\$[A-Za-z_][A-Za-z0-9._-]*(:[A-Za-z_][A-Za-z0-9._-]*)?/,/^[A-Za-z_][A-Za-z0-9._-]*:\*/,/^[A-Za-z_][A-Za-z0-9._-]*(:[A-Za-z_][A-Za-z0-9._-]*)?/,/^\*/,/^\*/,/^(and)/,/^(or)/,/^(div)/,/^(mod)/,/^([0-9]+(\.[0-9]*)?|(\.[0-9]+))/,/^=/,/^!=/,/^<=/,/^</,/^>=/,/^>/,/^\+/,/^-/,/^\|/,/^\/\//,/^\//,/^\[/,/^\]/,/^\(/,/^\)/,/^\.\./,/^\./,/^@/,/^::/,/^,/,/^("[^"\""]*"|'[^'\'']*')/,/^$/],lexer.conditions={INITIAL:{rules:[0,1,2,3,4,5,6,7,8,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36],inclusive:!0},OP_CONTEXT:{rules:[0,1,2,3,4,5,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36],inclusive:!0},VAL_CONTEXT:{rules:[0,1,2,3,4,5,6,7,8,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36],inclusive:!0}},lexer}();return parser.lexer=lexer,parser}();"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.parser=xpath,exports.parse=function(){return xpath.parse.apply(xpath,arguments)},exports.main=function(args){if(!args[1])throw new Error("Usage: "+args[0]+" FILE");if("undefined"!=typeof process)var source=require("fs").readFileSync(require("path").join(process.cwd(),args[1]),"utf8");else var cwd=require("file").path(require("file").cwd()),source=cwd.join(args[1]).read({charset:"utf-8"});return exports.parser.parse(source)},"undefined"!=typeof module&&require.main===module&&exports.main("undefined"!=typeof process?process.argv.slice(1):require("system").args)),function(){if(!jQuery||!jQuery.jstree){var is_ie6=!1,is_ie7=!1,is_ff2=!1;!function($){$.vakata={},$.vakata.css={get_css:function(rule_name,delete_flag,sheet){rule_name=rule_name.toLowerCase();var css_rules=sheet.cssRules||sheet.rules,j=0;do{if(css_rules.length&&j>css_rules.length+5)return!1;if(css_rules[j].selectorText&&css_rules[j].selectorText.toLowerCase()==rule_name)return delete_flag===!0?(sheet.removeRule&&sheet.removeRule(j),sheet.deleteRule&&sheet.deleteRule(j),!0):css_rules[j]}while(css_rules[++j]);return!1},add_css:function(rule_name,sheet){return $.jstree.css.get_css(rule_name,!1,sheet)?!1:(sheet.insertRule?sheet.insertRule(rule_name+" { }",0):sheet.addRule(rule_name,null,0),$.vakata.css.get_css(rule_name))},remove_css:function(rule_name,sheet){return $.vakata.css.get_css(rule_name,!0,sheet)},add_sheet:function(opts){var tmp=!1,is_new=!0;if(opts.str)return opts.title&&(tmp=$("style[id='"+opts.title+"-stylesheet']")[0]),tmp?is_new=!1:(tmp=document.createElement("style"),tmp.setAttribute("type","text/css"),opts.title&&tmp.setAttribute("id",opts.title+"-stylesheet")),tmp.styleSheet?is_new?(document.getElementsByTagName("head")[0].appendChild(tmp),tmp.styleSheet.cssText=opts.str):tmp.styleSheet.cssText=tmp.styleSheet.cssText+" "+opts.str:(tmp.appendChild(document.createTextNode(opts.str)),document.getElementsByTagName("head")[0].appendChild(tmp)),tmp.sheet||tmp.styleSheet;if(opts.url){if(!document.createStyleSheet)return tmp=document.createElement("link"),tmp.rel="stylesheet",tmp.type="text/css",tmp.media="all",tmp.href=opts.url,document.getElementsByTagName("head")[0].appendChild(tmp),tmp.styleSheet;try{tmp=document.createStyleSheet(opts.url)}catch(e){}}}};var instances=[],focused_instance=-1,plugins={},prepared_move={};$.fn.jstree=function(settings){var isMethodCall="string"==typeof settings,args=Array.prototype.slice.call(arguments,1),returnValue=this;if(isMethodCall){if("_"==settings.substring(0,1))return returnValue;this.each(function(){var instance=instances[$.data(this,"jstree_instance_id")],methodValue=instance&&$.isFunction(instance[settings])?instance[settings].apply(instance,args):instance;return"undefined"!=typeof methodValue&&(0===settings.indexOf("is_")||methodValue!==!0&&methodValue!==!1)?(returnValue=methodValue,!1):void 0})}else this.each(function(){var instance_id=$.data(this,"jstree_instance_id"),a=[],b=settings?$.extend({},!0,settings):{},c=$(this),s=!1,t=[];a=a.concat(args),c.data("jstree")&&a.push(c.data("jstree")),b=a.length?$.extend.apply(null,[!0,b].concat(a)):b,"undefined"!=typeof instance_id&&instances[instance_id]&&instances[instance_id].destroy(),instance_id=parseInt(instances.push({}),10)-1,$.data(this,"jstree_instance_id",instance_id),b.plugins=$.isArray(b.plugins)?b.plugins:$.jstree.defaults.plugins.slice(),b.plugins.unshift("core"),b.plugins=b.plugins.sort().join(",,").replace(/(,|^)([^,]+)(,,\2)+(,|$)/g,"$1$2$4").replace(/,,+/g,",").replace(/,$/,"").split(","),s=$.extend(!0,{},$.jstree.defaults,b),s.plugins=b.plugins,$.each(plugins,function(i){-1===$.inArray(i,s.plugins)?(s[i]=null,delete s[i]):t.push(i)}),s.plugins=t,instances[instance_id]=new $.jstree._instance(instance_id,$(this).addClass("jstree jstree-"+instance_id),s),$.each(instances[instance_id]._get_settings().plugins,function(i,val){instances[instance_id].data[val]={}}),$.each(instances[instance_id]._get_settings().plugins,function(i,val){plugins[val]&&plugins[val].__init.apply(instances[instance_id])}),setTimeout(function(){instances[instance_id]&&instances[instance_id].init()},0)});return returnValue},$.jstree={defaults:{plugins:[]},_focused:function(){return instances[focused_instance]||null},_reference:function(needle){if(instances[needle])return instances[needle];var o=$(needle);return o.length||"string"!=typeof needle||(o=$("#"+needle)),o.length?instances[o.closest(".jstree").data("jstree_instance_id")]||null:null},_instance:function(index,container,settings){this.data={core:{}},this.get_settings=function(){return $.extend(!0,{},settings)},this._get_settings=function(){return settings},this.get_index=function(){return index},this.get_container=function(){return container},this.get_container_ul=function(){return container.children("ul:eq(0)")},this._set_settings=function(s){settings=$.extend(!0,{},settings,s)}},_fn:{},plugin:function(pname,pdata){pdata=$.extend({},{__init:$.noop,__destroy:$.noop,_fn:{},defaults:!1},pdata),plugins[pname]=pdata,$.jstree.defaults[pname]=pdata.defaults,$.each(pdata._fn,function(i,val){val.plugin=pname,val.old=$.jstree._fn[i],$.jstree._fn[i]=function(){var rslt,func=val,args=Array.prototype.slice.call(arguments),evnt=new $.Event("before.jstree"),rlbk=!1;if(this.data.core.locked!==!0||"unlock"===i||"is_locked"===i){do{if(func&&func.plugin&&-1!==$.inArray(func.plugin,this._get_settings().plugins))break;func=func.old}while(func);if(func){if(0===i.indexOf("_"))rslt=func.apply(this,args);else{if(rslt=this.get_container().triggerHandler(evnt,{func:i,inst:this,args:args,plugin:func.plugin}),rslt===!1)return;"undefined"!=typeof rslt&&(args=rslt),rslt=func.apply($.extend({},this,{__callback:function(data){this.get_container().triggerHandler(i+".jstree",{inst:this,args:args,rslt:data,rlbk:rlbk})},__rollback:function(){return rlbk=this.get_rollback()},__call_old:function(replace_arguments){return func.old.apply(this,replace_arguments?Array.prototype.slice.call(arguments,1):args)}}),args)}return rslt}}},$.jstree._fn[i].old=val.old,$.jstree._fn[i].plugin=pname})},rollback:function(rb){rb&&($.isArray(rb)||(rb=[rb]),$.each(rb,function(i,val){instances[val.i].set_rollback(val.h,val.d)}))}},$.jstree._fn=$.jstree._instance.prototype={},$(function(){var u=navigator.userAgent.toLowerCase(),v=(u.match(/.+?(?:rv|it|ra|ie)[\/: ]([\d.]+)/)||[0,"0"])[1],css_string=".jstree ul, .jstree li { display:block; margin:0 0 0 0; padding:0 0 0 0; list-style-type:none; } .jstree li { display:block; min-height:18px; line-height:18px; white-space:nowrap; margin-left:18px; min-width:18px; } .jstree-rtl li { margin-left:0; margin-right:18px; } .jstree > ul > li { margin-left:0px; } .jstree-rtl > ul > li { margin-right:0px; } .jstree ins { display:inline-block; text-decoration:none; width:18px; height:18px; margin:0 0 0 0; padding:0; } .jstree a { display:inline-block; line-height:16px; height:16px; color:black; white-space:nowrap; text-decoration:none; padding:1px 2px; margin:0; } .jstree a:focus { outline: none; } .jstree a > ins { height:16px; width:16px; } .jstree a > .jstree-icon { margin-right:3px; } .jstree-rtl a > .jstree-icon { margin-left:3px; margin-right:0; } li.jstree-open > ul { display:block; } li.jstree-closed > ul { display:none; } ";if(/msie/.test(u)&&6==parseInt(v,10)){is_ie6=!0;try{document.execCommand("BackgroundImageCache",!1,!0)}catch(err){}css_string+=".jstree li { height:18px; margin-left:0; margin-right:0; } .jstree li li { margin-left:18px; } .jstree-rtl li li { margin-left:0px; margin-right:18px; } li.jstree-open ul { display:block; } li.jstree-closed ul { display:none !important; } .jstree li a { display:inline; border-width:0 !important; padding:0px 2px !important; } .jstree li a ins { height:16px; width:16px; margin-right:3px; } .jstree-rtl li a ins { margin-right:0px; margin-left:3px; } "}/msie/.test(u)&&7==parseInt(v,10)&&(is_ie7=!0,css_string+=".jstree li a { border-width:0 !important; padding:0px 2px !important; } "),!/compatible/.test(u)&&/mozilla/.test(u)&&parseFloat(v,10)<1.9&&(is_ff2=!0,css_string+=".jstree ins { display:-moz-inline-box; } .jstree li { line-height:12px; } .jstree a { display:-moz-inline-box; } .jstree .jstree-no-icons .jstree-checkbox { display:-moz-inline-stack !important; } "),$.vakata.css.add_sheet({str:css_string,title:"jstree"})}),$.jstree.plugin("core",{__init:function(){this.data.core.locked=!1,this.data.core.to_open=this.get_settings().core.initially_open,this.data.core.to_load=this.get_settings().core.initially_load},defaults:{html_titles:!1,animation:500,initially_open:[],initially_load:[],open_parents:!0,notify_plugins:!0,rtl:!1,load_open:!1,strings:{loading:"Loading ...",new_node:"New node",multiple_selection:"Multiple selection"}},_fn:{init:function(){this.set_focus(),this._get_settings().core.rtl&&this.get_container().addClass("jstree-rtl").css("direction","rtl"),this.get_container().html("<ul><li class='jstree-last jstree-leaf'><ins>&#160;</ins><a class='jstree-loading' href='#'><ins class='jstree-icon'>&#160;</ins>"+this._get_string("loading")+"</a></li></ul>"),this.data.core.li_height=this.get_container_ul().find("li.jstree-closed, li.jstree-leaf").eq(0).height()||18,this.get_container().delegate("li > ins","click.jstree",$.proxy(function(event){var trgt=$(event.target);this.toggle_node(trgt)},this)).bind("mousedown.jstree",$.proxy(function(){this.set_focus()},this)).bind("dblclick.jstree",function(){var sel;if(document.selection&&document.selection.empty)document.selection.empty();else if(window.getSelection){sel=window.getSelection();try{sel.removeAllRanges(),sel.collapse()}catch(err){}}}),this._get_settings().core.notify_plugins&&this.get_container().bind("load_node.jstree",$.proxy(function(e,data){var o=this._get_node(data.rslt.obj),t=this;-1===o&&(o=this.get_container_ul()),o.length&&o.find("li").each(function(){var th=$(this);th.data("jstree")&&$.each(th.data("jstree"),function(plugin,values){t.data[plugin]&&$.isFunction(t["_"+plugin+"_notify"])&&t["_"+plugin+"_notify"].call(t,th,values)})})},this)),this._get_settings().core.load_open&&this.get_container().bind("load_node.jstree",$.proxy(function(e,data){var o=this._get_node(data.rslt.obj),t=this;-1===o&&(o=this.get_container_ul()),o.length&&o.find("li.jstree-open:not(:has(ul))").each(function(){t.load_node(this,$.noop,$.noop)})},this)),this.__callback(),this.load_node(-1,function(){this.loaded(),this.reload_nodes()})},destroy:function(){var i,n=this.get_index(),s=this._get_settings(),_this=this;if($.each(s.plugins,function(i,val){try{plugins[val].__destroy.apply(_this)}catch(err){}}),this.__callback(),this.is_focused())for(i in instances)if(instances.hasOwnProperty(i)&&i!=n){instances[i].set_focus();break}n===focused_instance&&(focused_instance=-1),this.get_container().unbind(".jstree").undelegate(".jstree").removeData("jstree_instance_id").find("[class^='jstree']").andSelf().attr("class",function(){return this.className.replace(/jstree[^ ]*|$/gi,"")}),$(document).unbind(".jstree-"+n).undelegate(".jstree-"+n),instances[n]=null,delete instances[n]},_core_notify:function(n,data){data.opened&&this.open_node(n,!1,!0)},lock:function(){this.data.core.locked=!0,this.get_container().children("ul").addClass("jstree-locked").css("opacity","0.7"),this.__callback({})},unlock:function(){this.data.core.locked=!1,this.get_container().children("ul").removeClass("jstree-locked").css("opacity","1"),this.__callback({})},is_locked:function(){return this.data.core.locked},save_opened:function(){var _this=this;this.data.core.to_open=[],this.get_container_ul().find("li.jstree-open").each(function(){this.id&&_this.data.core.to_open.push("#"+this.id.toString().replace(/^#/,"").replace(/\\\//g,"/").replace(/\//g,"\\/").replace(/\\\./g,".").replace(/\./g,"\\.").replace(/\:/g,"\\:"))}),this.__callback(_this.data.core.to_open)},save_loaded:function(){},reload_nodes:function(is_callback){var _this=this,done=!0,current=[],remaining=[];is_callback||(this.data.core.reopen=!1,this.data.core.refreshing=!0,this.data.core.to_open=$.map($.makeArray(this.data.core.to_open),function(n){return"#"+n.toString().replace(/^#/,"").replace(/\\\//g,"/").replace(/\//g,"\\/").replace(/\\\./g,".").replace(/\./g,"\\.").replace(/\:/g,"\\:")}),this.data.core.to_load=$.map($.makeArray(this.data.core.to_load),function(n){return"#"+n.toString().replace(/^#/,"").replace(/\\\//g,"/").replace(/\//g,"\\/").replace(/\\\./g,".").replace(/\./g,"\\.").replace(/\:/g,"\\:")}),this.data.core.to_open.length&&(this.data.core.to_load=this.data.core.to_load.concat(this.data.core.to_open))),this.data.core.to_load.length&&($.each(this.data.core.to_load,function(i,val){return"#"==val?!0:void($(val).length?current.push(val):remaining.push(val))}),current.length&&(this.data.core.to_load=remaining,$.each(current,function(i,val){_this._is_loaded(val)||(_this.load_node(val,function(){_this.reload_nodes(!0)},function(){_this.reload_nodes(!0)}),done=!1)}))),this.data.core.to_open.length&&$.each(this.data.core.to_open,function(i,val){_this.open_node(val,!1,!0)}),done&&(this.data.core.reopen&&clearTimeout(this.data.core.reopen),this.data.core.reopen=setTimeout(function(){_this.__callback({},_this)},50),this.data.core.refreshing=!1,this.reopen())},reopen:function(){var _this=this;this.data.core.to_open.length&&$.each(this.data.core.to_open,function(i,val){_this.open_node(val,!1,!0)}),this.__callback({})},refresh:function(obj){var _this=this;this.save_opened(),obj||(obj=-1),obj=this._get_node(obj),obj||(obj=-1),-1!==obj?obj.children("UL").remove():this.get_container_ul().empty(),this.load_node(obj,function(){_this.__callback({obj:obj}),_this.reload_nodes()})},loaded:function(){this.__callback()},set_focus:function(){if(!this.is_focused()){var f=$.jstree._focused();f&&f.unset_focus(),this.get_container().addClass("jstree-focused"),focused_instance=this.get_index(),this.__callback()}},is_focused:function(){return focused_instance==this.get_index()},unset_focus:function(){this.is_focused()&&(this.get_container().removeClass("jstree-focused"),focused_instance=-1),this.__callback()},_get_node:function(obj){var $obj=$(obj,this.get_container());return $obj.is(".jstree")||-1==obj?-1:($obj=$obj.closest("li",this.get_container()),$obj.length?$obj:!1)},_get_next:function(obj,strict){return obj=this._get_node(obj),-1===obj?this.get_container().find("> ul > li:first-child"):obj.length?strict?obj.nextAll("li").size()>0?obj.nextAll("li:eq(0)"):!1:obj.hasClass("jstree-open")?obj.find("li:eq(0)"):obj.nextAll("li").size()>0?obj.nextAll("li:eq(0)"):obj.parentsUntil(".jstree","li").next("li").eq(0):!1},_get_prev:function(obj,strict){if(obj=this._get_node(obj),-1===obj)return this.get_container().find("> ul > li:last-child");if(!obj.length)return!1;if(strict)return obj.prevAll("li").length>0?obj.prevAll("li:eq(0)"):!1;if(obj.prev("li").length){for(obj=obj.prev("li").eq(0);obj.hasClass("jstree-open");)obj=obj.children("ul:eq(0)").children("li:last");return obj}var o=obj.parentsUntil(".jstree","li:eq(0)");return o.length?o:!1},_get_parent:function(obj){if(obj=this._get_node(obj),-1==obj||!obj.length)return!1;var o=obj.parentsUntil(".jstree","li:eq(0)");return o.length?o:-1},_get_children:function(obj){return obj=this._get_node(obj),-1===obj?this.get_container().children("ul:eq(0)").children("li"):obj.length?obj.children("ul:eq(0)").children("li"):!1},get_path:function(obj,id_mode){var p=[],_this=this;return obj=this._get_node(obj),-1!==obj&&obj&&obj.length?(obj.parentsUntil(".jstree","li").each(function(){p.push(id_mode?this.id:_this.get_text(this))}),p.reverse(),p.push(id_mode?obj.attr("id"):this.get_text(obj)),p):!1},_get_string:function(key){return this._get_settings().core.strings[key]||key},is_open:function(obj){return obj=this._get_node(obj),obj&&-1!==obj&&obj.hasClass("jstree-open")},is_closed:function(obj){return obj=this._get_node(obj),obj&&-1!==obj&&obj.hasClass("jstree-closed")},is_leaf:function(obj){return obj=this._get_node(obj),obj&&-1!==obj&&obj.hasClass("jstree-leaf")},correct_state:function(obj){return obj=this._get_node(obj),obj&&-1!==obj?(obj.removeClass("jstree-closed jstree-open").addClass("jstree-leaf").children("ul").remove(),void this.__callback({obj:obj})):!1},open_node:function(obj,callback,skip_animation){if(obj=this._get_node(obj),!obj.length)return!1;if(!obj.hasClass("jstree-closed"))return callback&&callback.call(),!1;var s=skip_animation||is_ie6?0:this._get_settings().core.animation,t=this;this._is_loaded(obj)?(this._get_settings().core.open_parents&&obj.parentsUntil(".jstree",".jstree-closed").each(function(){t.open_node(this,!1,!0)}),s&&obj.children("ul").css("display","none"),obj.removeClass("jstree-closed").addClass("jstree-open").children("a").removeClass("jstree-loading"),s?obj.children("ul").stop(!0,!0).slideDown(s,function(){this.style.display="",t.after_open(obj)}):t.after_open(obj),this.__callback({obj:obj}),callback&&callback.call()):(obj.children("a").addClass("jstree-loading"),this.load_node(obj,function(){t.open_node(obj,callback,skip_animation)},callback))},after_open:function(obj){this.__callback({obj:obj})},close_node:function(obj,skip_animation){obj=this._get_node(obj);var s=skip_animation||is_ie6?0:this._get_settings().core.animation,t=this;return obj.length&&obj.hasClass("jstree-open")?(s&&obj.children("ul").attr("style","display:block !important"),obj.removeClass("jstree-open").addClass("jstree-closed"),s?obj.children("ul").stop(!0,!0).slideUp(s,function(){this.style.display="",t.after_close(obj)}):t.after_close(obj),void this.__callback({obj:obj})):!1},after_close:function(obj){this.__callback({obj:obj})},toggle_node:function(obj){return obj=this._get_node(obj),obj.hasClass("jstree-closed")?this.open_node(obj):obj.hasClass("jstree-open")?this.close_node(obj):void 0},open_all:function(obj,do_animation,original_obj){obj=obj?this._get_node(obj):-1,obj&&-1!==obj||(obj=this.get_container_ul()),original_obj?obj=obj.find("li.jstree-closed"):(original_obj=obj,obj=obj.is(".jstree-closed")?obj.find("li.jstree-closed").andSelf():obj.find("li.jstree-closed"));var _this=this;obj.each(function(){var __this=this;_this._is_loaded(this)?_this.open_node(this,!1,!do_animation):_this.open_node(this,function(){_this.open_all(__this,do_animation,original_obj)},!do_animation)}),0===original_obj.find("li.jstree-closed").length&&this.__callback({obj:original_obj})},close_all:function(obj,do_animation){var _this=this;obj=obj?this._get_node(obj):this.get_container(),obj&&-1!==obj||(obj=this.get_container_ul()),obj.find("li.jstree-open").andSelf().each(function(){_this.close_node(this,!do_animation)}),this.__callback({obj:obj})},clean_node:function(obj){obj=obj&&-1!=obj?$(obj):this.get_container_ul(),obj=obj.is("li")?obj.find("li").andSelf():obj.find("li"),obj.removeClass("jstree-last").filter("li:last-child").addClass("jstree-last").end().filter(":has(li)").not(".jstree-open").removeClass("jstree-leaf").addClass("jstree-closed"),obj.not(".jstree-open, .jstree-closed").addClass("jstree-leaf").children("ul").remove(),this.__callback({obj:obj})},get_rollback:function(){return this.__callback(),{i:this.get_index(),h:this.get_container().children("ul").clone(!0),d:this.data}},set_rollback:function(html,data){this.get_container().empty().append(html),this.data=data,this.__callback()},load_node:function(obj){this.__callback({obj:obj})},_is_loaded:function(){return!0},create_node:function(obj,position,js,callback,is_loaded){obj=this._get_node(obj),position="undefined"==typeof position?"last":position;var tmp,d=$("<li />"),s=this._get_settings().core;if(-1!==obj&&!obj.length)return!1;if(!is_loaded&&!this._is_loaded(obj))return this.load_node(obj,function(){this.create_node(obj,position,js,callback,!0)}),!1;switch(this.__rollback(),"string"==typeof js&&(js={data:js}),js||(js={}),js.attr&&d.attr(js.attr),js.metadata&&d.data(js.metadata),js.state&&d.addClass("jstree-"+js.state),js.data||(js.data=this._get_string("new_node")),$.isArray(js.data)||(tmp=js.data,js.data=[],js.data.push(tmp)),$.each(js.data,function(i,m){tmp=$("<a />"),$.isFunction(m)&&(m=m.call(this,js)),"string"==typeof m?tmp.attr("href","#")[s.html_titles?"html":"text"](m):(m.attr||(m.attr={}),m.attr.href||(m.attr.href="#"),tmp.attr(m.attr)[s.html_titles?"html":"text"](m.title),m.language&&tmp.addClass(m.language)),tmp.prepend("<ins class='jstree-icon'>&#160;</ins>"),!m.icon&&js.icon&&(m.icon=js.icon),m.icon&&(-1===m.icon.indexOf("/")?tmp.children("ins").addClass(m.icon):tmp.children("ins").css("background","url('"+m.icon+"') center center no-repeat")),d.append(tmp)}),d.prepend("<ins class='jstree-icon'>&#160;</ins>"),-1===obj&&(obj=this.get_container(),"before"===position&&(position="first"),"after"===position&&(position="last")),position){case"before":obj.before(d),tmp=this._get_parent(obj);break;case"after":obj.after(d),tmp=this._get_parent(obj);break;case"inside":case"first":obj.children("ul").length||obj.append("<ul />"),obj.children("ul").prepend(d),tmp=obj;break;case"last":obj.children("ul").length||obj.append("<ul />"),obj.children("ul").append(d),tmp=obj;break;default:obj.children("ul").length||obj.append("<ul />"),position||(position=0),tmp=obj.children("ul").children("li").eq(position),tmp.length?tmp.before(d):obj.children("ul").append(d),tmp=obj}return(-1===tmp||tmp.get(0)===this.get_container().get(0))&&(tmp=-1),this.clean_node(tmp),this.__callback({obj:d,parent:tmp}),callback&&callback.call(this,d),d},get_text:function(obj){if(obj=this._get_node(obj),!obj.length)return!1;var s=this._get_settings().core.html_titles;return obj=obj.children("a:eq(0)"),s?(obj=obj.clone(),obj.children("INS").remove(),obj.html()):(obj=obj.contents().filter(function(){return 3==this.nodeType})[0],obj.nodeValue)},set_text:function(obj,val){if(obj=this._get_node(obj),!obj.length)return!1;if(obj=obj.children("a:eq(0)"),this._get_settings().core.html_titles){var tmp=obj.children("INS").clone();return obj.html(val).prepend(tmp),this.__callback({obj:obj,name:val}),!0}return obj=obj.contents().filter(function(){return 3==this.nodeType})[0],this.__callback({obj:obj,name:val}),obj.nodeValue=val},rename_node:function(obj,val){obj=this._get_node(obj),this.__rollback(),obj&&obj.length&&this.set_text.apply(this,Array.prototype.slice.call(arguments))&&this.__callback({obj:obj,name:val})},delete_node:function(obj){if(obj=this._get_node(obj),!obj.length)return!1;this.__rollback();var p=this._get_parent(obj),prev=$([]),t=this;return obj.each(function(){prev=prev.add(t._get_prev(this))}),obj=obj.detach(),-1!==p&&0===p.find("> ul > li").length&&p.removeClass("jstree-open jstree-closed").addClass("jstree-leaf"),this.clean_node(p),this.__callback({obj:obj,prev:prev,parent:p}),obj
},prepare_move:function(o,r,pos,cb,is_cb){var p={};if(p.ot=$.jstree._reference(o)||this,p.o=p.ot._get_node(o),p.r=-1===r?-1:this._get_node(r),p.p="undefined"==typeof pos||pos===!1?"last":pos,!is_cb&&prepared_move.o&&prepared_move.o[0]===p.o[0]&&prepared_move.r[0]===p.r[0]&&prepared_move.p===p.p)return this.__callback(prepared_move),void(cb&&cb.call(this,prepared_move));if(p.ot=$.jstree._reference(p.o)||this,p.rt=$.jstree._reference(p.r)||this,-1!==p.r&&p.r){if(!/^(before|after)$/.test(p.p)&&!this._is_loaded(p.r))return this.load_node(p.r,function(){this.prepare_move(o,r,pos,cb,!0)});switch(p.p){case"before":p.cp=p.r.index(),p.cr=p.rt._get_parent(p.r);break;case"after":p.cp=p.r.index()+1,p.cr=p.rt._get_parent(p.r);break;case"inside":case"first":p.cp=0,p.cr=p.r;break;case"last":p.cp=p.r.find(" > ul > li").length,p.cr=p.r;break;default:p.cp=p.p,p.cr=p.r}}else switch(p.cr=-1,p.p){case"first":case"before":case"inside":p.cp=0;break;case"after":case"last":p.cp=p.rt.get_container().find(" > ul > li").length;break;default:p.cp=p.p}p.np=-1==p.cr?p.rt.get_container():p.cr,p.op=p.ot._get_parent(p.o),p.cop=p.o.index(),-1===p.op&&(p.op=p.ot?p.ot.get_container():this.get_container()),!/^(before|after)$/.test(p.p)&&p.op&&p.np&&p.op[0]===p.np[0]&&p.o.index()<p.cp&&p.cp++,p.or=p.np.find(" > ul > li:nth-child("+(p.cp+1)+")"),prepared_move=p,this.__callback(prepared_move),cb&&cb.call(this,prepared_move)},check_move:function(){var obj=prepared_move,ret=!0,r=-1===obj.r?this.get_container():obj.r;return obj&&obj.o&&obj.or[0]!==obj.o[0]?obj.op&&obj.np&&obj.op[0]===obj.np[0]&&obj.cp-1===obj.o.index()?!1:(obj.o.each(function(){return-1!==r.parentsUntil(".jstree","li").andSelf().index(this)?(ret=!1,!1):void 0}),ret):!1},move_node:function(obj,ref,position,is_copy,is_prepared,skip_check){if(!is_prepared)return this.prepare_move(obj,ref,position,function(p){this.move_node(p,!1,!1,is_copy,!0,skip_check)});if(is_copy&&(prepared_move.cy=!0),!skip_check&&!this.check_move())return!1;this.__rollback();var o=!1;is_copy?(o=obj.o.clone(!0),o.find("*[id]").andSelf().each(function(){this.id&&(this.id="copy_"+this.id)})):o=obj.o,obj.or.length?obj.or.before(o):(obj.np.children("ul").length||$("<ul />").appendTo(obj.np),obj.np.children("ul:eq(0)").append(o));try{obj.ot.clean_node(obj.op),obj.rt.clean_node(obj.np),obj.op.find("> ul > li").length||obj.op.removeClass("jstree-open jstree-closed").addClass("jstree-leaf").children("ul").remove()}catch(e){}return is_copy&&(prepared_move.cy=!0,prepared_move.oc=o),this.__callback(prepared_move),prepared_move},_get_move:function(){return prepared_move}}})}(jQuery),function($){var scrollbar_width,e1,e2;$(function(){/msie/.test(navigator.userAgent.toLowerCase())?(e1=$('<textarea cols="10" rows="2"></textarea>').css({position:"absolute",top:-1e3,left:0}).appendTo("body"),e2=$('<textarea cols="10" rows="2" style="overflow: hidden;"></textarea>').css({position:"absolute",top:-1e3,left:0}).appendTo("body"),scrollbar_width=e1.width()-e2.width(),e1.add(e2).remove()):(e1=$("<div />").css({width:100,height:100,overflow:"auto",position:"absolute",top:-1e3,left:0}).prependTo("body").append("<div />").find("div").css({width:"100%",height:200}),scrollbar_width=100-e1.width(),e1.parent().remove())}),$.jstree.plugin("ui",{__init:function(){this.data.ui.selected=$(),this.data.ui.last_selected=!1,this.data.ui.hovered=null,this.data.ui.to_select=this.get_settings().ui.initially_select,this.get_container().delegate("a","click.jstree",$.proxy(function(event){event.preventDefault(),event.currentTarget.blur(),$(event.currentTarget).hasClass("jstree-loading")||this.select_node(event.currentTarget,!0,event)},this)).delegate("a","mouseenter.jstree",$.proxy(function(event){$(event.currentTarget).hasClass("jstree-loading")||this.hover_node(event.target)},this)).delegate("a","mouseleave.jstree",$.proxy(function(event){$(event.currentTarget).hasClass("jstree-loading")||this.dehover_node(event.target)},this)).bind("reopen.jstree",$.proxy(function(){this.reselect()},this)).bind("get_rollback.jstree",$.proxy(function(){this.dehover_node(),this.save_selected()},this)).bind("set_rollback.jstree",$.proxy(function(){this.reselect()},this)).bind("close_node.jstree",$.proxy(function(event,data){var s=this._get_settings().ui,obj=this._get_node(data.rslt.obj),clk=obj&&obj.length?obj.children("ul").find("a.jstree-clicked"):$(),_this=this;s.selected_parent_close!==!1&&clk.length&&clk.each(function(){_this.deselect_node(this),"select_parent"===s.selected_parent_close&&_this.select_node(obj)})},this)).bind("delete_node.jstree",$.proxy(function(event,data){var s=this._get_settings().ui.select_prev_on_delete,obj=this._get_node(data.rslt.obj),clk=obj&&obj.length?obj.find("a.jstree-clicked"):[],_this=this;clk.each(function(){_this.deselect_node(this)}),s&&clk.length&&data.rslt.prev.each(function(){return this.parentNode?(_this.select_node(this),!1):void 0})},this)).bind("move_node.jstree",$.proxy(function(event,data){data.rslt.cy&&data.rslt.oc.find("a.jstree-clicked").removeClass("jstree-clicked")},this))},defaults:{select_limit:-1,select_multiple_modifier:"ctrl",select_range_modifier:"shift",selected_parent_close:"select_parent",selected_parent_open:!0,select_prev_on_delete:!0,disable_selecting_children:!1,initially_select:[]},_fn:{_get_node:function(obj,allow_multiple){if("undefined"==typeof obj||null===obj)return allow_multiple?this.data.ui.selected:this.data.ui.last_selected;var $obj=$(obj,this.get_container());return $obj.is(".jstree")||-1==obj?-1:($obj=$obj.closest("li",this.get_container()),$obj.length?$obj:!1)},_ui_notify:function(n,data){data.selected&&this.select_node(n,!1)},save_selected:function(){var _this=this;this.data.ui.to_select=[],this.data.ui.selected.each(function(){this.id&&_this.data.ui.to_select.push("#"+this.id.toString().replace(/^#/,"").replace(/\\\//g,"/").replace(/\//g,"\\/").replace(/\\\./g,".").replace(/\./g,"\\.").replace(/\:/g,"\\:"))}),this.__callback(this.data.ui.to_select)},reselect:function(){var _this=this,s=this.data.ui.to_select;s=$.map($.makeArray(s),function(n){return"#"+n.toString().replace(/^#/,"").replace(/\\\//g,"/").replace(/\//g,"\\/").replace(/\\\./g,".").replace(/\./g,"\\.").replace(/\:/g,"\\:")}),$.each(s,function(i,val){val&&"#"!==val&&_this.select_node(val)}),this.data.ui.selected=this.data.ui.selected.filter(function(){return this.parentNode}),this.__callback()},refresh:function(){return this.save_selected(),this.__call_old()},hover_node:function(obj){return obj=this._get_node(obj),obj.length?(obj.hasClass("jstree-hovered")||this.dehover_node(),this.data.ui.hovered=obj.children("a").addClass("jstree-hovered").parent(),this._fix_scroll(obj),void this.__callback({obj:obj})):!1},dehover_node:function(){var p,obj=this.data.ui.hovered;return obj&&obj.length?(p=obj.children("a").removeClass("jstree-hovered").parent(),this.data.ui.hovered[0]===p[0]&&(this.data.ui.hovered=null),void this.__callback({obj:obj})):!1},select_node:function(obj,check,e){if(obj=this._get_node(obj),-1==obj||!obj||!obj.length)return!1;var s=this._get_settings().ui,is_multiple="on"==s.select_multiple_modifier||s.select_multiple_modifier!==!1&&e&&e[s.select_multiple_modifier+"Key"],is_range=s.select_range_modifier!==!1&&e&&e[s.select_range_modifier+"Key"]&&this.data.ui.last_selected&&this.data.ui.last_selected[0]!==obj[0]&&this.data.ui.last_selected.parent()[0]===obj.parent()[0],is_selected=this.is_selected(obj),proceed=!0,t=this;if(check){if(s.disable_selecting_children&&is_multiple&&(obj.parentsUntil(".jstree","li").children("a.jstree-clicked").length||obj.children("ul").find("a.jstree-clicked:eq(0)").length))return!1;switch(proceed=!1,!0){case is_range:this.data.ui.last_selected.addClass("jstree-last-selected"),obj=obj[obj.index()<this.data.ui.last_selected.index()?"nextUntil":"prevUntil"](".jstree-last-selected").andSelf(),-1==s.select_limit||obj.length<s.select_limit?(this.data.ui.last_selected.removeClass("jstree-last-selected"),this.data.ui.selected.each(function(){this!==t.data.ui.last_selected[0]&&t.deselect_node(this)}),is_selected=!1,proceed=!0):proceed=!1;break;case is_selected&&!is_multiple:this.deselect_all(),is_selected=!1,proceed=!0;break;case!is_selected&&!is_multiple:(-1==s.select_limit||s.select_limit>0)&&(this.deselect_all(),proceed=!0);break;case is_selected&&is_multiple:this.deselect_node(obj);break;case!is_selected&&is_multiple:(-1==s.select_limit||this.data.ui.selected.length+1<=s.select_limit)&&(proceed=!0)}}proceed&&!is_selected&&(is_range||(this.data.ui.last_selected=obj),obj.children("a").addClass("jstree-clicked"),s.selected_parent_open&&obj.parents(".jstree-closed").each(function(){t.open_node(this,!1,!0)}),this.data.ui.selected=this.data.ui.selected.add(obj),this._fix_scroll(obj.eq(0)),this.__callback({obj:obj,e:e}))},_fix_scroll:function(obj){var t,c=this.get_container()[0];if(c.scrollHeight>c.offsetHeight){if(obj=this._get_node(obj),!obj||-1===obj||!obj.length||!obj.is(":visible"))return;t=obj.offset().top-this.get_container().offset().top,0>t&&(c.scrollTop=c.scrollTop+t-1),t+this.data.core.li_height+(c.scrollWidth>c.offsetWidth?scrollbar_width:0)>c.offsetHeight&&(c.scrollTop=c.scrollTop+(t-c.offsetHeight+this.data.core.li_height+1+(c.scrollWidth>c.offsetWidth?scrollbar_width:0)))}},deselect_node:function(obj){return obj=this._get_node(obj),obj.length?void(this.is_selected(obj)&&(obj.children("a").removeClass("jstree-clicked"),this.data.ui.selected=this.data.ui.selected.not(obj),this.data.ui.last_selected.get(0)===obj.get(0)&&(this.data.ui.last_selected=this.data.ui.selected.eq(0)),this.__callback({obj:obj}))):!1},toggle_select:function(obj){return obj=this._get_node(obj),obj.length?void(this.is_selected(obj)?this.deselect_node(obj):this.select_node(obj)):!1},is_selected:function(obj){return this.data.ui.selected.index(this._get_node(obj))>=0},get_selected:function(context){return context?$(context).find("a.jstree-clicked").parent():this.data.ui.selected},deselect_all:function(context){var ret=context?$(context).find("a.jstree-clicked").parent():this.get_container().find("a.jstree-clicked").parent();ret.children("a.jstree-clicked").removeClass("jstree-clicked"),this.data.ui.selected=$([]),this.data.ui.last_selected=!1,this.__callback({obj:ret})}}}),$.jstree.defaults.plugins.push("ui")}(jQuery),function($){$.jstree.plugin("crrm",{__init:function(){this.get_container().bind("move_node.jstree",$.proxy(function(e,data){if(this._get_settings().crrm.move.open_onmove){var t=this;data.rslt.np.parentsUntil(".jstree").andSelf().filter(".jstree-closed").each(function(){t.open_node(this,!1,!0)})}},this))},defaults:{input_width_limit:200,move:{always_copy:!1,open_onmove:!0,default_position:"last",check_move:function(){return!0}}},_fn:{_show_input:function(obj,callback){obj=this._get_node(obj);var rtl=this._get_settings().core.rtl,w=this._get_settings().crrm.input_width_limit,w1=obj.children("ins").width(),w2=obj.find("> a:visible > ins").width()*obj.find("> a:visible > ins").length,t=this.get_text(obj),h1=$("<div />",{css:{position:"absolute",top:"-200px",left:rtl?"0px":"-1000px",visibility:"hidden"}}).appendTo("body"),h2=obj.css("position","relative").append($("<input />",{value:t,"class":"jstree-rename-input",css:{padding:"0",border:"1px solid silver",position:"absolute",left:rtl?"auto":w1+w2+4+"px",right:rtl?w1+w2+4+"px":"auto",top:"0px",height:this.data.core.li_height-2+"px",lineHeight:this.data.core.li_height-2+"px",width:"150px"},blur:$.proxy(function(){var i=obj.children(".jstree-rename-input"),v=i.val();""===v&&(v=t),h1.remove(),i.remove(),this.set_text(obj,t),this.rename_node(obj,v),callback.call(this,obj,v,t),obj.css("position","")},this),keyup:function(event){var key=event.keyCode||event.which;return 27==key?(this.value=t,void this.blur()):13==key?void this.blur():void h2.width(Math.min(h1.text("pW"+this.value).width(),w))},keypress:function(event){var key=event.keyCode||event.which;return 13==key?!1:void 0}})).children(".jstree-rename-input");this.set_text(obj,""),h1.css({fontFamily:h2.css("fontFamily")||"",fontSize:h2.css("fontSize")||"",fontWeight:h2.css("fontWeight")||"",fontStyle:h2.css("fontStyle")||"",fontStretch:h2.css("fontStretch")||"",fontVariant:h2.css("fontVariant")||"",letterSpacing:h2.css("letterSpacing")||"",wordSpacing:h2.css("wordSpacing")||""}),h2.width(Math.min(h1.text("pW"+h2[0].value).width(),w))[0].select()},rename:function(obj){obj=this._get_node(obj),this.__rollback();var f=this.__callback;this._show_input(obj,function(obj,new_name,old_name){f.call(this,{obj:obj,new_name:new_name,old_name:old_name})})},create:function(obj,position,js,callback,skip_rename){var t,_this=this;return obj=this._get_node(obj),obj||(obj=-1),this.__rollback(),t=this.create_node(obj,position,js,function(t){var p=this._get_parent(t),pos=$(t).index();callback&&callback.call(this,t),p.length&&p.hasClass("jstree-closed")&&this.open_node(p,!1,!0),skip_rename?_this.__callback({obj:t,name:this.get_text(t),parent:p,position:pos}):this._show_input(t,function(obj,new_name){_this.__callback({obj:obj,name:new_name,parent:p,position:pos})})})},remove:function(obj){obj=this._get_node(obj,!0);var p=this._get_parent(obj),prev=this._get_prev(obj);this.__rollback(),obj=this.delete_node(obj),obj!==!1&&this.__callback({obj:obj,prev:prev,parent:p})},check_move:function(){if(!this.__call_old())return!1;var s=this._get_settings().crrm.move;return s.check_move.call(this,this._get_move())?!0:!1},move_node:function(obj,ref,position,is_copy,is_prepared,skip_check){var s=this._get_settings().crrm.move;return is_prepared?((s.always_copy===!0||"multitree"===s.always_copy&&obj.rt.get_index()!==obj.ot.get_index())&&(is_copy=!0),void this.__call_old(!0,obj,ref,position,is_copy,!0,skip_check)):("undefined"==typeof position&&(position=s.default_position),"inside"!==position||s.default_position.match(/^(before|after)$/)||(position=s.default_position),this.__call_old(!0,obj,ref,position,is_copy,!1,skip_check))},cut:function(obj){return obj=this._get_node(obj,!0),obj&&obj.length?(this.data.crrm.cp_nodes=!1,this.data.crrm.ct_nodes=obj,void this.__callback({obj:obj})):!1},copy:function(obj){return obj=this._get_node(obj,!0),obj&&obj.length?(this.data.crrm.ct_nodes=!1,this.data.crrm.cp_nodes=obj,void this.__callback({obj:obj})):!1},paste:function(obj){if(obj=this._get_node(obj),!obj||!obj.length)return!1;var nodes=this.data.crrm.ct_nodes?this.data.crrm.ct_nodes:this.data.crrm.cp_nodes;return this.data.crrm.ct_nodes||this.data.crrm.cp_nodes?(this.data.crrm.ct_nodes&&(this.move_node(this.data.crrm.ct_nodes,obj),this.data.crrm.ct_nodes=!1),this.data.crrm.cp_nodes&&this.move_node(this.data.crrm.cp_nodes,obj,!1,!0),void this.__callback({obj:obj,nodes:nodes})):!1}}})}(jQuery),function($){var themes_loaded=[];$.jstree._themes=!1,$.jstree.plugin("themes",{__init:function(){this.get_container().bind("init.jstree",$.proxy(function(){var s=this._get_settings().themes;this.data.themes.dots=s.dots,this.data.themes.icons=s.icons,this.set_theme(s.theme,s.url)},this)).bind("loaded.jstree",$.proxy(function(){this.data.themes.dots?this.show_dots():this.hide_dots(),this.data.themes.icons?this.show_icons():this.hide_icons()},this))},defaults:{theme:"default",url:!1,dots:!0,icons:!0},_fn:{set_theme:function(theme_name,theme_url){return theme_name?(theme_url||(theme_url=$.jstree._themes+theme_name+"/style.css"),-1==$.inArray(theme_url,themes_loaded)&&($.vakata.css.add_sheet({url:theme_url}),themes_loaded.push(theme_url)),this.data.themes.theme!=theme_name&&(this.get_container().removeClass("jstree-"+this.data.themes.theme),this.data.themes.theme=theme_name),this.get_container().addClass("jstree-"+theme_name),this.data.themes.dots?this.show_dots():this.hide_dots(),this.data.themes.icons?this.show_icons():this.hide_icons(),void this.__callback()):!1},get_theme:function(){return this.data.themes.theme},show_dots:function(){this.data.themes.dots=!0,this.get_container().children("ul").removeClass("jstree-no-dots")},hide_dots:function(){this.data.themes.dots=!1,this.get_container().children("ul").addClass("jstree-no-dots")},toggle_dots:function(){this.data.themes.dots?this.hide_dots():this.show_dots()},show_icons:function(){this.data.themes.icons=!0,this.get_container().children("ul").removeClass("jstree-no-icons")},hide_icons:function(){this.data.themes.icons=!1,this.get_container().children("ul").addClass("jstree-no-icons")},toggle_icons:function(){this.data.themes.icons?this.hide_icons():this.show_icons()}}}),$(function(){$.jstree._themes===!1&&$("script").each(function(){return this.src.toString().match(/jquery\.jstree[^\/]*?\.js(\?.*)?$/)?($.jstree._themes=this.src.toString().replace(/jquery\.jstree[^\/]*?\.js(\?.*)?$/,"")+"themes/",!1):void 0}),$.jstree._themes===!1&&($.jstree._themes="themes/")}),$.jstree.defaults.plugins.push("themes")}(jQuery),function($){function exec(i,event){var tmp,f=$.jstree._focused();return f&&f.data&&f.data.hotkeys&&f.data.hotkeys.enabled&&(tmp=f._get_settings().hotkeys[i])?tmp.call(f,event):void 0}var bound=[];$.jstree.plugin("hotkeys",{__init:function(){if("undefined"==typeof $.hotkeys)throw"jsTree hotkeys: jQuery hotkeys plugin not included.";if(!this.data.ui)throw"jsTree hotkeys: jsTree UI plugin not included.";$.each(this._get_settings().hotkeys,function(i,v){v!==!1&&-1==$.inArray(i,bound)&&($(document).bind("keydown",i,function(event){return exec(i,event)}),bound.push(i))}),this.get_container().bind("lock.jstree",$.proxy(function(){this.data.hotkeys.enabled&&(this.data.hotkeys.enabled=!1,this.data.hotkeys.revert=!0)},this)).bind("unlock.jstree",$.proxy(function(){this.data.hotkeys.revert&&(this.data.hotkeys.enabled=!0)},this)),this.enable_hotkeys()},defaults:{up:function(){var o=this.data.ui.hovered||this.data.ui.last_selected||-1;return this.hover_node(this._get_prev(o)),!1},"ctrl+up":function(){var o=this.data.ui.hovered||this.data.ui.last_selected||-1;return this.hover_node(this._get_prev(o)),!1},"shift+up":function(){var o=this.data.ui.hovered||this.data.ui.last_selected||-1;return this.hover_node(this._get_prev(o)),!1},down:function(){var o=this.data.ui.hovered||this.data.ui.last_selected||-1;return this.hover_node(this._get_next(o)),!1},"ctrl+down":function(){var o=this.data.ui.hovered||this.data.ui.last_selected||-1;return this.hover_node(this._get_next(o)),!1},"shift+down":function(){var o=this.data.ui.hovered||this.data.ui.last_selected||-1;return this.hover_node(this._get_next(o)),!1},left:function(){var o=this.data.ui.hovered||this.data.ui.last_selected;return o&&(o.hasClass("jstree-open")?this.close_node(o):this.hover_node(this._get_prev(o))),!1},"ctrl+left":function(){var o=this.data.ui.hovered||this.data.ui.last_selected;return o&&(o.hasClass("jstree-open")?this.close_node(o):this.hover_node(this._get_prev(o))),!1},"shift+left":function(){var o=this.data.ui.hovered||this.data.ui.last_selected;return o&&(o.hasClass("jstree-open")?this.close_node(o):this.hover_node(this._get_prev(o))),!1},right:function(){var o=this.data.ui.hovered||this.data.ui.last_selected;return o&&o.length&&(o.hasClass("jstree-closed")?this.open_node(o):this.hover_node(this._get_next(o))),!1},"ctrl+right":function(){var o=this.data.ui.hovered||this.data.ui.last_selected;return o&&o.length&&(o.hasClass("jstree-closed")?this.open_node(o):this.hover_node(this._get_next(o))),!1},"shift+right":function(){var o=this.data.ui.hovered||this.data.ui.last_selected;return o&&o.length&&(o.hasClass("jstree-closed")?this.open_node(o):this.hover_node(this._get_next(o))),!1},space:function(){return this.data.ui.hovered&&this.data.ui.hovered.children("a:eq(0)").click(),!1},"ctrl+space":function(event){return event.type="click",this.data.ui.hovered&&this.data.ui.hovered.children("a:eq(0)").trigger(event),!1},"shift+space":function(event){return event.type="click",this.data.ui.hovered&&this.data.ui.hovered.children("a:eq(0)").trigger(event),!1},f2:function(){this.rename(this.data.ui.hovered||this.data.ui.last_selected)},del:function(){this.remove(this.data.ui.hovered||this._get_node(null))}},_fn:{enable_hotkeys:function(){this.data.hotkeys.enabled=!0},disable_hotkeys:function(){this.data.hotkeys.enabled=!1}}})}(jQuery),function($){$.jstree.plugin("json_data",{__init:function(){var s=this._get_settings().json_data;s.progressive_unload&&this.get_container().bind("after_close.jstree",function(e,data){data.rslt.obj.children("ul").remove()})},defaults:{data:!1,ajax:!1,correct_state:!0,progressive_render:!1,progressive_unload:!1},_fn:{load_node:function(obj,s_call,e_call){var _this=this;this.load_node_json(obj,function(){_this.__callback({obj:_this._get_node(obj)}),s_call.call(this)},e_call)},_is_loaded:function(obj){var s=this._get_settings().json_data;return obj=this._get_node(obj),-1==obj||!obj||!s.ajax&&!s.progressive_render&&!$.isFunction(s.data)||obj.is(".jstree-open, .jstree-leaf")||obj.children("ul").children("li").length>0},refresh:function(obj){obj=this._get_node(obj);var s=this._get_settings().json_data;return obj&&-1!==obj&&s.progressive_unload&&($.isFunction(s.data)||s.ajax)&&obj.removeData("jstree_children"),this.__call_old()},load_node_json:function(obj,s_call,e_call){var d,s=this.get_settings().json_data,error_func=function(){},success_func=function(){};if(obj=this._get_node(obj),obj&&-1!==obj&&(s.progressive_render||s.progressive_unload)&&!obj.is(".jstree-open, .jstree-leaf")&&0===obj.children("ul").children("li").length&&obj.data("jstree_children"))return d=this._parse_json(obj.data("jstree_children"),obj),d&&(obj.append(d),s.progressive_unload||obj.removeData("jstree_children")),this.clean_node(obj),void(s_call&&s_call.call(this));if(obj&&-1!==obj){if(obj.data("jstree_is_loading"))return;obj.data("jstree_is_loading",!0)}switch(!0){case!s.data&&!s.ajax:throw"Neither data nor ajax settings supplied.";case $.isFunction(s.data):s.data.call(this,obj,$.proxy(function(d){d=this._parse_json(d,obj),d?(-1!==obj&&obj?(obj.append(d).children("a.jstree-loading").removeClass("jstree-loading"),obj.removeData("jstree_is_loading")):this.get_container().children("ul").empty().append(d.children()),this.clean_node(obj),s_call&&s_call.call(this)):(-1!==obj&&obj?(obj.children("a.jstree-loading").removeClass("jstree-loading"),obj.removeData("jstree_is_loading"),s.correct_state&&this.correct_state(obj)):s.correct_state&&this.get_container().children("ul").empty(),e_call&&e_call.call(this))},this));break;case!!s.data&&!s.ajax||!!s.data&&!!s.ajax&&(!obj||-1===obj):obj&&-1!=obj||(d=this._parse_json(s.data,obj),d?(this.get_container().children("ul").empty().append(d.children()),this.clean_node()):s.correct_state&&this.get_container().children("ul").empty()),s_call&&s_call.call(this);break;case!s.data&&!!s.ajax||!!s.data&&!!s.ajax&&obj&&-1!==obj:error_func=function(x,t,e){var ef=this.get_settings().json_data.ajax.error;ef&&ef.call(this,x,t,e),-1!=obj&&obj.length?(obj.children("a.jstree-loading").removeClass("jstree-loading"),obj.removeData("jstree_is_loading"),"success"===t&&s.correct_state&&this.correct_state(obj)):"success"===t&&s.correct_state&&this.get_container().children("ul").empty(),e_call&&e_call.call(this)},success_func=function(d,t,x){var sf=this.get_settings().json_data.ajax.success;return sf&&(d=sf.call(this,d,t,x)||d),""===d||d&&d.toString&&""===d.toString().replace(/^[\s\n]+$/,"")||!$.isArray(d)&&!$.isPlainObject(d)?error_func.call(this,x,t,""):(d=this._parse_json(d,obj),void(d?(-1!==obj&&obj?(obj.append(d).children("a.jstree-loading").removeClass("jstree-loading"),obj.removeData("jstree_is_loading")):this.get_container().children("ul").empty().append(d.children()),this.clean_node(obj),s_call&&s_call.call(this)):-1!==obj&&obj?(obj.children("a.jstree-loading").removeClass("jstree-loading"),obj.removeData("jstree_is_loading"),s.correct_state&&(this.correct_state(obj),s_call&&s_call.call(this))):s.correct_state&&(this.get_container().children("ul").empty(),s_call&&s_call.call(this))))},s.ajax.context=this,s.ajax.error=error_func,s.ajax.success=success_func,s.ajax.dataType||(s.ajax.dataType="json"),$.isFunction(s.ajax.url)&&(s.ajax.url=s.ajax.url.call(this,obj)),$.isFunction(s.ajax.data)&&(s.ajax.data=s.ajax.data.call(this,obj)),$.ajax(s.ajax)}},_parse_json:function(js,obj,is_callback){var tmp,i,j,ul1,ul2,d=!1,p=this._get_settings(),s=p.json_data,t=p.core.html_titles;if(!js)return d;if(s.progressive_unload&&obj&&-1!==obj&&obj.data("jstree_children",d),$.isArray(js)){if(d=$(),!js.length)return!1;for(i=0,j=js.length;j>i;i++)tmp=this._parse_json(js[i],obj,!0),tmp.length&&(d=d.add(tmp))}else{if("string"==typeof js&&(js={data:js}),!js.data&&""!==js.data)return d;d=$("<li />"),js.attr&&d.attr(js.attr),js.metadata&&d.data(js.metadata),js.state&&d.addClass("jstree-"+js.state),$.isArray(js.data)||(tmp=js.data,js.data=[],js.data.push(tmp)),$.each(js.data,function(i,m){tmp=$("<a />"),$.isFunction(m)&&(m=m.call(this,js)),"string"==typeof m?tmp.attr("href","#")[t?"html":"text"](m):(m.attr||(m.attr={}),m.attr.href||(m.attr.href="#"),tmp.attr(m.attr)[t?"html":"text"](m.title),m.language&&tmp.addClass(m.language)),tmp.prepend("<ins class='jstree-icon'>&#160;</ins>"),!m.icon&&js.icon&&(m.icon=js.icon),m.icon&&(-1===m.icon.indexOf("/")?tmp.children("ins").addClass(m.icon):tmp.children("ins").css("background","url('"+m.icon+"') center center no-repeat")),d.append(tmp)}),d.prepend("<ins class='jstree-icon'>&#160;</ins>"),js.children&&(s.progressive_render&&"open"!==js.state?d.addClass("jstree-closed").data("jstree_children",js.children):(s.progressive_unload&&d.data("jstree_children",js.children),$.isArray(js.children)&&js.children.length&&(tmp=this._parse_json(js.children,obj,!0),tmp.length&&(ul2=$("<ul />"),ul2.append(tmp),d.append(ul2)))))}return is_callback||(ul1=$("<ul />"),ul1.append(d),d=ul1),d},get_json:function(obj,li_attr,a_attr,is_callback){var tmp1,tmp2,li,a,t,lang,result=[],s=this._get_settings(),_this=this;return obj=this._get_node(obj),obj&&-1!==obj||(obj=this.get_container().find("> ul > li")),li_attr=$.isArray(li_attr)?li_attr:["id","class"],!is_callback&&this.data.types&&li_attr.push(s.types.type_attr),a_attr=$.isArray(a_attr)?a_attr:[],obj.each(function(){li=$(this),tmp1={data:[]},li_attr.length&&(tmp1.attr={}),$.each(li_attr,function(i,v){tmp2=li.attr(v),tmp2&&tmp2.length&&tmp2.replace(/jstree[^ ]*/gi,"").length&&(tmp1.attr[v]=(" "+tmp2).replace(/ jstree[^ ]*/gi,"").replace(/\s+$/gi," ").replace(/^ /,"").replace(/ $/,""))}),li.hasClass("jstree-open")&&(tmp1.state="open"),li.hasClass("jstree-closed")&&(tmp1.state="closed"),li.data()&&(tmp1.metadata=li.data()),a=li.children("a"),a.each(function(){t=$(this),a_attr.length||-1!==$.inArray("languages",s.plugins)||t.children("ins").get(0).style.backgroundImage.length||t.children("ins").get(0).className&&t.children("ins").get(0).className.replace(/jstree[^ ]*|$/gi,"").length?(lang=!1,-1!==$.inArray("languages",s.plugins)&&$.isArray(s.languages)&&s.languages.length&&$.each(s.languages,function(l,lv){return t.hasClass(lv)?(lang=lv,!1):void 0}),tmp2={attr:{},title:_this.get_text(t,lang)},$.each(a_attr,function(k,z){tmp2.attr[z]=(" "+(t.attr(z)||"")).replace(/ jstree[^ ]*/gi,"").replace(/\s+$/gi," ").replace(/^ /,"").replace(/ $/,"")}),-1!==$.inArray("languages",s.plugins)&&$.isArray(s.languages)&&s.languages.length&&$.each(s.languages,function(k,z){return t.hasClass(z)?(tmp2.language=z,!0):void 0}),t.children("ins").get(0).className.replace(/jstree[^ ]*|$/gi,"").replace(/^\s+$/gi,"").length&&(tmp2.icon=t.children("ins").get(0).className.replace(/jstree[^ ]*|$/gi,"").replace(/\s+$/gi," ").replace(/^ /,"").replace(/ $/,"")),t.children("ins").get(0).style.backgroundImage.length&&(tmp2.icon=t.children("ins").get(0).style.backgroundImage.replace("url(","").replace(")",""))):tmp2=_this.get_text(t),a.length>1?tmp1.data.push(tmp2):tmp1.data=tmp2}),li=li.find("> ul > li"),li.length&&(tmp1.children=_this.get_json(li,li_attr,a_attr,!0)),result.push(tmp1)}),result}}})}(jQuery),function($){$.jstree.plugin("languages",{__init:function(){this._load_css()},defaults:[],_fn:{set_lang:function(i){var langs=this._get_settings().languages,st=!1,selector=".jstree-"+this.get_index()+" a";if(!$.isArray(langs)||0===langs.length)return!1;if(-1==$.inArray(i,langs)){if(!langs[i])return!1;i=langs[i]}return i==this.data.languages.current_language?!0:(st=$.vakata.css.get_css(selector+"."+this.data.languages.current_language,!1,this.data.languages.language_css),st!==!1&&(st.style.display="none"),st=$.vakata.css.get_css(selector+"."+i,!1,this.data.languages.language_css),st!==!1&&(st.style.display=""),this.data.languages.current_language=i,this.__callback(i),!0)},get_lang:function(){return this.data.languages.current_language},_get_string:function(key,lang){var langs=this._get_settings().languages,s=this._get_settings().core.strings;return $.isArray(langs)&&langs.length&&(lang=lang&&-1!=$.inArray(lang,langs)?lang:this.data.languages.current_language),s[lang]&&s[lang][key]?s[lang][key]:s[key]?s[key]:key},get_text:function(obj,lang){if(obj=this._get_node(obj)||this.data.ui.last_selected,!obj.size())return!1;var langs=this._get_settings().languages,s=this._get_settings().core.html_titles;return $.isArray(langs)&&langs.length?(lang=lang&&-1!=$.inArray(lang,langs)?lang:this.data.languages.current_language,obj=obj.children("a."+lang)):obj=obj.children("a:eq(0)"),s?(obj=obj.clone(),obj.children("INS").remove(),obj.html()):(obj=obj.contents().filter(function(){return 3==this.nodeType})[0],obj.nodeValue)},set_text:function(obj,val,lang){if(obj=this._get_node(obj)||this.data.ui.last_selected,!obj.size())return!1;var tmp,langs=this._get_settings().languages,s=this._get_settings().core.html_titles;return $.isArray(langs)&&langs.length?(lang=lang&&-1!=$.inArray(lang,langs)?lang:this.data.languages.current_language,obj=obj.children("a."+lang)):obj=obj.children("a:eq(0)"),s?(tmp=obj.children("INS").clone(),obj.html(val).prepend(tmp),this.__callback({obj:obj,name:val,lang:lang}),!0):(obj=obj.contents().filter(function(){return 3==this.nodeType})[0],this.__callback({obj:obj,name:val,lang:lang}),obj.nodeValue=val)},_load_css:function(){var ln,langs=this._get_settings().languages,str="/* languages css */",selector=".jstree-"+this.get_index()+" a";if($.isArray(langs)&&langs.length){for(this.data.languages.current_language=langs[0],ln=0;ln<langs.length;ln++)str+=selector+"."+langs[ln]+" {",langs[ln]!=this.data.languages.current_language&&(str+=" display:none; "),str+=" } ";this.data.languages.language_css=$.vakata.css.add_sheet({str:str,title:"jstree-languages"})}},create_node:function(obj,position,js,callback){var t=this.__call_old(!0,obj,position,js,function(t){var ln,langs=this._get_settings().languages,a=t.children("a");if($.isArray(langs)&&langs.length){for(ln=0;ln<langs.length;ln++)a.is("."+langs[ln])||t.append(a.eq(0).clone().removeClass(langs.join(" ")).addClass(langs[ln]));a.not("."+langs.join(", .")).remove()}callback&&callback.call(this,t)});return t}}})}(jQuery),function($){$.jstree.plugin("cookies",{__init:function(){if("undefined"==typeof $.cookie)throw"jsTree cookie: jQuery cookie plugin not included.";var tmp,s=this._get_settings().cookies;s.save_loaded&&(tmp=$.cookie(s.save_loaded),tmp&&tmp.length&&(this.data.core.to_load=tmp.split(","))),s.save_opened&&(tmp=$.cookie(s.save_opened),tmp&&tmp.length&&(this.data.core.to_open=tmp.split(","))),s.save_selected&&(tmp=$.cookie(s.save_selected),tmp&&tmp.length&&this.data.ui&&(this.data.ui.to_select=tmp.split(","))),this.get_container().one((this.data.ui?"reselect":"reopen")+".jstree",$.proxy(function(){this.get_container().bind("open_node.jstree close_node.jstree select_node.jstree deselect_node.jstree",$.proxy(function(e){this._get_settings().cookies.auto_save&&this.save_cookie((e.handleObj.namespace+e.handleObj.type).replace("jstree",""))},this))},this))},defaults:{save_loaded:"jstree_load",save_opened:"jstree_open",save_selected:"jstree_select",auto_save:!0,cookie_options:{}},_fn:{save_cookie:function(c){if(!this.data.core.refreshing){var s=this._get_settings().cookies;if(!c)return s.save_loaded&&(this.save_loaded(),$.cookie(s.save_loaded,this.data.core.to_load.join(","),s.cookie_options)),s.save_opened&&(this.save_opened(),$.cookie(s.save_opened,this.data.core.to_open.join(","),s.cookie_options)),void(s.save_selected&&this.data.ui&&(this.save_selected(),$.cookie(s.save_selected,this.data.ui.to_select.join(","),s.cookie_options)));
switch(c){case"open_node":case"close_node":s.save_opened&&(this.save_opened(),$.cookie(s.save_opened,this.data.core.to_open.join(","),s.cookie_options)),s.save_loaded&&(this.save_loaded(),$.cookie(s.save_loaded,this.data.core.to_load.join(","),s.cookie_options));break;case"select_node":case"deselect_node":s.save_selected&&this.data.ui&&(this.save_selected(),$.cookie(s.save_selected,this.data.ui.to_select.join(","),s.cookie_options))}}}}})}(jQuery),function($){$.jstree.plugin("sort",{__init:function(){this.get_container().bind("load_node.jstree",$.proxy(function(e,data){var obj=this._get_node(data.rslt.obj);obj=-1===obj?this.get_container().children("ul"):obj.children("ul"),this.sort(obj)},this)).bind("rename_node.jstree create_node.jstree create.jstree",$.proxy(function(e,data){this.sort(data.rslt.obj.parent())},this)).bind("move_node.jstree",$.proxy(function(e,data){var m=-1==data.rslt.np?this.get_container():data.rslt.np;this.sort(m.children("ul"))},this))},defaults:function(a,b){return this.get_text(a)>this.get_text(b)?1:-1},_fn:{sort:function(obj){var s=this._get_settings().sort,t=this;obj.append($.makeArray(obj.children("li")).sort($.proxy(s,t))),obj.find("> li > ul").each(function(){t.sort($(this))}),this.clean_node(obj)}}})}(jQuery),function($){var o=!1,r=!1,m=!1,ml=!1,sli=!1,sti=!1,dir1=!1,dir2=!1,last_pos=!1;$.vakata.dnd={is_down:!1,is_drag:!1,helper:!1,scroll_spd:10,init_x:0,init_y:0,threshold:5,helper_left:5,helper_top:10,user_data:{},drag_start:function(e,data,html){$.vakata.dnd.is_drag&&$.vakata.drag_stop({});try{e.currentTarget.unselectable="on",e.currentTarget.onselectstart=function(){return!1},e.currentTarget.style&&(e.currentTarget.style.MozUserSelect="none")}catch(err){}return $.vakata.dnd.init_x=e.pageX,$.vakata.dnd.init_y=e.pageY,$.vakata.dnd.user_data=data,$.vakata.dnd.is_down=!0,$.vakata.dnd.helper=$("<div id='vakata-dragged' />").html(html),$(document).bind("mousemove",$.vakata.dnd.drag),$(document).bind("mouseup",$.vakata.dnd.drag_stop),!1},drag:function(e){if($.vakata.dnd.is_down){if(!$.vakata.dnd.is_drag){if(!(Math.abs(e.pageX-$.vakata.dnd.init_x)>5||Math.abs(e.pageY-$.vakata.dnd.init_y)>5))return;$.vakata.dnd.helper.appendTo("body"),$.vakata.dnd.is_drag=!0,$(document).triggerHandler("drag_start.vakata",{event:e,data:$.vakata.dnd.user_data})}if("mousemove"===e.type){var d=$(document),t=d.scrollTop(),l=d.scrollLeft();e.pageY-t<20?(sti&&"down"===dir1&&(clearInterval(sti),sti=!1),sti||(dir1="up",sti=setInterval(function(){$(document).scrollTop($(document).scrollTop()-$.vakata.dnd.scroll_spd)},150))):sti&&"up"===dir1&&(clearInterval(sti),sti=!1),$(window).height()-(e.pageY-t)<20?(sti&&"up"===dir1&&(clearInterval(sti),sti=!1),sti||(dir1="down",sti=setInterval(function(){$(document).scrollTop($(document).scrollTop()+$.vakata.dnd.scroll_spd)},150))):sti&&"down"===dir1&&(clearInterval(sti),sti=!1),e.pageX-l<20?(sli&&"right"===dir2&&(clearInterval(sli),sli=!1),sli||(dir2="left",sli=setInterval(function(){$(document).scrollLeft($(document).scrollLeft()-$.vakata.dnd.scroll_spd)},150))):sli&&"left"===dir2&&(clearInterval(sli),sli=!1),$(window).width()-(e.pageX-l)<20?(sli&&"left"===dir2&&(clearInterval(sli),sli=!1),sli||(dir2="right",sli=setInterval(function(){$(document).scrollLeft($(document).scrollLeft()+$.vakata.dnd.scroll_spd)},150))):sli&&"right"===dir2&&(clearInterval(sli),sli=!1)}$.vakata.dnd.helper.css({left:e.pageX+$.vakata.dnd.helper_left+"px",top:e.pageY+$.vakata.dnd.helper_top+"px"}),$(document).triggerHandler("drag.vakata",{event:e,data:$.vakata.dnd.user_data})}},drag_stop:function(e){sli&&clearInterval(sli),sti&&clearInterval(sti),$(document).unbind("mousemove",$.vakata.dnd.drag),$(document).unbind("mouseup",$.vakata.dnd.drag_stop),$(document).triggerHandler("drag_stop.vakata",{event:e,data:$.vakata.dnd.user_data}),$.vakata.dnd.helper.remove(),$.vakata.dnd.init_x=0,$.vakata.dnd.init_y=0,$.vakata.dnd.user_data={},$.vakata.dnd.is_down=!1,$.vakata.dnd.is_drag=!1}},$(function(){var css_string="#vakata-dragged { display:block; margin:0 0 0 0; padding:4px 4px 4px 24px; position:absolute; top:-2000px; line-height:16px; z-index:10000; } ";$.vakata.css.add_sheet({str:css_string,title:"vakata"})}),$.jstree.plugin("dnd",{__init:function(){this.data.dnd={active:!1,after:!1,inside:!1,before:!1,off:!1,prepared:!1,w:0,to1:!1,to2:!1,cof:!1,cw:!1,ch:!1,i1:!1,i2:!1,mto:!1},this.get_container().bind("mouseenter.jstree",$.proxy(function(e){if($.vakata.dnd.is_drag&&$.vakata.dnd.user_data.jstree&&(this.data.themes&&(m.attr("class","jstree-"+this.data.themes.theme),ml&&ml.attr("class","jstree-"+this.data.themes.theme),$.vakata.dnd.helper.attr("class","jstree-dnd-helper jstree-"+this.data.themes.theme)),e.currentTarget===e.target&&$.vakata.dnd.user_data.obj&&$($.vakata.dnd.user_data.obj).length&&$($.vakata.dnd.user_data.obj).parents(".jstree:eq(0)")[0]!==e.target)){var dc,tr=$.jstree._reference(e.target);tr.data.dnd.foreign?(dc=tr._get_settings().dnd.drag_check.call(this,{o:o,r:tr.get_container(),is_root:!0}),(dc===!0||dc.inside===!0||dc.before===!0||dc.after===!0)&&$.vakata.dnd.helper.children("ins").attr("class","jstree-ok")):(tr.prepare_move(o,tr.get_container(),"last"),tr.check_move()&&$.vakata.dnd.helper.children("ins").attr("class","jstree-ok"))}},this)).bind("mouseup.jstree",$.proxy(function(e){if($.vakata.dnd.is_drag&&$.vakata.dnd.user_data.jstree&&e.currentTarget===e.target&&$.vakata.dnd.user_data.obj&&$($.vakata.dnd.user_data.obj).length&&$($.vakata.dnd.user_data.obj).parents(".jstree:eq(0)")[0]!==e.target){var dc,tr=$.jstree._reference(e.currentTarget);tr.data.dnd.foreign?(dc=tr._get_settings().dnd.drag_check.call(this,{o:o,r:tr.get_container(),is_root:!0}),(dc===!0||dc.inside===!0||dc.before===!0||dc.after===!0)&&tr._get_settings().dnd.drag_finish.call(this,{o:o,r:tr.get_container(),is_root:!0})):tr.move_node(o,tr.get_container(),"last",e[tr._get_settings().dnd.copy_modifier+"Key"])}},this)).bind("mouseleave.jstree",$.proxy(function(e){return e.relatedTarget&&e.relatedTarget.id&&"jstree-marker-line"===e.relatedTarget.id?!1:void($.vakata.dnd.is_drag&&$.vakata.dnd.user_data.jstree&&(this.data.dnd.i1&&clearInterval(this.data.dnd.i1),this.data.dnd.i2&&clearInterval(this.data.dnd.i2),this.data.dnd.to1&&clearTimeout(this.data.dnd.to1),this.data.dnd.to2&&clearTimeout(this.data.dnd.to2),$.vakata.dnd.helper.children("ins").hasClass("jstree-ok")&&$.vakata.dnd.helper.children("ins").attr("class","jstree-invalid")))},this)).bind("mousemove.jstree",$.proxy(function(e){if($.vakata.dnd.is_drag&&$.vakata.dnd.user_data.jstree){var cnt=this.get_container()[0];e.pageX+24>this.data.dnd.cof.left+this.data.dnd.cw?(this.data.dnd.i1&&clearInterval(this.data.dnd.i1),this.data.dnd.i1=setInterval($.proxy(function(){this.scrollLeft+=$.vakata.dnd.scroll_spd},cnt),100)):e.pageX-24<this.data.dnd.cof.left?(this.data.dnd.i1&&clearInterval(this.data.dnd.i1),this.data.dnd.i1=setInterval($.proxy(function(){this.scrollLeft-=$.vakata.dnd.scroll_spd},cnt),100)):this.data.dnd.i1&&clearInterval(this.data.dnd.i1),e.pageY+24>this.data.dnd.cof.top+this.data.dnd.ch?(this.data.dnd.i2&&clearInterval(this.data.dnd.i2),this.data.dnd.i2=setInterval($.proxy(function(){this.scrollTop+=$.vakata.dnd.scroll_spd},cnt),100)):e.pageY-24<this.data.dnd.cof.top?(this.data.dnd.i2&&clearInterval(this.data.dnd.i2),this.data.dnd.i2=setInterval($.proxy(function(){this.scrollTop-=$.vakata.dnd.scroll_spd},cnt),100)):this.data.dnd.i2&&clearInterval(this.data.dnd.i2)}},this)).bind("scroll.jstree",$.proxy(function(){$.vakata.dnd.is_drag&&$.vakata.dnd.user_data.jstree&&m&&ml&&(m.hide(),ml.hide())},this)).delegate("a","mousedown.jstree",$.proxy(function(e){return 1===e.which?(this.start_drag(e.currentTarget,e),!1):void 0},this)).delegate("a","mouseenter.jstree",$.proxy(function(e){$.vakata.dnd.is_drag&&$.vakata.dnd.user_data.jstree&&this.dnd_enter(e.currentTarget)},this)).delegate("a","mousemove.jstree",$.proxy(function(e){$.vakata.dnd.is_drag&&$.vakata.dnd.user_data.jstree&&(r&&r.length&&r.children("a")[0]===e.currentTarget||this.dnd_enter(e.currentTarget),"undefined"==typeof this.data.dnd.off.top&&(this.data.dnd.off=$(e.target).offset()),this.data.dnd.w=(e.pageY-(this.data.dnd.off.top||0))%this.data.core.li_height,this.data.dnd.w<0&&(this.data.dnd.w+=this.data.core.li_height),this.dnd_show())},this)).delegate("a","mouseleave.jstree",$.proxy(function(e){if($.vakata.dnd.is_drag&&$.vakata.dnd.user_data.jstree){if(e.relatedTarget&&e.relatedTarget.id&&"jstree-marker-line"===e.relatedTarget.id)return!1;m&&m.hide(),ml&&ml.hide(),this.data.dnd.mto=setTimeout(function(t){return function(){t.dnd_leave(e)}}(this),0)}},this)).delegate("a","mouseup.jstree",$.proxy(function(e){$.vakata.dnd.is_drag&&$.vakata.dnd.user_data.jstree&&this.dnd_finish(e)},this)),$(document).bind("drag_stop.vakata",$.proxy(function(){this.data.dnd.to1&&clearTimeout(this.data.dnd.to1),this.data.dnd.to2&&clearTimeout(this.data.dnd.to2),this.data.dnd.i1&&clearInterval(this.data.dnd.i1),this.data.dnd.i2&&clearInterval(this.data.dnd.i2),this.data.dnd.after=!1,this.data.dnd.before=!1,this.data.dnd.inside=!1,this.data.dnd.off=!1,this.data.dnd.prepared=!1,this.data.dnd.w=!1,this.data.dnd.to1=!1,this.data.dnd.to2=!1,this.data.dnd.i1=!1,this.data.dnd.i2=!1,this.data.dnd.active=!1,this.data.dnd.foreign=!1,m&&m.css({top:"-2000px"}),ml&&ml.css({top:"-2000px"})},this)).bind("drag_start.vakata",$.proxy(function(e,data){if(data.data.jstree){var et=$(data.event.target);et.closest(".jstree").hasClass("jstree-"+this.get_index())&&this.dnd_enter(et)}},this));var s=this._get_settings().dnd;s.drag_target&&$(document).delegate(s.drag_target,"mousedown.jstree-"+this.get_index(),$.proxy(function(e){o=e.target,$.vakata.dnd.drag_start(e,{jstree:!0,obj:e.target},"<ins class='jstree-icon'></ins>"+$(e.target).text()),this.data.themes&&(m&&m.attr("class","jstree-"+this.data.themes.theme),ml&&ml.attr("class","jstree-"+this.data.themes.theme),$.vakata.dnd.helper.attr("class","jstree-dnd-helper jstree-"+this.data.themes.theme)),$.vakata.dnd.helper.children("ins").attr("class","jstree-invalid");var cnt=this.get_container();this.data.dnd.cof=cnt.offset(),this.data.dnd.cw=parseInt(cnt.width(),10),this.data.dnd.ch=parseInt(cnt.height(),10),this.data.dnd.foreign=!0,e.preventDefault()},this)),s.drop_target&&$(document).delegate(s.drop_target,"mouseenter.jstree-"+this.get_index(),$.proxy(function(e){this.data.dnd.active&&this._get_settings().dnd.drop_check.call(this,{o:o,r:$(e.target),e:e})&&$.vakata.dnd.helper.children("ins").attr("class","jstree-ok")},this)).delegate(s.drop_target,"mouseleave.jstree-"+this.get_index(),$.proxy(function(){this.data.dnd.active&&$.vakata.dnd.helper.children("ins").attr("class","jstree-invalid")},this)).delegate(s.drop_target,"mouseup.jstree-"+this.get_index(),$.proxy(function(e){this.data.dnd.active&&$.vakata.dnd.helper.children("ins").hasClass("jstree-ok")&&this._get_settings().dnd.drop_finish.call(this,{o:o,r:$(e.target),e:e})},this))},defaults:{copy_modifier:"ctrl",check_timeout:100,open_timeout:500,drop_target:".jstree-drop",drop_check:function(){return!0},drop_finish:$.noop,drag_target:".jstree-draggable",drag_finish:$.noop,drag_check:function(){return{after:!1,before:!1,inside:!0}}},_fn:{dnd_prepare:function(){if(r&&r.length){if(this.data.dnd.off=r.offset(),this._get_settings().core.rtl&&(this.data.dnd.off.right=this.data.dnd.off.left+r.width()),this.data.dnd.foreign){var a=this._get_settings().dnd.drag_check.call(this,{o:o,r:r});return this.data.dnd.after=a.after,this.data.dnd.before=a.before,this.data.dnd.inside=a.inside,this.data.dnd.prepared=!0,this.dnd_show()}return this.prepare_move(o,r,"before"),this.data.dnd.before=this.check_move(),this.prepare_move(o,r,"after"),this.data.dnd.after=this.check_move(),this._is_loaded(r)?(this.prepare_move(o,r,"inside"),this.data.dnd.inside=this.check_move()):this.data.dnd.inside=!1,this.data.dnd.prepared=!0,this.dnd_show()}},dnd_show:function(){if(this.data.dnd.prepared){var pos,o=["before","inside","after"],r=!1,rtl=this._get_settings().core.rtl;switch(o=this.data.dnd.w<this.data.core.li_height/3?["before","inside","after"]:this.data.dnd.w<=2*this.data.core.li_height/3?this.data.dnd.w<this.data.core.li_height/2?["inside","before","after"]:["inside","after","before"]:["after","inside","before"],$.each(o,$.proxy(function(i,val){return this.data.dnd[val]?($.vakata.dnd.helper.children("ins").attr("class","jstree-ok"),r=val,!1):void 0},this)),r===!1&&$.vakata.dnd.helper.children("ins").attr("class","jstree-invalid"),pos=rtl?this.data.dnd.off.right-18:this.data.dnd.off.left+10,r){case"before":m.css({left:pos+"px",top:this.data.dnd.off.top-6+"px"}).show(),ml&&ml.css({left:pos+8+"px",top:this.data.dnd.off.top-1+"px"}).show();break;case"after":m.css({left:pos+"px",top:this.data.dnd.off.top+this.data.core.li_height-6+"px"}).show(),ml&&ml.css({left:pos+8+"px",top:this.data.dnd.off.top+this.data.core.li_height-1+"px"}).show();break;case"inside":m.css({left:pos+(rtl?-4:4)+"px",top:this.data.dnd.off.top+this.data.core.li_height/2-5+"px"}).show(),ml&&ml.hide();break;default:m.hide(),ml&&ml.hide()}return last_pos=r,r}},dnd_open:function(){this.data.dnd.to2=!1,this.open_node(r,$.proxy(this.dnd_prepare,this),!0)},dnd_finish:function(e){this.data.dnd.foreign?(this.data.dnd.after||this.data.dnd.before||this.data.dnd.inside)&&this._get_settings().dnd.drag_finish.call(this,{o:o,r:r,p:last_pos}):(this.dnd_prepare(),this.move_node(o,r,last_pos,e[this._get_settings().dnd.copy_modifier+"Key"])),o=!1,r=!1,m.hide(),ml&&ml.hide()},dnd_enter:function(obj){this.data.dnd.mto&&(clearTimeout(this.data.dnd.mto),this.data.dnd.mto=!1);var s=this._get_settings().dnd;this.data.dnd.prepared=!1,r=this._get_node(obj),s.check_timeout?(this.data.dnd.to1&&clearTimeout(this.data.dnd.to1),this.data.dnd.to1=setTimeout($.proxy(this.dnd_prepare,this),s.check_timeout)):this.dnd_prepare(),s.open_timeout?(this.data.dnd.to2&&clearTimeout(this.data.dnd.to2),r&&r.length&&r.hasClass("jstree-closed")&&(this.data.dnd.to2=setTimeout($.proxy(this.dnd_open,this),s.open_timeout))):r&&r.length&&r.hasClass("jstree-closed")&&this.dnd_open()},dnd_leave:function(e){this.data.dnd.after=!1,this.data.dnd.before=!1,this.data.dnd.inside=!1,$.vakata.dnd.helper.children("ins").attr("class","jstree-invalid"),m.hide(),ml&&ml.hide(),r&&r[0]===e.target.parentNode&&(this.data.dnd.to1&&(clearTimeout(this.data.dnd.to1),this.data.dnd.to1=!1),this.data.dnd.to2&&(clearTimeout(this.data.dnd.to2),this.data.dnd.to2=!1))},start_drag:function(obj,e){o=this._get_node(obj),this.data.ui&&this.is_selected(o)&&(o=this._get_node(null,!0));var dt=o.length>1?this._get_string("multiple_selection"):this.get_text(o),cnt=this.get_container();this._get_settings().core.html_titles||(dt=dt.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")),$.vakata.dnd.drag_start(e,{jstree:!0,obj:o},"<ins class='jstree-icon'></ins>"+dt),this.data.themes&&(m&&m.attr("class","jstree-"+this.data.themes.theme),ml&&ml.attr("class","jstree-"+this.data.themes.theme),$.vakata.dnd.helper.attr("class","jstree-dnd-helper jstree-"+this.data.themes.theme)),this.data.dnd.cof=cnt.offset(),this.data.dnd.cw=parseInt(cnt.width(),10),this.data.dnd.ch=parseInt(cnt.height(),10),this.data.dnd.active=!0}}}),$(function(){var css_string="#vakata-dragged ins { display:block; text-decoration:none; width:16px; height:16px; margin:0 0 0 0; padding:0; position:absolute; top:4px; left:4px;  -moz-border-radius:4px; border-radius:4px; -webkit-border-radius:4px; } #vakata-dragged .jstree-ok { background:green; } #vakata-dragged .jstree-invalid { background:red; } #jstree-marker { padding:0; margin:0; font-size:12px; overflow:hidden; height:12px; width:8px; position:absolute; top:-30px; z-index:10001; background-repeat:no-repeat; display:none; background-color:transparent; text-shadow:1px 1px 1px white; color:black; line-height:10px; } #jstree-marker-line { padding:0; margin:0; line-height:0%; font-size:1px; overflow:hidden; height:1px; width:100px; position:absolute; top:-30px; z-index:10000; background-repeat:no-repeat; display:none; background-color:#456c43;  cursor:pointer; border:1px solid #eeeeee; border-left:0; -moz-box-shadow: 0px 0px 2px #666; -webkit-box-shadow: 0px 0px 2px #666; box-shadow: 0px 0px 2px #666;  -moz-border-radius:1px; border-radius:1px; -webkit-border-radius:1px; }";$.vakata.css.add_sheet({str:css_string,title:"jstree"}),m=$("<div />").attr({id:"jstree-marker"}).hide().html("&raquo;").bind("mouseleave mouseenter",function(e){return m.hide(),ml.hide(),e.preventDefault(),e.stopImmediatePropagation(),!1}).appendTo("body"),ml=$("<div />").attr({id:"jstree-marker-line"}).hide().bind("mouseup",function(e){return r&&r.length?(r.children("a").trigger(e),e.preventDefault(),e.stopImmediatePropagation(),!1):void 0}).bind("mouseleave",function(e){var rt=$(e.relatedTarget);return(rt.is(".jstree")||0===rt.closest(".jstree").length)&&r&&r.length?(r.children("a").trigger(e),m.hide(),ml.hide(),e.preventDefault(),e.stopImmediatePropagation(),!1):void 0}).appendTo("body"),$(document).bind("drag_start.vakata",function(e,data){data.data.jstree&&(m.show(),ml&&ml.show())}),$(document).bind("drag_stop.vakata",function(e,data){data.data.jstree&&(m.hide(),ml&&ml.hide())})})}(jQuery),function($){$.jstree.plugin("checkbox",{__init:function(){this.data.checkbox.noui=this._get_settings().checkbox.override_ui,this.data.ui&&this.data.checkbox.noui&&(this.select_node=this.deselect_node=this.deselect_all=$.noop,this.get_selected=this.get_checked),this.get_container().bind("open_node.jstree create_node.jstree clean_node.jstree refresh.jstree",$.proxy(function(e,data){this._prepare_checkboxes(data.rslt.obj)},this)).bind("loaded.jstree",$.proxy(function(){this._prepare_checkboxes()},this)).delegate(this.data.ui&&this.data.checkbox.noui?"a":"ins.jstree-checkbox","click.jstree",$.proxy(function(e){return e.preventDefault(),this._get_node(e.target).hasClass("jstree-checked")?this.uncheck_node(e.target):this.check_node(e.target),this.data.ui&&this.data.checkbox.noui?(this.save_selected(),void(this.data.cookies&&this.save_cookie("select_node"))):(e.stopImmediatePropagation(),!1)},this))},defaults:{override_ui:!1,two_state:!1,real_checkboxes:!1,checked_parent_open:!0,real_checkboxes_names:function(n){return["check_"+(n[0].id||Math.ceil(1e4*Math.random())),1]}},__destroy:function(){this.get_container().find("input.jstree-real-checkbox").removeClass("jstree-real-checkbox").end().find("ins.jstree-checkbox").remove()},_fn:{_checkbox_notify:function(n,data){data.checked&&this.check_node(n,!1)},_prepare_checkboxes:function(obj){if(obj=obj&&-1!=obj?this._get_node(obj):this.get_container().find("> ul > li"),obj!==!1){var c,t,_this=this,ts=this._get_settings().checkbox.two_state,rc=this._get_settings().checkbox.real_checkboxes,rcn=this._get_settings().checkbox.real_checkboxes_names;obj.each(function(){t=$(this),c=t.is("li")&&(t.hasClass("jstree-checked")||rc&&t.children(":checked").length)?"jstree-checked":"jstree-unchecked",t.find("li").andSelf().each(function(){var nm,$t=$(this);$t.children("a"+(_this.data.languages?"":":eq(0)")).not(":has(.jstree-checkbox)").prepend("<ins class='jstree-checkbox'>&#160;</ins>").parent().not(".jstree-checked, .jstree-unchecked").addClass(ts?"jstree-unchecked":c),rc&&($t.children(":checkbox").length?$t.children(":checkbox").addClass("jstree-real-checkbox"):(nm=rcn.call(_this,$t),$t.prepend("<input type='checkbox' class='jstree-real-checkbox' id='"+nm[0]+"' name='"+nm[0]+"' value='"+nm[1]+"' />"))),ts?($t.hasClass("jstree-checked")||$t.children(":checked").length)&&$t.addClass("jstree-checked").children(":checkbox").prop("checked",!0):("jstree-checked"===c||$t.hasClass("jstree-checked")||$t.children(":checked").length)&&$t.find("li").andSelf().addClass("jstree-checked").children(":checkbox").prop("checked",!0)})}),ts||obj.find(".jstree-checked").parent().parent().each(function(){_this._repair_state(this)})}},change_state:function(obj,state){obj=this._get_node(obj);var coll=!1,rc=this._get_settings().checkbox.real_checkboxes;if(!obj||-1===obj)return!1;if(state=state===!1||state===!0?state:obj.hasClass("jstree-checked"),this._get_settings().checkbox.two_state)state?(obj.removeClass("jstree-checked").addClass("jstree-unchecked"),rc&&obj.children(":checkbox").prop("checked",!1)):(obj.removeClass("jstree-unchecked").addClass("jstree-checked"),rc&&obj.children(":checkbox").prop("checked",!0));else{if(state){if(coll=obj.find("li").andSelf(),!coll.filter(".jstree-checked, .jstree-undetermined").length)return!1;coll.removeClass("jstree-checked jstree-undetermined").addClass("jstree-unchecked"),rc&&coll.children(":checkbox").prop("checked",!1)}else{if(coll=obj.find("li").andSelf(),!coll.filter(".jstree-unchecked, .jstree-undetermined").length)return!1;coll.removeClass("jstree-unchecked jstree-undetermined").addClass("jstree-checked"),rc&&coll.children(":checkbox").prop("checked",!0),this.data.ui&&(this.data.ui.last_selected=obj),this.data.checkbox.last_selected=obj}obj.parentsUntil(".jstree","li").each(function(){var $this=$(this);if(state){if($this.children("ul").children("li.jstree-checked, li.jstree-undetermined").length)return $this.parentsUntil(".jstree","li").andSelf().removeClass("jstree-checked jstree-unchecked").addClass("jstree-undetermined"),rc&&$this.parentsUntil(".jstree","li").andSelf().children(":checkbox").prop("checked",!1),!1;$this.removeClass("jstree-checked jstree-undetermined").addClass("jstree-unchecked"),rc&&$this.children(":checkbox").prop("checked",!1)}else{if($this.children("ul").children("li.jstree-unchecked, li.jstree-undetermined").length)return $this.parentsUntil(".jstree","li").andSelf().removeClass("jstree-checked jstree-unchecked").addClass("jstree-undetermined"),rc&&$this.parentsUntil(".jstree","li").andSelf().children(":checkbox").prop("checked",!1),!1;$this.removeClass("jstree-unchecked jstree-undetermined").addClass("jstree-checked"),rc&&$this.children(":checkbox").prop("checked",!0)}})}return this.data.ui&&this.data.checkbox.noui&&(this.data.ui.selected=this.get_checked()),this.__callback(obj),!0},check_node:function(obj){if(this.change_state(obj,!1)){if(obj=this._get_node(obj),this._get_settings().checkbox.checked_parent_open){var t=this;obj.parents(".jstree-closed").each(function(){t.open_node(this,!1,!0)})}this.__callback({obj:obj})}},uncheck_node:function(obj){this.change_state(obj,!0)&&this.__callback({obj:this._get_node(obj)})},check_all:function(){var _this=this,coll=this._get_settings().checkbox.two_state?this.get_container_ul().find("li"):this.get_container_ul().children("li");coll.each(function(){_this.change_state(this,!1)}),this.__callback()},uncheck_all:function(){var _this=this,coll=this._get_settings().checkbox.two_state?this.get_container_ul().find("li"):this.get_container_ul().children("li");coll.each(function(){_this.change_state(this,!0)}),this.__callback()},is_checked:function(obj){return obj=this._get_node(obj),obj.length?obj.is(".jstree-checked"):!1},get_checked:function(obj,get_all){return obj=obj&&-1!==obj?this._get_node(obj):this.get_container(),obj.find(get_all||this._get_settings().checkbox.two_state?".jstree-checked":"> ul > .jstree-checked, .jstree-undetermined > ul > .jstree-checked")},get_unchecked:function(obj,get_all){return obj=obj&&-1!==obj?this._get_node(obj):this.get_container(),obj.find(get_all||this._get_settings().checkbox.two_state?".jstree-unchecked":"> ul > .jstree-unchecked, .jstree-undetermined > ul > .jstree-unchecked")},show_checkboxes:function(){this.get_container().children("ul").removeClass("jstree-no-checkboxes")},hide_checkboxes:function(){this.get_container().children("ul").addClass("jstree-no-checkboxes")},_repair_state:function(obj){if(obj=this._get_node(obj),obj.length){if(this._get_settings().checkbox.two_state)return void obj.find("li").andSelf().not(".jstree-checked").removeClass("jstree-undetermined").addClass("jstree-unchecked").children(":checkbox").prop("checked",!0);var rc=this._get_settings().checkbox.real_checkboxes,a=obj.find("> ul > .jstree-checked").length,b=obj.find("> ul > .jstree-undetermined").length,c=obj.find("> ul > li").length;0===c?obj.hasClass("jstree-undetermined")&&this.change_state(obj,!1):0===a&&0===b?this.change_state(obj,!0):a===c?this.change_state(obj,!1):(obj.parentsUntil(".jstree","li").andSelf().removeClass("jstree-checked jstree-unchecked").addClass("jstree-undetermined"),rc&&obj.parentsUntil(".jstree","li").andSelf().children(":checkbox").prop("checked",!1))}},reselect:function(){if(this.data.ui&&this.data.checkbox.noui){var _this=this,s=this.data.ui.to_select;s=$.map($.makeArray(s),function(n){return"#"+n.toString().replace(/^#/,"").replace(/\\\//g,"/").replace(/\//g,"\\/").replace(/\\\./g,".").replace(/\./g,"\\.").replace(/\:/g,"\\:")}),this.deselect_all(),$.each(s,function(i,val){_this.check_node(val)}),this.__callback()}else this.__call_old()},save_loaded:function(){var _this=this;this.data.core.to_load=[],this.get_container_ul().find("li.jstree-closed.jstree-undetermined").each(function(){this.id&&_this.data.core.to_load.push("#"+this.id)})}}}),$(function(){var css_string=".jstree .jstree-real-checkbox { display:none; } ";$.vakata.css.add_sheet({str:css_string,title:"jstree"})})}(jQuery),function($){$.vakata.xslt=function(xml,xsl,callback){var xm,xs,processor,support,rs="";return document.recalc?(xm=document.createElement("xml"),xs=document.createElement("xml"),xm.innerHTML=xml,xs.innerHTML=xsl,$("body").append(xm).append(xs),setTimeout(function(xm,xs,callback){return function(){callback.call(null,xm.transformNode(xs.XMLDocument)),setTimeout(function(xm,xs){return function(){$(xm).remove(),$(xs).remove()}}(xm,xs),200)}}(xm,xs,callback),100),!0):("undefined"!=typeof window.DOMParser&&"undefined"!=typeof window.XMLHttpRequest&&"undefined"==typeof window.XSLTProcessor&&(xml=(new DOMParser).parseFromString(xml,"text/xml"),xsl=(new DOMParser).parseFromString(xsl,"text/xml")),"undefined"!=typeof window.DOMParser&&"undefined"!=typeof window.XMLHttpRequest&&"undefined"!=typeof window.XSLTProcessor?(processor=new XSLTProcessor,(support=$.isFunction(processor.transformDocument)?"undefined"!=typeof window.XMLSerializer:!0)?(xml=(new DOMParser).parseFromString(xml,"text/xml"),xsl=(new DOMParser).parseFromString(xsl,"text/xml"),$.isFunction(processor.transformDocument)?(rs=document.implementation.createDocument("","",null),processor.transformDocument(xml,xsl,rs,null),callback.call(null,(new XMLSerializer).serializeToString(rs)),!0):(processor.importStylesheet(xsl),rs=processor.transformToFragment(xml,document),callback.call(null,$("<div />").append(rs).html()),!0)):!1):!1)};var xsl={nest:'<?xml version="1.0" encoding="utf-8" ?><xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" ><xsl:output method="html" encoding="utf-8" omit-xml-declaration="yes" standalone="no" indent="no" media-type="text/html" /><xsl:template match="/">	<xsl:call-template name="nodes">		<xsl:with-param name="node" select="/root" />	</xsl:call-template></xsl:template><xsl:template name="nodes">	<xsl:param name="node" />	<ul>	<xsl:for-each select="$node/item">		<xsl:variable name="children" select="count(./item) &gt; 0" />		<li>			<xsl:attribute name="class">				<xsl:if test="position() = last()">jstree-last </xsl:if>				<xsl:choose>					<xsl:when test="@state = \'open\'">jstree-open </xsl:when>					<xsl:when test="$children or @hasChildren or @state = \'closed\'">jstree-closed </xsl:when>					<xsl:otherwise>jstree-leaf </xsl:otherwise>				</xsl:choose>				<xsl:value-of select="@class" />			</xsl:attribute>			<xsl:for-each select="@*">				<xsl:if test="name() != \'class\' and name() != \'state\' and name() != \'hasChildren\'">					<xsl:attribute name="{name()}"><xsl:value-of select="." /></xsl:attribute>				</xsl:if>			</xsl:for-each>	<ins class="jstree-icon"><xsl:text>&#xa0;</xsl:text></ins>			<xsl:for-each select="content/name">				<a>				<xsl:attribute name="href">					<xsl:choose>					<xsl:when test="@href"><xsl:value-of select="@href" /></xsl:when>					<xsl:otherwise>#</xsl:otherwise>					</xsl:choose>				</xsl:attribute>				<xsl:attribute name="class"><xsl:value-of select="@lang" /> <xsl:value-of select="@class" /></xsl:attribute>				<xsl:attribute name="style"><xsl:value-of select="@style" /></xsl:attribute>				<xsl:for-each select="@*">					<xsl:if test="name() != \'style\' and name() != \'class\' and name() != \'href\'">						<xsl:attribute name="{name()}"><xsl:value-of select="." /></xsl:attribute>					</xsl:if>				</xsl:for-each>					<ins>						<xsl:attribute name="class">jstree-icon 							<xsl:if test="string-length(attribute::icon) > 0 and not(contains(@icon,\'/\'))"><xsl:value-of select="@icon" /></xsl:if>						</xsl:attribute>						<xsl:if test="string-length(attribute::icon) > 0 and contains(@icon,\'/\')"><xsl:attribute name="style">background:url(<xsl:value-of select="@icon" />) center center no-repeat;</xsl:attribute></xsl:if>						<xsl:text>&#xa0;</xsl:text>					</ins>					<xsl:copy-of select="./child::node()" />				</a>			</xsl:for-each>			<xsl:if test="$children or @hasChildren"><xsl:call-template name="nodes"><xsl:with-param name="node" select="current()" /></xsl:call-template></xsl:if>		</li>	</xsl:for-each>	</ul></xsl:template></xsl:stylesheet>',flat:'<?xml version="1.0" encoding="utf-8" ?><xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" ><xsl:output method="html" encoding="utf-8" omit-xml-declaration="yes" standalone="no" indent="no" media-type="text/xml" /><xsl:template match="/">	<ul>	<xsl:for-each select="//item[not(@parent_id) or @parent_id=0 or not(@parent_id = //item/@id)]">		<xsl:call-template name="nodes">			<xsl:with-param name="node" select="." />			<xsl:with-param name="is_last" select="number(position() = last())" />		</xsl:call-template>	</xsl:for-each>	</ul></xsl:template><xsl:template name="nodes">	<xsl:param name="node" />	<xsl:param name="is_last" />	<xsl:variable name="children" select="count(//item[@parent_id=$node/attribute::id]) &gt; 0" />	<li>	<xsl:attribute name="class">		<xsl:if test="$is_last = true()">jstree-last </xsl:if>		<xsl:choose>			<xsl:when test="@state = \'open\'">jstree-open </xsl:when>			<xsl:when test="$children or @hasChildren or @state = \'closed\'">jstree-closed </xsl:when>			<xsl:otherwise>jstree-leaf </xsl:otherwise>		</xsl:choose>		<xsl:value-of select="@class" />	</xsl:attribute>	<xsl:for-each select="@*">		<xsl:if test="name() != \'parent_id\' and name() != \'hasChildren\' and name() != \'class\' and name() != \'state\'">		<xsl:attribute name="{name()}"><xsl:value-of select="." /></xsl:attribute>		</xsl:if>	</xsl:for-each>	<ins class="jstree-icon"><xsl:text>&#xa0;</xsl:text></ins>	<xsl:for-each select="content/name">		<a>		<xsl:attribute name="href">			<xsl:choose>			<xsl:when test="@href"><xsl:value-of select="@href" /></xsl:when>			<xsl:otherwise>#</xsl:otherwise>			</xsl:choose>		</xsl:attribute>		<xsl:attribute name="class"><xsl:value-of select="@lang" /> <xsl:value-of select="@class" /></xsl:attribute>		<xsl:attribute name="style"><xsl:value-of select="@style" /></xsl:attribute>		<xsl:for-each select="@*">			<xsl:if test="name() != \'style\' and name() != \'class\' and name() != \'href\'">				<xsl:attribute name="{name()}"><xsl:value-of select="." /></xsl:attribute>			</xsl:if>		</xsl:for-each>			<ins>				<xsl:attribute name="class">jstree-icon 					<xsl:if test="string-length(attribute::icon) > 0 and not(contains(@icon,\'/\'))"><xsl:value-of select="@icon" /></xsl:if>				</xsl:attribute>				<xsl:if test="string-length(attribute::icon) > 0 and contains(@icon,\'/\')"><xsl:attribute name="style">background:url(<xsl:value-of select="@icon" />) center center no-repeat;</xsl:attribute></xsl:if>				<xsl:text>&#xa0;</xsl:text>			</ins>			<xsl:copy-of select="./child::node()" />		</a>	</xsl:for-each>	<xsl:if test="$children">		<ul>		<xsl:for-each select="//item[@parent_id=$node/attribute::id]">			<xsl:call-template name="nodes">				<xsl:with-param name="node" select="." />				<xsl:with-param name="is_last" select="number(position() = last())" />			</xsl:call-template>		</xsl:for-each>		</ul>	</xsl:if>	</li></xsl:template></xsl:stylesheet>'},escape_xml=function(string){return string.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")
};$.jstree.plugin("xml_data",{defaults:{data:!1,ajax:!1,xsl:"flat",clean_node:!1,correct_state:!0,get_skip_empty:!1,get_include_preamble:!0},_fn:{load_node:function(obj,s_call,e_call){var _this=this;this.load_node_xml(obj,function(){_this.__callback({obj:_this._get_node(obj)}),s_call.call(this)},e_call)},_is_loaded:function(obj){var s=this._get_settings().xml_data;return obj=this._get_node(obj),-1==obj||!obj||!s.ajax&&!$.isFunction(s.data)||obj.is(".jstree-open, .jstree-leaf")||obj.children("ul").children("li").size()>0},load_node_xml:function(obj,s_call,e_call){var s=this.get_settings().xml_data,error_func=function(){},success_func=function(){};if(obj=this._get_node(obj),obj&&-1!==obj){if(obj.data("jstree_is_loading"))return;obj.data("jstree_is_loading",!0)}switch(!0){case!s.data&&!s.ajax:throw"Neither data nor ajax settings supplied.";case $.isFunction(s.data):s.data.call(this,obj,$.proxy(function(d){this.parse_xml(d,$.proxy(function(d){d&&(d=d.replace(/ ?xmlns="[^"]*"/gi,""),d.length>10?(d=$(d),-1!==obj&&obj?(obj.children("a.jstree-loading").removeClass("jstree-loading"),obj.append(d),obj.removeData("jstree_is_loading")):this.get_container().children("ul").empty().append(d.children()),s.clean_node&&this.clean_node(obj),s_call&&s_call.call(this)):obj&&-1!==obj?(obj.children("a.jstree-loading").removeClass("jstree-loading"),obj.removeData("jstree_is_loading"),s.correct_state&&(this.correct_state(obj),s_call&&s_call.call(this))):s.correct_state&&(this.get_container().children("ul").empty(),s_call&&s_call.call(this)))},this))},this));break;case!!s.data&&!s.ajax||!!s.data&&!!s.ajax&&(!obj||-1===obj):obj&&-1!=obj||this.parse_xml(s.data,$.proxy(function(d){d?(d=d.replace(/ ?xmlns="[^"]*"/gi,""),d.length>10&&(d=$(d),this.get_container().children("ul").empty().append(d.children()),s.clean_node&&this.clean_node(obj),s_call&&s_call.call(this))):s.correct_state&&(this.get_container().children("ul").empty(),s_call&&s_call.call(this))},this));break;case!s.data&&!!s.ajax||!!s.data&&!!s.ajax&&obj&&-1!==obj:error_func=function(x,t,e){var ef=this.get_settings().xml_data.ajax.error;ef&&ef.call(this,x,t,e),-1!==obj&&obj.length?(obj.children("a.jstree-loading").removeClass("jstree-loading"),obj.removeData("jstree_is_loading"),"success"===t&&s.correct_state&&this.correct_state(obj)):"success"===t&&s.correct_state&&this.get_container().children("ul").empty(),e_call&&e_call.call(this)},success_func=function(d,t,x){d=x.responseText;var sf=this.get_settings().xml_data.ajax.success;return sf&&(d=sf.call(this,d,t,x)||d),""===d||d&&d.toString&&""===d.toString().replace(/^[\s\n]+$/,"")?error_func.call(this,x,t,""):void this.parse_xml(d,$.proxy(function(d){d&&(d=d.replace(/ ?xmlns="[^"]*"/gi,""),d.length>10?(d=$(d),-1!==obj&&obj?(obj.children("a.jstree-loading").removeClass("jstree-loading"),obj.append(d),obj.removeData("jstree_is_loading")):this.get_container().children("ul").empty().append(d.children()),s.clean_node&&this.clean_node(obj),s_call&&s_call.call(this)):obj&&-1!==obj?(obj.children("a.jstree-loading").removeClass("jstree-loading"),obj.removeData("jstree_is_loading"),s.correct_state&&(this.correct_state(obj),s_call&&s_call.call(this))):s.correct_state&&(this.get_container().children("ul").empty(),s_call&&s_call.call(this)))},this))},s.ajax.context=this,s.ajax.error=error_func,s.ajax.success=success_func,s.ajax.dataType||(s.ajax.dataType="xml"),$.isFunction(s.ajax.url)&&(s.ajax.url=s.ajax.url.call(this,obj)),$.isFunction(s.ajax.data)&&(s.ajax.data=s.ajax.data.call(this,obj)),$.ajax(s.ajax)}},parse_xml:function(xml,callback){var s=this._get_settings().xml_data;$.vakata.xslt(xml,xsl[s.xsl],callback)},get_xml:function(tp,obj,li_attr,a_attr,is_callback){var tmp1,tmp2,li,a,lang,result="",s=this._get_settings(),_this=this;return tp||(tp="flat"),is_callback||(is_callback=0),obj=this._get_node(obj),obj&&-1!==obj||(obj=this.get_container().find("> ul > li")),li_attr=$.isArray(li_attr)?li_attr:["id","class"],!is_callback&&this.data.types&&-1===$.inArray(s.types.type_attr,li_attr)&&li_attr.push(s.types.type_attr),a_attr=$.isArray(a_attr)?a_attr:[],is_callback||(s.xml_data.get_include_preamble&&(result+='<?xml version="1.0" encoding="UTF-8"?>'),result+="<root>"),obj.each(function(){result+="<item",li=$(this),$.each(li_attr,function(i,v){var t=li.attr(v);s.xml_data.get_skip_empty&&"undefined"==typeof t||(result+=" "+v+'="'+escape_xml((" "+(t||"")).replace(/ jstree[^ ]*/gi,"").replace(/\s+$/gi," ").replace(/^ /,"").replace(/ $/,""))+'"')}),li.hasClass("jstree-open")&&(result+=' state="open"'),li.hasClass("jstree-closed")&&(result+=' state="closed"'),"flat"===tp&&(result+=' parent_id="'+escape_xml(is_callback)+'"'),result+=">",result+="<content>",a=li.children("a"),a.each(function(){tmp1=$(this),lang=!1,result+="<name",-1!==$.inArray("languages",s.plugins)&&$.each(s.languages,function(k,z){return tmp1.hasClass(z)?(result+=' lang="'+escape_xml(z)+'"',lang=z,!1):void 0}),a_attr.length&&$.each(a_attr,function(k,z){var t=tmp1.attr(z);s.xml_data.get_skip_empty&&"undefined"==typeof t||(result+=" "+z+'="'+escape_xml((" "+t||"").replace(/ jstree[^ ]*/gi,"").replace(/\s+$/gi," ").replace(/^ /,"").replace(/ $/,""))+'"')}),tmp1.children("ins").get(0).className.replace(/jstree[^ ]*|$/gi,"").replace(/^\s+$/gi,"").length&&(result+=' icon="'+escape_xml(tmp1.children("ins").get(0).className.replace(/jstree[^ ]*|$/gi,"").replace(/\s+$/gi," ").replace(/^ /,"").replace(/ $/,""))+'"'),tmp1.children("ins").get(0).style.backgroundImage.length&&(result+=' icon="'+escape_xml(tmp1.children("ins").get(0).style.backgroundImage.replace("url(","").replace(")","").replace(/'/gi,"").replace(/"/gi,""))+'"'),result+=">",result+="<![CDATA["+_this.get_text(tmp1,lang)+"]]>",result+="</name>"}),result+="</content>",tmp2=li[0].id||!0,li=li.find("> ul > li"),tmp2=li.length?_this.get_xml(tp,li,li_attr,a_attr,tmp2):"","nest"==tp&&(result+=tmp2),result+="</item>","flat"==tp&&(result+=tmp2)}),is_callback||(result+="</root>"),result}}})}(jQuery),function($){$.expr[":"].jstree_contains=function(a,i,m){return(a.textContent||a.innerText||"").toLowerCase().indexOf(m[3].toLowerCase())>=0},$.expr[":"].jstree_title_contains=function(a,i,m){return(a.getAttribute("title")||"").toLowerCase().indexOf(m[3].toLowerCase())>=0},$.jstree.plugin("search",{__init:function(){this.data.search.str="",this.data.search.result=$(),this._get_settings().search.show_only_matches&&this.get_container().bind("search.jstree",function(e,data){$(this).children("ul").find("li").hide().removeClass("jstree-last"),data.rslt.nodes.parentsUntil(".jstree").andSelf().show().filter("ul").each(function(){$(this).children("li:visible").eq(-1).addClass("jstree-last")})}).bind("clear_search.jstree",function(){$(this).children("ul").find("li").css("display","").end().end().jstree("clean_node",-1)})},defaults:{ajax:!1,search_method:"jstree_contains",show_only_matches:!1},_fn:{search:function(str,skip_async){if(""===$.trim(str))return void this.clear_search();var s=this.get_settings().search,t=this,error_func=function(){},success_func=function(){};return this.data.search.str=str,!skip_async&&s.ajax!==!1&&this.get_container_ul().find("li.jstree-closed:not(:has(ul)):eq(0)").length>0?(this.search.supress_callback=!0,error_func=function(){},success_func=function(d,t,x){var sf=this.get_settings().search.ajax.success;sf&&(d=sf.call(this,d,t,x)||d),this.data.search.to_open=d,this._search_open()},s.ajax.context=this,s.ajax.error=error_func,s.ajax.success=success_func,$.isFunction(s.ajax.url)&&(s.ajax.url=s.ajax.url.call(this,str)),$.isFunction(s.ajax.data)&&(s.ajax.data=s.ajax.data.call(this,str)),s.ajax.data||(s.ajax.data={search_string:str}),(!s.ajax.dataType||/^json/.exec(s.ajax.dataType))&&(s.ajax.dataType="json"),void $.ajax(s.ajax)):(this.data.search.result.length&&this.clear_search(),this.data.search.result=this.get_container().find("a"+(this.data.languages?"."+this.get_lang():"")+":"+s.search_method+"("+this.data.search.str+")"),this.data.search.result.addClass("jstree-search").parent().parents(".jstree-closed").each(function(){t.open_node(this,!1,!0)}),void this.__callback({nodes:this.data.search.result,str:str}))},clear_search:function(){this.data.search.result.removeClass("jstree-search"),this.__callback(this.data.search.result),this.data.search.result=$()},_search_open:function(){var _this=this,done=!0,current=[],remaining=[];this.data.search.to_open.length&&($.each(this.data.search.to_open,function(i,val){return"#"==val?!0:void($(val).length&&$(val).is(".jstree-closed")?current.push(val):remaining.push(val))}),current.length&&(this.data.search.to_open=remaining,$.each(current,function(i,val){_this.open_node(val,function(){_this._search_open(!0)})}),done=!1)),done&&this.search(this.data.search.str,!0)}}})}(jQuery),function($){$.vakata.context={hide_on_mouseleave:!1,cnt:$("<div id='vakata-contextmenu' />"),vis:!1,tgt:!1,par:!1,func:!1,data:!1,rtl:!1,show:function(s,t,x,y,d,p,rtl){$.vakata.context.rtl=!!rtl;var h,w,html=$.vakata.context.parse(s);html&&($.vakata.context.vis=!0,$.vakata.context.tgt=t,$.vakata.context.par=p||t||null,$.vakata.context.data=d||null,$.vakata.context.cnt.html(html).css({visibility:"hidden",display:"block",left:0,top:0}),$.vakata.context.hide_on_mouseleave&&$.vakata.context.cnt.one("mouseleave",function(){$.vakata.context.hide()}),h=$.vakata.context.cnt.height(),w=$.vakata.context.cnt.width(),x+w>$(document).width()&&(x=$(document).width()-(w+5),$.vakata.context.cnt.find("li > ul").addClass("right")),y+h>$(document).height()&&(y-=h+t[0].offsetHeight,$.vakata.context.cnt.find("li > ul").addClass("bottom")),$.vakata.context.cnt.css({left:x,top:y}).find("li:has(ul)").bind("mouseenter",function(){var w=$(document).width(),h=$(document).height(),ul=$(this).children("ul").show();w!==$(document).width()&&ul.toggleClass("right"),h!==$(document).height()&&ul.toggleClass("bottom")}).bind("mouseleave",function(){$(this).children("ul").hide()}).end().css({visibility:"visible"}).show(),$(document).triggerHandler("context_show.vakata"))},hide:function(){$.vakata.context.vis=!1,$.vakata.context.cnt.attr("class","").css({visibility:"hidden"}),$(document).triggerHandler("context_hide.vakata")},parse:function(s,is_callback){if(!s)return!1;var str="",tmp=!1,was_sep=!0;return is_callback||($.vakata.context.func={}),str+="<ul>",$.each(s,function(i,val){return val?($.vakata.context.func[i]=val.action,!was_sep&&val.separator_before&&(str+="<li class='vakata-separator vakata-separator-before'></li>"),was_sep=!1,str+="<li class='"+(val._class||"")+(val._disabled?" jstree-contextmenu-disabled ":"")+"'><ins ",val.icon&&-1===val.icon.indexOf("/")&&(str+=" class='"+val.icon+"' "),val.icon&&-1!==val.icon.indexOf("/")&&(str+=" style='background:url("+val.icon+") center center no-repeat;' "),str+=">&#160;</ins><a href='#' rel='"+i+"'>",val.submenu&&(str+="<span style='float:"+($.vakata.context.rtl?"left":"right")+";'>&raquo;</span>"),str+=val.label+"</a>",val.submenu&&(tmp=$.vakata.context.parse(val.submenu,!0),tmp&&(str+=tmp)),str+="</li>",void(val.separator_after&&(str+="<li class='vakata-separator vakata-separator-after'></li>",was_sep=!0))):!0}),str=str.replace(/<li class\='vakata-separator vakata-separator-after'\><\/li\>$/,""),str+="</ul>",$(document).triggerHandler("context_parse.vakata"),str.length>10?str:!1},exec:function(i){return $.isFunction($.vakata.context.func[i])?($.vakata.context.func[i].call($.vakata.context.data,$.vakata.context.par),!0):!1}},$(function(){var css_string="#vakata-contextmenu { display:block; visibility:hidden; left:0; top:-200px; position:absolute; margin:0; padding:0; min-width:180px; background:#ebebeb; border:1px solid silver; z-index:10000; *width:180px; } #vakata-contextmenu ul { min-width:180px; *width:180px; } #vakata-contextmenu ul, #vakata-contextmenu li { margin:0; padding:0; list-style-type:none; display:block; } #vakata-contextmenu li { line-height:20px; min-height:20px; position:relative; padding:0px; } #vakata-contextmenu li a { padding:1px 6px; line-height:17px; display:block; text-decoration:none; margin:1px 1px 0 1px; } #vakata-contextmenu li ins { float:left; width:16px; height:16px; text-decoration:none; margin-right:2px; } #vakata-contextmenu li a:hover, #vakata-contextmenu li.vakata-hover > a { background:gray; color:white; } #vakata-contextmenu li ul { display:none; position:absolute; top:-2px; left:100%; background:#ebebeb; border:1px solid gray; } #vakata-contextmenu .right { right:100%; left:auto; } #vakata-contextmenu .bottom { bottom:-1px; top:auto; } #vakata-contextmenu li.vakata-separator { min-height:0; height:1px; line-height:1px; font-size:1px; overflow:hidden; margin:0 2px; background:silver; /* border-top:1px solid #fefefe; */ padding:0; } ";$.vakata.css.add_sheet({str:css_string,title:"vakata"}),$.vakata.context.cnt.delegate("a","click",function(e){e.preventDefault()}).delegate("a","mouseup",function(){!$(this).parent().hasClass("jstree-contextmenu-disabled")&&$.vakata.context.exec($(this).attr("rel"))?$.vakata.context.hide():$(this).blur()}).delegate("a","mouseover",function(){$.vakata.context.cnt.find(".vakata-hover").removeClass("vakata-hover")}).appendTo("body"),$(document).bind("mousedown",function(e){$.vakata.context.vis&&!$.contains($.vakata.context.cnt[0],e.target)&&$.vakata.context.hide()}),"undefined"!=typeof $.hotkeys&&$(document).bind("keydown","up",function(e){if($.vakata.context.vis){var o=$.vakata.context.cnt.find("ul:visible").last().children(".vakata-hover").removeClass("vakata-hover").prevAll("li:not(.vakata-separator)").first();o.length||(o=$.vakata.context.cnt.find("ul:visible").last().children("li:not(.vakata-separator)").last()),o.addClass("vakata-hover"),e.stopImmediatePropagation(),e.preventDefault()}}).bind("keydown","down",function(e){if($.vakata.context.vis){var o=$.vakata.context.cnt.find("ul:visible").last().children(".vakata-hover").removeClass("vakata-hover").nextAll("li:not(.vakata-separator)").first();o.length||(o=$.vakata.context.cnt.find("ul:visible").last().children("li:not(.vakata-separator)").first()),o.addClass("vakata-hover"),e.stopImmediatePropagation(),e.preventDefault()}}).bind("keydown","right",function(e){$.vakata.context.vis&&($.vakata.context.cnt.find(".vakata-hover").children("ul").show().children("li:not(.vakata-separator)").removeClass("vakata-hover").first().addClass("vakata-hover"),e.stopImmediatePropagation(),e.preventDefault())}).bind("keydown","left",function(e){$.vakata.context.vis&&($.vakata.context.cnt.find(".vakata-hover").children("ul").hide().children(".vakata-separator").removeClass("vakata-hover"),e.stopImmediatePropagation(),e.preventDefault())}).bind("keydown","esc",function(e){$.vakata.context.hide(),e.preventDefault()}).bind("keydown","space",function(e){$.vakata.context.cnt.find(".vakata-hover").last().children("a").click(),e.preventDefault()})}),$.jstree.plugin("contextmenu",{__init:function(){this.get_container().delegate("a","contextmenu.jstree",$.proxy(function(e){e.preventDefault(),$(e.currentTarget).hasClass("jstree-loading")||this.show_contextmenu(e.currentTarget,e.pageX,e.pageY)},this)).delegate("a","click.jstree",$.proxy(function(){this.data.contextmenu&&$.vakata.context.hide()},this)).bind("destroy.jstree",$.proxy(function(){this.data.contextmenu&&$.vakata.context.hide()},this)),$(document).bind("context_hide.vakata",$.proxy(function(){this.data.contextmenu=!1},this))},defaults:{select_node:!1,show_at_node:!0,items:{create:{separator_before:!1,separator_after:!0,label:"Create",action:function(obj){this.create(obj)}},rename:{separator_before:!1,separator_after:!1,label:"Rename",action:function(obj){this.rename(obj)}},remove:{separator_before:!1,icon:!1,separator_after:!1,label:"Delete",action:function(obj){this.is_selected(obj)?this.remove():this.remove(obj)}},ccp:{separator_before:!0,icon:!1,separator_after:!1,label:"Edit",action:!1,submenu:{cut:{separator_before:!1,separator_after:!1,label:"Cut",action:function(obj){this.cut(obj)}},copy:{separator_before:!1,icon:!1,separator_after:!1,label:"Copy",action:function(obj){this.copy(obj)}},paste:{separator_before:!1,icon:!1,separator_after:!1,label:"Paste",action:function(obj){this.paste(obj)}}}}}},_fn:{show_contextmenu:function(obj,x,y){obj=this._get_node(obj);var s=this.get_settings().contextmenu,a=obj.children("a:visible:eq(0)"),o=!1,i=!1;s.select_node&&this.data.ui&&!this.is_selected(obj)&&(this.deselect_all(),this.select_node(obj,!0)),(s.show_at_node||"undefined"==typeof x||"undefined"==typeof y)&&(o=a.offset(),x=o.left,y=o.top+this.data.core.li_height),i=obj.data("jstree")&&obj.data("jstree").contextmenu?obj.data("jstree").contextmenu:s.items,$.isFunction(i)&&(i=i.call(this,obj)),this.data.contextmenu=!0,$.vakata.context.show(i,a,x,y,this,obj,this._get_settings().core.rtl),this.data.themes&&$.vakata.context.cnt.attr("class","jstree-"+this.data.themes.theme+"-context")}}})}(jQuery),function($){$.jstree.plugin("types",{__init:function(){var s=this._get_settings().types;this.data.types.attach_to=[],this.get_container().bind("init.jstree",$.proxy(function(){var types=s.types,attr=s.type_attr,icons_css="",_this=this;$.each(types,function(i,tp){return $.each(tp,function(k){/^(max_depth|max_children|icon|valid_children)$/.test(k)||_this.data.types.attach_to.push(k)}),tp.icon?void((tp.icon.image||tp.icon.position)&&(icons_css+="default"==i?".jstree-"+_this.get_index()+" a > .jstree-icon { ":".jstree-"+_this.get_index()+" li["+attr+'="'+i+'"] > a > .jstree-icon { ',tp.icon.image&&(icons_css+=" background-image:url("+tp.icon.image+"); "),icons_css+=tp.icon.position?" background-position:"+tp.icon.position+"; ":" background-position:0 0; ",icons_css+="} ")):!0}),""!==icons_css&&$.vakata.css.add_sheet({str:icons_css,title:"jstree-types"})},this)).bind("before.jstree",$.proxy(function(e,data){var s,t,o=this._get_settings().types.use_data?this._get_node(data.args[0]):!1,d=o&&-1!==o&&o.length?o.data("jstree"):!1;if(d&&d.types&&d.types[data.func]===!1)return e.stopImmediatePropagation(),!1;if(-1!==$.inArray(data.func,this.data.types.attach_to)){if(!data.args[0]||!data.args[0].tagName&&!data.args[0].jquery)return;if(s=this._get_settings().types.types,t=this._get_type(data.args[0]),(s[t]&&"undefined"!=typeof s[t][data.func]||s["default"]&&"undefined"!=typeof s["default"][data.func])&&this._check(data.func,data.args[0])===!1)return e.stopImmediatePropagation(),!1}},this)),is_ie6&&this.get_container().bind("load_node.jstree set_type.jstree",$.proxy(function(e,data){var r=data&&data.rslt&&data.rslt.obj&&-1!==data.rslt.obj?this._get_node(data.rslt.obj).parent():this.get_container_ul(),c=!1,s=this._get_settings().types;$.each(s.types,function(i,tp){tp.icon&&(tp.icon.image||tp.icon.position)&&(c=r.find("default"===i?"li > a > .jstree-icon":"li["+s.type_attr+"='"+i+"'] > a > .jstree-icon"),tp.icon.image&&c.css("backgroundImage","url("+tp.icon.image+")"),c.css("backgroundPosition",tp.icon.position||"0 0"))})},this))},defaults:{max_children:-1,max_depth:-1,valid_children:"all",use_data:!1,type_attr:"rel",types:{"default":{max_children:-1,max_depth:-1,valid_children:"all"}}},_fn:{_types_notify:function(n,data){data.type&&this._get_settings().types.use_data&&this.set_type(data.type,n)},_get_type:function(obj){return obj=this._get_node(obj),obj&&obj.length?obj.attr(this._get_settings().types.type_attr)||"default":!1},set_type:function(str,obj){obj=this._get_node(obj);var ret=obj.length&&str?obj.attr(this._get_settings().types.type_attr,str):!1;return ret&&this.__callback({obj:obj,type:str}),ret},_check:function(rule,obj,opts){obj=this._get_node(obj);var v=!1,t=this._get_type(obj),d=0,_this=this,s=this._get_settings().types,data=!1;if(-1===obj){if(!s[rule])return;v=s[rule]}else{if(t===!1)return;data=s.use_data?obj.data("jstree"):!1,data&&data.types&&"undefined"!=typeof data.types[rule]?v=data.types[rule]:s.types[t]&&"undefined"!=typeof s.types[t][rule]?v=s.types[t][rule]:s.types["default"]&&"undefined"!=typeof s.types["default"][rule]&&(v=s.types["default"][rule])}return $.isFunction(v)&&(v=v.call(this,obj)),"max_depth"===rule&&-1!==obj&&opts!==!1&&-2!==s.max_depth&&0!==v&&obj.children("a:eq(0)").parentsUntil(".jstree","li").each(function(i){return-1!==s.max_depth&&s.max_depth-(i+1)<=0?(v=0,!1):(d=0===i?v:_this._check(rule,this,!1),-1!==d&&0>=d-(i+1)?(v=0,!1):(d>=0&&(v>d-(i+1)||0>v)&&(v=d-(i+1)),void(s.max_depth>=0&&(s.max_depth-(i+1)<v||0>v)&&(v=s.max_depth-(i+1)))))}),v},check_move:function(){if(!this.__call_old())return!1;var t,m=this._get_move(),s=m.rt._get_settings().types,mc=m.rt._check("max_children",m.cr),md=m.rt._check("max_depth",m.cr),vc=m.rt._check("valid_children",m.cr),ch=0,d=1;if("none"===vc)return!1;if($.isArray(vc)&&m.ot&&m.ot._get_type&&(m.o.each(function(){return-1===$.inArray(m.ot._get_type(this),vc)?(d=!1,!1):void 0}),d===!1))return!1;if(-2!==s.max_children&&-1!==mc&&(ch=-1===m.cr?this.get_container().find("> ul > li").not(m.o).length:m.cr.find("> ul > li").not(m.o).length,ch+m.o.length>mc))return!1;if(-2!==s.max_depth&&-1!==md){if(d=0,0===md)return!1;if("undefined"==typeof m.o.d){for(t=m.o;t.length>0;)t=t.find("> ul > li"),d++;m.o.d=d}if(md-m.o.d<0)return!1}return!0},create_node:function(obj,position,js,callback,is_loaded,skip_check){if(!skip_check&&(is_loaded||this._is_loaded(obj))){var ch,p="string"==typeof position&&position.match(/^before|after$/i)&&-1!==obj?this._get_parent(obj):this._get_node(obj),s=this._get_settings().types,mc=this._check("max_children",p),md=this._check("max_depth",p),vc=this._check("valid_children",p);if("string"==typeof js&&(js={data:js}),js||(js={}),"none"===vc)return!1;if($.isArray(vc))if(js.attr&&js.attr[s.type_attr]){if(-1===$.inArray(js.attr[s.type_attr],vc))return!1}else js.attr||(js.attr={}),js.attr[s.type_attr]=vc[0];if(-2!==s.max_children&&-1!==mc&&(ch=-1===p?this.get_container().find("> ul > li").length:p.find("> ul > li").length,ch+1>mc))return!1;if(-2!==s.max_depth&&-1!==md&&0>md-1)return!1}return this.__call_old(!0,obj,position,js,callback,is_loaded,skip_check)}}})}(jQuery),function($){$.jstree.plugin("html_data",{__init:function(){this.data.html_data.original_container_html=this.get_container().find(" > ul > li").clone(!0),this.data.html_data.original_container_html.find("li").andSelf().contents().filter(function(){return 3==this.nodeType}).remove()},defaults:{data:!1,ajax:!1,correct_state:!0},_fn:{load_node:function(obj,s_call,e_call){var _this=this;this.load_node_html(obj,function(){_this.__callback({obj:_this._get_node(obj)}),s_call.call(this)},e_call)},_is_loaded:function(obj){return obj=this._get_node(obj),-1==obj||!obj||!this._get_settings().html_data.ajax&&!$.isFunction(this._get_settings().html_data.data)||obj.is(".jstree-open, .jstree-leaf")||obj.children("ul").children("li").size()>0},load_node_html:function(obj,s_call,e_call){var d,s=this.get_settings().html_data,error_func=function(){},success_func=function(){};if(obj=this._get_node(obj),obj&&-1!==obj){if(obj.data("jstree_is_loading"))return;obj.data("jstree_is_loading",!0)}switch(!0){case $.isFunction(s.data):s.data.call(this,obj,$.proxy(function(d){d&&""!==d&&d.toString&&""!==d.toString().replace(/^[\s\n]+$/,"")?(d=$(d),d.is("ul")||(d=$("<ul />").append(d)),-1!=obj&&obj?(obj.children("a.jstree-loading").removeClass("jstree-loading"),obj.append(d).children("ul").find("li, a").filter(function(){return!this.firstChild||!this.firstChild.tagName||"INS"!==this.firstChild.tagName}).prepend("<ins class='jstree-icon'>&#160;</ins>").end().filter("a").children("ins:first-child").not(".jstree-icon").addClass("jstree-icon"),obj.removeData("jstree_is_loading")):this.get_container().children("ul").empty().append(d.children()).find("li, a").filter(function(){return!this.firstChild||!this.firstChild.tagName||"INS"!==this.firstChild.tagName}).prepend("<ins class='jstree-icon'>&#160;</ins>").end().filter("a").children("ins:first-child").not(".jstree-icon").addClass("jstree-icon"),this.clean_node(obj),s_call&&s_call.call(this)):obj&&-1!==obj?(obj.children("a.jstree-loading").removeClass("jstree-loading"),obj.removeData("jstree_is_loading"),s.correct_state&&(this.correct_state(obj),s_call&&s_call.call(this))):s.correct_state&&(this.get_container().children("ul").empty(),s_call&&s_call.call(this))},this));break;case!s.data&&!s.ajax:obj&&-1!=obj||(this.get_container().children("ul").empty().append(this.data.html_data.original_container_html).find("li, a").filter(function(){return!this.firstChild||!this.firstChild.tagName||"INS"!==this.firstChild.tagName}).prepend("<ins class='jstree-icon'>&#160;</ins>").end().filter("a").children("ins:first-child").not(".jstree-icon").addClass("jstree-icon"),this.clean_node()),s_call&&s_call.call(this);break;case!!s.data&&!s.ajax||!!s.data&&!!s.ajax&&(!obj||-1===obj):obj&&-1!=obj||(d=$(s.data),d.is("ul")||(d=$("<ul />").append(d)),this.get_container().children("ul").empty().append(d.children()).find("li, a").filter(function(){return!this.firstChild||!this.firstChild.tagName||"INS"!==this.firstChild.tagName}).prepend("<ins class='jstree-icon'>&#160;</ins>").end().filter("a").children("ins:first-child").not(".jstree-icon").addClass("jstree-icon"),this.clean_node()),s_call&&s_call.call(this);break;case!s.data&&!!s.ajax||!!s.data&&!!s.ajax&&obj&&-1!==obj:obj=this._get_node(obj),error_func=function(x,t,e){var ef=this.get_settings().html_data.ajax.error;ef&&ef.call(this,x,t,e),-1!=obj&&obj.length?(obj.children("a.jstree-loading").removeClass("jstree-loading"),obj.removeData("jstree_is_loading"),"success"===t&&s.correct_state&&this.correct_state(obj)):"success"===t&&s.correct_state&&this.get_container().children("ul").empty(),e_call&&e_call.call(this)},success_func=function(d,t,x){var sf=this.get_settings().html_data.ajax.success;return sf&&(d=sf.call(this,d,t,x)||d),""===d||d&&d.toString&&""===d.toString().replace(/^[\s\n]+$/,"")?error_func.call(this,x,t,""):void(d?(d=$(d),d.is("ul")||(d=$("<ul />").append(d)),-1!=obj&&obj?(obj.children("a.jstree-loading").removeClass("jstree-loading"),obj.append(d).children("ul").find("li, a").filter(function(){return!this.firstChild||!this.firstChild.tagName||"INS"!==this.firstChild.tagName}).prepend("<ins class='jstree-icon'>&#160;</ins>").end().filter("a").children("ins:first-child").not(".jstree-icon").addClass("jstree-icon"),obj.removeData("jstree_is_loading")):this.get_container().children("ul").empty().append(d.children()).find("li, a").filter(function(){return!this.firstChild||!this.firstChild.tagName||"INS"!==this.firstChild.tagName}).prepend("<ins class='jstree-icon'>&#160;</ins>").end().filter("a").children("ins:first-child").not(".jstree-icon").addClass("jstree-icon"),this.clean_node(obj),s_call&&s_call.call(this)):obj&&-1!==obj?(obj.children("a.jstree-loading").removeClass("jstree-loading"),obj.removeData("jstree_is_loading"),s.correct_state&&(this.correct_state(obj),s_call&&s_call.call(this))):s.correct_state&&(this.get_container().children("ul").empty(),s_call&&s_call.call(this)))},s.ajax.context=this,s.ajax.error=error_func,s.ajax.success=success_func,s.ajax.dataType||(s.ajax.dataType="html"),$.isFunction(s.ajax.url)&&(s.ajax.url=s.ajax.url.call(this,obj)),$.isFunction(s.ajax.data)&&(s.ajax.data=s.ajax.data.call(this,obj)),$.ajax(s.ajax)}}}}),$.jstree.defaults.plugins.push("html_data")}(jQuery),function($){$.jstree.plugin("themeroller",{__init:function(){var s=this._get_settings().themeroller;this.get_container().addClass("ui-widget-content").addClass("jstree-themeroller").delegate("a","mouseenter.jstree",function(e){$(e.currentTarget).hasClass("jstree-loading")||$(this).addClass(s.item_h)}).delegate("a","mouseleave.jstree",function(){$(this).removeClass(s.item_h)}).bind("init.jstree",$.proxy(function(e,data){data.inst.get_container().find("> ul > li > .jstree-loading > ins").addClass("ui-icon-refresh"),this._themeroller(data.inst.get_container().find("> ul > li"))},this)).bind("open_node.jstree create_node.jstree",$.proxy(function(e,data){this._themeroller(data.rslt.obj)},this)).bind("loaded.jstree refresh.jstree",$.proxy(function(){this._themeroller()},this)).bind("close_node.jstree",$.proxy(function(e,data){this._themeroller(data.rslt.obj)},this)).bind("delete_node.jstree",$.proxy(function(e,data){this._themeroller(data.rslt.parent)},this)).bind("correct_state.jstree",$.proxy(function(e,data){data.rslt.obj.children("ins.jstree-icon").removeClass(s.opened+" "+s.closed+" ui-icon").end().find("> a > ins.ui-icon").filter(function(){return-1===this.className.toString().replace(s.item_clsd,"").replace(s.item_open,"").replace(s.item_leaf,"").indexOf("ui-icon-")}).removeClass(s.item_open+" "+s.item_clsd).addClass(s.item_leaf||"jstree-no-icon")},this)).bind("select_node.jstree",$.proxy(function(e,data){data.rslt.obj.children("a").addClass(s.item_a)},this)).bind("deselect_node.jstree deselect_all.jstree",$.proxy(function(){this.get_container().find("a."+s.item_a).removeClass(s.item_a).end().find("a.jstree-clicked").addClass(s.item_a)},this)).bind("dehover_node.jstree",$.proxy(function(e,data){data.rslt.obj.children("a").removeClass(s.item_h)},this)).bind("hover_node.jstree",$.proxy(function(e,data){this.get_container().find("a."+s.item_h).not(data.rslt.obj).removeClass(s.item_h),data.rslt.obj.children("a").addClass(s.item_h)},this)).bind("move_node.jstree",$.proxy(function(e,data){this._themeroller(data.rslt.o),this._themeroller(data.rslt.op)},this))},__destroy:function(){var s=this._get_settings().themeroller,c=["ui-icon"];$.each(s,function(i,v){v=v.split(" "),v.length&&(c=c.concat(v))}),this.get_container().removeClass("ui-widget-content").find("."+c.join(", .")).removeClass(c.join(" "))},_fn:{_themeroller:function(obj){var s=this._get_settings().themeroller;obj=obj&&-1!=obj?this._get_node(obj).parent():this.get_container_ul(),obj.find("li.jstree-closed").children("ins.jstree-icon").removeClass(s.opened).addClass("ui-icon "+s.closed).end().children("a").addClass(s.item).children("ins.jstree-icon").addClass("ui-icon").filter(function(){return-1===this.className.toString().replace(s.item_clsd,"").replace(s.item_open,"").replace(s.item_leaf,"").indexOf("ui-icon-")}).removeClass(s.item_leaf+" "+s.item_open).addClass(s.item_clsd||"jstree-no-icon").end().end().end().end().find("li.jstree-open").children("ins.jstree-icon").removeClass(s.closed).addClass("ui-icon "+s.opened).end().children("a").addClass(s.item).children("ins.jstree-icon").addClass("ui-icon").filter(function(){return-1===this.className.toString().replace(s.item_clsd,"").replace(s.item_open,"").replace(s.item_leaf,"").indexOf("ui-icon-")}).removeClass(s.item_leaf+" "+s.item_clsd).addClass(s.item_open||"jstree-no-icon").end().end().end().end().find("li.jstree-leaf").children("ins.jstree-icon").removeClass(s.closed+" ui-icon "+s.opened).end().children("a").addClass(s.item).children("ins.jstree-icon").addClass("ui-icon").filter(function(){return-1===this.className.toString().replace(s.item_clsd,"").replace(s.item_open,"").replace(s.item_leaf,"").indexOf("ui-icon-")}).removeClass(s.item_clsd+" "+s.item_open).addClass(s.item_leaf||"jstree-no-icon")}},defaults:{opened:"ui-icon-triangle-1-se",closed:"ui-icon-triangle-1-e",item:"ui-state-default",item_h:"ui-state-hover",item_a:"ui-state-active",item_open:"ui-icon-folder-open",item_clsd:"ui-icon-folder-collapsed",item_leaf:"ui-icon-document"}}),$(function(){var css_string=".jstree-themeroller .ui-icon { overflow:visible; } .jstree-themeroller a { padding:0 2px; } .jstree-themeroller .jstree-no-icon { display:none; }";$.vakata.css.add_sheet({str:css_string,title:"jstree"})})}(jQuery),function($){$.jstree.plugin("unique",{__init:function(){this.get_container().bind("before.jstree",$.proxy(function(e,data){var p,t,nms=[],res=!0;return"move_node"==data.func&&data.args[4]===!0&&data.args[0].o&&data.args[0].o.length&&(data.args[0].o.children("a").each(function(){nms.push($(this).text().replace(/^\s+/g,""))}),res=this._check_unique(nms,data.args[0].np.find("> ul > li").not(data.args[0].o),"move_node")),"create_node"==data.func&&(data.args[4]||this._is_loaded(data.args[0]))&&(p=this._get_node(data.args[0]),!data.args[1]||"before"!==data.args[1]&&"after"!==data.args[1]||(p=this._get_parent(data.args[0]),p&&-1!==p||(p=this.get_container())),nms.push("string"==typeof data.args[2]?data.args[2]:data.args[2]&&data.args[2].data?data.args[2].data:this._get_string("new_node")),res=this._check_unique(nms,p.find("> ul > li"),"create_node")),"rename_node"==data.func&&(nms.push(data.args[1]),t=this._get_node(data.args[0]),p=this._get_parent(t),p&&-1!==p||(p=this.get_container()),res=this._check_unique(nms,p.find("> ul > li").not(t),"rename_node")),res?void 0:(e.stopPropagation(),!1)
},this))},defaults:{error_callback:$.noop},_fn:{_check_unique:function(nms,p,func){var cnms=[];return p.children("a").each(function(){cnms.push($(this).text().replace(/^\s+/g,""))}),cnms.length&&nms.length?(cnms=cnms.sort().join(",,").replace(/(,|^)([^,]+)(,,\2)+(,|$)/g,"$1$2$4").replace(/,,+/g,",").replace(/,$/,"").split(","),cnms.length+nms.length!=cnms.concat(nms).sort().join(",,").replace(/(,|^)([^,]+)(,,\2)+(,|$)/g,"$1$2$4").replace(/,,+/g,",").replace(/,$/,"").split(",").length?(this._get_settings().unique.error_callback.call(null,nms,p,func),!1):!0):!0},check_move:function(){if(!this.__call_old())return!1;var p=this._get_move(),nms=[];return p.o&&p.o.length?(p.o.children("a").each(function(){nms.push($(this).text().replace(/^\s+/g,""))}),this._check_unique(nms,p.np.find("> ul > li").not(p.o),"check_move")):!0}}})}(jQuery),function($){$.jstree.plugin("wholerow",{__init:function(){if(!this.data.ui)throw"jsTree wholerow: jsTree UI plugin not included.";this.data.wholerow.html=!1,this.data.wholerow.to=!1,this.get_container().bind("init.jstree",$.proxy(function(){this._get_settings().core.animation=0},this)).bind("open_node.jstree create_node.jstree clean_node.jstree loaded.jstree",$.proxy(function(e,data){this._prepare_wholerow_span(data&&data.rslt&&data.rslt.obj?data.rslt.obj:-1)},this)).bind("search.jstree clear_search.jstree reopen.jstree after_open.jstree after_close.jstree create_node.jstree delete_node.jstree clean_node.jstree",$.proxy(function(e,data){this.data.to&&clearTimeout(this.data.to),this.data.to=setTimeout(function(t,o){return function(){t._prepare_wholerow_ul(o)}}(this,data&&data.rslt&&data.rslt.obj?data.rslt.obj:-1),0)},this)).bind("deselect_all.jstree",$.proxy(function(){this.get_container().find(" > .jstree-wholerow .jstree-clicked").removeClass("jstree-clicked "+(this.data.themeroller?this._get_settings().themeroller.item_a:""))},this)).bind("select_node.jstree deselect_node.jstree ",$.proxy(function(e,data){data.rslt.obj.each(function(){var ref=data.inst.get_container().find(" > .jstree-wholerow li:visible:eq("+parseInt(($(this).offset().top-data.inst.get_container().offset().top+data.inst.get_container()[0].scrollTop)/data.inst.data.core.li_height,10)+")");ref.children("a").attr("class",data.rslt.obj.children("a").attr("class"))})},this)).bind("hover_node.jstree dehover_node.jstree",$.proxy(function(e,data){if(this.get_container().find(" > .jstree-wholerow .jstree-hovered").removeClass("jstree-hovered "+(this.data.themeroller?this._get_settings().themeroller.item_h:"")),"hover_node"===e.type){var ref=this.get_container().find(" > .jstree-wholerow li:visible:eq("+parseInt((data.rslt.obj.offset().top-this.get_container().offset().top+this.get_container()[0].scrollTop)/this.data.core.li_height,10)+")");ref.children("a").attr("class",data.rslt.obj.children(".jstree-hovered").attr("class"))}},this)).delegate(".jstree-wholerow-span, ins.jstree-icon, li","click.jstree",function(e){var n=$(e.currentTarget);"A"===e.target.tagName||"INS"===e.target.tagName&&n.closest("li").is(".jstree-open, .jstree-closed")||(n.closest("li").children("a:visible:eq(0)").click(),e.stopImmediatePropagation())}).delegate("li","mouseover.jstree",$.proxy(function(e){return e.stopImmediatePropagation(),$(e.currentTarget).children(".jstree-hovered, .jstree-clicked").length?!1:(this.hover_node(e.currentTarget),!1)},this)).delegate("li","mouseleave.jstree",$.proxy(function(e){$(e.currentTarget).children("a").hasClass("jstree-hovered").length||this.dehover_node(e.currentTarget)},this)),(is_ie7||is_ie6)&&$.vakata.css.add_sheet({str:".jstree-"+this.get_index()+" { position:relative; } ",title:"jstree"})},defaults:{},__destroy:function(){this.get_container().children(".jstree-wholerow").remove(),this.get_container().find(".jstree-wholerow-span").remove()},_fn:{_prepare_wholerow_span:function(obj){obj=obj&&-1!=obj?this._get_node(obj):this.get_container().find("> ul > li"),obj!==!1&&obj.each(function(){$(this).find("li").andSelf().each(function(){var $t=$(this);return $t.children(".jstree-wholerow-span").length?!0:void $t.prepend("<span class='jstree-wholerow-span' style='width:"+18*$t.parentsUntil(".jstree","li").length+"px;'>&#160;</span>")})})},_prepare_wholerow_ul:function(){var o=this.get_container().children("ul").eq(0),h=o.html();o.addClass("jstree-wholerow-real"),this.data.wholerow.last_html!==h&&(this.data.wholerow.last_html=h,this.get_container().children(".jstree-wholerow").remove(),this.get_container().append(o.clone().removeClass("jstree-wholerow-real").wrapAll("<div class='jstree-wholerow' />").parent().width(o.parent()[0].scrollWidth).css("top",-1*(o.height()+(is_ie7?5:0))).find("li[id]").each(function(){this.removeAttribute("id")}).end()))}}}),$(function(){var css_string=".jstree .jstree-wholerow-real { position:relative; z-index:1; } .jstree .jstree-wholerow-real li { cursor:pointer; } .jstree .jstree-wholerow-real a { border-left-color:transparent !important; border-right-color:transparent !important; } .jstree .jstree-wholerow { position:relative; z-index:0; height:0; } .jstree .jstree-wholerow ul, .jstree .jstree-wholerow li { width:100%; } .jstree .jstree-wholerow, .jstree .jstree-wholerow ul, .jstree .jstree-wholerow li, .jstree .jstree-wholerow a { margin:0 !important; padding:0 !important; } .jstree .jstree-wholerow, .jstree .jstree-wholerow ul, .jstree .jstree-wholerow li { background:transparent !important; }.jstree .jstree-wholerow ins, .jstree .jstree-wholerow span, .jstree .jstree-wholerow input { display:none !important; }.jstree .jstree-wholerow a, .jstree .jstree-wholerow a:hover { text-indent:-9999px; !important; width:100%; padding:0 !important; border-right-width:0px !important; border-left-width:0px !important; } .jstree .jstree-wholerow-span { position:absolute; left:0; margin:0px; padding:0; height:18px; border-width:0; padding:0; z-index:0; }";is_ff2&&(css_string+=".jstree .jstree-wholerow a { display:block; height:18px; margin:0; padding:0; border:0; } .jstree .jstree-wholerow-real a { border-color:transparent !important; } "),(is_ie7||is_ie6)&&(css_string+=".jstree .jstree-wholerow, .jstree .jstree-wholerow li, .jstree .jstree-wholerow ul, .jstree .jstree-wholerow a { margin:0; padding:0; line-height:18px; } .jstree .jstree-wholerow a { display:block; height:18px; line-height:18px; overflow:hidden; } "),$.vakata.css.add_sheet({str:css_string,title:"jstree"})})}(jQuery),function($){var nodeInterface=["getChildren","getChildrenCount","getAttr","getName","getProps"],validateInterface=function(obj,inter){var valid=!0;return obj=obj||{},inter=[].concat(inter),$.each(inter,function(i,v){return $.isFunction(obj[v])?void 0:(valid=!1,!1)}),valid};$.jstree.plugin("model",{__init:function(){if(!this.data.json_data)throw"jsTree model: jsTree json_data plugin not included.";this._get_settings().json_data.data=function(n,b){var obj=-1==n?this._get_settings().model.object:n.data("jstree_model");return validateInterface(obj,nodeInterface)?void(this._get_settings().model.async?obj.getChildren($.proxy(function(data){this.model_done(data,b)},this)):this.model_done(obj.getChildren(),b)):b.call(null,!1)}},defaults:{object:!1,id_prefix:!1,async:!1},_fn:{model_done:function(data,callback){var ret=[],s=this._get_settings(),_this=this;$.isArray(data)||(data=[data]),$.each(data,function(i,nd){var r=nd.getProps()||{};r.attr=nd.getAttr()||{},nd.getChildrenCount()&&(r.state="closed"),r.data=nd.getName(),$.isArray(r.data)||(r.data=[r.data]),_this.data.types&&$.isFunction(nd.getType)&&(r.attr[s.types.type_attr]=nd.getType()),r.attr.id&&s.model.id_prefix&&(r.attr.id=s.model.id_prefix+r.attr.id),r.metadata||(r.metadata={}),r.metadata.jstree_model=nd,ret.push(r)}),callback.call(null,ret)}}})}(jQuery)}}(),function($){var tmp,loading,overlay,wrap,outer,content,close,title,nav_left,nav_right,loadingTimer,start_pos,final_pos,selectedIndex=0,selectedOpts={},selectedArray=[],currentIndex=0,currentOpts={},currentArray=[],ajaxLoader=null,imgPreloader=new Image,imgRegExp=/\.(jpg|gif|png|bmp|jpeg)(.*)?$/i,swfRegExp=/[^\.]\.(swf)\s*$/i,loadingFrame=1,titleHeight=0,titleStr="",busy=!1,fx=$.extend($("<div/>")[0],{prop:0}),isIE6=$.browser.msie&&$.browser.version<7&&!window.XMLHttpRequest,_abort=function(){loading.hide(),imgPreloader.onerror=imgPreloader.onload=null,ajaxLoader&&ajaxLoader.abort(),tmp.empty()},_error=function(){return!1===selectedOpts.onError(selectedArray,selectedIndex,selectedOpts)?(loading.hide(),void(busy=!1)):(selectedOpts.titleShow=!1,selectedOpts.width="auto",selectedOpts.height="auto",tmp.html('<p id="fancybox-error">The requested content cannot be loaded.<br />Please try again later.</p>'),void _process_inline())},_start=function(){var href,type,title,str,emb,ret,obj=selectedArray[selectedIndex];if(_abort(),selectedOpts=$.extend({},$.fn.fancybox.defaults,"undefined"==typeof $(obj).data("fancybox")?selectedOpts:$(obj).data("fancybox")),ret=selectedOpts.onStart(selectedArray,selectedIndex,selectedOpts),ret===!1)return void(busy=!1);if("object"==typeof ret&&(selectedOpts=$.extend(selectedOpts,ret)),title=selectedOpts.title||(obj.nodeName?$(obj).attr("title"):obj.title)||"",obj.nodeName&&!selectedOpts.orig&&(selectedOpts.orig=$(obj).children("img:first").length?$(obj).children("img:first"):$(obj)),""===title&&selectedOpts.orig&&selectedOpts.titleFromAlt&&(title=selectedOpts.orig.attr("alt")),href=selectedOpts.href||(obj.nodeName?$(obj).attr("href"):obj.href)||null,(/^(?:javascript)/i.test(href)||"#"==href)&&(href=null),selectedOpts.type?(type=selectedOpts.type,href||(href=selectedOpts.content)):selectedOpts.content?type="html":href&&(type=href.match(imgRegExp)?"image":href.match(swfRegExp)?"swf":$(obj).hasClass("iframe")?"iframe":0===href.indexOf("#")?"inline":"ajax"),!type)return void _error();switch("inline"==type&&(obj=href.substr(href.indexOf("#")),type=$(obj).length>0?"inline":"ajax"),selectedOpts.type=type,selectedOpts.href=href,selectedOpts.title=title,selectedOpts.autoDimensions&&("html"==selectedOpts.type||"inline"==selectedOpts.type||"ajax"==selectedOpts.type?(selectedOpts.width="auto",selectedOpts.height="auto"):selectedOpts.autoDimensions=!1),selectedOpts.modal&&(selectedOpts.overlayShow=!0,selectedOpts.hideOnOverlayClick=!1,selectedOpts.hideOnContentClick=!1,selectedOpts.enableEscapeButton=!1,selectedOpts.showCloseButton=!1),selectedOpts.padding=parseInt(selectedOpts.padding,10),selectedOpts.margin=parseInt(selectedOpts.margin,10),tmp.css("padding",selectedOpts.padding+selectedOpts.margin),$(".fancybox-inline-tmp").unbind("fancybox-cancel").bind("fancybox-change",function(){$(this).replaceWith(content.children())}),type){case"html":tmp.html(selectedOpts.content),_process_inline();break;case"inline":if($(obj).parent().is("#fancybox-content")===!0)return void(busy=!1);$('<div class="fancybox-inline-tmp" />').hide().insertBefore($(obj)).bind("fancybox-cleanup",function(){$(this).replaceWith(content.children())}).bind("fancybox-cancel",function(){$(this).replaceWith(tmp.children())}),$(obj).appendTo(tmp),_process_inline();break;case"image":busy=!1,$.fancybox.showActivity(),imgPreloader=new Image,imgPreloader.onerror=function(){_error()},imgPreloader.onload=function(){busy=!0,imgPreloader.onerror=imgPreloader.onload=null,_process_image()},imgPreloader.src=href;break;case"swf":selectedOpts.scrolling="no",str='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="'+selectedOpts.width+'" height="'+selectedOpts.height+'"><param name="movie" value="'+href+'"></param>',emb="",$.each(selectedOpts.swf,function(name,val){str+='<param name="'+name+'" value="'+val+'"></param>',emb+=" "+name+'="'+val+'"'}),str+='<embed src="'+href+'" type="application/x-shockwave-flash" width="'+selectedOpts.width+'" height="'+selectedOpts.height+'"'+emb+"></embed></object>",tmp.html(str),_process_inline();break;case"ajax":busy=!1,$.fancybox.showActivity(),selectedOpts.ajax.win=selectedOpts.ajax.success,ajaxLoader=$.ajax($.extend({},selectedOpts.ajax,{url:href,data:selectedOpts.ajax.data||{},error:function(XMLHttpRequest){XMLHttpRequest.status>0&&_error()},success:function(data,textStatus,XMLHttpRequest){var o="object"==typeof XMLHttpRequest?XMLHttpRequest:ajaxLoader;if(200==o.status){if("function"==typeof selectedOpts.ajax.win){if(ret=selectedOpts.ajax.win(href,data,textStatus,XMLHttpRequest),ret===!1)return void loading.hide();("string"==typeof ret||"object"==typeof ret)&&(data=ret)}tmp.html(data),_process_inline()}}}));break;case"iframe":_show()}},_process_inline=function(){var w=selectedOpts.width,h=selectedOpts.height;w=w.toString().indexOf("%")>-1?parseInt(($(window).width()-2*selectedOpts.margin)*parseFloat(w)/100,10)+"px":"auto"==w?"auto":w+"px",h=h.toString().indexOf("%")>-1?parseInt(($(window).height()-2*selectedOpts.margin)*parseFloat(h)/100,10)+"px":"auto"==h?"auto":h+"px",tmp.wrapInner('<div style="width:'+w+";height:"+h+";overflow: "+("auto"==selectedOpts.scrolling?"auto":"yes"==selectedOpts.scrolling?"scroll":"hidden")+';position:relative;"></div>'),selectedOpts.width=tmp.width(),selectedOpts.height=tmp.height(),_show()},_process_image=function(){selectedOpts.width=imgPreloader.width,selectedOpts.height=imgPreloader.height,$("<img />").attr({id:"fancybox-img",src:imgPreloader.src,alt:selectedOpts.title}).appendTo(tmp),_show()},_show=function(){var pos,equal;return loading.hide(),wrap.is(":visible")&&!1===currentOpts.onCleanup(currentArray,currentIndex,currentOpts)?($.event.trigger("fancybox-cancel"),void(busy=!1)):(busy=!0,$(content.add(overlay)).unbind(),$(window).unbind("resize.fb scroll.fb"),$(document).unbind("keydown.fb"),wrap.is(":visible")&&"outside"!==currentOpts.titlePosition&&wrap.css("height",wrap.height()),currentArray=selectedArray,currentIndex=selectedIndex,currentOpts=selectedOpts,currentOpts.overlayShow?(overlay.css({"background-color":currentOpts.overlayColor,opacity:currentOpts.overlayOpacity,cursor:currentOpts.hideOnOverlayClick?"pointer":"auto",height:$(document).height()}),overlay.is(":visible")||(isIE6&&$("select:not(#fancybox-tmp select)").filter(function(){return"hidden"!==this.style.visibility}).css({visibility:"hidden"}).one("fancybox-cleanup",function(){this.style.visibility="inherit"}),overlay.show())):overlay.hide(),final_pos=_get_zoom_to(),_process_title(),wrap.is(":visible")?($(close.add(nav_left).add(nav_right)).hide(),pos=wrap.position(),start_pos={top:pos.top,left:pos.left,width:wrap.width(),height:wrap.height()},equal=start_pos.width==final_pos.width&&start_pos.height==final_pos.height,void content.fadeTo(currentOpts.changeFade,.3,function(){var finish_resizing=function(){content.html(tmp.contents()).fadeTo(currentOpts.changeFade,1,_finish)};$.event.trigger("fancybox-change"),content.empty().removeAttr("filter").css({"border-width":currentOpts.padding,width:final_pos.width-2*currentOpts.padding,height:selectedOpts.autoDimensions?"auto":final_pos.height-titleHeight-2*currentOpts.padding}),equal?finish_resizing():(fx.prop=0,$(fx).animate({prop:1},{duration:currentOpts.changeSpeed,easing:currentOpts.easingChange,step:_draw,complete:finish_resizing}))})):(wrap.removeAttr("style"),content.css("border-width",currentOpts.padding),"elastic"==currentOpts.transitionIn?(start_pos=_get_zoom_from(),content.html(tmp.contents()),wrap.show(),currentOpts.opacity&&(final_pos.opacity=0),fx.prop=0,void $(fx).animate({prop:1},{duration:currentOpts.speedIn,easing:currentOpts.easingIn,step:_draw,complete:_finish})):("inside"==currentOpts.titlePosition&&titleHeight>0&&title.show(),content.css({width:final_pos.width-2*currentOpts.padding,height:selectedOpts.autoDimensions?"auto":final_pos.height-titleHeight-2*currentOpts.padding}).html(tmp.contents()),void wrap.css(final_pos).fadeIn("none"==currentOpts.transitionIn?0:currentOpts.speedIn,_finish))))},_format_title=function(title){return title&&title.length?"float"==currentOpts.titlePosition?'<table id="fancybox-title-float-wrap" cellpadding="0" cellspacing="0"><tr><td id="fancybox-title-float-left"></td><td id="fancybox-title-float-main">'+title+'</td><td id="fancybox-title-float-right"></td></tr></table>':'<div id="fancybox-title-'+currentOpts.titlePosition+'">'+title+"</div>":!1},_process_title=function(){if(titleStr=currentOpts.title||"",titleHeight=0,title.empty().removeAttr("style").removeClass(),currentOpts.titleShow===!1)return void title.hide();if(titleStr=$.isFunction(currentOpts.titleFormat)?currentOpts.titleFormat(titleStr,currentArray,currentIndex,currentOpts):_format_title(titleStr),!titleStr||""===titleStr)return void title.hide();switch(title.addClass("fancybox-title-"+currentOpts.titlePosition).html(titleStr).appendTo("body").show(),currentOpts.titlePosition){case"inside":title.css({width:final_pos.width-2*currentOpts.padding,marginLeft:currentOpts.padding,marginRight:currentOpts.padding}),titleHeight=title.outerHeight(!0),title.appendTo(outer),final_pos.height+=titleHeight;break;case"over":title.css({marginLeft:currentOpts.padding,width:final_pos.width-2*currentOpts.padding,bottom:currentOpts.padding}).appendTo(outer);break;case"float":title.css("left",-1*parseInt((title.width()-final_pos.width-40)/2,10)).appendTo(wrap);break;default:title.css({width:final_pos.width-2*currentOpts.padding,paddingLeft:currentOpts.padding,paddingRight:currentOpts.padding}).appendTo(wrap)}title.hide()},_set_navigation=function(){return(currentOpts.enableEscapeButton||currentOpts.enableKeyboardNav)&&$(document).bind("keydown.fb",function(e){27==e.keyCode&&currentOpts.enableEscapeButton?(e.preventDefault(),$.fancybox.close()):37!=e.keyCode&&39!=e.keyCode||!currentOpts.enableKeyboardNav||"INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName||"SELECT"===e.target.tagName||(e.preventDefault(),$.fancybox[37==e.keyCode?"prev":"next"]())}),currentOpts.showNavArrows?((currentOpts.cyclic&&currentArray.length>1||0!==currentIndex)&&nav_left.show(),void((currentOpts.cyclic&&currentArray.length>1||currentIndex!=currentArray.length-1)&&nav_right.show())):(nav_left.hide(),void nav_right.hide())},_finish=function(){$.support.opacity||(content.get(0).style.removeAttribute("filter"),wrap.get(0).style.removeAttribute("filter")),selectedOpts.autoDimensions&&content.css("height","auto"),wrap.css("height","auto"),titleStr&&titleStr.length&&title.show(),currentOpts.showCloseButton&&close.show(),_set_navigation(),currentOpts.hideOnContentClick&&content.bind("click",$.fancybox.close),currentOpts.hideOnOverlayClick&&overlay.bind("click",$.fancybox.close),$(window).bind("resize.fb",$.fancybox.resize),currentOpts.centerOnScroll&&$(window).bind("scroll.fb",$.fancybox.center),"iframe"==currentOpts.type&&$('<iframe id="fancybox-frame" name="fancybox-frame'+(new Date).getTime()+'" frameborder="0" hspace="0" '+($.browser.msie?'allowtransparency="true""':"")+' scrolling="'+selectedOpts.scrolling+'" src="'+currentOpts.href+'"></iframe>').appendTo(content),wrap.show(),busy=!1,$.fancybox.center(),currentOpts.onComplete(currentArray,currentIndex,currentOpts),_preload_images()},_preload_images=function(){var href,objNext;currentArray.length-1>currentIndex&&(href=currentArray[currentIndex+1].href,"undefined"!=typeof href&&href.match(imgRegExp)&&(objNext=new Image,objNext.src=href)),currentIndex>0&&(href=currentArray[currentIndex-1].href,"undefined"!=typeof href&&href.match(imgRegExp)&&(objNext=new Image,objNext.src=href))},_draw=function(pos){var dim={width:parseInt(start_pos.width+(final_pos.width-start_pos.width)*pos,10),height:parseInt(start_pos.height+(final_pos.height-start_pos.height)*pos,10),top:parseInt(start_pos.top+(final_pos.top-start_pos.top)*pos,10),left:parseInt(start_pos.left+(final_pos.left-start_pos.left)*pos,10)};"undefined"!=typeof final_pos.opacity&&(dim.opacity=.5>pos?.5:pos),wrap.css(dim),content.css({width:dim.width-2*currentOpts.padding,height:dim.height-titleHeight*pos-2*currentOpts.padding})},_get_viewport=function(){return[$(window).width()-2*currentOpts.margin,$(window).height()-2*currentOpts.margin,$(document).scrollLeft()+currentOpts.margin,$(document).scrollTop()+currentOpts.margin]},_get_zoom_to=function(){var ratio,view=_get_viewport(),to={},resize=currentOpts.autoScale,double_padding=2*currentOpts.padding;return to.width=currentOpts.width.toString().indexOf("%")>-1?parseInt(view[0]*parseFloat(currentOpts.width)/100,10):currentOpts.width+double_padding,to.height=currentOpts.height.toString().indexOf("%")>-1?parseInt(view[1]*parseFloat(currentOpts.height)/100,10):currentOpts.height+double_padding,resize&&(to.width>view[0]||to.height>view[1])&&("image"==selectedOpts.type||"swf"==selectedOpts.type?(ratio=currentOpts.width/currentOpts.height,to.width>view[0]&&(to.width=view[0],to.height=parseInt((to.width-double_padding)/ratio+double_padding,10)),to.height>view[1]&&(to.height=view[1],to.width=parseInt((to.height-double_padding)*ratio+double_padding,10))):(to.width=Math.min(to.width,view[0]),to.height=Math.min(to.height,view[1]))),to.top=parseInt(Math.max(view[3]-20,view[3]+.5*(view[1]-to.height-40)),10),to.left=parseInt(Math.max(view[2]-20,view[2]+.5*(view[0]-to.width-40)),10),to},_get_obj_pos=function(obj){var pos=obj.offset();return pos.top+=parseInt(obj.css("paddingTop"),10)||0,pos.left+=parseInt(obj.css("paddingLeft"),10)||0,pos.top+=parseInt(obj.css("border-top-width"),10)||0,pos.left+=parseInt(obj.css("border-left-width"),10)||0,pos.width=obj.width(),pos.height=obj.height(),pos},_get_zoom_from=function(){var pos,view,orig=selectedOpts.orig?$(selectedOpts.orig):!1,from={};return orig&&orig.length?(pos=_get_obj_pos(orig),from={width:pos.width+2*currentOpts.padding,height:pos.height+2*currentOpts.padding,top:pos.top-currentOpts.padding-20,left:pos.left-currentOpts.padding-20}):(view=_get_viewport(),from={width:2*currentOpts.padding,height:2*currentOpts.padding,top:parseInt(view[3]+.5*view[1],10),left:parseInt(view[2]+.5*view[0],10)}),from},_animate_loading=function(){return loading.is(":visible")?($("div",loading).css("top",-40*loadingFrame+"px"),void(loadingFrame=(loadingFrame+1)%12)):void clearInterval(loadingTimer)};$.fn.fancybox=function(options){return $(this).length?($(this).data("fancybox",$.extend({},options,$.metadata?$(this).metadata():{})).unbind("click.fb").bind("click.fb",function(e){if(e.preventDefault(),!busy){busy=!0,$(this).blur(),selectedArray=[],selectedIndex=0;var rel=$(this).attr("rel")||"";rel&&""!=rel&&"nofollow"!==rel?(selectedArray=$("a[rel="+rel+"], area[rel="+rel+"]"),selectedIndex=selectedArray.index(this)):selectedArray.push(this),_start()}}),this):this},$.fancybox=function(obj){var opts;if(!busy){if(busy=!0,opts="undefined"!=typeof arguments[1]?arguments[1]:{},selectedArray=[],selectedIndex=parseInt(opts.index,10)||0,$.isArray(obj)){for(var i=0,j=obj.length;j>i;i++)"object"==typeof obj[i]?$(obj[i]).data("fancybox",$.extend({},opts,obj[i])):obj[i]=$({}).data("fancybox",$.extend({content:obj[i]},opts));selectedArray=jQuery.merge(selectedArray,obj)}else"object"==typeof obj?$(obj).data("fancybox",$.extend({},opts,obj)):obj=$({}).data("fancybox",$.extend({content:obj},opts)),selectedArray.push(obj);(selectedIndex>selectedArray.length||0>selectedIndex)&&(selectedIndex=0),_start()}},$.fancybox.showActivity=function(){clearInterval(loadingTimer),loading.show(),loadingTimer=setInterval(_animate_loading,66)},$.fancybox.hideActivity=function(){loading.hide()},$.fancybox.next=function(){return $.fancybox.pos(currentIndex+1)},$.fancybox.prev=function(){return $.fancybox.pos(currentIndex-1)},$.fancybox.pos=function(pos){busy||(pos=parseInt(pos),selectedArray=currentArray,pos>-1&&pos<currentArray.length?(selectedIndex=pos,_start()):currentOpts.cyclic&&currentArray.length>1&&(selectedIndex=pos>=currentArray.length?0:currentArray.length-1,_start()))},$.fancybox.cancel=function(){busy||(busy=!0,$.event.trigger("fancybox-cancel"),_abort(),selectedOpts.onCancel(selectedArray,selectedIndex,selectedOpts),busy=!1)},$.fancybox.close=function(){function _cleanup(){overlay.fadeOut("fast"),title.empty().hide(),wrap.hide(),$.event.trigger("fancybox-cleanup"),content.empty(),currentOpts.onClosed(currentArray,currentIndex,currentOpts),currentArray=selectedOpts=[],currentIndex=selectedIndex=0,currentOpts=selectedOpts={},busy=!1}if(!busy&&!wrap.is(":hidden")){if(busy=!0,currentOpts&&!1===currentOpts.onCleanup(currentArray,currentIndex,currentOpts))return void(busy=!1);if(_abort(),$(close.add(nav_left).add(nav_right)).hide(),$(content.add(overlay)).unbind(),$(window).unbind("resize.fb scroll.fb"),$(document).unbind("keydown.fb"),content.find("iframe").attr("src",isIE6&&/^https/i.test(window.location.href||"")?"javascript:void(false)":"about:blank"),"inside"!==currentOpts.titlePosition&&title.empty(),wrap.stop(),"elastic"==currentOpts.transitionOut){start_pos=_get_zoom_from();var pos=wrap.position();final_pos={top:pos.top,left:pos.left,width:wrap.width(),height:wrap.height()},currentOpts.opacity&&(final_pos.opacity=1),title.empty().hide(),fx.prop=1,$(fx).animate({prop:0},{duration:currentOpts.speedOut,easing:currentOpts.easingOut,step:_draw,complete:_cleanup})}else wrap.fadeOut("none"==currentOpts.transitionOut?0:currentOpts.speedOut,_cleanup)}},$.fancybox.resize=function(){overlay.is(":visible")&&overlay.css("height",$(document).height()),$.fancybox.center(!0)},$.fancybox.center=function(){var view,align;busy||(align=arguments[0]===!0?1:0,view=_get_viewport(),(align||!(wrap.width()>view[0]||wrap.height()>view[1]))&&wrap.stop().animate({top:parseInt(Math.max(view[3]-20,view[3]+.5*(view[1]-content.height()-40)-currentOpts.padding)),left:parseInt(Math.max(view[2]-20,view[2]+.5*(view[0]-content.width()-40)-currentOpts.padding))},"number"==typeof arguments[0]?arguments[0]:200))},$.fancybox.init=function(){$("#fancybox-wrap").length||($("body").append(tmp=$('<div id="fancybox-tmp"></div>'),loading=$('<div id="fancybox-loading"><div></div></div>'),overlay=$('<div id="fancybox-overlay"></div>'),wrap=$('<div id="fancybox-wrap"></div>')),outer=$('<div id="fancybox-outer"></div>').append('<div class="fancybox-bg" id="fancybox-bg-n"></div><div class="fancybox-bg" id="fancybox-bg-ne"></div><div class="fancybox-bg" id="fancybox-bg-e"></div><div class="fancybox-bg" id="fancybox-bg-se"></div><div class="fancybox-bg" id="fancybox-bg-s"></div><div class="fancybox-bg" id="fancybox-bg-sw"></div><div class="fancybox-bg" id="fancybox-bg-w"></div><div class="fancybox-bg" id="fancybox-bg-nw"></div>').appendTo(wrap),outer.append(content=$('<div id="fancybox-content"></div>'),close=$('<a id="fancybox-close"></a>'),title=$('<div id="fancybox-title"></div>'),nav_left=$('<a href="javascript:;" id="fancybox-left"><span class="fancy-ico" id="fancybox-left-ico"></span></a>'),nav_right=$('<a href="javascript:;" id="fancybox-right"><span class="fancy-ico" id="fancybox-right-ico"></span></a>')),close.click($.fancybox.close),loading.click($.fancybox.cancel),nav_left.click(function(e){e.preventDefault(),$.fancybox.prev()}),nav_right.click(function(e){e.preventDefault(),$.fancybox.next()}),$.fn.mousewheel&&wrap.bind("mousewheel.fb",function(e,delta){busy?e.preventDefault():(0==$(e.target).get(0).clientHeight||$(e.target).get(0).scrollHeight===$(e.target).get(0).clientHeight)&&(e.preventDefault(),$.fancybox[delta>0?"prev":"next"]())}),$.support.opacity||wrap.addClass("fancybox-ie"),isIE6&&(loading.addClass("fancybox-ie6"),wrap.addClass("fancybox-ie6"),$('<iframe id="fancybox-hide-sel-frame" src="'+(/^https/i.test(window.location.href||"")?"javascript:void(false)":"about:blank")+'" scrolling="no" border="0" frameborder="0" tabindex="-1"></iframe>').prependTo(outer)))},$.fn.fancybox.defaults={padding:10,margin:40,opacity:!1,modal:!1,cyclic:!1,scrolling:"auto",width:560,height:340,autoScale:!0,autoDimensions:!0,centerOnScroll:!1,ajax:{},swf:{wmode:"transparent"},hideOnOverlayClick:!0,hideOnContentClick:!1,overlayShow:!0,overlayOpacity:.7,overlayColor:"#777",titleShow:!0,titlePosition:"float",titleFormat:null,titleFromAlt:!1,transitionIn:"fade",transitionOut:"fade",speedIn:300,speedOut:300,changeSpeed:300,changeFade:"fast",easingIn:"swing",easingOut:"swing",showCloseButton:!0,showNavArrows:!0,enableEscapeButton:!0,enableKeyboardNav:!0,onStart:function(){},onCancel:function(){},onComplete:function(){},onCleanup:function(){},onClosed:function(){},onError:function(){}},$(document).ready(function(){$.fancybox.init()})}(jQuery);var CryptoJS=CryptoJS||function(i,m){var p={},h=p.lib={},n=h.Base=function(){function a(){}return{extend:function(b){a.prototype=this;var c=new a;return b&&c.mixIn(b),c.$super=this,c},create:function(){var a=this.extend();return a.init.apply(a,arguments),a},init:function(){},mixIn:function(a){for(var c in a)a.hasOwnProperty(c)&&(this[c]=a[c]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.$super.extend(this)}}}(),o=h.WordArray=n.extend({init:function(a,b){a=this.words=a||[],this.sigBytes=b!=m?b:4*a.length},toString:function(a){return(a||e).stringify(this)},concat:function(a){var b=this.words,c=a.words,d=this.sigBytes,a=a.sigBytes;if(this.clamp(),d%4)for(var f=0;a>f;f++)b[d+f>>>2]|=(c[f>>>2]>>>24-8*(f%4)&255)<<24-8*((d+f)%4);else if(65535<c.length)for(f=0;a>f;f+=4)b[d+f>>>2]=c[f>>>2];else b.push.apply(b,c);return this.sigBytes+=a,this},clamp:function(){var a=this.words,b=this.sigBytes;a[b>>>2]&=4294967295<<32-8*(b%4),a.length=i.ceil(b/4)},clone:function(){var a=n.clone.call(this);return a.words=this.words.slice(0),a},random:function(a){for(var b=[],c=0;a>c;c+=4)b.push(4294967296*i.random()|0);return o.create(b,a)}}),q=p.enc={},e=q.Hex={stringify:function(a){for(var b=a.words,a=a.sigBytes,c=[],d=0;a>d;d++){var f=b[d>>>2]>>>24-8*(d%4)&255;c.push((f>>>4).toString(16)),c.push((15&f).toString(16))}return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d+=2)c[d>>>3]|=parseInt(a.substr(d,2),16)<<24-4*(d%8);return o.create(c,b/2)}},g=q.Latin1={stringify:function(a){for(var b=a.words,a=a.sigBytes,c=[],d=0;a>d;d++)c.push(String.fromCharCode(b[d>>>2]>>>24-8*(d%4)&255));return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d++)c[d>>>2]|=(255&a.charCodeAt(d))<<24-8*(d%4);return o.create(c,b)}},j=q.Utf8={stringify:function(a){try{return decodeURIComponent(escape(g.stringify(a)))}catch(b){throw Error("Malformed UTF-8 data")}},parse:function(a){return g.parse(unescape(encodeURIComponent(a)))}},k=h.BufferedBlockAlgorithm=n.extend({reset:function(){this._data=o.create(),this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=j.parse(a)),this._data.concat(a),this._nDataBytes+=a.sigBytes},_process:function(a){var b=this._data,c=b.words,d=b.sigBytes,f=this.blockSize,e=d/(4*f),e=a?i.ceil(e):i.max((0|e)-this._minBufferSize,0),a=e*f,d=i.min(4*a,d);if(a){for(var g=0;a>g;g+=f)this._doProcessBlock(c,g);g=c.splice(0,a),b.sigBytes-=d}return o.create(g,d)},clone:function(){var a=n.clone.call(this);return a._data=this._data.clone(),a},_minBufferSize:0});h.Hasher=k.extend({init:function(){this.reset()},reset:function(){k.reset.call(this),this._doReset()},update:function(a){return this._append(a),this._process(),this},finalize:function(a){return a&&this._append(a),this._doFinalize(),this._hash},clone:function(){var a=k.clone.call(this);return a._hash=this._hash.clone(),a},blockSize:16,_createHelper:function(a){return function(b,c){return a.create(c).finalize(b)}},_createHmacHelper:function(a){return function(b,c){return l.HMAC.create(a,c).finalize(b)}}});var l=p.algo={};return p}(Math);!function(){var i=CryptoJS,m=i.lib,p=m.WordArray,m=m.Hasher,h=[],n=i.algo.SHA1=m.extend({_doReset:function(){this._hash=p.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(o,i){for(var e=this._hash.words,g=e[0],j=e[1],k=e[2],l=e[3],a=e[4],b=0;80>b;b++){if(16>b)h[b]=0|o[i+b];else{var c=h[b-3]^h[b-8]^h[b-14]^h[b-16];h[b]=c<<1|c>>>31}c=(g<<5|g>>>27)+a+h[b],c=20>b?c+((j&k|~j&l)+1518500249):40>b?c+((j^k^l)+1859775393):60>b?c+((j&k|j&l|k&l)-1894007588):c+((j^k^l)-899497514),a=l,l=k,k=j<<30|j>>>2,j=g,g=c}e[0]=e[0]+g|0,e[1]=e[1]+j|0,e[2]=e[2]+k|0,e[3]=e[3]+l|0,e[4]=e[4]+a|0},_doFinalize:function(){var i=this._data,h=i.words,e=8*this._nDataBytes,g=8*i.sigBytes;
h[g>>>5]|=128<<24-g%32,h[(g+64>>>9<<4)+15]=e,i.sigBytes=4*h.length,this._process()}});i.SHA1=m._createHelper(n),i.HmacSHA1=m._createHmacHelper(n)}();var DIFF_DELETE=-1,DIFF_INSERT=1,DIFF_EQUAL=0;diff_match_patch.Diff,diff_match_patch.prototype.diff_main=function(text1,text2,opt_checklines,opt_deadline){"undefined"==typeof opt_deadline&&(opt_deadline=this.Diff_Timeout<=0?Number.MAX_VALUE:(new Date).getTime()+1e3*this.Diff_Timeout);var deadline=opt_deadline;if(null==text1||null==text2)throw new Error("Null input. (diff_main)");if(text1==text2)return text1?[[DIFF_EQUAL,text1]]:[];"undefined"==typeof opt_checklines&&(opt_checklines=!0);var checklines=opt_checklines,commonlength=this.diff_commonPrefix(text1,text2),commonprefix=text1.substring(0,commonlength);text1=text1.substring(commonlength),text2=text2.substring(commonlength),commonlength=this.diff_commonSuffix(text1,text2);var commonsuffix=text1.substring(text1.length-commonlength);text1=text1.substring(0,text1.length-commonlength),text2=text2.substring(0,text2.length-commonlength);var diffs=this.diff_compute_(text1,text2,checklines,deadline);return commonprefix&&diffs.unshift([DIFF_EQUAL,commonprefix]),commonsuffix&&diffs.push([DIFF_EQUAL,commonsuffix]),this.diff_cleanupMerge(diffs),diffs},diff_match_patch.prototype.diff_compute_=function(text1,text2,checklines,deadline){var diffs;if(!text1)return[[DIFF_INSERT,text2]];if(!text2)return[[DIFF_DELETE,text1]];var longtext=text1.length>text2.length?text1:text2,shorttext=text1.length>text2.length?text2:text1,i=longtext.indexOf(shorttext);if(-1!=i)return diffs=[[DIFF_INSERT,longtext.substring(0,i)],[DIFF_EQUAL,shorttext],[DIFF_INSERT,longtext.substring(i+shorttext.length)]],text1.length>text2.length&&(diffs[0][0]=diffs[2][0]=DIFF_DELETE),diffs;if(1==shorttext.length)return[[DIFF_DELETE,text1],[DIFF_INSERT,text2]];var hm=this.diff_halfMatch_(text1,text2);if(hm){var text1_a=hm[0],text1_b=hm[1],text2_a=hm[2],text2_b=hm[3],mid_common=hm[4],diffs_a=this.diff_main(text1_a,text2_a,checklines,deadline),diffs_b=this.diff_main(text1_b,text2_b,checklines,deadline);return diffs_a.concat([[DIFF_EQUAL,mid_common]],diffs_b)}return checklines&&text1.length>100&&text2.length>100?this.diff_lineMode_(text1,text2,deadline):this.diff_bisect_(text1,text2,deadline)},diff_match_patch.prototype.diff_lineMode_=function(text1,text2,deadline){var a=this.diff_linesToChars_(text1,text2);text1=a.chars1,text2=a.chars2;var linearray=a.lineArray,diffs=this.diff_main(text1,text2,!1,deadline);this.diff_charsToLines_(diffs,linearray),this.diff_cleanupSemantic(diffs),diffs.push([DIFF_EQUAL,""]);for(var pointer=0,count_delete=0,count_insert=0,text_delete="",text_insert="";pointer<diffs.length;){switch(diffs[pointer][0]){case DIFF_INSERT:count_insert++,text_insert+=diffs[pointer][1];break;case DIFF_DELETE:count_delete++,text_delete+=diffs[pointer][1];break;case DIFF_EQUAL:if(count_delete>=1&&count_insert>=1){diffs.splice(pointer-count_delete-count_insert,count_delete+count_insert),pointer=pointer-count_delete-count_insert;for(var a=this.diff_main(text_delete,text_insert,!1,deadline),j=a.length-1;j>=0;j--)diffs.splice(pointer,0,a[j]);pointer+=a.length}count_insert=0,count_delete=0,text_delete="",text_insert=""}pointer++}return diffs.pop(),diffs},diff_match_patch.prototype.diff_bisect_=function(text1,text2,deadline){for(var text1_length=text1.length,text2_length=text2.length,max_d=Math.ceil((text1_length+text2_length)/2),v_offset=max_d,v_length=2*max_d,v1=new Array(v_length),v2=new Array(v_length),x=0;v_length>x;x++)v1[x]=-1,v2[x]=-1;v1[v_offset+1]=0,v2[v_offset+1]=0;for(var delta=text1_length-text2_length,front=delta%2!=0,k1start=0,k1end=0,k2start=0,k2end=0,d=0;max_d>d&&!((new Date).getTime()>deadline);d++){for(var k1=-d+k1start;d-k1end>=k1;k1+=2){var x1,k1_offset=v_offset+k1;x1=k1==-d||k1!=d&&v1[k1_offset-1]<v1[k1_offset+1]?v1[k1_offset+1]:v1[k1_offset-1]+1;for(var y1=x1-k1;text1_length>x1&&text2_length>y1&&text1.charAt(x1)==text2.charAt(y1);)x1++,y1++;if(v1[k1_offset]=x1,x1>text1_length)k1end+=2;else if(y1>text2_length)k1start+=2;else if(front){var k2_offset=v_offset+delta-k1;if(k2_offset>=0&&v_length>k2_offset&&-1!=v2[k2_offset]){var x2=text1_length-v2[k2_offset];if(x1>=x2)return this.diff_bisectSplit_(text1,text2,x1,y1,deadline)}}}for(var k2=-d+k2start;d-k2end>=k2;k2+=2){var x2,k2_offset=v_offset+k2;x2=k2==-d||k2!=d&&v2[k2_offset-1]<v2[k2_offset+1]?v2[k2_offset+1]:v2[k2_offset-1]+1;for(var y2=x2-k2;text1_length>x2&&text2_length>y2&&text1.charAt(text1_length-x2-1)==text2.charAt(text2_length-y2-1);)x2++,y2++;if(v2[k2_offset]=x2,x2>text1_length)k2end+=2;else if(y2>text2_length)k2start+=2;else if(!front){var k1_offset=v_offset+delta-k2;if(k1_offset>=0&&v_length>k1_offset&&-1!=v1[k1_offset]){var x1=v1[k1_offset],y1=v_offset+x1-k1_offset;if(x2=text1_length-x2,x1>=x2)return this.diff_bisectSplit_(text1,text2,x1,y1,deadline)}}}}return[[DIFF_DELETE,text1],[DIFF_INSERT,text2]]},diff_match_patch.prototype.diff_bisectSplit_=function(text1,text2,x,y,deadline){var text1a=text1.substring(0,x),text2a=text2.substring(0,y),text1b=text1.substring(x),text2b=text2.substring(y),diffs=this.diff_main(text1a,text2a,!1,deadline),diffsb=this.diff_main(text1b,text2b,!1,deadline);return diffs.concat(diffsb)},diff_match_patch.prototype.diff_linesToChars_=function(text1,text2){function diff_linesToCharsMunge_(text){for(var chars="",lineStart=0,lineEnd=-1,lineArrayLength=lineArray.length;lineEnd<text.length-1;){lineEnd=text.indexOf("\n",lineStart),-1==lineEnd&&(lineEnd=text.length-1);var line=text.substring(lineStart,lineEnd+1);lineStart=lineEnd+1,(lineHash.hasOwnProperty?lineHash.hasOwnProperty(line):void 0!==lineHash[line])?chars+=String.fromCharCode(lineHash[line]):(chars+=String.fromCharCode(lineArrayLength),lineHash[line]=lineArrayLength,lineArray[lineArrayLength++]=line)}return chars}var lineArray=[],lineHash={};lineArray[0]="";var chars1=diff_linesToCharsMunge_(text1),chars2=diff_linesToCharsMunge_(text2);return{chars1:chars1,chars2:chars2,lineArray:lineArray}},diff_match_patch.prototype.diff_charsToLines_=function(diffs,lineArray){for(var x=0;x<diffs.length;x++){for(var chars=diffs[x][1],text=[],y=0;y<chars.length;y++)text[y]=lineArray[chars.charCodeAt(y)];diffs[x][1]=text.join("")}},diff_match_patch.prototype.diff_commonPrefix=function(text1,text2){if(!text1||!text2||text1.charAt(0)!=text2.charAt(0))return 0;for(var pointermin=0,pointermax=Math.min(text1.length,text2.length),pointermid=pointermax,pointerstart=0;pointermid>pointermin;)text1.substring(pointerstart,pointermid)==text2.substring(pointerstart,pointermid)?(pointermin=pointermid,pointerstart=pointermin):pointermax=pointermid,pointermid=Math.floor((pointermax-pointermin)/2+pointermin);return pointermid},diff_match_patch.prototype.diff_commonSuffix=function(text1,text2){if(!text1||!text2||text1.charAt(text1.length-1)!=text2.charAt(text2.length-1))return 0;for(var pointermin=0,pointermax=Math.min(text1.length,text2.length),pointermid=pointermax,pointerend=0;pointermid>pointermin;)text1.substring(text1.length-pointermid,text1.length-pointerend)==text2.substring(text2.length-pointermid,text2.length-pointerend)?(pointermin=pointermid,pointerend=pointermin):pointermax=pointermid,pointermid=Math.floor((pointermax-pointermin)/2+pointermin);return pointermid},diff_match_patch.prototype.diff_commonOverlap_=function(text1,text2){var text1_length=text1.length,text2_length=text2.length;if(0==text1_length||0==text2_length)return 0;text1_length>text2_length?text1=text1.substring(text1_length-text2_length):text2_length>text1_length&&(text2=text2.substring(0,text1_length));var text_length=Math.min(text1_length,text2_length);if(text1==text2)return text_length;for(var best=0,length=1;;){var pattern=text1.substring(text_length-length),found=text2.indexOf(pattern);if(-1==found)return best;length+=found,(0==found||text1.substring(text_length-length)==text2.substring(0,length))&&(best=length,length++)}},diff_match_patch.prototype.diff_halfMatch_=function(text1,text2){function diff_halfMatchI_(longtext,shorttext,i){for(var best_longtext_a,best_longtext_b,best_shorttext_a,best_shorttext_b,seed=longtext.substring(i,i+Math.floor(longtext.length/4)),j=-1,best_common="";-1!=(j=shorttext.indexOf(seed,j+1));){var prefixLength=dmp.diff_commonPrefix(longtext.substring(i),shorttext.substring(j)),suffixLength=dmp.diff_commonSuffix(longtext.substring(0,i),shorttext.substring(0,j));best_common.length<suffixLength+prefixLength&&(best_common=shorttext.substring(j-suffixLength,j)+shorttext.substring(j,j+prefixLength),best_longtext_a=longtext.substring(0,i-suffixLength),best_longtext_b=longtext.substring(i+prefixLength),best_shorttext_a=shorttext.substring(0,j-suffixLength),best_shorttext_b=shorttext.substring(j+prefixLength))}return 2*best_common.length>=longtext.length?[best_longtext_a,best_longtext_b,best_shorttext_a,best_shorttext_b,best_common]:null}if(this.Diff_Timeout<=0)return null;var longtext=text1.length>text2.length?text1:text2,shorttext=text1.length>text2.length?text2:text1;if(longtext.length<4||2*shorttext.length<longtext.length)return null;var hm,dmp=this,hm1=diff_halfMatchI_(longtext,shorttext,Math.ceil(longtext.length/4)),hm2=diff_halfMatchI_(longtext,shorttext,Math.ceil(longtext.length/2));if(!hm1&&!hm2)return null;hm=hm2?hm1?hm1[4].length>hm2[4].length?hm1:hm2:hm2:hm1;var text1_a,text1_b,text2_a,text2_b;text1.length>text2.length?(text1_a=hm[0],text1_b=hm[1],text2_a=hm[2],text2_b=hm[3]):(text2_a=hm[0],text2_b=hm[1],text1_a=hm[2],text1_b=hm[3]);var mid_common=hm[4];return[text1_a,text1_b,text2_a,text2_b,mid_common]},diff_match_patch.prototype.diff_cleanupSemantic=function(diffs){for(var changes=!1,equalities=[],equalitiesLength=0,lastequality=null,pointer=0,length_insertions1=0,length_deletions1=0,length_insertions2=0,length_deletions2=0;pointer<diffs.length;)diffs[pointer][0]==DIFF_EQUAL?(equalities[equalitiesLength++]=pointer,length_insertions1=length_insertions2,length_deletions1=length_deletions2,length_insertions2=0,length_deletions2=0,lastequality=diffs[pointer][1]):(diffs[pointer][0]==DIFF_INSERT?length_insertions2+=diffs[pointer][1].length:length_deletions2+=diffs[pointer][1].length,lastequality&&lastequality.length<=Math.max(length_insertions1,length_deletions1)&&lastequality.length<=Math.max(length_insertions2,length_deletions2)&&(diffs.splice(equalities[equalitiesLength-1],0,[DIFF_DELETE,lastequality]),diffs[equalities[equalitiesLength-1]+1][0]=DIFF_INSERT,equalitiesLength--,equalitiesLength--,pointer=equalitiesLength>0?equalities[equalitiesLength-1]:-1,length_insertions1=0,length_deletions1=0,length_insertions2=0,length_deletions2=0,lastequality=null,changes=!0)),pointer++;for(changes&&this.diff_cleanupMerge(diffs),this.diff_cleanupSemanticLossless(diffs),pointer=1;pointer<diffs.length;){if(diffs[pointer-1][0]==DIFF_DELETE&&diffs[pointer][0]==DIFF_INSERT){var deletion=diffs[pointer-1][1],insertion=diffs[pointer][1],overlap_length1=this.diff_commonOverlap_(deletion,insertion),overlap_length2=this.diff_commonOverlap_(insertion,deletion);overlap_length1>=overlap_length2?(overlap_length1>=deletion.length/2||overlap_length1>=insertion.length/2)&&(diffs.splice(pointer,0,[DIFF_EQUAL,insertion.substring(0,overlap_length1)]),diffs[pointer-1][1]=deletion.substring(0,deletion.length-overlap_length1),diffs[pointer+1][1]=insertion.substring(overlap_length1),pointer++):(overlap_length2>=deletion.length/2||overlap_length2>=insertion.length/2)&&(diffs.splice(pointer,0,[DIFF_EQUAL,deletion.substring(0,overlap_length2)]),diffs[pointer-1][0]=DIFF_INSERT,diffs[pointer-1][1]=insertion.substring(0,insertion.length-overlap_length2),diffs[pointer+1][0]=DIFF_DELETE,diffs[pointer+1][1]=deletion.substring(overlap_length2),pointer++),pointer++}pointer++}},diff_match_patch.prototype.diff_cleanupSemanticLossless=function(diffs){function diff_cleanupSemanticScore_(one,two){if(!one||!two)return 6;var char1=one.charAt(one.length-1),char2=two.charAt(0),nonAlphaNumeric1=char1.match(diff_match_patch.nonAlphaNumericRegex_),nonAlphaNumeric2=char2.match(diff_match_patch.nonAlphaNumericRegex_),whitespace1=nonAlphaNumeric1&&char1.match(diff_match_patch.whitespaceRegex_),whitespace2=nonAlphaNumeric2&&char2.match(diff_match_patch.whitespaceRegex_),lineBreak1=whitespace1&&char1.match(diff_match_patch.linebreakRegex_),lineBreak2=whitespace2&&char2.match(diff_match_patch.linebreakRegex_),blankLine1=lineBreak1&&one.match(diff_match_patch.blanklineEndRegex_),blankLine2=lineBreak2&&two.match(diff_match_patch.blanklineStartRegex_);return blankLine1||blankLine2?5:lineBreak1||lineBreak2?4:nonAlphaNumeric1&&!whitespace1&&whitespace2?3:whitespace1||whitespace2?2:nonAlphaNumeric1||nonAlphaNumeric2?1:0}for(var pointer=1;pointer<diffs.length-1;){if(diffs[pointer-1][0]==DIFF_EQUAL&&diffs[pointer+1][0]==DIFF_EQUAL){var equality1=diffs[pointer-1][1],edit=diffs[pointer][1],equality2=diffs[pointer+1][1],commonOffset=this.diff_commonSuffix(equality1,edit);if(commonOffset){var commonString=edit.substring(edit.length-commonOffset);equality1=equality1.substring(0,equality1.length-commonOffset),edit=commonString+edit.substring(0,edit.length-commonOffset),equality2=commonString+equality2}for(var bestEquality1=equality1,bestEdit=edit,bestEquality2=equality2,bestScore=diff_cleanupSemanticScore_(equality1,edit)+diff_cleanupSemanticScore_(edit,equality2);edit.charAt(0)===equality2.charAt(0);){equality1+=edit.charAt(0),edit=edit.substring(1)+equality2.charAt(0),equality2=equality2.substring(1);var score=diff_cleanupSemanticScore_(equality1,edit)+diff_cleanupSemanticScore_(edit,equality2);score>=bestScore&&(bestScore=score,bestEquality1=equality1,bestEdit=edit,bestEquality2=equality2)}diffs[pointer-1][1]!=bestEquality1&&(bestEquality1?diffs[pointer-1][1]=bestEquality1:(diffs.splice(pointer-1,1),pointer--),diffs[pointer][1]=bestEdit,bestEquality2?diffs[pointer+1][1]=bestEquality2:(diffs.splice(pointer+1,1),pointer--))}pointer++}},diff_match_patch.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/,diff_match_patch.whitespaceRegex_=/\s/,diff_match_patch.linebreakRegex_=/[\r\n]/,diff_match_patch.blanklineEndRegex_=/\n\r?\n$/,diff_match_patch.blanklineStartRegex_=/^\r?\n\r?\n/,diff_match_patch.prototype.diff_cleanupEfficiency=function(diffs){for(var changes=!1,equalities=[],equalitiesLength=0,lastequality=null,pointer=0,pre_ins=!1,pre_del=!1,post_ins=!1,post_del=!1;pointer<diffs.length;)diffs[pointer][0]==DIFF_EQUAL?(diffs[pointer][1].length<this.Diff_EditCost&&(post_ins||post_del)?(equalities[equalitiesLength++]=pointer,pre_ins=post_ins,pre_del=post_del,lastequality=diffs[pointer][1]):(equalitiesLength=0,lastequality=null),post_ins=post_del=!1):(diffs[pointer][0]==DIFF_DELETE?post_del=!0:post_ins=!0,lastequality&&(pre_ins&&pre_del&&post_ins&&post_del||lastequality.length<this.Diff_EditCost/2&&pre_ins+pre_del+post_ins+post_del==3)&&(diffs.splice(equalities[equalitiesLength-1],0,[DIFF_DELETE,lastequality]),diffs[equalities[equalitiesLength-1]+1][0]=DIFF_INSERT,equalitiesLength--,lastequality=null,pre_ins&&pre_del?(post_ins=post_del=!0,equalitiesLength=0):(equalitiesLength--,pointer=equalitiesLength>0?equalities[equalitiesLength-1]:-1,post_ins=post_del=!1),changes=!0)),pointer++;changes&&this.diff_cleanupMerge(diffs)},diff_match_patch.prototype.diff_cleanupMerge=function(diffs){diffs.push([DIFF_EQUAL,""]);for(var commonlength,pointer=0,count_delete=0,count_insert=0,text_delete="",text_insert="";pointer<diffs.length;)switch(diffs[pointer][0]){case DIFF_INSERT:count_insert++,text_insert+=diffs[pointer][1],pointer++;break;case DIFF_DELETE:count_delete++,text_delete+=diffs[pointer][1],pointer++;break;case DIFF_EQUAL:count_delete+count_insert>1?(0!==count_delete&&0!==count_insert&&(commonlength=this.diff_commonPrefix(text_insert,text_delete),0!==commonlength&&(pointer-count_delete-count_insert>0&&diffs[pointer-count_delete-count_insert-1][0]==DIFF_EQUAL?diffs[pointer-count_delete-count_insert-1][1]+=text_insert.substring(0,commonlength):(diffs.splice(0,0,[DIFF_EQUAL,text_insert.substring(0,commonlength)]),pointer++),text_insert=text_insert.substring(commonlength),text_delete=text_delete.substring(commonlength)),commonlength=this.diff_commonSuffix(text_insert,text_delete),0!==commonlength&&(diffs[pointer][1]=text_insert.substring(text_insert.length-commonlength)+diffs[pointer][1],text_insert=text_insert.substring(0,text_insert.length-commonlength),text_delete=text_delete.substring(0,text_delete.length-commonlength))),0===count_delete?diffs.splice(pointer-count_insert,count_delete+count_insert,[DIFF_INSERT,text_insert]):0===count_insert?diffs.splice(pointer-count_delete,count_delete+count_insert,[DIFF_DELETE,text_delete]):diffs.splice(pointer-count_delete-count_insert,count_delete+count_insert,[DIFF_DELETE,text_delete],[DIFF_INSERT,text_insert]),pointer=pointer-count_delete-count_insert+(count_delete?1:0)+(count_insert?1:0)+1):0!==pointer&&diffs[pointer-1][0]==DIFF_EQUAL?(diffs[pointer-1][1]+=diffs[pointer][1],diffs.splice(pointer,1)):pointer++,count_insert=0,count_delete=0,text_delete="",text_insert=""}""===diffs[diffs.length-1][1]&&diffs.pop();var changes=!1;for(pointer=1;pointer<diffs.length-1;)diffs[pointer-1][0]==DIFF_EQUAL&&diffs[pointer+1][0]==DIFF_EQUAL&&(diffs[pointer][1].substring(diffs[pointer][1].length-diffs[pointer-1][1].length)==diffs[pointer-1][1]?(diffs[pointer][1]=diffs[pointer-1][1]+diffs[pointer][1].substring(0,diffs[pointer][1].length-diffs[pointer-1][1].length),diffs[pointer+1][1]=diffs[pointer-1][1]+diffs[pointer+1][1],diffs.splice(pointer-1,1),changes=!0):diffs[pointer][1].substring(0,diffs[pointer+1][1].length)==diffs[pointer+1][1]&&(diffs[pointer-1][1]+=diffs[pointer+1][1],diffs[pointer][1]=diffs[pointer][1].substring(diffs[pointer+1][1].length)+diffs[pointer+1][1],diffs.splice(pointer+1,1),changes=!0)),pointer++;changes&&this.diff_cleanupMerge(diffs)},diff_match_patch.prototype.diff_xIndex=function(diffs,loc){var x,chars1=0,chars2=0,last_chars1=0,last_chars2=0;for(x=0;x<diffs.length&&(diffs[x][0]!==DIFF_INSERT&&(chars1+=diffs[x][1].length),diffs[x][0]!==DIFF_DELETE&&(chars2+=diffs[x][1].length),!(chars1>loc));x++)last_chars1=chars1,last_chars2=chars2;return diffs.length!=x&&diffs[x][0]===DIFF_DELETE?last_chars2:last_chars2+(loc-last_chars1)},diff_match_patch.prototype.diff_prettyHtml=function(diffs){for(var html=[],pattern_amp=/&/g,pattern_lt=/</g,pattern_gt=/>/g,pattern_para=/\n/g,x=0;x<diffs.length;x++){var op=diffs[x][0],data=diffs[x][1],text=data.replace(pattern_amp,"&amp;").replace(pattern_lt,"&lt;").replace(pattern_gt,"&gt;").replace(pattern_para,"&para;<br>");switch(op){case DIFF_INSERT:html[x]='<ins style="background:#e6ffe6;">'+text+"</ins>";break;case DIFF_DELETE:html[x]='<del style="background:#ffe6e6;">'+text+"</del>";break;case DIFF_EQUAL:html[x]="<span>"+text+"</span>"}}return html.join("")},diff_match_patch.prototype.diff_text1=function(diffs){for(var text=[],x=0;x<diffs.length;x++)diffs[x][0]!==DIFF_INSERT&&(text[x]=diffs[x][1]);return text.join("")},diff_match_patch.prototype.diff_text2=function(diffs){for(var text=[],x=0;x<diffs.length;x++)diffs[x][0]!==DIFF_DELETE&&(text[x]=diffs[x][1]);return text.join("")},diff_match_patch.prototype.diff_levenshtein=function(diffs){for(var levenshtein=0,insertions=0,deletions=0,x=0;x<diffs.length;x++){var op=diffs[x][0],data=diffs[x][1];switch(op){case DIFF_INSERT:insertions+=data.length;break;case DIFF_DELETE:deletions+=data.length;break;case DIFF_EQUAL:levenshtein+=Math.max(insertions,deletions),insertions=0,deletions=0}}return levenshtein+=Math.max(insertions,deletions)},diff_match_patch.prototype.diff_toDelta=function(diffs){for(var text=[],x=0;x<diffs.length;x++)switch(diffs[x][0]){case DIFF_INSERT:text[x]="+"+encodeURI(diffs[x][1]);break;case DIFF_DELETE:text[x]="-"+diffs[x][1].length;break;case DIFF_EQUAL:text[x]="="+diffs[x][1].length}return text.join("	").replace(/%20/g," ")},diff_match_patch.prototype.diff_fromDelta=function(text1,delta){for(var diffs=[],diffsLength=0,pointer=0,tokens=delta.split(/\t/g),x=0;x<tokens.length;x++){var param=tokens[x].substring(1);switch(tokens[x].charAt(0)){case"+":try{diffs[diffsLength++]=[DIFF_INSERT,decodeURI(param)]}catch(ex){throw new Error("Illegal escape in diff_fromDelta: "+param)}break;case"-":case"=":var n=parseInt(param,10);if(isNaN(n)||0>n)throw new Error("Invalid number in diff_fromDelta: "+param);var text=text1.substring(pointer,pointer+=n);diffs[diffsLength++]="="==tokens[x].charAt(0)?[DIFF_EQUAL,text]:[DIFF_DELETE,text];break;default:if(tokens[x])throw new Error("Invalid diff operation in diff_fromDelta: "+tokens[x])}}if(pointer!=text1.length)throw new Error("Delta length ("+pointer+") does not equal source text length ("+text1.length+").");return diffs},diff_match_patch.prototype.match_main=function(text,pattern,loc){if(null==text||null==pattern||null==loc)throw new Error("Null input. (match_main)");return loc=Math.max(0,Math.min(loc,text.length)),text==pattern?0:text.length?text.substring(loc,loc+pattern.length)==pattern?loc:this.match_bitap_(text,pattern,loc):-1},diff_match_patch.prototype.match_bitap_=function(text,pattern,loc){function match_bitapScore_(e,x){var accuracy=e/pattern.length,proximity=Math.abs(loc-x);return dmp.Match_Distance?accuracy+proximity/dmp.Match_Distance:proximity?1:accuracy}if(pattern.length>this.Match_MaxBits)throw new Error("Pattern too long for this browser.");var s=this.match_alphabet_(pattern),dmp=this,score_threshold=this.Match_Threshold,best_loc=text.indexOf(pattern,loc);-1!=best_loc&&(score_threshold=Math.min(match_bitapScore_(0,best_loc),score_threshold),best_loc=text.lastIndexOf(pattern,loc+pattern.length),-1!=best_loc&&(score_threshold=Math.min(match_bitapScore_(0,best_loc),score_threshold)));var matchmask=1<<pattern.length-1;best_loc=-1;for(var bin_min,bin_mid,last_rd,bin_max=pattern.length+text.length,d=0;d<pattern.length;d++){for(bin_min=0,bin_mid=bin_max;bin_mid>bin_min;)match_bitapScore_(d,loc+bin_mid)<=score_threshold?bin_min=bin_mid:bin_max=bin_mid,bin_mid=Math.floor((bin_max-bin_min)/2+bin_min);bin_max=bin_mid;var start=Math.max(1,loc-bin_mid+1),finish=Math.min(loc+bin_mid,text.length)+pattern.length,rd=Array(finish+2);rd[finish+1]=(1<<d)-1;for(var j=finish;j>=start;j--){var charMatch=s[text.charAt(j-1)];if(rd[j]=0===d?(rd[j+1]<<1|1)&charMatch:(rd[j+1]<<1|1)&charMatch|((last_rd[j+1]|last_rd[j])<<1|1)|last_rd[j+1],rd[j]&matchmask){var score=match_bitapScore_(d,j-1);if(score_threshold>=score){if(score_threshold=score,best_loc=j-1,!(best_loc>loc))break;start=Math.max(1,2*loc-best_loc)}}}if(match_bitapScore_(d+1,loc)>score_threshold)break;last_rd=rd}return best_loc},diff_match_patch.prototype.match_alphabet_=function(pattern){for(var s={},i=0;i<pattern.length;i++)s[pattern.charAt(i)]=0;for(var i=0;i<pattern.length;i++)s[pattern.charAt(i)]|=1<<pattern.length-i-1;return s},diff_match_patch.prototype.patch_addContext_=function(patch,text){if(0!=text.length){for(var pattern=text.substring(patch.start2,patch.start2+patch.length1),padding=0;text.indexOf(pattern)!=text.lastIndexOf(pattern)&&pattern.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)padding+=this.Patch_Margin,pattern=text.substring(patch.start2-padding,patch.start2+patch.length1+padding);padding+=this.Patch_Margin;var prefix=text.substring(patch.start2-padding,patch.start2);prefix&&patch.diffs.unshift([DIFF_EQUAL,prefix]);var suffix=text.substring(patch.start2+patch.length1,patch.start2+patch.length1+padding);suffix&&patch.diffs.push([DIFF_EQUAL,suffix]),patch.start1-=prefix.length,patch.start2-=prefix.length,patch.length1+=prefix.length+suffix.length,patch.length2+=prefix.length+suffix.length}},diff_match_patch.prototype.patch_make=function(a,opt_b,opt_c){var text1,diffs;if("string"==typeof a&&"string"==typeof opt_b&&"undefined"==typeof opt_c)text1=a,diffs=this.diff_main(text1,opt_b,!0),diffs.length>2&&(this.diff_cleanupSemantic(diffs),this.diff_cleanupEfficiency(diffs));else if(a&&"object"==typeof a&&"undefined"==typeof opt_b&&"undefined"==typeof opt_c)diffs=a,text1=this.diff_text1(diffs);else if("string"==typeof a&&opt_b&&"object"==typeof opt_b&&"undefined"==typeof opt_c)text1=a,diffs=opt_b;else{if("string"!=typeof a||"string"!=typeof opt_b||!opt_c||"object"!=typeof opt_c)throw new Error("Unknown call format to patch_make.");text1=a,diffs=opt_c}if(0===diffs.length)return[];for(var patches=[],patch=new diff_match_patch.patch_obj,patchDiffLength=0,char_count1=0,char_count2=0,prepatch_text=text1,postpatch_text=text1,x=0;x<diffs.length;x++){var diff_type=diffs[x][0],diff_text=diffs[x][1];switch(patchDiffLength||diff_type===DIFF_EQUAL||(patch.start1=char_count1,patch.start2=char_count2),diff_type){case DIFF_INSERT:patch.diffs[patchDiffLength++]=diffs[x],patch.length2+=diff_text.length,postpatch_text=postpatch_text.substring(0,char_count2)+diff_text+postpatch_text.substring(char_count2);break;case DIFF_DELETE:patch.length1+=diff_text.length,patch.diffs[patchDiffLength++]=diffs[x],postpatch_text=postpatch_text.substring(0,char_count2)+postpatch_text.substring(char_count2+diff_text.length);break;case DIFF_EQUAL:diff_text.length<=2*this.Patch_Margin&&patchDiffLength&&diffs.length!=x+1?(patch.diffs[patchDiffLength++]=diffs[x],patch.length1+=diff_text.length,patch.length2+=diff_text.length):diff_text.length>=2*this.Patch_Margin&&patchDiffLength&&(this.patch_addContext_(patch,prepatch_text),patches.push(patch),patch=new diff_match_patch.patch_obj,patchDiffLength=0,prepatch_text=postpatch_text,char_count1=char_count2)}diff_type!==DIFF_INSERT&&(char_count1+=diff_text.length),diff_type!==DIFF_DELETE&&(char_count2+=diff_text.length)}return patchDiffLength&&(this.patch_addContext_(patch,prepatch_text),patches.push(patch)),patches},diff_match_patch.prototype.patch_deepCopy=function(patches){for(var patchesCopy=[],x=0;x<patches.length;x++){var patch=patches[x],patchCopy=new diff_match_patch.patch_obj;patchCopy.diffs=[];for(var y=0;y<patch.diffs.length;y++)patchCopy.diffs[y]=patch.diffs[y].slice();patchCopy.start1=patch.start1,patchCopy.start2=patch.start2,patchCopy.length1=patch.length1,patchCopy.length2=patch.length2,patchesCopy[x]=patchCopy}return patchesCopy},diff_match_patch.prototype.patch_apply=function(patches,text){if(0==patches.length)return[text,[]];patches=this.patch_deepCopy(patches);var nullPadding=this.patch_addPadding(patches);text=nullPadding+text+nullPadding,this.patch_splitMax(patches);for(var delta=0,results=[],x=0;x<patches.length;x++){var start_loc,expected_loc=patches[x].start2+delta,text1=this.diff_text1(patches[x].diffs),end_loc=-1;if(text1.length>this.Match_MaxBits?(start_loc=this.match_main(text,text1.substring(0,this.Match_MaxBits),expected_loc),-1!=start_loc&&(end_loc=this.match_main(text,text1.substring(text1.length-this.Match_MaxBits),expected_loc+text1.length-this.Match_MaxBits),(-1==end_loc||start_loc>=end_loc)&&(start_loc=-1))):start_loc=this.match_main(text,text1,expected_loc),-1==start_loc)results[x]=!1,delta-=patches[x].length2-patches[x].length1;else{results[x]=!0,delta=start_loc-expected_loc;var text2;if(text2=-1==end_loc?text.substring(start_loc,start_loc+text1.length):text.substring(start_loc,end_loc+this.Match_MaxBits),text1==text2)text=text.substring(0,start_loc)+this.diff_text2(patches[x].diffs)+text.substring(start_loc+text1.length);else{var diffs=this.diff_main(text1,text2,!1);if(text1.length>this.Match_MaxBits&&this.diff_levenshtein(diffs)/text1.length>this.Patch_DeleteThreshold)results[x]=!1;else{this.diff_cleanupSemanticLossless(diffs);for(var index2,index1=0,y=0;y<patches[x].diffs.length;y++){var mod=patches[x].diffs[y];mod[0]!==DIFF_EQUAL&&(index2=this.diff_xIndex(diffs,index1)),mod[0]===DIFF_INSERT?text=text.substring(0,start_loc+index2)+mod[1]+text.substring(start_loc+index2):mod[0]===DIFF_DELETE&&(text=text.substring(0,start_loc+index2)+text.substring(start_loc+this.diff_xIndex(diffs,index1+mod[1].length))),mod[0]!==DIFF_DELETE&&(index1+=mod[1].length)}}}}}return text=text.substring(nullPadding.length,text.length-nullPadding.length),[text,results]},diff_match_patch.prototype.patch_addPadding=function(patches){for(var paddingLength=this.Patch_Margin,nullPadding="",x=1;paddingLength>=x;x++)nullPadding+=String.fromCharCode(x);for(var x=0;x<patches.length;x++)patches[x].start1+=paddingLength,patches[x].start2+=paddingLength;var patch=patches[0],diffs=patch.diffs;if(0==diffs.length||diffs[0][0]!=DIFF_EQUAL)diffs.unshift([DIFF_EQUAL,nullPadding]),patch.start1-=paddingLength,patch.start2-=paddingLength,patch.length1+=paddingLength,patch.length2+=paddingLength;else if(paddingLength>diffs[0][1].length){var extraLength=paddingLength-diffs[0][1].length;diffs[0][1]=nullPadding.substring(diffs[0][1].length)+diffs[0][1],patch.start1-=extraLength,patch.start2-=extraLength,patch.length1+=extraLength,patch.length2+=extraLength}if(patch=patches[patches.length-1],diffs=patch.diffs,0==diffs.length||diffs[diffs.length-1][0]!=DIFF_EQUAL)diffs.push([DIFF_EQUAL,nullPadding]),patch.length1+=paddingLength,patch.length2+=paddingLength;else if(paddingLength>diffs[diffs.length-1][1].length){var extraLength=paddingLength-diffs[diffs.length-1][1].length;diffs[diffs.length-1][1]+=nullPadding.substring(0,extraLength),patch.length1+=extraLength,patch.length2+=extraLength}return nullPadding},diff_match_patch.prototype.patch_splitMax=function(patches){for(var patch_size=this.Match_MaxBits,x=0;x<patches.length;x++)if(!(patches[x].length1<=patch_size)){var bigpatch=patches[x];patches.splice(x--,1);for(var start1=bigpatch.start1,start2=bigpatch.start2,precontext="";0!==bigpatch.diffs.length;){var patch=new diff_match_patch.patch_obj,empty=!0;for(patch.start1=start1-precontext.length,patch.start2=start2-precontext.length,""!==precontext&&(patch.length1=patch.length2=precontext.length,patch.diffs.push([DIFF_EQUAL,precontext]));0!==bigpatch.diffs.length&&patch.length1<patch_size-this.Patch_Margin;){var diff_type=bigpatch.diffs[0][0],diff_text=bigpatch.diffs[0][1];diff_type===DIFF_INSERT?(patch.length2+=diff_text.length,start2+=diff_text.length,patch.diffs.push(bigpatch.diffs.shift()),empty=!1):diff_type===DIFF_DELETE&&1==patch.diffs.length&&patch.diffs[0][0]==DIFF_EQUAL&&diff_text.length>2*patch_size?(patch.length1+=diff_text.length,start1+=diff_text.length,empty=!1,patch.diffs.push([diff_type,diff_text]),bigpatch.diffs.shift()):(diff_text=diff_text.substring(0,patch_size-patch.length1-this.Patch_Margin),patch.length1+=diff_text.length,start1+=diff_text.length,diff_type===DIFF_EQUAL?(patch.length2+=diff_text.length,start2+=diff_text.length):empty=!1,patch.diffs.push([diff_type,diff_text]),diff_text==bigpatch.diffs[0][1]?bigpatch.diffs.shift():bigpatch.diffs[0][1]=bigpatch.diffs[0][1].substring(diff_text.length))}precontext=this.diff_text2(patch.diffs),precontext=precontext.substring(precontext.length-this.Patch_Margin);var postcontext=this.diff_text1(bigpatch.diffs).substring(0,this.Patch_Margin);""!==postcontext&&(patch.length1+=postcontext.length,patch.length2+=postcontext.length,0!==patch.diffs.length&&patch.diffs[patch.diffs.length-1][0]===DIFF_EQUAL?patch.diffs[patch.diffs.length-1][1]+=postcontext:patch.diffs.push([DIFF_EQUAL,postcontext])),empty||patches.splice(++x,0,patch)}}},diff_match_patch.prototype.patch_toText=function(patches){for(var text=[],x=0;x<patches.length;x++)text[x]=patches[x];return text.join("")},diff_match_patch.prototype.patch_fromText=function(textline){var patches=[];if(!textline)return patches;for(var text=textline.split("\n"),textPointer=0,patchHeader=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;textPointer<text.length;){var m=text[textPointer].match(patchHeader);if(!m)throw new Error("Invalid patch string: "+text[textPointer]);var patch=new diff_match_patch.patch_obj;for(patches.push(patch),patch.start1=parseInt(m[1],10),""===m[2]?(patch.start1--,patch.length1=1):"0"==m[2]?patch.length1=0:(patch.start1--,patch.length1=parseInt(m[2],10)),patch.start2=parseInt(m[3],10),""===m[4]?(patch.start2--,patch.length2=1):"0"==m[4]?patch.length2=0:(patch.start2--,patch.length2=parseInt(m[4],10)),textPointer++;textPointer<text.length;){var sign=text[textPointer].charAt(0);
try{var line=decodeURI(text[textPointer].substring(1))}catch(ex){throw new Error("Illegal escape in patch_fromText: "+line)}if("-"==sign)patch.diffs.push([DIFF_DELETE,line]);else if("+"==sign)patch.diffs.push([DIFF_INSERT,line]);else if(" "==sign)patch.diffs.push([DIFF_EQUAL,line]);else{if("@"==sign)break;if(""!==sign)throw new Error('Invalid patch mode "'+sign+'" in: '+line)}textPointer++}}return patches},diff_match_patch.patch_obj=function(){this.diffs=[],this.start1=null,this.start2=null,this.length1=0,this.length2=0},diff_match_patch.patch_obj.prototype.toString=function(){var coords1,coords2;coords1=0===this.length1?this.start1+",0":1==this.length1?this.start1+1:this.start1+1+","+this.length1,coords2=0===this.length2?this.start2+",0":1==this.length2?this.start2+1:this.start2+1+","+this.length2;for(var op,text=["@@ -"+coords1+" +"+coords2+" @@\n"],x=0;x<this.diffs.length;x++){switch(this.diffs[x][0]){case DIFF_INSERT:op="+";break;case DIFF_DELETE:op="-";break;case DIFF_EQUAL:op=" "}text[x+1]=op+encodeURI(this.diffs[x][1])+"\n"}return text.join("").replace(/%20/g," ")},this.diff_match_patch=diff_match_patch,this.DIFF_DELETE=DIFF_DELETE,this.DIFF_INSERT=DIFF_INSERT,this.DIFF_EQUAL=DIFF_EQUAL,function(){function html(s){return s.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")}function clean(node){for(var l=node.c.length;l--;)"object"==typeof node.c[l]&&clean(node.c[l]);node.n=node.a=node.c=null}function format(node,indent,chr,buffer){var attr,child,xml=indent+"<"+node.n,nc=node.c.length,i=0;for(attr in node.a)xml+=" "+attr+'="'+node.a[attr]+'"';if(xml+=nc?">":" />",buffer.push(xml),nc){do if(child=node.c[i++],"string"==typeof child){if(1==nc)return buffer.push(buffer.pop()+child+"</"+node.n+">");buffer.push(indent+chr+child)}else"object"==typeof child&&format(child,indent+chr,chr,buffer);while(nc>i);buffer.push(indent+"</"+node.n+">")}}XMLWriter.prototype={encoding:"ISO-8859-1",version:"1.0",formatting:"indented",indentChar:"	",indentation:1,newLine:"\n",writeStartDocument:function(standalone){this.close(),this.stack=[],this.standalone=standalone},writeEndDocument:function(){this.active=this.root,this.stack=[]},writeDocType:function(dt){this.doctype=dt},writeStartElement:function(name,ns){ns&&(name=ns+":"+name);var node={n:name,a:{},c:[]};this.active?(this.active.c.push(node),this.stack.push(this.active)):this.root=node,this.active=node},deleteEndElement:function(){this.stack.pop(),this.active.c.pop()},writeEndElement:function(){this.active=this.stack.pop()||this.root},writeAttributeString:function(name,value){this.active&&(this.active.a[name]=html(value))},writeString:function(text){this.active&&this.active.c.push(html(text))},writeElementString:function(name,text,ns){this.writeStartElement(name,ns),this.writeString(html(text)),this.writeEndElement()},writeCDATA:function(text){text=text.replace(/>>]/g,"]]><![CDATA[>"),this.writeString("<![CDATA["+text+"]]>")},writeComment:function(text){this.writeString("<!-- "+text+" -->")},flush:function(){this.stack&&this.stack[0]&&this.writeEndDocument();var chr="",indent="",num=this.indentation,formatting="indented"==this.formatting.toLowerCase(),buffer='<?xml version="'+this.version+'" encoding="'+this.encoding+'"';if(void 0!==this.standalone&&(buffer+=' standalone="'+(this.standalone?"yes":"no")+'" '),buffer+=" ?>",buffer=[buffer],this.doctype&&this.root&&buffer.push("<!DOCTYPE "+this.root.n+" "+this.doctype+">"),formatting)for(;num--;)chr+=this.indentChar;return this.root&&format(this.root,indent,chr,buffer),buffer.join(formatting?this.newLine:"")},close:function(){this.root&&clean(this.root),this.active=this.root=this.stack=null},getDocument:window.ActiveXObject?function(){var doc=new ActiveXObject("Microsoft.XMLDOM");return doc.async=!1,doc.loadXML(this.flush()),doc}:function(){return(new DOMParser).parseFromString(this.flush(),"text/xml")}}}(),window.CodeMirror=function(){"use strict";function CodeMirror(place,options){if(!(this instanceof CodeMirror))return new CodeMirror(place,options);this.options=options=options||{};for(var opt in defaults)!options.hasOwnProperty(opt)&&defaults.hasOwnProperty(opt)&&(options[opt]=defaults[opt]);setGuttersForLineNumbers(options);var docStart="string"==typeof options.value?0:options.value.first,display=this.display=makeDisplay(place,docStart);display.wrapper.CodeMirror=this,updateGutters(this),options.autofocus&&!mobile&&focusInput(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,focused:!1,suppressEdits:!1,pasteIncoming:!1,draggingText:!1,highlight:new Delayed},themeChanged(this),options.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap");var doc=options.value;"string"==typeof doc&&(doc=new Doc(options.value,options.mode)),operation(this,attachDoc)(this,doc),ie&&setTimeout(bind(resetInput,this,!0),20),registerEventHandlers(this);var hasFocus;try{hasFocus=document.activeElement==display.input}catch(e){}hasFocus||options.autofocus&&!mobile?setTimeout(bind(onFocus,this),20):onBlur(this),operation(this,function(){for(var opt in optionHandlers)optionHandlers.propertyIsEnumerable(opt)&&optionHandlers[opt](this,options[opt],Init);for(var i=0;i<initHooks.length;++i)initHooks[i](this)})()}function makeDisplay(place,docStart){var d={},input=d.input=elt("textarea",null,null,"position: absolute; padding: 0; width: 1px; height: 1em; outline: none; font-size: 4px;");return webkit?input.style.width="1000px":input.setAttribute("wrap","off"),ios&&(input.style.border="1px solid black"),input.setAttribute("autocorrect","off"),input.setAttribute("autocapitalize","off"),input.setAttribute("spellcheck","false"),d.inputDiv=elt("div",[input],null,"overflow: hidden; position: relative; width: 3px; height: 0px;"),d.scrollbarH=elt("div",[elt("div",null,null,"height: 1px")],"CodeMirror-hscrollbar"),d.scrollbarV=elt("div",[elt("div",null,null,"width: 1px")],"CodeMirror-vscrollbar"),d.scrollbarFiller=elt("div",null,"CodeMirror-scrollbar-filler"),d.gutterFiller=elt("div",null,"CodeMirror-gutter-filler"),d.lineDiv=elt("div",null,"CodeMirror-code"),d.selectionDiv=elt("div",null,null,"position: relative; z-index: 1"),d.cursor=elt("div","","CodeMirror-cursor"),d.otherCursor=elt("div","","CodeMirror-cursor CodeMirror-secondarycursor"),d.measure=elt("div",null,"CodeMirror-measure"),d.lineSpace=elt("div",[d.measure,d.selectionDiv,d.lineDiv,d.cursor,d.otherCursor],null,"position: relative; outline: none"),d.mover=elt("div",[elt("div",[d.lineSpace],"CodeMirror-lines")],null,"position: relative"),d.sizer=elt("div",[d.mover],"CodeMirror-sizer"),d.heightForcer=elt("div",null,null,"position: absolute; height: "+scrollerCutOff+"px; width: 1px;"),d.gutters=elt("div",null,"CodeMirror-gutters"),d.lineGutter=null,d.scroller=elt("div",[d.sizer,d.heightForcer,d.gutters],"CodeMirror-scroll"),d.scroller.setAttribute("tabIndex","-1"),d.wrapper=elt("div",[d.inputDiv,d.scrollbarH,d.scrollbarV,d.scrollbarFiller,d.gutterFiller,d.scroller],"CodeMirror"),ie_lt8&&(d.gutters.style.zIndex=-1,d.scroller.style.paddingRight=0),place.appendChild?place.appendChild(d.wrapper):place(d.wrapper),ios&&(input.style.width="0px"),webkit||(d.scroller.draggable=!0),khtml?(d.inputDiv.style.height="1px",d.inputDiv.style.position="absolute"):ie_lt8&&(d.scrollbarH.style.minWidth=d.scrollbarV.style.minWidth="18px"),d.viewOffset=d.lastSizeC=0,d.showingFrom=d.showingTo=docStart,d.lineNumWidth=d.lineNumInnerWidth=d.lineNumChars=null,d.prevInput="",d.alignWidgets=!1,d.pollingFast=!1,d.poll=new Delayed,d.cachedCharWidth=d.cachedTextHeight=null,d.measureLineCache=[],d.measureLineCachePos=0,d.inaccurateSelection=!1,d.maxLine=null,d.maxLineLength=0,d.maxLineChanged=!1,d.wheelDX=d.wheelDY=d.wheelStartX=d.wheelStartY=null,d}function loadMode(cm){cm.doc.mode=CodeMirror.getMode(cm.options,cm.doc.modeOption),cm.doc.iter(function(line){line.stateAfter&&(line.stateAfter=null),line.styles&&(line.styles=null)}),cm.doc.frontier=cm.doc.first,startWorker(cm,100),cm.state.modeGen++,cm.curOp&&regChange(cm)}function wrappingChanged(cm){cm.options.lineWrapping?(cm.display.wrapper.className+=" CodeMirror-wrap",cm.display.sizer.style.minWidth=""):(cm.display.wrapper.className=cm.display.wrapper.className.replace(" CodeMirror-wrap",""),computeMaxLength(cm)),estimateLineHeights(cm),regChange(cm),clearCaches(cm),setTimeout(function(){updateScrollbars(cm)},100)}function estimateHeight(cm){var th=textHeight(cm.display),wrapping=cm.options.lineWrapping,perLine=wrapping&&Math.max(5,cm.display.scroller.clientWidth/charWidth(cm.display)-3);return function(line){return lineIsHidden(cm.doc,line)?0:wrapping?(Math.ceil(line.text.length/perLine)||1)*th:th}}function estimateLineHeights(cm){var doc=cm.doc,est=estimateHeight(cm);doc.iter(function(line){var estHeight=est(line);estHeight!=line.height&&updateLineHeight(line,estHeight)})}function keyMapChanged(cm){var map=keyMap[cm.options.keyMap],style=map.style;cm.display.wrapper.className=cm.display.wrapper.className.replace(/\s*cm-keymap-\S+/g,"")+(style?" cm-keymap-"+style:""),cm.state.disableInput=map.disableInput}function themeChanged(cm){cm.display.wrapper.className=cm.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+cm.options.theme.replace(/(^|\s)\s*/g," cm-s-"),clearCaches(cm)}function guttersChanged(cm){updateGutters(cm),regChange(cm),setTimeout(function(){alignHorizontally(cm)},20)}function updateGutters(cm){var gutters=cm.display.gutters,specs=cm.options.gutters;removeChildren(gutters);for(var i=0;i<specs.length;++i){var gutterClass=specs[i],gElt=gutters.appendChild(elt("div",null,"CodeMirror-gutter "+gutterClass));"CodeMirror-linenumbers"==gutterClass&&(cm.display.lineGutter=gElt,gElt.style.width=(cm.display.lineNumWidth||1)+"px")}gutters.style.display=i?"":"none"}function lineLength(doc,line){if(0==line.height)return 0;for(var merged,len=line.text.length,cur=line;merged=collapsedSpanAtStart(cur);){var found=merged.find();cur=getLine(doc,found.from.line),len+=found.from.ch-found.to.ch}for(cur=line;merged=collapsedSpanAtEnd(cur);){var found=merged.find();len-=cur.text.length-found.from.ch,cur=getLine(doc,found.to.line),len+=cur.text.length-found.to.ch}return len}function computeMaxLength(cm){var d=cm.display,doc=cm.doc;d.maxLine=getLine(doc,doc.first),d.maxLineLength=lineLength(doc,d.maxLine),d.maxLineChanged=!0,doc.iter(function(line){var len=lineLength(doc,line);len>d.maxLineLength&&(d.maxLineLength=len,d.maxLine=line)})}function setGuttersForLineNumbers(options){for(var found=!1,i=0;i<options.gutters.length;++i)"CodeMirror-linenumbers"==options.gutters[i]&&(options.lineNumbers?found=!0:options.gutters.splice(i--,1));!found&&options.lineNumbers&&options.gutters.push("CodeMirror-linenumbers")}function updateScrollbars(cm){var d=cm.display,docHeight=cm.doc.height,totalHeight=docHeight+paddingVert(d);d.sizer.style.minHeight=d.heightForcer.style.top=totalHeight+"px",d.gutters.style.height=Math.max(totalHeight,d.scroller.clientHeight-scrollerCutOff)+"px";var scrollHeight=Math.max(totalHeight,d.scroller.scrollHeight),needsH=d.scroller.scrollWidth>d.scroller.clientWidth+1,needsV=scrollHeight>d.scroller.clientHeight+1;needsV?(d.scrollbarV.style.display="block",d.scrollbarV.style.bottom=needsH?scrollbarWidth(d.measure)+"px":"0",d.scrollbarV.firstChild.style.height=scrollHeight-d.scroller.clientHeight+d.scrollbarV.clientHeight+"px"):d.scrollbarV.style.display="",needsH?(d.scrollbarH.style.display="block",d.scrollbarH.style.right=needsV?scrollbarWidth(d.measure)+"px":"0",d.scrollbarH.firstChild.style.width=d.scroller.scrollWidth-d.scroller.clientWidth+d.scrollbarH.clientWidth+"px"):d.scrollbarH.style.display="",needsH&&needsV?(d.scrollbarFiller.style.display="block",d.scrollbarFiller.style.height=d.scrollbarFiller.style.width=scrollbarWidth(d.measure)+"px"):d.scrollbarFiller.style.display="",needsH&&cm.options.coverGutterNextToScrollbar&&cm.options.fixedGutter?(d.gutterFiller.style.display="block",d.gutterFiller.style.height=scrollbarWidth(d.measure)+"px",d.gutterFiller.style.width=d.gutters.offsetWidth+"px"):d.gutterFiller.style.display="",mac_geLion&&0===scrollbarWidth(d.measure)&&(d.scrollbarV.style.minWidth=d.scrollbarH.style.minHeight=mac_geMountainLion?"18px":"12px")}function visibleLines(display,doc,viewPort){var top=display.scroller.scrollTop,height=display.wrapper.clientHeight;"number"==typeof viewPort?top=viewPort:viewPort&&(top=viewPort.top,height=viewPort.bottom-viewPort.top),top=Math.floor(top-paddingTop(display));var bottom=Math.ceil(top+height);return{from:lineAtHeight(doc,top),to:lineAtHeight(doc,bottom)}}function alignHorizontally(cm){var display=cm.display;if(display.alignWidgets||display.gutters.firstChild&&cm.options.fixedGutter){for(var comp=compensateForHScroll(display)-display.scroller.scrollLeft+cm.doc.scrollLeft,gutterW=display.gutters.offsetWidth,l=comp+"px",n=display.lineDiv.firstChild;n;n=n.nextSibling)if(n.alignable)for(var i=0,a=n.alignable;i<a.length;++i)a[i].style.left=l;cm.options.fixedGutter&&(display.gutters.style.left=comp+gutterW+"px")}}function maybeUpdateLineNumberWidth(cm){if(!cm.options.lineNumbers)return!1;var doc=cm.doc,last=lineNumberFor(cm.options,doc.first+doc.size-1),display=cm.display;if(last.length!=display.lineNumChars){var test=display.measure.appendChild(elt("div",[elt("div",last)],"CodeMirror-linenumber CodeMirror-gutter-elt")),innerW=test.firstChild.offsetWidth,padding=test.offsetWidth-innerW;return display.lineGutter.style.width="",display.lineNumInnerWidth=Math.max(innerW,display.lineGutter.offsetWidth-padding),display.lineNumWidth=display.lineNumInnerWidth+padding,display.lineNumChars=display.lineNumInnerWidth?last.length:-1,display.lineGutter.style.width=display.lineNumWidth+"px",!0}return!1}function lineNumberFor(options,i){return String(options.lineNumberFormatter(i+options.firstLineNumber))}function compensateForHScroll(display){return getRect(display.scroller).left-getRect(display.sizer).left}function updateDisplay(cm,changes,viewPort){for(var updated,oldFrom=cm.display.showingFrom,oldTo=cm.display.showingTo,visible=visibleLines(cm.display,cm.doc,viewPort);updateDisplayInner(cm,changes,visible)&&(updated=!0,updateSelection(cm),updateScrollbars(cm),viewPort&&(viewPort=Math.min(cm.display.scroller.scrollHeight-cm.display.scroller.clientHeight,"number"==typeof viewPort?viewPort:viewPort.top)),visible=visibleLines(cm.display,cm.doc,viewPort),!(visible.from>=cm.display.showingFrom&&visible.to<=cm.display.showingTo));)changes=[];return updated&&(signalLater(cm,"update",cm),(cm.display.showingFrom!=oldFrom||cm.display.showingTo!=oldTo)&&signalLater(cm,"viewportChange",cm,cm.display.showingFrom,cm.display.showingTo)),updated}function updateDisplayInner(cm,changes,visible){var display=cm.display,doc=cm.doc;if(!display.wrapper.clientWidth)return display.showingFrom=display.showingTo=doc.first,void(display.viewOffset=0);if(!(0==changes.length&&visible.from>display.showingFrom&&visible.to<display.showingTo)){maybeUpdateLineNumberWidth(cm)&&(changes=[{from:doc.first,to:doc.first+doc.size}]);var gutterW=display.sizer.style.marginLeft=display.gutters.offsetWidth+"px";display.scrollbarH.style.left=cm.options.fixedGutter?gutterW:"0";var positionsChangedFrom=1/0;if(cm.options.lineNumbers)for(var i=0;i<changes.length;++i)if(changes[i].diff){positionsChangedFrom=changes[i].from;break}var end=doc.first+doc.size,from=Math.max(visible.from-cm.options.viewportMargin,doc.first),to=Math.min(end,visible.to+cm.options.viewportMargin);if(display.showingFrom<from&&from-display.showingFrom<20&&(from=Math.max(doc.first,display.showingFrom)),display.showingTo>to&&display.showingTo-to<20&&(to=Math.min(end,display.showingTo)),sawCollapsedSpans)for(from=lineNo(visualLine(doc,getLine(doc,from)));end>to&&lineIsHidden(doc,getLine(doc,to));)++to;var intact=[{from:Math.max(display.showingFrom,doc.first),to:Math.min(display.showingTo,end)}];if(intact=intact[0].from>=intact[0].to?[]:computeIntact(intact,changes),sawCollapsedSpans)for(var i=0;i<intact.length;++i)for(var merged,range=intact[i];merged=collapsedSpanAtEnd(getLine(doc,range.to-1));){var newTo=merged.find().from.line;if(!(newTo>range.from)){intact.splice(i--,1);break}range.to=newTo}for(var intactLines=0,i=0;i<intact.length;++i){var range=intact[i];range.from<from&&(range.from=from),range.to>to&&(range.to=to),range.from>=range.to?intact.splice(i--,1):intactLines+=range.to-range.from}if(intactLines==to-from&&from==display.showingFrom&&to==display.showingTo)return void updateViewOffset(cm);intact.sort(function(a,b){return a.from-b.from});try{var focused=document.activeElement}catch(e){}.7*(to-from)>intactLines&&(display.lineDiv.style.display="none"),patchDisplay(cm,from,to,intact,positionsChangedFrom),display.lineDiv.style.display="",focused&&document.activeElement!=focused&&focused.offsetHeight&&focused.focus();var different=from!=display.showingFrom||to!=display.showingTo||display.lastSizeC!=display.wrapper.clientHeight;different&&(display.lastSizeC=display.wrapper.clientHeight,startWorker(cm,400)),display.showingFrom=from,display.showingTo=to;for(var height,prevBottom=display.lineDiv.offsetTop,node=display.lineDiv.firstChild;node;node=node.nextSibling)if(node.lineObj){if(ie_lt8){var bot=node.offsetTop+node.offsetHeight;height=bot-prevBottom,prevBottom=bot}else{var box=getRect(node);height=box.bottom-box.top}var diff=node.lineObj.height-height;if(2>height&&(height=textHeight(display)),diff>.001||-.001>diff){updateLineHeight(node.lineObj,height);var widgets=node.lineObj.widgets;if(widgets)for(var i=0;i<widgets.length;++i)widgets[i].height=widgets[i].node.offsetHeight}}return updateViewOffset(cm),!0}}function updateViewOffset(cm){var off=cm.display.viewOffset=heightAtLine(cm,getLine(cm.doc,cm.display.showingFrom));cm.display.mover.style.top=off+"px"}function computeIntact(intact,changes){for(var i=0,l=changes.length||0;l>i;++i){for(var change=changes[i],intact2=[],diff=change.diff||0,j=0,l2=intact.length;l2>j;++j){var range=intact[j];change.to<=range.from&&change.diff?intact2.push({from:range.from+diff,to:range.to+diff}):change.to<=range.from||change.from>=range.to?intact2.push(range):(change.from>range.from&&intact2.push({from:range.from,to:change.from}),change.to<range.to&&intact2.push({from:change.to+diff,to:range.to+diff}))}intact=intact2}return intact}function getDimensions(cm){for(var d=cm.display,left={},width={},n=d.gutters.firstChild,i=0;n;n=n.nextSibling,++i)left[cm.options.gutters[i]]=n.offsetLeft,width[cm.options.gutters[i]]=n.offsetWidth;return{fixedPos:compensateForHScroll(d),gutterTotalWidth:d.gutters.offsetWidth,gutterLeft:left,gutterWidth:width,wrapperWidth:d.wrapper.clientWidth}}function patchDisplay(cm,from,to,intact,updateNumbersFrom){function rm(node){var next=node.nextSibling;return webkit&&mac&&cm.display.currentWheelTarget==node?(node.style.display="none",node.lineObj=null):node.parentNode.removeChild(node),next}var dims=getDimensions(cm),display=cm.display,lineNumbers=cm.options.lineNumbers;intact.length||webkit&&cm.display.currentWheelTarget||removeChildren(display.lineDiv);var container=display.lineDiv,cur=container.firstChild,nextIntact=intact.shift(),lineN=from;for(cm.doc.iter(from,to,function(line){if(nextIntact&&nextIntact.to==lineN&&(nextIntact=intact.shift()),lineIsHidden(cm.doc,line)){if(0!=line.height&&updateLineHeight(line,0),line.widgets&&cur.previousSibling)for(var i=0;i<line.widgets.length;++i){var w=line.widgets[i];if(w.showIfHidden){var prev=cur.previousSibling;if(/pre/i.test(prev.nodeName)){var wrap=elt("div",null,null,"position: relative");prev.parentNode.replaceChild(wrap,prev),wrap.appendChild(prev),prev=wrap}var wnode=prev.appendChild(elt("div",[w.node],"CodeMirror-linewidget"));w.handleMouseEvents||(wnode.ignoreEvents=!0),positionLineWidget(w,wnode,prev,dims)}}}else if(nextIntact&&nextIntact.from<=lineN&&nextIntact.to>lineN){for(;cur.lineObj!=line;)cur=rm(cur);lineNumbers&&lineN>=updateNumbersFrom&&cur.lineNumber&&setTextContent(cur.lineNumber,lineNumberFor(cm.options,lineN)),cur=cur.nextSibling}else{if(line.widgets)for(var reuse,j=0,search=cur;search&&20>j;++j,search=search.nextSibling)if(search.lineObj==line&&/div/i.test(search.nodeName)){reuse=search;break}var lineNode=buildLineElement(cm,line,lineN,dims,reuse);if(lineNode!=reuse)container.insertBefore(lineNode,cur);else{for(;cur!=reuse;)cur=rm(cur);cur=cur.nextSibling}lineNode.lineObj=line}++lineN});cur;)cur=rm(cur)}function buildLineElement(cm,line,lineNo,dims,reuse){var wrap,lineElement=lineContent(cm,line),markers=line.gutterMarkers,display=cm.display;if(!(cm.options.lineNumbers||markers||line.bgClass||line.wrapClass||line.widgets))return lineElement;if(reuse){reuse.alignable=null;for(var next,isOk=!0,widgetsSeen=0,insertBefore=null,n=reuse.firstChild;n;n=next)if(next=n.nextSibling,/\bCodeMirror-linewidget\b/.test(n.className)){for(var i=0,first=!0;i<line.widgets.length;++i){var widget=line.widgets[i];if(widget.above||(insertBefore=n,first=!1),widget.node==n.firstChild){positionLineWidget(widget,n,reuse,dims),++widgetsSeen;break}}if(i==line.widgets.length){isOk=!1;break}}else reuse.removeChild(n);reuse.insertBefore(lineElement,insertBefore),isOk&&widgetsSeen==line.widgets.length&&(wrap=reuse,reuse.className=line.wrapClass||"")}if(wrap||(wrap=elt("div",null,line.wrapClass,"position: relative"),wrap.appendChild(lineElement)),line.bgClass&&wrap.insertBefore(elt("div",null,line.bgClass+" CodeMirror-linebackground"),wrap.firstChild),cm.options.lineNumbers||markers){var gutterWrap=wrap.insertBefore(elt("div",null,null,"position: absolute; left: "+(cm.options.fixedGutter?dims.fixedPos:-dims.gutterTotalWidth)+"px"),wrap.firstChild);if(cm.options.fixedGutter&&(wrap.alignable||(wrap.alignable=[])).push(gutterWrap),!cm.options.lineNumbers||markers&&markers["CodeMirror-linenumbers"]||(wrap.lineNumber=gutterWrap.appendChild(elt("div",lineNumberFor(cm.options,lineNo),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+dims.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+display.lineNumInnerWidth+"px"))),markers)for(var k=0;k<cm.options.gutters.length;++k){var id=cm.options.gutters[k],found=markers.hasOwnProperty(id)&&markers[id];found&&gutterWrap.appendChild(elt("div",[found],"CodeMirror-gutter-elt","left: "+dims.gutterLeft[id]+"px; width: "+dims.gutterWidth[id]+"px"))}}if(ie_lt8&&(wrap.style.zIndex=2),line.widgets&&wrap!=reuse)for(var i=0,ws=line.widgets;i<ws.length;++i){var widget=ws[i],node=elt("div",[widget.node],"CodeMirror-linewidget");widget.handleMouseEvents||(node.ignoreEvents=!0),positionLineWidget(widget,node,wrap,dims),widget.above?wrap.insertBefore(node,cm.options.lineNumbers&&0!=line.height?gutterWrap:lineElement):wrap.appendChild(node),signalLater(widget,"redraw")}return wrap}function positionLineWidget(widget,node,wrap,dims){if(widget.noHScroll){(wrap.alignable||(wrap.alignable=[])).push(node);var width=dims.wrapperWidth;node.style.left=dims.fixedPos+"px",widget.coverGutter||(width-=dims.gutterTotalWidth,node.style.paddingLeft=dims.gutterTotalWidth+"px"),node.style.width=width+"px"}widget.coverGutter&&(node.style.zIndex=5,node.style.position="relative",widget.noHScroll||(node.style.marginLeft=-dims.gutterTotalWidth+"px"))}function updateSelection(cm){var display=cm.display,collapsed=posEq(cm.doc.sel.from,cm.doc.sel.to);if(collapsed||cm.options.showCursorWhenSelecting?updateSelectionCursor(cm):display.cursor.style.display=display.otherCursor.style.display="none",collapsed?display.selectionDiv.style.display="none":updateSelectionRange(cm),cm.options.moveInputWithCursor){var headPos=cursorCoords(cm,cm.doc.sel.head,"div"),wrapOff=getRect(display.wrapper),lineOff=getRect(display.lineDiv);display.inputDiv.style.top=Math.max(0,Math.min(display.wrapper.clientHeight-10,headPos.top+lineOff.top-wrapOff.top))+"px",display.inputDiv.style.left=Math.max(0,Math.min(display.wrapper.clientWidth-10,headPos.left+lineOff.left-wrapOff.left))+"px"}}function updateSelectionCursor(cm){var display=cm.display,pos=cursorCoords(cm,cm.doc.sel.head,"div");display.cursor.style.left=pos.left+"px",display.cursor.style.top=pos.top+"px",display.cursor.style.height=Math.max(0,pos.bottom-pos.top)*cm.options.cursorHeight+"px",display.cursor.style.display="",pos.other?(display.otherCursor.style.display="",display.otherCursor.style.left=pos.other.left+"px",display.otherCursor.style.top=pos.other.top+"px",display.otherCursor.style.height=.85*(pos.other.bottom-pos.other.top)+"px"):display.otherCursor.style.display="none"}function updateSelectionRange(cm){function add(left,top,width,bottom){0>top&&(top=0),fragment.appendChild(elt("div",null,"CodeMirror-selected","position: absolute; left: "+left+"px; top: "+top+"px; width: "+(null==width?clientWidth-left:width)+"px; height: "+(bottom-top)+"px"))}function drawForLine(line,fromArg,toArg){function coords(ch,bias){return charCoords(cm,Pos(line,ch),"div",lineObj,bias)}var start,end,lineObj=getLine(doc,line),lineLen=lineObj.text.length;return iterateBidiSections(getOrder(lineObj),fromArg||0,null==toArg?lineLen:toArg,function(from,to,dir){var rightPos,left,right,leftPos=coords(from,"left");if(from==to)rightPos=leftPos,left=right=leftPos.left;else{if(rightPos=coords(to-1,"right"),"rtl"==dir){var tmp=leftPos;leftPos=rightPos,rightPos=tmp}left=leftPos.left,right=rightPos.right}null==fromArg&&0==from&&(left=pl),rightPos.top-leftPos.top>3&&(add(left,leftPos.top,null,leftPos.bottom),left=pl,leftPos.bottom<rightPos.top&&add(left,leftPos.bottom,null,rightPos.top)),null==toArg&&to==lineLen&&(right=clientWidth),(!start||leftPos.top<start.top||leftPos.top==start.top&&leftPos.left<start.left)&&(start=leftPos),(!end||rightPos.bottom>end.bottom||rightPos.bottom==end.bottom&&rightPos.right>end.right)&&(end=rightPos),pl+1>left&&(left=pl),add(left,rightPos.top,right-left,rightPos.bottom)}),{start:start,end:end}}var display=cm.display,doc=cm.doc,sel=cm.doc.sel,fragment=document.createDocumentFragment(),clientWidth=display.lineSpace.offsetWidth,pl=paddingLeft(cm.display);if(sel.from.line==sel.to.line)drawForLine(sel.from.line,sel.from.ch,sel.to.ch);else{var fromLine=getLine(doc,sel.from.line),toLine=getLine(doc,sel.to.line),singleVLine=visualLine(doc,fromLine)==visualLine(doc,toLine),leftEnd=drawForLine(sel.from.line,sel.from.ch,singleVLine?fromLine.text.length:null).end,rightStart=drawForLine(sel.to.line,singleVLine?0:null,sel.to.ch).start;singleVLine&&(leftEnd.top<rightStart.top-2?(add(leftEnd.right,leftEnd.top,null,leftEnd.bottom),add(pl,rightStart.top,rightStart.left,rightStart.bottom)):add(leftEnd.right,leftEnd.top,rightStart.left-leftEnd.right,leftEnd.bottom)),leftEnd.bottom<rightStart.top&&add(pl,leftEnd.bottom,null,rightStart.top)}removeChildrenAndAdd(display.selectionDiv,fragment),display.selectionDiv.style.display=""}function restartBlink(cm){if(cm.state.focused){var display=cm.display;clearInterval(display.blinker);var on=!0;display.cursor.style.visibility=display.otherCursor.style.visibility="",display.blinker=setInterval(function(){display.cursor.style.visibility=display.otherCursor.style.visibility=(on=!on)?"":"hidden"},cm.options.cursorBlinkRate)}}function startWorker(cm,time){cm.doc.mode.startState&&cm.doc.frontier<cm.display.showingTo&&cm.state.highlight.set(time,bind(highlightWorker,cm))}function highlightWorker(cm){var doc=cm.doc;if(doc.frontier<doc.first&&(doc.frontier=doc.first),!(doc.frontier>=cm.display.showingTo)){var prevChange,end=+new Date+cm.options.workTime,state=copyState(doc.mode,getStateBefore(cm,doc.frontier)),changed=[];doc.iter(doc.frontier,Math.min(doc.first+doc.size,cm.display.showingTo+500),function(line){if(doc.frontier>=cm.display.showingFrom){var oldStyles=line.styles;line.styles=highlightLine(cm,line,state);for(var ischange=!oldStyles||oldStyles.length!=line.styles.length,i=0;!ischange&&i<oldStyles.length;++i)ischange=oldStyles[i]!=line.styles[i];ischange&&(prevChange&&prevChange.end==doc.frontier?prevChange.end++:changed.push(prevChange={start:doc.frontier,end:doc.frontier+1})),line.stateAfter=copyState(doc.mode,state)}else processLine(cm,line,state),line.stateAfter=doc.frontier%5==0?copyState(doc.mode,state):null;return++doc.frontier,+new Date>end?(startWorker(cm,cm.options.workDelay),!0):void 0}),changed.length&&operation(cm,function(){for(var i=0;i<changed.length;++i)regChange(this,changed[i].start,changed[i].end)})()}}function findStartLine(cm,n,precise){for(var minindent,minline,doc=cm.doc,search=n,lim=n-100;search>lim;--search){if(search<=doc.first)return doc.first;var line=getLine(doc,search-1);if(line.stateAfter&&(!precise||search<=doc.frontier))return search;var indented=countColumn(line.text,null,cm.options.tabSize);(null==minline||minindent>indented)&&(minline=search-1,minindent=indented)}return minline}function getStateBefore(cm,n,precise){var doc=cm.doc,display=cm.display;if(!doc.mode.startState)return!0;var pos=findStartLine(cm,n,precise),state=pos>doc.first&&getLine(doc,pos-1).stateAfter;return state=state?copyState(doc.mode,state):startState(doc.mode),doc.iter(pos,n,function(line){processLine(cm,line,state);var save=pos==n-1||pos%5==0||pos>=display.showingFrom&&pos<display.showingTo;line.stateAfter=save?copyState(doc.mode,state):null,++pos}),state}function paddingTop(display){return display.lineSpace.offsetTop}function paddingVert(display){return display.mover.offsetHeight-display.lineSpace.offsetHeight}function paddingLeft(display){var e=removeChildrenAndAdd(display.measure,elt("pre",null,null,"text-align: left")).appendChild(elt("span","x"));return e.offsetLeft}function measureChar(cm,line,ch,data,bias){var dir=-1;data=data||measureLine(cm,line);for(var pos=ch;;pos+=dir){var r=data[pos];if(r)break;0>dir&&0==pos&&(dir=1)}var rightV=(ch>pos||"right"==bias)&&null!=r.topRight;return{left:ch>pos?r.right:r.left,right:pos>ch?r.left:r.right,top:rightV?r.topRight:r.top,bottom:rightV?r.bottomRight:r.bottom}}function findCachedMeasurement(cm,line){for(var cache=cm.display.measureLineCache,i=0;i<cache.length;++i){var memo=cache[i];if(memo.text==line.text&&memo.markedSpans==line.markedSpans&&cm.display.scroller.clientWidth==memo.width&&memo.classes==line.textClass+"|"+line.bgClass+"|"+line.wrapClass)return memo}}function clearCachedMeasurement(cm,line){var exists=findCachedMeasurement(cm,line);exists&&(exists.text=exists.measure=exists.markedSpans=null)}function measureLine(cm,line){var cached=findCachedMeasurement(cm,line);if(cached)return cached.measure;var measure=measureLineInner(cm,line),cache=cm.display.measureLineCache,memo={text:line.text,width:cm.display.scroller.clientWidth,markedSpans:line.markedSpans,measure:measure,classes:line.textClass+"|"+line.bgClass+"|"+line.wrapClass};return 16==cache.length?cache[++cm.display.measureLineCachePos%16]=memo:cache.push(memo),measure}function measureLineInner(cm,line){function categorizeVSpan(top,bot){bot>maxBot&&(bot=maxBot),0>top&&(top=0);for(var j=0;j<vranges.length;j+=2){var rtop=vranges[j],rbot=vranges[j+1];if(!(rtop>bot||top>rbot)&&(top>=rtop&&rbot>=bot||rtop>=top&&bot>=rbot||Math.min(bot,rbot)-Math.max(top,rtop)>=bot-top>>1))return vranges[j]=Math.min(top,rtop),vranges[j+1]=Math.max(bot,rbot),j}return vranges.push(top,bot),j}var display=cm.display,measure=emptyArray(line.text.length),pre=lineContent(cm,line,measure);if(ie&&!ie_lt8&&!cm.options.lineWrapping&&pre.childNodes.length>100){for(var fragment=document.createDocumentFragment(),chunk=10,n=pre.childNodes.length,i=0,chunks=Math.ceil(n/chunk);chunks>i;++i){for(var wrap=elt("div",null,null,"display: inline-block"),j=0;chunk>j&&n;++j)wrap.appendChild(pre.firstChild),--n;fragment.appendChild(wrap)}pre.appendChild(fragment)}removeChildrenAndAdd(display.measure,pre);var outer=getRect(display.lineDiv),vranges=[],data=emptyArray(line.text.length),maxBot=pre.offsetHeight;ie_lt9&&display.measure.first!=pre&&removeChildrenAndAdd(display.measure,pre);for(var cur,i=0;i<measure.length;++i)if(cur=measure[i]){var size,node=cur;if(/\bCodeMirror-widget\b/.test(cur.className)&&cur.getClientRects){1==cur.firstChild.nodeType&&(node=cur.firstChild);var rects=node.getClientRects(),rLeft=rects[0],rRight=rects[rects.length-1];
if(rects.length>1){var vCatLeft=categorizeVSpan(rLeft.top-outer.top,rLeft.bottom-outer.top),vCatRight=categorizeVSpan(rRight.top-outer.top,rRight.bottom-outer.top);data[i]={left:rLeft.left-outer.left,right:rRight.right-outer.left,top:vCatLeft,topRight:vCatRight};continue}}size=getRect(node);var vCat=categorizeVSpan(size.top-outer.top,size.bottom-outer.top),right=size.right;cur.measureRight&&(right=getRect(cur.measureRight).left),data[i]={left:size.left-outer.left,right:right-outer.left,top:vCat}}for(var cur,i=0;i<data.length;++i)if(cur=data[i]){var vr=cur.top,vrRight=cur.topRight;cur.top=vranges[vr],cur.bottom=vranges[vr+1],null!=vrRight&&(cur.topRight=vranges[vrRight],cur.bottomRight=vranges[vrRight+1])}return data}function measureLineWidth(cm,line){var hasBadSpan=!1;if(line.markedSpans)for(var i=0;i<line.markedSpans;++i){var sp=line.markedSpans[i];!sp.collapsed||null!=sp.to&&sp.to!=line.text.length||(hasBadSpan=!0)}var cached=!hasBadSpan&&findCachedMeasurement(cm,line);if(cached)return measureChar(cm,line,line.text.length,cached.measure,"right").right;var pre=lineContent(cm,line),end=pre.appendChild(zeroWidthElement(cm.display.measure));return removeChildrenAndAdd(cm.display.measure,pre),getRect(end).right-getRect(cm.display.lineDiv).left}function clearCaches(cm){cm.display.measureLineCache.length=cm.display.measureLineCachePos=0,cm.display.cachedCharWidth=cm.display.cachedTextHeight=null,cm.options.lineWrapping||(cm.display.maxLineChanged=!0),cm.display.lineNumChars=null}function pageScrollX(){return window.pageXOffset||(document.documentElement||document.body).scrollLeft}function pageScrollY(){return window.pageYOffset||(document.documentElement||document.body).scrollTop}function intoCoordSystem(cm,lineObj,rect,context){if(lineObj.widgets)for(var i=0;i<lineObj.widgets.length;++i)if(lineObj.widgets[i].above){var size=widgetHeight(lineObj.widgets[i]);rect.top+=size,rect.bottom+=size}if("line"==context)return rect;context||(context="local");var yOff=heightAtLine(cm,lineObj);if("local"==context?yOff+=paddingTop(cm.display):yOff-=cm.display.viewOffset,"page"==context||"window"==context){var lOff=getRect(cm.display.lineSpace);yOff+=lOff.top+("window"==context?0:pageScrollY());var xOff=lOff.left+("window"==context?0:pageScrollX());rect.left+=xOff,rect.right+=xOff}return rect.top+=yOff,rect.bottom+=yOff,rect}function fromCoordSystem(cm,coords,context){if("div"==context)return coords;var left=coords.left,top=coords.top;if("page"==context)left-=pageScrollX(),top-=pageScrollY();else if("local"==context||!context){var localBox=getRect(cm.display.sizer);left+=localBox.left,top+=localBox.top}var lineSpaceBox=getRect(cm.display.lineSpace);return{left:left-lineSpaceBox.left,top:top-lineSpaceBox.top}}function charCoords(cm,pos,context,lineObj,bias){return lineObj||(lineObj=getLine(cm.doc,pos.line)),intoCoordSystem(cm,lineObj,measureChar(cm,lineObj,pos.ch,null,bias),context)}function cursorCoords(cm,pos,context,lineObj,measurement){function get(ch,right){var m=measureChar(cm,lineObj,ch,measurement,right?"right":"left");return right?m.left=m.right:m.right=m.left,intoCoordSystem(cm,lineObj,m,context)}function getBidi(ch,partPos){var part=order[partPos],right=part.level%2;return ch==bidiLeft(part)&&partPos&&part.level<order[partPos-1].level?(part=order[--partPos],ch=bidiRight(part)-(part.level%2?0:1),right=!0):ch==bidiRight(part)&&partPos<order.length-1&&part.level<order[partPos+1].level&&(part=order[++partPos],ch=bidiLeft(part)-part.level%2,right=!1),right&&ch==part.to&&ch>part.from?get(ch-1):get(ch,right)}lineObj=lineObj||getLine(cm.doc,pos.line),measurement||(measurement=measureLine(cm,lineObj));var order=getOrder(lineObj),ch=pos.ch;if(!order)return get(ch);var partPos=getBidiPartAt(order,ch),val=getBidi(ch,partPos);return null!=bidiOther&&(val.other=getBidi(ch,bidiOther)),val}function PosWithInfo(line,ch,outside,xRel){var pos=new Pos(line,ch);return pos.xRel=xRel,outside&&(pos.outside=!0),pos}function coordsChar(cm,x,y){var doc=cm.doc;if(y+=cm.display.viewOffset,0>y)return PosWithInfo(doc.first,0,!0,-1);var lineNo=lineAtHeight(doc,y),last=doc.first+doc.size-1;if(lineNo>last)return PosWithInfo(doc.first+doc.size-1,getLine(doc,last).text.length,!0,1);for(0>x&&(x=0);;){var lineObj=getLine(doc,lineNo),found=coordsCharInner(cm,lineObj,lineNo,x,y),merged=collapsedSpanAtEnd(lineObj),mergedPos=merged&&merged.find();if(!merged||!(found.ch>mergedPos.from.ch||found.ch==mergedPos.from.ch&&found.xRel>0))return found;lineNo=mergedPos.to.line}}function coordsCharInner(cm,lineObj,lineNo,x,y){function getX(ch){var sp=cursorCoords(cm,Pos(lineNo,ch),"line",lineObj,measurement);return wrongLine=!0,innerOff>sp.bottom?sp.left-adjust:innerOff<sp.top?sp.left+adjust:(wrongLine=!1,sp.left)}var innerOff=y-heightAtLine(cm,lineObj),wrongLine=!1,adjust=2*cm.display.wrapper.clientWidth,measurement=measureLine(cm,lineObj),bidi=getOrder(lineObj),dist=lineObj.text.length,from=lineLeft(lineObj),to=lineRight(lineObj),fromX=getX(from),fromOutside=wrongLine,toX=getX(to),toOutside=wrongLine;if(x>toX)return PosWithInfo(lineNo,to,toOutside,1);for(;;){if(bidi?to==from||to==moveVisually(lineObj,from,1):1>=to-from){for(var ch=fromX>x||toX-x>=x-fromX?from:to,xDiff=x-(ch==from?fromX:toX);isExtendingChar.test(lineObj.text.charAt(ch));)++ch;var pos=PosWithInfo(lineNo,ch,ch==from?fromOutside:toOutside,0>xDiff?-1:xDiff?1:0);return pos}var step=Math.ceil(dist/2),middle=from+step;if(bidi){middle=from;for(var i=0;step>i;++i)middle=moveVisually(lineObj,middle,1)}var middleX=getX(middle);middleX>x?(to=middle,toX=middleX,(toOutside=wrongLine)&&(toX+=1e3),dist=step):(from=middle,fromX=middleX,fromOutside=wrongLine,dist-=step)}}function textHeight(display){if(null!=display.cachedTextHeight)return display.cachedTextHeight;if(null==measureText){measureText=elt("pre");for(var i=0;49>i;++i)measureText.appendChild(document.createTextNode("x")),measureText.appendChild(elt("br"));measureText.appendChild(document.createTextNode("x"))}removeChildrenAndAdd(display.measure,measureText);var height=measureText.offsetHeight/50;return height>3&&(display.cachedTextHeight=height),removeChildren(display.measure),height||1}function charWidth(display){if(null!=display.cachedCharWidth)return display.cachedCharWidth;var anchor=elt("span","x"),pre=elt("pre",[anchor]);removeChildrenAndAdd(display.measure,pre);var width=anchor.offsetWidth;return width>2&&(display.cachedCharWidth=width),width||10}function startOperation(cm){cm.curOp={changes:[],updateInput:null,userSelChange:null,textChanged:null,selectionChanged:!1,cursorActivity:!1,updateMaxLine:!1,updateScrollPos:!1,id:++nextOpId},delayedCallbackDepth++||(delayedCallbacks=[])}function endOperation(cm){var op=cm.curOp,doc=cm.doc,display=cm.display;if(cm.curOp=null,op.updateMaxLine&&computeMaxLength(cm),display.maxLineChanged&&!cm.options.lineWrapping&&display.maxLine){var width=measureLineWidth(cm,display.maxLine);display.sizer.style.minWidth=Math.max(0,width+3+scrollerCutOff)+"px",display.maxLineChanged=!1;var maxScrollLeft=Math.max(0,display.sizer.offsetLeft+display.sizer.offsetWidth-display.scroller.clientWidth);maxScrollLeft<doc.scrollLeft&&!op.updateScrollPos&&setScrollLeft(cm,Math.min(display.scroller.scrollLeft,maxScrollLeft),!0)}var newScrollPos,updated;if(op.updateScrollPos)newScrollPos=op.updateScrollPos;else if(op.selectionChanged&&display.scroller.clientHeight){var coords=cursorCoords(cm,doc.sel.head);newScrollPos=calculateScrollPos(cm,coords.left,coords.top,coords.left,coords.bottom)}(op.changes.length||newScrollPos&&null!=newScrollPos.scrollTop)&&(updated=updateDisplay(cm,op.changes,newScrollPos&&newScrollPos.scrollTop),cm.display.scroller.offsetHeight&&(cm.doc.scrollTop=cm.display.scroller.scrollTop)),!updated&&op.selectionChanged&&updateSelection(cm),op.updateScrollPos?(display.scroller.scrollTop=display.scrollbarV.scrollTop=doc.scrollTop=newScrollPos.scrollTop,display.scroller.scrollLeft=display.scrollbarH.scrollLeft=doc.scrollLeft=newScrollPos.scrollLeft,alignHorizontally(cm),op.scrollToPos&&scrollPosIntoView(cm,clipPos(cm.doc,op.scrollToPos),op.scrollToPosMargin)):newScrollPos&&scrollCursorIntoView(cm),op.selectionChanged&&restartBlink(cm),cm.state.focused&&op.updateInput&&resetInput(cm,op.userSelChange);var hidden=op.maybeHiddenMarkers,unhidden=op.maybeUnhiddenMarkers;if(hidden)for(var i=0;i<hidden.length;++i)hidden[i].lines.length||signal(hidden[i],"hide");if(unhidden)for(var i=0;i<unhidden.length;++i)unhidden[i].lines.length&&signal(unhidden[i],"unhide");var delayed;if(--delayedCallbackDepth||(delayed=delayedCallbacks,delayedCallbacks=null),op.textChanged&&signal(cm,"change",cm,op.textChanged),op.cursorActivity&&signal(cm,"cursorActivity",cm),delayed)for(var i=0;i<delayed.length;++i)delayed[i]()}function operation(cm1,f){return function(){var cm=cm1||this,withOp=!cm.curOp;withOp&&startOperation(cm);try{var result=f.apply(cm,arguments)}finally{withOp&&endOperation(cm)}return result}}function docOperation(f){return function(){var result,withOp=this.cm&&!this.cm.curOp;withOp&&startOperation(this.cm);try{result=f.apply(this,arguments)}finally{withOp&&endOperation(this.cm)}return result}}function runInOp(cm,f){var result,withOp=!cm.curOp;withOp&&startOperation(cm);try{result=f()}finally{withOp&&endOperation(cm)}return result}function regChange(cm,from,to,lendiff){null==from&&(from=cm.doc.first),null==to&&(to=cm.doc.first+cm.doc.size),cm.curOp.changes.push({from:from,to:to,diff:lendiff})}function slowPoll(cm){cm.display.pollingFast||cm.display.poll.set(cm.options.pollInterval,function(){readInput(cm),cm.state.focused&&slowPoll(cm)})}function fastPoll(cm){function p(){var changed=readInput(cm);changed||missed?(cm.display.pollingFast=!1,slowPoll(cm)):(missed=!0,cm.display.poll.set(60,p))}var missed=!1;cm.display.pollingFast=!0,cm.display.poll.set(20,p)}function readInput(cm){var input=cm.display.input,prevInput=cm.display.prevInput,doc=cm.doc,sel=doc.sel;if(!cm.state.focused||hasSelection(input)||isReadOnly(cm)||cm.state.disableInput)return!1;var text=input.value;if(text==prevInput&&posEq(sel.from,sel.to))return!1;if(ie&&!ie_lt9&&cm.display.inputHasSelection===text)return resetInput(cm,!0),!1;var withOp=!cm.curOp;withOp&&startOperation(cm),sel.shift=!1;for(var same=0,l=Math.min(prevInput.length,text.length);l>same&&prevInput.charCodeAt(same)==text.charCodeAt(same);)++same;var from=sel.from,to=sel.to;same<prevInput.length?from=Pos(from.line,from.ch-(prevInput.length-same)):cm.state.overwrite&&posEq(from,to)&&!cm.state.pasteIncoming&&(to=Pos(to.line,Math.min(getLine(doc,to.line).text.length,to.ch+(text.length-same))));var updateInput=cm.curOp.updateInput,changeEvent={from:from,to:to,text:splitLines(text.slice(same)),origin:cm.state.pasteIncoming?"paste":"+input"};return makeChange(cm.doc,changeEvent,"end"),cm.curOp.updateInput=updateInput,signalLater(cm,"inputRead",cm,changeEvent),text.length>1e3||text.indexOf("\n")>-1?input.value=cm.display.prevInput="":cm.display.prevInput=text,withOp&&endOperation(cm),cm.state.pasteIncoming=!1,!0}function resetInput(cm,user){var minimal,selected,doc=cm.doc;if(posEq(doc.sel.from,doc.sel.to))user&&(cm.display.prevInput=cm.display.input.value="",ie&&!ie_lt9&&(cm.display.inputHasSelection=null));else{cm.display.prevInput="",minimal=hasCopyEvent&&(doc.sel.to.line-doc.sel.from.line>100||(selected=cm.getSelection()).length>1e3);var content=minimal?"-":selected||cm.getSelection();cm.display.input.value=content,cm.state.focused&&selectInput(cm.display.input),ie&&!ie_lt9&&(cm.display.inputHasSelection=content)}cm.display.inaccurateSelection=minimal}function focusInput(cm){"nocursor"==cm.options.readOnly||mobile&&document.activeElement==cm.display.input||cm.display.input.focus()}function isReadOnly(cm){return cm.options.readOnly||cm.doc.cantEdit}function registerEventHandlers(cm){function reFocus(){cm.state.focused&&setTimeout(bind(focusInput,cm),0)}function onResize(){null==resizeTimer&&(resizeTimer=setTimeout(function(){resizeTimer=null,d.cachedCharWidth=d.cachedTextHeight=knownScrollbarWidth=null,clearCaches(cm),runInOp(cm,bind(regChange,cm))},100))}function unregister(){for(var p=d.wrapper.parentNode;p&&p!=document.body;p=p.parentNode);p?setTimeout(unregister,5e3):off(window,"resize",onResize)}function drag_(e){signalDOMEvent(cm,e)||cm.options.onDragEvent&&cm.options.onDragEvent(cm,addStop(e))||e_stop(e)}function prepareCopy(){d.inaccurateSelection&&(d.prevInput="",d.inaccurateSelection=!1,d.input.value=cm.getSelection(),selectInput(d.input))}var d=cm.display;on(d.scroller,"mousedown",operation(cm,onMouseDown)),ie?on(d.scroller,"dblclick",operation(cm,function(e){if(!signalDOMEvent(cm,e)){var pos=posFromMouse(cm,e);if(pos&&!clickInGutter(cm,e)&&!eventInWidget(cm.display,e)){e_preventDefault(e);var word=findWordAt(getLine(cm.doc,pos.line).text,pos);extendSelection(cm.doc,word.from,word.to)}}})):on(d.scroller,"dblclick",function(e){signalDOMEvent(cm,e)||e_preventDefault(e)}),on(d.lineSpace,"selectstart",function(e){eventInWidget(d,e)||e_preventDefault(e)}),captureMiddleClick||on(d.scroller,"contextmenu",function(e){onContextMenu(cm,e)}),on(d.scroller,"scroll",function(){d.scroller.clientHeight&&(setScrollTop(cm,d.scroller.scrollTop),setScrollLeft(cm,d.scroller.scrollLeft,!0),signal(cm,"scroll",cm))}),on(d.scrollbarV,"scroll",function(){d.scroller.clientHeight&&setScrollTop(cm,d.scrollbarV.scrollTop)}),on(d.scrollbarH,"scroll",function(){d.scroller.clientHeight&&setScrollLeft(cm,d.scrollbarH.scrollLeft)}),on(d.scroller,"mousewheel",function(e){onScrollWheel(cm,e)}),on(d.scroller,"DOMMouseScroll",function(e){onScrollWheel(cm,e)}),on(d.scrollbarH,"mousedown",reFocus),on(d.scrollbarV,"mousedown",reFocus),on(d.wrapper,"scroll",function(){d.wrapper.scrollTop=d.wrapper.scrollLeft=0});var resizeTimer;on(window,"resize",onResize),setTimeout(unregister,5e3),on(d.input,"keyup",operation(cm,function(e){signalDOMEvent(cm,e)||cm.options.onKeyEvent&&cm.options.onKeyEvent(cm,addStop(e))||16==e.keyCode&&(cm.doc.sel.shift=!1)})),on(d.input,"input",bind(fastPoll,cm)),on(d.input,"keydown",operation(cm,onKeyDown)),on(d.input,"keypress",operation(cm,onKeyPress)),on(d.input,"focus",bind(onFocus,cm)),on(d.input,"blur",bind(onBlur,cm)),cm.options.dragDrop&&(on(d.scroller,"dragstart",function(e){onDragStart(cm,e)}),on(d.scroller,"dragenter",drag_),on(d.scroller,"dragover",drag_),on(d.scroller,"drop",operation(cm,onDrop))),on(d.scroller,"paste",function(e){eventInWidget(d,e)||(focusInput(cm),fastPoll(cm))}),on(d.input,"paste",function(){cm.state.pasteIncoming=!0,fastPoll(cm)}),on(d.input,"cut",prepareCopy),on(d.input,"copy",prepareCopy),khtml&&on(d.sizer,"mouseup",function(){document.activeElement==d.input&&d.input.blur(),focusInput(cm)})}function eventInWidget(display,e){for(var n=e_target(e);n!=display.wrapper;n=n.parentNode)if(!n||n.ignoreEvents||n.parentNode==display.sizer&&n!=display.mover)return!0}function posFromMouse(cm,e,liberal){var display=cm.display;if(!liberal){var target=e_target(e);if(target==display.scrollbarH||target==display.scrollbarH.firstChild||target==display.scrollbarV||target==display.scrollbarV.firstChild||target==display.scrollbarFiller||target==display.gutterFiller)return null}var x,y,space=getRect(display.lineSpace);try{x=e.clientX,y=e.clientY}catch(e){return null}return coordsChar(cm,x-space.left,y-space.top)}function onMouseDown(e){function doSelect(cur){if(!posEq(lastPos,cur)){if(lastPos=cur,"single"==type)return void extendSelection(cm.doc,clipPos(doc,start),cur);if(startstart=clipPos(doc,startstart),startend=clipPos(doc,startend),"double"==type){var word=findWordAt(getLine(doc,cur.line).text,cur);posLess(cur,startstart)?extendSelection(cm.doc,word.from,startend):extendSelection(cm.doc,startstart,word.to)}else"triple"==type&&(posLess(cur,startstart)?extendSelection(cm.doc,startend,clipPos(doc,Pos(cur.line,0))):extendSelection(cm.doc,startstart,clipPos(doc,Pos(cur.line+1,0))))}}function extend(e){var curCount=++counter,cur=posFromMouse(cm,e,!0);if(cur)if(posEq(cur,last)){var outside=e.clientY<editorSize.top?-20:e.clientY>editorSize.bottom?20:0;outside&&setTimeout(operation(cm,function(){counter==curCount&&(display.scroller.scrollTop+=outside,extend(e))}),50)}else{cm.state.focused||onFocus(cm),last=cur,doSelect(cur);var visible=visibleLines(display,doc);(cur.line>=visible.to||cur.line<visible.from)&&setTimeout(operation(cm,function(){counter==curCount&&extend(e)}),150)}}function done(e){counter=1/0,e_preventDefault(e),focusInput(cm),off(document,"mousemove",move),off(document,"mouseup",up)}if(!signalDOMEvent(this,e)){var cm=this,display=cm.display,doc=cm.doc,sel=doc.sel;if(sel.shift=e.shiftKey,eventInWidget(display,e))return void(webkit||(display.scroller.draggable=!1,setTimeout(function(){display.scroller.draggable=!0},100)));if(!clickInGutter(cm,e)){var start=posFromMouse(cm,e);switch(e_button(e)){case 3:return void(captureMiddleClick&&onContextMenu.call(cm,cm,e));case 2:return start&&extendSelection(cm.doc,start),setTimeout(bind(focusInput,cm),20),void e_preventDefault(e)}if(!start)return void(e_target(e)==display.scroller&&e_preventDefault(e));cm.state.focused||onFocus(cm);var now=+new Date,type="single";if(lastDoubleClick&&lastDoubleClick.time>now-400&&posEq(lastDoubleClick.pos,start))type="triple",e_preventDefault(e),setTimeout(bind(focusInput,cm),20),selectLine(cm,start.line);else if(lastClick&&lastClick.time>now-400&&posEq(lastClick.pos,start)){type="double",lastDoubleClick={time:now,pos:start},e_preventDefault(e);var word=findWordAt(getLine(doc,start.line).text,start);extendSelection(cm.doc,word.from,word.to)}else lastClick={time:now,pos:start};var last=start;if(cm.options.dragDrop&&dragAndDrop&&!isReadOnly(cm)&&!posEq(sel.from,sel.to)&&!posLess(start,sel.from)&&!posLess(sel.to,start)&&"single"==type){var dragEnd=operation(cm,function(e2){webkit&&(display.scroller.draggable=!1),cm.state.draggingText=!1,off(document,"mouseup",dragEnd),off(display.scroller,"drop",dragEnd),Math.abs(e.clientX-e2.clientX)+Math.abs(e.clientY-e2.clientY)<10&&(e_preventDefault(e2),extendSelection(cm.doc,start),focusInput(cm))});return webkit&&(display.scroller.draggable=!0),cm.state.draggingText=dragEnd,display.scroller.dragDrop&&display.scroller.dragDrop(),on(document,"mouseup",dragEnd),void on(display.scroller,"drop",dragEnd)}e_preventDefault(e),"single"==type&&extendSelection(cm.doc,clipPos(doc,start));var startstart=sel.from,startend=sel.to,lastPos=start,editorSize=getRect(display.wrapper),counter=0,move=operation(cm,function(e){ie||e_button(e)?extend(e):done(e)}),up=operation(cm,done);on(document,"mousemove",move),on(document,"mouseup",up)}}}function clickInGutter(cm,e){var display=cm.display;try{var mX=e.clientX,mY=e.clientY}catch(e){return!1}if(mX>=Math.floor(getRect(display.gutters).right))return!1;if(e_preventDefault(e),!hasHandler(cm,"gutterClick"))return!0;var lineBox=getRect(display.lineDiv);if(mY>lineBox.bottom)return!0;mY-=lineBox.top-display.viewOffset;for(var i=0;i<cm.options.gutters.length;++i){var g=display.gutters.childNodes[i];if(g&&getRect(g).right>=mX){var line=lineAtHeight(cm.doc,mY),gutter=cm.options.gutters[i];signalLater(cm,"gutterClick",cm,line,gutter,e);break}}return!0}function onDrop(e){var cm=this;if(!(signalDOMEvent(cm,e)||eventInWidget(cm.display,e)||cm.options.onDragEvent&&cm.options.onDragEvent(cm,addStop(e)))){e_preventDefault(e),ie&&(lastDrop=+new Date);var pos=posFromMouse(cm,e,!0),files=e.dataTransfer.files;if(pos&&!isReadOnly(cm))if(files&&files.length&&window.FileReader&&window.File)for(var n=files.length,text=Array(n),read=0,loadFile=function(file,i){var reader=new FileReader;reader.onload=function(){text[i]=reader.result,++read==n&&(pos=clipPos(cm.doc,pos),makeChange(cm.doc,{from:pos,to:pos,text:splitLines(text.join("\n")),origin:"paste"},"around"))},reader.readAsText(file)},i=0;n>i;++i)loadFile(files[i],i);else{if(cm.state.draggingText&&!posLess(pos,cm.doc.sel.from)&&!posLess(cm.doc.sel.to,pos))return cm.state.draggingText(e),void setTimeout(bind(focusInput,cm),20);try{var text=e.dataTransfer.getData("Text");if(text){var curFrom=cm.doc.sel.from,curTo=cm.doc.sel.to;setSelection(cm.doc,pos,pos),cm.state.draggingText&&replaceRange(cm.doc,"",curFrom,curTo,"paste"),cm.replaceSelection(text,null,"paste"),focusInput(cm),onFocus(cm)}}catch(e){}}}}function onDragStart(cm,e){if(ie&&(!cm.state.draggingText||+new Date-lastDrop<100))return void e_stop(e);if(!signalDOMEvent(cm,e)&&!eventInWidget(cm.display,e)){var txt=cm.getSelection();if(e.dataTransfer.setData("Text",txt),e.dataTransfer.setDragImage&&!safari){var img=elt("img",null,null,"position: fixed; left: 0; top: 0;");opera&&(img.width=img.height=1,cm.display.wrapper.appendChild(img),img._top=img.offsetTop),e.dataTransfer.setDragImage(img,0,0),opera&&img.parentNode.removeChild(img)}}}function setScrollTop(cm,val){Math.abs(cm.doc.scrollTop-val)<2||(cm.doc.scrollTop=val,gecko||updateDisplay(cm,[],val),cm.display.scroller.scrollTop!=val&&(cm.display.scroller.scrollTop=val),cm.display.scrollbarV.scrollTop!=val&&(cm.display.scrollbarV.scrollTop=val),gecko&&updateDisplay(cm,[]),startWorker(cm,100))}function setScrollLeft(cm,val,isScroller){(isScroller?val==cm.doc.scrollLeft:Math.abs(cm.doc.scrollLeft-val)<2)||(val=Math.min(val,cm.display.scroller.scrollWidth-cm.display.scroller.clientWidth),cm.doc.scrollLeft=val,alignHorizontally(cm),cm.display.scroller.scrollLeft!=val&&(cm.display.scroller.scrollLeft=val),cm.display.scrollbarH.scrollLeft!=val&&(cm.display.scrollbarH.scrollLeft=val))}function onScrollWheel(cm,e){var dx=e.wheelDeltaX,dy=e.wheelDeltaY;null==dx&&e.detail&&e.axis==e.HORIZONTAL_AXIS&&(dx=e.detail),null==dy&&e.detail&&e.axis==e.VERTICAL_AXIS?dy=e.detail:null==dy&&(dy=e.wheelDelta);var display=cm.display,scroll=display.scroller;if(dx&&scroll.scrollWidth>scroll.clientWidth||dy&&scroll.scrollHeight>scroll.clientHeight){if(dy&&mac&&webkit)for(var cur=e.target;cur!=scroll;cur=cur.parentNode)if(cur.lineObj){cm.display.currentWheelTarget=cur;break}if(dx&&!gecko&&!opera&&null!=wheelPixelsPerUnit)return dy&&setScrollTop(cm,Math.max(0,Math.min(scroll.scrollTop+dy*wheelPixelsPerUnit,scroll.scrollHeight-scroll.clientHeight))),setScrollLeft(cm,Math.max(0,Math.min(scroll.scrollLeft+dx*wheelPixelsPerUnit,scroll.scrollWidth-scroll.clientWidth))),e_preventDefault(e),void(display.wheelStartX=null);if(dy&&null!=wheelPixelsPerUnit){var pixels=dy*wheelPixelsPerUnit,top=cm.doc.scrollTop,bot=top+display.wrapper.clientHeight;0>pixels?top=Math.max(0,top+pixels-50):bot=Math.min(cm.doc.height,bot+pixels+50),updateDisplay(cm,[],{top:top,bottom:bot})}20>wheelSamples&&(null==display.wheelStartX?(display.wheelStartX=scroll.scrollLeft,display.wheelStartY=scroll.scrollTop,display.wheelDX=dx,display.wheelDY=dy,setTimeout(function(){if(null!=display.wheelStartX){var movedX=scroll.scrollLeft-display.wheelStartX,movedY=scroll.scrollTop-display.wheelStartY,sample=movedY&&display.wheelDY&&movedY/display.wheelDY||movedX&&display.wheelDX&&movedX/display.wheelDX;display.wheelStartX=display.wheelStartY=null,sample&&(wheelPixelsPerUnit=(wheelPixelsPerUnit*wheelSamples+sample)/(wheelSamples+1),++wheelSamples)}},200)):(display.wheelDX+=dx,display.wheelDY+=dy))}}function doHandleBinding(cm,bound,dropShift){if("string"==typeof bound&&(bound=commands[bound],!bound))return!1;cm.display.pollingFast&&readInput(cm)&&(cm.display.pollingFast=!1);var doc=cm.doc,prevShift=doc.sel.shift,done=!1;try{isReadOnly(cm)&&(cm.state.suppressEdits=!0),dropShift&&(doc.sel.shift=!1),done=bound(cm)!=Pass}finally{doc.sel.shift=prevShift,cm.state.suppressEdits=!1}return done}function allKeyMaps(cm){var maps=cm.state.keyMaps.slice(0);return cm.options.extraKeys&&maps.push(cm.options.extraKeys),maps.push(cm.options.keyMap),maps}function handleKeyBinding(cm,e){var startMap=getKeyMap(cm.options.keyMap),next=startMap.auto;clearTimeout(maybeTransition),next&&!isModifierKey(e)&&(maybeTransition=setTimeout(function(){getKeyMap(cm.options.keyMap)==startMap&&(cm.options.keyMap=next.call?next.call(null,cm):next,keyMapChanged(cm))},50));var name=keyName(e,!0),handled=!1;if(!name)return!1;var keymaps=allKeyMaps(cm);return handled=e.shiftKey?lookupKey("Shift-"+name,keymaps,function(b){return doHandleBinding(cm,b,!0)})||lookupKey(name,keymaps,function(b){return("string"==typeof b?/^go[A-Z]/.test(b):b.motion)?doHandleBinding(cm,b):void 0}):lookupKey(name,keymaps,function(b){return doHandleBinding(cm,b)}),handled&&(e_preventDefault(e),restartBlink(cm),ie_lt9&&(e.oldKeyCode=e.keyCode,e.keyCode=0),signalLater(cm,"keyHandled",cm,name,e)),handled}function handleCharBinding(cm,e,ch){var handled=lookupKey("'"+ch+"'",allKeyMaps(cm),function(b){return doHandleBinding(cm,b,!0)});return handled&&(e_preventDefault(e),restartBlink(cm),signalLater(cm,"keyHandled",cm,"'"+ch+"'",e)),handled}function onKeyDown(e){var cm=this;if(cm.state.focused||onFocus(cm),ie&&27==e.keyCode&&(e.returnValue=!1),!(signalDOMEvent(cm,e)||cm.options.onKeyEvent&&cm.options.onKeyEvent(cm,addStop(e)))){var code=e.keyCode;cm.doc.sel.shift=16==code||e.shiftKey;var handled=handleKeyBinding(cm,e);opera&&(lastStoppedKey=handled?code:null,!handled&&88==code&&!hasCopyEvent&&(mac?e.metaKey:e.ctrlKey)&&cm.replaceSelection(""))}}function onKeyPress(e){var cm=this;if(!(signalDOMEvent(cm,e)||cm.options.onKeyEvent&&cm.options.onKeyEvent(cm,addStop(e)))){var keyCode=e.keyCode,charCode=e.charCode;if(opera&&keyCode==lastStoppedKey)return lastStoppedKey=null,void e_preventDefault(e);if(!(opera&&(!e.which||e.which<10)||khtml)||!handleKeyBinding(cm,e)){var ch=String.fromCharCode(null==charCode?keyCode:charCode);this.options.electricChars&&this.doc.mode.electricChars&&this.options.smartIndent&&!isReadOnly(this)&&this.doc.mode.electricChars.indexOf(ch)>-1&&setTimeout(operation(cm,function(){indentLine(cm,cm.doc.sel.to.line,"smart")}),75),handleCharBinding(cm,e,ch)||(ie&&!ie_lt9&&(cm.display.inputHasSelection=null),fastPoll(cm))}}}function onFocus(cm){"nocursor"!=cm.options.readOnly&&(cm.state.focused||(signal(cm,"focus",cm),cm.state.focused=!0,-1==cm.display.wrapper.className.search(/\bCodeMirror-focused\b/)&&(cm.display.wrapper.className+=" CodeMirror-focused"),resetInput(cm,!0)),slowPoll(cm),restartBlink(cm))}function onBlur(cm){cm.state.focused&&(signal(cm,"blur",cm),cm.state.focused=!1,cm.display.wrapper.className=cm.display.wrapper.className.replace(" CodeMirror-focused","")),clearInterval(cm.display.blinker),setTimeout(function(){cm.state.focused||(cm.doc.sel.shift=!1)},150)}function onContextMenu(cm,e){function prepareSelectAllHack(){if(null!=display.input.selectionStart){var extval=display.input.value=" "+(posEq(sel.from,sel.to)?"":display.input.value);display.prevInput=" ",display.input.selectionStart=1,display.input.selectionEnd=extval.length}}function rehide(){if(display.inputDiv.style.position="relative",display.input.style.cssText=oldCSS,ie_lt9&&(display.scrollbarV.scrollTop=display.scroller.scrollTop=scrollPos),slowPoll(cm),null!=display.input.selectionStart){(!ie||ie_lt9)&&prepareSelectAllHack(),clearTimeout(detectingSelectAll);var i=0,poll=function(){" "==display.prevInput&&0==display.input.selectionStart?operation(cm,commands.selectAll)(cm):i++<10?detectingSelectAll=setTimeout(poll,500):resetInput(cm)};detectingSelectAll=setTimeout(poll,200)}}var display=cm.display,sel=cm.doc.sel;if(!eventInWidget(display,e)){var pos=posFromMouse(cm,e),scrollPos=display.scroller.scrollTop;if(pos&&!opera){(posEq(sel.from,sel.to)||posLess(pos,sel.from)||!posLess(pos,sel.to))&&operation(cm,setSelection)(cm.doc,pos,pos);var oldCSS=display.input.style.cssText;if(display.inputDiv.style.position="absolute",display.input.style.cssText="position: fixed; width: 30px; height: 30px; top: "+(e.clientY-5)+"px; left: "+(e.clientX-5)+"px; z-index: 1000; background: white; outline: none;border-width: 0; outline: none; overflow: hidden; opacity: .05; -ms-opacity: .05; filter: alpha(opacity=5);",focusInput(cm),resetInput(cm,!0),posEq(sel.from,sel.to)&&(display.input.value=display.prevInput=" "),ie&&!ie_lt9&&prepareSelectAllHack(),captureMiddleClick){e_stop(e);var mouseup=function(){off(window,"mouseup",mouseup),setTimeout(rehide,20)};on(window,"mouseup",mouseup)}else setTimeout(rehide,50)}}}function clipPostChange(doc,change,pos){if(!posLess(change.from,pos))return clipPos(doc,pos);var diff=change.text.length-1-(change.to.line-change.from.line);if(pos.line>change.to.line+diff){var preLine=pos.line-diff,lastLine=doc.first+doc.size-1;return preLine>lastLine?Pos(lastLine,getLine(doc,lastLine).text.length):clipToLen(pos,getLine(doc,preLine).text.length)}if(pos.line==change.to.line+diff)return clipToLen(pos,lst(change.text).length+(1==change.text.length?change.from.ch:0)+getLine(doc,change.to.line).text.length-change.to.ch);var inside=pos.line-change.from.line;return clipToLen(pos,change.text[inside].length+(inside?0:change.from.ch))}function computeSelAfterChange(doc,change,hint){if(hint&&"object"==typeof hint)return{anchor:clipPostChange(doc,change,hint.anchor),head:clipPostChange(doc,change,hint.head)};if("start"==hint)return{anchor:change.from,head:change.from};var end=changeEnd(change);if("around"==hint)return{anchor:change.from,head:end};if("end"==hint)return{anchor:end,head:end};var adjustPos=function(pos){if(posLess(pos,change.from))return pos;if(!posLess(change.to,pos))return end;var line=pos.line+change.text.length-(change.to.line-change.from.line)-1,ch=pos.ch;return pos.line==change.to.line&&(ch+=end.ch-change.to.ch),Pos(line,ch)};return{anchor:adjustPos(doc.sel.anchor),head:adjustPos(doc.sel.head)}}function filterChange(doc,change,update){var obj={canceled:!1,from:change.from,to:change.to,text:change.text,origin:change.origin,cancel:function(){this.canceled=!0}};return update&&(obj.update=function(from,to,text,origin){from&&(this.from=clipPos(doc,from)),to&&(this.to=clipPos(doc,to)),text&&(this.text=text),void 0!==origin&&(this.origin=origin)}),signal(doc,"beforeChange",doc,obj),doc.cm&&signal(doc.cm,"beforeChange",doc.cm,obj),obj.canceled?null:{from:obj.from,to:obj.to,text:obj.text,origin:obj.origin}}function makeChange(doc,change,selUpdate,ignoreReadOnly){if(doc.cm){if(!doc.cm.curOp)return operation(doc.cm,makeChange)(doc,change,selUpdate,ignoreReadOnly);if(doc.cm.state.suppressEdits)return}if(!(hasHandler(doc,"beforeChange")||doc.cm&&hasHandler(doc.cm,"beforeChange"))||(change=filterChange(doc,change,!0))){var split=sawReadOnlySpans&&!ignoreReadOnly&&removeReadOnlyRanges(doc,change.from,change.to);if(split){for(var i=split.length-1;i>=1;--i)makeChangeNoReadonly(doc,{from:split[i].from,to:split[i].to,text:[""]});split.length&&makeChangeNoReadonly(doc,{from:split[0].from,to:split[0].to,text:change.text},selUpdate)}else makeChangeNoReadonly(doc,change,selUpdate)}}function makeChangeNoReadonly(doc,change,selUpdate){var selAfter=computeSelAfterChange(doc,change,selUpdate);addToHistory(doc,change,selAfter,doc.cm?doc.cm.curOp.id:0/0),makeChangeSingleDoc(doc,change,selAfter,stretchSpansOverChange(doc,change));var rebased=[];linkedDocs(doc,function(doc,sharedHist){sharedHist||-1!=indexOf(rebased,doc.history)||(rebaseHist(doc.history,change),rebased.push(doc.history)),makeChangeSingleDoc(doc,change,null,stretchSpansOverChange(doc,change))})}function makeChangeFromHistory(doc,type){if(!doc.cm||!doc.cm.state.suppressEdits){var hist=doc.history,event=("undo"==type?hist.done:hist.undone).pop();if(event){var anti={changes:[],anchorBefore:event.anchorAfter,headBefore:event.headAfter,anchorAfter:event.anchorBefore,headAfter:event.headBefore,generation:hist.generation};("undo"==type?hist.undone:hist.done).push(anti),hist.generation=event.generation||++hist.maxGeneration;for(var filter=hasHandler(doc,"beforeChange")||doc.cm&&hasHandler(doc.cm,"beforeChange"),i=event.changes.length-1;i>=0;--i){var change=event.changes[i];if(change.origin=type,filter&&!filterChange(doc,change,!1))return void(("undo"==type?hist.done:hist.undone).length=0);anti.changes.push(historyChangeFromChange(doc,change));var after=i?computeSelAfterChange(doc,change,null):{anchor:event.anchorBefore,head:event.headBefore};
makeChangeSingleDoc(doc,change,after,mergeOldSpans(doc,change));var rebased=[];linkedDocs(doc,function(doc,sharedHist){sharedHist||-1!=indexOf(rebased,doc.history)||(rebaseHist(doc.history,change),rebased.push(doc.history)),makeChangeSingleDoc(doc,change,null,mergeOldSpans(doc,change))})}}}}function shiftDoc(doc,distance){function shiftPos(pos){return Pos(pos.line+distance,pos.ch)}doc.first+=distance,doc.cm&&regChange(doc.cm,doc.first,doc.first,distance),doc.sel.head=shiftPos(doc.sel.head),doc.sel.anchor=shiftPos(doc.sel.anchor),doc.sel.from=shiftPos(doc.sel.from),doc.sel.to=shiftPos(doc.sel.to)}function makeChangeSingleDoc(doc,change,selAfter,spans){if(doc.cm&&!doc.cm.curOp)return operation(doc.cm,makeChangeSingleDoc)(doc,change,selAfter,spans);if(change.to.line<doc.first)return void shiftDoc(doc,change.text.length-1-(change.to.line-change.from.line));if(!(change.from.line>doc.lastLine())){if(change.from.line<doc.first){var shift=change.text.length-1-(doc.first-change.from.line);shiftDoc(doc,shift),change={from:Pos(doc.first,0),to:Pos(change.to.line+shift,change.to.ch),text:[lst(change.text)],origin:change.origin}}var last=doc.lastLine();change.to.line>last&&(change={from:change.from,to:Pos(last,getLine(doc,last).text.length),text:[change.text[0]],origin:change.origin}),change.removed=getBetween(doc,change.from,change.to),selAfter||(selAfter=computeSelAfterChange(doc,change,null)),doc.cm?makeChangeSingleDocInEditor(doc.cm,change,spans,selAfter):updateDoc(doc,change,spans,selAfter)}}function makeChangeSingleDocInEditor(cm,change,spans,selAfter){var doc=cm.doc,display=cm.display,from=change.from,to=change.to,recomputeMaxLength=!1,checkWidthStart=from.line;cm.options.lineWrapping||(checkWidthStart=lineNo(visualLine(doc,getLine(doc,from.line))),doc.iter(checkWidthStart,to.line+1,function(line){return line==display.maxLine?(recomputeMaxLength=!0,!0):void 0})),posLess(doc.sel.head,change.from)||posLess(change.to,doc.sel.head)||(cm.curOp.cursorActivity=!0),updateDoc(doc,change,spans,selAfter,estimateHeight(cm)),cm.options.lineWrapping||(doc.iter(checkWidthStart,from.line+change.text.length,function(line){var len=lineLength(doc,line);len>display.maxLineLength&&(display.maxLine=line,display.maxLineLength=len,display.maxLineChanged=!0,recomputeMaxLength=!1)}),recomputeMaxLength&&(cm.curOp.updateMaxLine=!0)),doc.frontier=Math.min(doc.frontier,from.line),startWorker(cm,400);var lendiff=change.text.length-(to.line-from.line)-1;if(regChange(cm,from.line,to.line+1,lendiff),hasHandler(cm,"change")){var changeObj={from:from,to:to,text:change.text,removed:change.removed,origin:change.origin};if(cm.curOp.textChanged){for(var cur=cm.curOp.textChanged;cur.next;cur=cur.next);cur.next=changeObj}else cm.curOp.textChanged=changeObj}}function replaceRange(doc,code,from,to,origin){if(to||(to=from),posLess(to,from)){var tmp=to;to=from,from=tmp}"string"==typeof code&&(code=splitLines(code)),makeChange(doc,{from:from,to:to,text:code,origin:origin},null)}function Pos(line,ch){return this instanceof Pos?(this.line=line,void(this.ch=ch)):new Pos(line,ch)}function posEq(a,b){return a.line==b.line&&a.ch==b.ch}function posLess(a,b){return a.line<b.line||a.line==b.line&&a.ch<b.ch}function copyPos(x){return Pos(x.line,x.ch)}function clipLine(doc,n){return Math.max(doc.first,Math.min(n,doc.first+doc.size-1))}function clipPos(doc,pos){if(pos.line<doc.first)return Pos(doc.first,0);var last=doc.first+doc.size-1;return pos.line>last?Pos(last,getLine(doc,last).text.length):clipToLen(pos,getLine(doc,pos.line).text.length)}function clipToLen(pos,linelen){var ch=pos.ch;return null==ch||ch>linelen?Pos(pos.line,linelen):0>ch?Pos(pos.line,0):pos}function isLine(doc,l){return l>=doc.first&&l<doc.first+doc.size}function extendSelection(doc,pos,other,bias){if(doc.sel.shift||doc.sel.extend){var anchor=doc.sel.anchor;if(other){var posBefore=posLess(pos,anchor);posBefore!=posLess(other,anchor)?(anchor=pos,pos=other):posBefore!=posLess(pos,other)&&(pos=other)}setSelection(doc,anchor,pos,bias)}else setSelection(doc,pos,other||pos,bias);doc.cm&&(doc.cm.curOp.userSelChange=!0)}function filterSelectionChange(doc,anchor,head){var obj={anchor:anchor,head:head};return signal(doc,"beforeSelectionChange",doc,obj),doc.cm&&signal(doc.cm,"beforeSelectionChange",doc.cm,obj),obj.anchor=clipPos(doc,obj.anchor),obj.head=clipPos(doc,obj.head),obj}function setSelection(doc,anchor,head,bias,checkAtomic){if(!checkAtomic&&hasHandler(doc,"beforeSelectionChange")||doc.cm&&hasHandler(doc.cm,"beforeSelectionChange")){var filtered=filterSelectionChange(doc,anchor,head);head=filtered.head,anchor=filtered.anchor}var sel=doc.sel;if(sel.goalColumn=null,(checkAtomic||!posEq(anchor,sel.anchor))&&(anchor=skipAtomic(doc,anchor,bias,"push"!=checkAtomic)),(checkAtomic||!posEq(head,sel.head))&&(head=skipAtomic(doc,head,bias,"push"!=checkAtomic)),!posEq(sel.anchor,anchor)||!posEq(sel.head,head)){sel.anchor=anchor,sel.head=head;var inv=posLess(head,anchor);sel.from=inv?head:anchor,sel.to=inv?anchor:head,doc.cm&&(doc.cm.curOp.updateInput=doc.cm.curOp.selectionChanged=doc.cm.curOp.cursorActivity=!0),signalLater(doc,"cursorActivity",doc)}}function reCheckSelection(cm){setSelection(cm.doc,cm.doc.sel.from,cm.doc.sel.to,null,"push")}function skipAtomic(doc,pos,bias,mayClear){var flipped=!1,curPos=pos,dir=bias||1;doc.cantEdit=!1;search:for(;;){var line=getLine(doc,curPos.line);if(line.markedSpans)for(var i=0;i<line.markedSpans.length;++i){var sp=line.markedSpans[i],m=sp.marker;if((null==sp.from||(m.inclusiveLeft?sp.from<=curPos.ch:sp.from<curPos.ch))&&(null==sp.to||(m.inclusiveRight?sp.to>=curPos.ch:sp.to>curPos.ch))){if(mayClear&&(signal(m,"beforeCursorEnter"),m.explicitlyCleared)){if(line.markedSpans){--i;continue}break}if(!m.atomic)continue;var newPos=m.find()[0>dir?"from":"to"];if(posEq(newPos,curPos)&&(newPos.ch+=dir,newPos.ch<0?newPos=newPos.line>doc.first?clipPos(doc,Pos(newPos.line-1)):null:newPos.ch>line.text.length&&(newPos=newPos.line<doc.first+doc.size-1?Pos(newPos.line+1,0):null),!newPos)){if(flipped)return mayClear?(doc.cantEdit=!0,Pos(doc.first,0)):skipAtomic(doc,pos,bias,!0);flipped=!0,newPos=pos,dir=-dir}curPos=newPos;continue search}}return curPos}}function scrollCursorIntoView(cm){var coords=scrollPosIntoView(cm,cm.doc.sel.head,cm.options.cursorScrollMargin);if(cm.state.focused){var display=cm.display,box=getRect(display.sizer),doScroll=null;if(coords.top+box.top<0?doScroll=!0:coords.bottom+box.top>(window.innerHeight||document.documentElement.clientHeight)&&(doScroll=!1),null!=doScroll&&!phantom){var hidden="none"==display.cursor.style.display;hidden&&(display.cursor.style.display="",display.cursor.style.left=coords.left+"px",display.cursor.style.top=coords.top-display.viewOffset+"px"),display.cursor.scrollIntoView(doScroll),hidden&&(display.cursor.style.display="none")}}}function scrollPosIntoView(cm,pos,margin){for(null==margin&&(margin=0);;){var changed=!1,coords=cursorCoords(cm,pos),scrollPos=calculateScrollPos(cm,coords.left,coords.top-margin,coords.left,coords.bottom+margin),startTop=cm.doc.scrollTop,startLeft=cm.doc.scrollLeft;if(null!=scrollPos.scrollTop&&(setScrollTop(cm,scrollPos.scrollTop),Math.abs(cm.doc.scrollTop-startTop)>1&&(changed=!0)),null!=scrollPos.scrollLeft&&(setScrollLeft(cm,scrollPos.scrollLeft),Math.abs(cm.doc.scrollLeft-startLeft)>1&&(changed=!0)),!changed)return coords}}function scrollIntoView(cm,x1,y1,x2,y2){var scrollPos=calculateScrollPos(cm,x1,y1,x2,y2);null!=scrollPos.scrollTop&&setScrollTop(cm,scrollPos.scrollTop),null!=scrollPos.scrollLeft&&setScrollLeft(cm,scrollPos.scrollLeft)}function calculateScrollPos(cm,x1,y1,x2,y2){var display=cm.display,snapMargin=textHeight(cm.display);0>y1&&(y1=0);var screen=display.scroller.clientHeight-scrollerCutOff,screentop=display.scroller.scrollTop,result={},docBottom=cm.doc.height+paddingVert(display),atTop=snapMargin>y1,atBottom=y2>docBottom-snapMargin;if(screentop>y1)result.scrollTop=atTop?0:y1;else if(y2>screentop+screen){var newTop=Math.min(y1,(atBottom?docBottom:y2)-screen);newTop!=screentop&&(result.scrollTop=newTop)}var screenw=display.scroller.clientWidth-scrollerCutOff,screenleft=display.scroller.scrollLeft;x1+=display.gutters.offsetWidth,x2+=display.gutters.offsetWidth;var gutterw=display.gutters.offsetWidth,atLeft=gutterw+10>x1;return screenleft+gutterw>x1||atLeft?(atLeft&&(x1=0),result.scrollLeft=Math.max(0,x1-10-gutterw)):x2>screenw+screenleft-3&&(result.scrollLeft=x2+10-screenw),result}function updateScrollPos(cm,left,top){cm.curOp.updateScrollPos={scrollLeft:null==left?cm.doc.scrollLeft:left,scrollTop:null==top?cm.doc.scrollTop:top}}function addToScrollPos(cm,left,top){var pos=cm.curOp.updateScrollPos||(cm.curOp.updateScrollPos={scrollLeft:cm.doc.scrollLeft,scrollTop:cm.doc.scrollTop}),scroll=cm.display.scroller;pos.scrollTop=Math.max(0,Math.min(scroll.scrollHeight-scroll.clientHeight,pos.scrollTop+top)),pos.scrollLeft=Math.max(0,Math.min(scroll.scrollWidth-scroll.clientWidth,pos.scrollLeft+left))}function indentLine(cm,n,how,aggressive){var doc=cm.doc;if(null==how&&(how="add"),"smart"==how)if(cm.doc.mode.indent)var state=getStateBefore(cm,n);else how="prev";var indentation,tabSize=cm.options.tabSize,line=getLine(doc,n),curSpace=countColumn(line.text,null,tabSize),curSpaceString=line.text.match(/^\s*/)[0];if("smart"==how&&(indentation=cm.doc.mode.indent(state,line.text.slice(curSpaceString.length),line.text),indentation==Pass)){if(!aggressive)return;how="prev"}"prev"==how?indentation=n>doc.first?countColumn(getLine(doc,n-1).text,null,tabSize):0:"add"==how?indentation=curSpace+cm.options.indentUnit:"subtract"==how?indentation=curSpace-cm.options.indentUnit:"number"==typeof how&&(indentation=curSpace+how),indentation=Math.max(0,indentation);var indentString="",pos=0;if(cm.options.indentWithTabs)for(var i=Math.floor(indentation/tabSize);i;--i)pos+=tabSize,indentString+="	";indentation>pos&&(indentString+=spaceStr(indentation-pos)),indentString!=curSpaceString&&replaceRange(cm.doc,indentString,Pos(n,0),Pos(n,curSpaceString.length),"+input"),line.stateAfter=null}function changeLine(cm,handle,op){var no=handle,line=handle,doc=cm.doc;return"number"==typeof handle?line=getLine(doc,clipLine(doc,handle)):no=lineNo(handle),null==no?null:op(line,no)?(regChange(cm,no,no+1),line):null}function findPosH(doc,pos,dir,unit,visually){function findNextLine(){var l=line+dir;return l<doc.first||l>=doc.first+doc.size?possible=!1:(line=l,lineObj=getLine(doc,l))}function moveOnce(boundToLine){var next=(visually?moveVisually:moveLogically)(lineObj,ch,dir,!0);if(null==next){if(boundToLine||!findNextLine())return possible=!1;ch=visually?(0>dir?lineRight:lineLeft)(lineObj):0>dir?lineObj.text.length:0}else ch=next;return!0}var line=pos.line,ch=pos.ch,origDir=dir,lineObj=getLine(doc,line),possible=!0;if("char"==unit)moveOnce();else if("column"==unit)moveOnce(!0);else if("word"==unit||"group"==unit)for(var sawType=null,group="group"==unit,first=!0;!(0>dir)||moveOnce(!first);first=!1){var cur=lineObj.text.charAt(ch)||"\n",type=isWordChar(cur)?"w":group?/\s/.test(cur)?null:"p":null;if(sawType&&sawType!=type){0>dir&&(dir=1,moveOnce());break}if(type&&(sawType=type),dir>0&&!moveOnce(!first))break}var result=skipAtomic(doc,Pos(line,ch),origDir,!0);return possible||(result.hitSide=!0),result}function findPosV(cm,pos,dir,unit){var y,doc=cm.doc,x=pos.left;if("page"==unit){var pageSize=Math.min(cm.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight);y=pos.top+dir*(pageSize-(0>dir?1.5:.5)*textHeight(cm.display))}else"line"==unit&&(y=dir>0?pos.bottom+3:pos.top-3);for(;;){var target=coordsChar(cm,x,y);if(!target.outside)break;if(0>dir?0>=y:y>=doc.height){target.hitSide=!0;break}y+=5*dir}return target}function findWordAt(line,pos){var start=pos.ch,end=pos.ch;if(line){pos.xRel<0||end==line.length?--start:++end;for(var startChar=line.charAt(start),check=isWordChar(startChar)?isWordChar:/\s/.test(startChar)?function(ch){return/\s/.test(ch)}:function(ch){return!/\s/.test(ch)&&!isWordChar(ch)};start>0&&check(line.charAt(start-1));)--start;for(;end<line.length&&check(line.charAt(end));)++end}return{from:Pos(pos.line,start),to:Pos(pos.line,end)}}function selectLine(cm,line){extendSelection(cm.doc,Pos(line,0),clipPos(cm.doc,Pos(line+1,0)))}function option(name,deflt,handle,notOnInit){CodeMirror.defaults[name]=deflt,handle&&(optionHandlers[name]=notOnInit?function(cm,val,old){old!=Init&&handle(cm,val,old)}:handle)}function copyState(mode,state){if(state===!0)return state;if(mode.copyState)return mode.copyState(state);var nstate={};for(var n in state){var val=state[n];val instanceof Array&&(val=val.concat([])),nstate[n]=val}return nstate}function startState(mode,a1,a2){return mode.startState?mode.startState(a1,a2):!0}function getKeyMap(val){return"string"==typeof val?keyMap[val]:val}function lookupKey(name,maps,handle){function lookup(map){map=getKeyMap(map);var found=map[name];if(found===!1)return"stop";if(null!=found&&handle(found))return!0;if(map.nofallthrough)return"stop";var fallthrough=map.fallthrough;if(null==fallthrough)return!1;if("[object Array]"!=Object.prototype.toString.call(fallthrough))return lookup(fallthrough);for(var i=0,e=fallthrough.length;e>i;++i){var done=lookup(fallthrough[i]);if(done)return done}return!1}for(var i=0;i<maps.length;++i){var done=lookup(maps[i]);if(done)return"stop"!=done}}function isModifierKey(event){var name=keyNames[event.keyCode];return"Ctrl"==name||"Alt"==name||"Shift"==name||"Mod"==name}function keyName(event,noShift){if(opera&&34==event.keyCode&&event["char"])return!1;var name=keyNames[event.keyCode];return null==name||event.altGraphKey?!1:(event.altKey&&(name="Alt-"+name),(flipCtrlCmd?event.metaKey:event.ctrlKey)&&(name="Ctrl-"+name),(flipCtrlCmd?event.ctrlKey:event.metaKey)&&(name="Cmd-"+name),!noShift&&event.shiftKey&&(name="Shift-"+name),name)}function StringStream(string,tabSize){this.pos=this.start=0,this.string=string,this.tabSize=tabSize||8,this.lastColumnPos=this.lastColumnValue=0}function TextMarker(doc,type){this.lines=[],this.type=type,this.doc=doc}function markText(doc,from,to,options,type){if(options&&options.shared)return markTextShared(doc,from,to,options,type);if(doc.cm&&!doc.cm.curOp)return operation(doc.cm,markText)(doc,from,to,options,type);var marker=new TextMarker(doc,type);if("range"==type&&!posLess(from,to))return marker;options&&copyObj(options,marker),marker.replacedWith&&(marker.collapsed=!0,marker.replacedWith=elt("span",[marker.replacedWith],"CodeMirror-widget"),options.handleMouseEvents||(marker.replacedWith.ignoreEvents=!0)),marker.collapsed&&(sawCollapsedSpans=!0),marker.addToHistory&&addToHistory(doc,{from:from,to:to,origin:"markText"},{head:doc.sel.head,anchor:doc.sel.anchor},0/0);var collapsedAtStart,collapsedAtEnd,updateMaxLine,curLine=from.line,size=0,cm=doc.cm;if(doc.iter(curLine,to.line+1,function(line){cm&&marker.collapsed&&!cm.options.lineWrapping&&visualLine(doc,line)==cm.display.maxLine&&(updateMaxLine=!0);var span={from:null,to:null,marker:marker};size+=line.text.length,curLine==from.line&&(span.from=from.ch,size-=from.ch),curLine==to.line&&(span.to=to.ch,size-=line.text.length-to.ch),marker.collapsed&&(curLine==to.line&&(collapsedAtEnd=collapsedSpanAt(line,to.ch)),curLine==from.line?collapsedAtStart=collapsedSpanAt(line,from.ch):updateLineHeight(line,0)),addMarkedSpan(line,span),++curLine}),marker.collapsed&&doc.iter(from.line,to.line+1,function(line){lineIsHidden(doc,line)&&updateLineHeight(line,0)}),marker.clearOnEnter&&on(marker,"beforeCursorEnter",function(){marker.clear()}),marker.readOnly&&(sawReadOnlySpans=!0,(doc.history.done.length||doc.history.undone.length)&&doc.clearHistory()),marker.collapsed){if(collapsedAtStart!=collapsedAtEnd)throw new Error("Inserting collapsed marker overlapping an existing one");marker.size=size,marker.atomic=!0}return cm&&(updateMaxLine&&(cm.curOp.updateMaxLine=!0),(marker.className||marker.startStyle||marker.endStyle||marker.collapsed)&&regChange(cm,from.line,to.line+1),marker.atomic&&reCheckSelection(cm)),marker}function SharedTextMarker(markers,primary){this.markers=markers,this.primary=primary;for(var i=0,me=this;i<markers.length;++i)markers[i].parent=this,on(markers[i],"clear",function(){me.clear()})}function markTextShared(doc,from,to,options,type){options=copyObj(options),options.shared=!1;var markers=[markText(doc,from,to,options,type)],primary=markers[0],widget=options.replacedWith;return linkedDocs(doc,function(doc){widget&&(options.replacedWith=widget.cloneNode(!0)),markers.push(markText(doc,clipPos(doc,from),clipPos(doc,to),options,type));for(var i=0;i<doc.linked.length;++i)if(doc.linked[i].isParent)return;primary=lst(markers)}),new SharedTextMarker(markers,primary)}function getMarkedSpanFor(spans,marker){if(spans)for(var i=0;i<spans.length;++i){var span=spans[i];if(span.marker==marker)return span}}function removeMarkedSpan(spans,span){for(var r,i=0;i<spans.length;++i)spans[i]!=span&&(r||(r=[])).push(spans[i]);return r}function addMarkedSpan(line,span){line.markedSpans=line.markedSpans?line.markedSpans.concat([span]):[span],span.marker.attachLine(line)}function markedSpansBefore(old,startCh,isInsert){if(old)for(var nw,i=0;i<old.length;++i){var span=old[i],marker=span.marker,startsBefore=null==span.from||(marker.inclusiveLeft?span.from<=startCh:span.from<startCh);if(startsBefore||"bookmark"==marker.type&&span.from==startCh&&(!isInsert||!span.marker.insertLeft)){var endsAfter=null==span.to||(marker.inclusiveRight?span.to>=startCh:span.to>startCh);(nw||(nw=[])).push({from:span.from,to:endsAfter?null:span.to,marker:marker})}}return nw}function markedSpansAfter(old,endCh,isInsert){if(old)for(var nw,i=0;i<old.length;++i){var span=old[i],marker=span.marker,endsAfter=null==span.to||(marker.inclusiveRight?span.to>=endCh:span.to>endCh);if(endsAfter||"bookmark"==marker.type&&span.from==endCh&&(!isInsert||span.marker.insertLeft)){var startsBefore=null==span.from||(marker.inclusiveLeft?span.from<=endCh:span.from<endCh);(nw||(nw=[])).push({from:startsBefore?null:span.from-endCh,to:null==span.to?null:span.to-endCh,marker:marker})}}return nw}function stretchSpansOverChange(doc,change){var oldFirst=isLine(doc,change.from.line)&&getLine(doc,change.from.line).markedSpans,oldLast=isLine(doc,change.to.line)&&getLine(doc,change.to.line).markedSpans;if(!oldFirst&&!oldLast)return null;var startCh=change.from.ch,endCh=change.to.ch,isInsert=posEq(change.from,change.to),first=markedSpansBefore(oldFirst,startCh,isInsert),last=markedSpansAfter(oldLast,endCh,isInsert),sameLine=1==change.text.length,offset=lst(change.text).length+(sameLine?startCh:0);if(first)for(var i=0;i<first.length;++i){var span=first[i];if(null==span.to){var found=getMarkedSpanFor(last,span.marker);found?sameLine&&(span.to=null==found.to?null:found.to+offset):span.to=startCh}}if(last)for(var i=0;i<last.length;++i){var span=last[i];if(null!=span.to&&(span.to+=offset),null==span.from){var found=getMarkedSpanFor(first,span.marker);found||(span.from=offset,sameLine&&(first||(first=[])).push(span))}else span.from+=offset,sameLine&&(first||(first=[])).push(span)}if(sameLine&&first){for(var i=0;i<first.length;++i)null!=first[i].from&&first[i].from==first[i].to&&"bookmark"!=first[i].marker.type&&first.splice(i--,1);first.length||(first=null)}var newMarkers=[first];if(!sameLine){var gapMarkers,gap=change.text.length-2;if(gap>0&&first)for(var i=0;i<first.length;++i)null==first[i].to&&(gapMarkers||(gapMarkers=[])).push({from:null,to:null,marker:first[i].marker});for(var i=0;gap>i;++i)newMarkers.push(gapMarkers);newMarkers.push(last)}return newMarkers}function mergeOldSpans(doc,change){var old=getOldSpans(doc,change),stretched=stretchSpansOverChange(doc,change);if(!old)return stretched;if(!stretched)return old;for(var i=0;i<old.length;++i){var oldCur=old[i],stretchCur=stretched[i];if(oldCur&&stretchCur)spans:for(var j=0;j<stretchCur.length;++j){for(var span=stretchCur[j],k=0;k<oldCur.length;++k)if(oldCur[k].marker==span.marker)continue spans;oldCur.push(span)}else stretchCur&&(old[i]=stretchCur)}return old}function removeReadOnlyRanges(doc,from,to){var markers=null;if(doc.iter(from.line,to.line+1,function(line){if(line.markedSpans)for(var i=0;i<line.markedSpans.length;++i){var mark=line.markedSpans[i].marker;!mark.readOnly||markers&&-1!=indexOf(markers,mark)||(markers||(markers=[])).push(mark)}}),!markers)return null;for(var parts=[{from:from,to:to}],i=0;i<markers.length;++i)for(var mk=markers[i],m=mk.find(),j=0;j<parts.length;++j){var p=parts[j];if(!posLess(p.to,m.from)&&!posLess(m.to,p.from)){var newParts=[j,1];(posLess(p.from,m.from)||!mk.inclusiveLeft&&posEq(p.from,m.from))&&newParts.push({from:p.from,to:m.from}),(posLess(m.to,p.to)||!mk.inclusiveRight&&posEq(p.to,m.to))&&newParts.push({from:m.to,to:p.to}),parts.splice.apply(parts,newParts),j+=newParts.length-1}}return parts}function collapsedSpanAt(line,ch){var found,sps=sawCollapsedSpans&&line.markedSpans;if(sps)for(var sp,i=0;i<sps.length;++i)sp=sps[i],sp.marker.collapsed&&(null==sp.from||sp.from<ch)&&(null==sp.to||sp.to>ch)&&(!found||found.width<sp.marker.width)&&(found=sp.marker);return found}function collapsedSpanAtStart(line){return collapsedSpanAt(line,-1)}function collapsedSpanAtEnd(line){return collapsedSpanAt(line,line.text.length+1)}function visualLine(doc,line){for(var merged;merged=collapsedSpanAtStart(line);)line=getLine(doc,merged.find().from.line);return line}function lineIsHidden(doc,line){var sps=sawCollapsedSpans&&line.markedSpans;if(sps)for(var sp,i=0;i<sps.length;++i)if(sp=sps[i],sp.marker.collapsed){if(null==sp.from)return!0;if(!sp.marker.replacedWith&&0==sp.from&&sp.marker.inclusiveLeft&&lineIsHiddenInner(doc,line,sp))return!0}}function lineIsHiddenInner(doc,line,span){if(null==span.to){var end=span.marker.find().to,endLine=getLine(doc,end.line);return lineIsHiddenInner(doc,endLine,getMarkedSpanFor(endLine.markedSpans,span.marker))}if(span.marker.inclusiveRight&&span.to==line.text.length)return!0;for(var sp,i=0;i<line.markedSpans.length;++i)if(sp=line.markedSpans[i],sp.marker.collapsed&&!sp.marker.replacedWith&&sp.from==span.to&&(sp.marker.inclusiveLeft||span.marker.inclusiveRight)&&lineIsHiddenInner(doc,line,sp))return!0}function detachMarkedSpans(line){var spans=line.markedSpans;if(spans){for(var i=0;i<spans.length;++i)spans[i].marker.detachLine(line);line.markedSpans=null}}function attachMarkedSpans(line,spans){if(spans){for(var i=0;i<spans.length;++i)spans[i].marker.attachLine(line);line.markedSpans=spans}}function widgetOperation(f){return function(){var withOp=!this.cm.curOp;withOp&&startOperation(this.cm);try{var result=f.apply(this,arguments)}finally{withOp&&endOperation(this.cm)}return result}}function widgetHeight(widget){return null!=widget.height?widget.height:(widget.node.parentNode&&1==widget.node.parentNode.nodeType||removeChildrenAndAdd(widget.cm.display.measure,elt("div",[widget.node],null,"position: relative")),widget.height=widget.node.offsetHeight)}function addLineWidget(cm,handle,node,options){var widget=new LineWidget(cm,node,options);return widget.noHScroll&&(cm.display.alignWidgets=!0),changeLine(cm,handle,function(line){if((line.widgets||(line.widgets=[])).push(widget),widget.line=line,!lineIsHidden(cm.doc,line)||widget.showIfHidden){var aboveVisible=heightAtLine(cm,line)<cm.display.scroller.scrollTop;updateLineHeight(line,line.height+widgetHeight(widget)),aboveVisible&&addToScrollPos(cm,0,widget.height)}return!0}),widget}function makeLine(text,markedSpans,estimateHeight){var line={text:text};return attachMarkedSpans(line,markedSpans),line.height=estimateHeight?estimateHeight(line):1,line}function updateLine(line,text,markedSpans,estimateHeight){line.text=text,line.stateAfter&&(line.stateAfter=null),line.styles&&(line.styles=null),null!=line.order&&(line.order=null),detachMarkedSpans(line),attachMarkedSpans(line,markedSpans);var estHeight=estimateHeight?estimateHeight(line):1;estHeight!=line.height&&updateLineHeight(line,estHeight)}function cleanUpLine(line){line.parent=null,detachMarkedSpans(line)}function runMode(cm,text,mode,state,f){var flattenSpans=mode.flattenSpans;null==flattenSpans&&(flattenSpans=cm.options.flattenSpans);var style,curStart=0,curStyle=null,stream=new StringStream(text,cm.options.tabSize);for(""==text&&mode.blankLine&&mode.blankLine(state);!stream.eol();)stream.pos>cm.options.maxHighlightLength?(flattenSpans=!1,stream.pos=Math.min(text.length,stream.start+5e4),style=null):style=mode.token(stream,state),flattenSpans&&curStyle==style||(curStart<stream.start&&f(stream.start,curStyle),curStart=stream.start,curStyle=style),stream.start=stream.pos;curStart<stream.pos&&f(stream.pos,curStyle)}function highlightLine(cm,line,state){var st=[cm.state.modeGen];runMode(cm,line.text,cm.doc.mode,state,function(end,style){st.push(end,style)});for(var o=0;o<cm.state.overlays.length;++o){var overlay=cm.state.overlays[o],i=1,at=0;runMode(cm,line.text,overlay.mode,!0,function(end,style){for(var start=i;end>at;){var i_end=st[i];i_end>end&&st.splice(i,1,end,st[i+1],i_end),i+=2,at=Math.min(end,i_end)}if(style)if(overlay.opaque)st.splice(start,i-start,end,style),i=start+2;else for(;i>start;start+=2){var cur=st[start+1];st[start+1]=cur?cur+" "+style:style}})}return st}function getLineStyles(cm,line){return line.styles&&line.styles[0]==cm.state.modeGen||(line.styles=highlightLine(cm,line,line.stateAfter=getStateBefore(cm,lineNo(line)))),line.styles}function processLine(cm,line,state){var mode=cm.doc.mode,stream=new StringStream(line.text,cm.options.tabSize);for(""==line.text&&mode.blankLine&&mode.blankLine(state);!stream.eol()&&stream.pos<=cm.options.maxHighlightLength;)mode.token(stream,state),stream.start=stream.pos}function styleToClass(style){return style?styleToClassCache[style]||(styleToClassCache[style]="cm-"+style.replace(/ +/g," cm-")):null}function lineContent(cm,realLine,measure){for(var merged,line=realLine,empty=!0;merged=collapsedSpanAtStart(line);)line=getLine(cm.doc,merged.find().from.line);var builder={pre:elt("pre"),col:0,pos:0,display:!measure,measure:null,measuredSomething:!1,cm:cm};line.textClass&&(builder.pre.className=line.textClass);do{line.text&&(empty=!1),builder.measure=line==realLine&&measure,builder.pos=0,builder.addToken=builder.measure?buildTokenMeasure:buildToken,(ie||webkit)&&cm.getOption("lineWrapping")&&(builder.addToken=buildTokenSplitSpaces(builder.addToken));var next=insertLineContent(line,builder,getLineStyles(cm,line));measure&&line==realLine&&!builder.measuredSomething&&(measure[0]=builder.pre.appendChild(zeroWidthElement(cm.display.measure)),builder.measuredSomething=!0),next&&(line=getLine(cm.doc,next.to.line))}while(next);!measure||builder.measuredSomething||measure[0]||(measure[0]=builder.pre.appendChild(empty?elt("span",""):zeroWidthElement(cm.display.measure))),builder.pre.firstChild||lineIsHidden(cm.doc,realLine)||builder.pre.appendChild(document.createTextNode(""));var order;if(measure&&ie&&(order=getOrder(line))){var l=order.length-1;order[l].from==order[l].to&&--l;var last=order[l],prev=order[l-1];if(last.from+1==last.to&&prev&&last.level<prev.level){var span=measure[builder.pos-1];span&&span.parentNode.insertBefore(span.measureRight=zeroWidthElement(cm.display.measure),span.nextSibling)}}return signal(cm,"renderLine",cm,realLine,builder.pre),builder.pre}function buildToken(builder,text,style,startStyle,endStyle){if(text){if(tokenSpecialChars.test(text))for(var content=document.createDocumentFragment(),pos=0;;){tokenSpecialChars.lastIndex=pos;var m=tokenSpecialChars.exec(text),skipped=m?m.index-pos:text.length-pos;if(skipped&&(content.appendChild(document.createTextNode(text.slice(pos,pos+skipped))),builder.col+=skipped),!m)break;if(pos+=skipped+1,"	"==m[0]){var tabSize=builder.cm.options.tabSize,tabWidth=tabSize-builder.col%tabSize;content.appendChild(elt("span",spaceStr(tabWidth),"cm-tab")),builder.col+=tabWidth}else{var token=elt("span","","cm-invalidchar");token.title="\\u"+m[0].charCodeAt(0).toString(16),content.appendChild(token),builder.col+=1}}else{builder.col+=text.length;var content=document.createTextNode(text)}if(style||startStyle||endStyle||builder.measure){var fullStyle=style||"";return startStyle&&(fullStyle+=startStyle),endStyle&&(fullStyle+=endStyle),builder.pre.appendChild(elt("span",[content],fullStyle))}builder.pre.appendChild(content)}}function buildTokenMeasure(builder,text,style,startStyle,endStyle){for(var wrapping=builder.cm.options.lineWrapping,i=0;i<text.length;++i){var ch=text.charAt(i),start=0==i;ch>=""&&"">ch&&i<text.length-1?(ch=text.slice(i,i+2),++i):i&&wrapping&&spanAffectsWrapping(text,i)&&builder.pre.appendChild(elt("wbr"));var span=builder.measure[builder.pos]=buildToken(builder,ch,style,start&&startStyle,i==text.length-1&&endStyle);ie&&wrapping&&" "==ch&&i&&!/\s/.test(text.charAt(i-1))&&i<text.length-1&&!/\s/.test(text.charAt(i+1))&&(span.style.whiteSpace="normal"),builder.pos+=ch.length}text.length&&(builder.measuredSomething=!0)}function buildTokenSplitSpaces(inner){function split(old){for(var out=" ",i=0;i<old.length-2;++i)out+=i%2?" ":"";return out+=" "}return function(builder,text,style,startStyle,endStyle){return inner(builder,text.replace(/ {3,}/,split),style,startStyle,endStyle)}}function buildCollapsedSpan(builder,size,widget){widget&&(builder.display||(widget=widget.cloneNode(!0)),builder.measure&&(builder.measure[builder.pos]=size?widget:builder.pre.appendChild(zeroWidthElement(builder.cm.display.measure)),builder.measuredSomething=!0),builder.pre.appendChild(widget)),builder.pos+=size}function insertLineContent(line,builder,styles){var spans=line.markedSpans,allText=line.text,at=0;if(spans)for(var style,spanStyle,spanEndStyle,spanStartStyle,collapsed,len=allText.length,pos=0,i=1,text="",nextChange=0;;){if(nextChange==pos){spanStyle=spanEndStyle=spanStartStyle="",collapsed=null,nextChange=1/0;for(var foundBookmark=null,j=0;j<spans.length;++j){var sp=spans[j],m=sp.marker;sp.from<=pos&&(null==sp.to||sp.to>pos)?(null!=sp.to&&nextChange>sp.to&&(nextChange=sp.to,spanEndStyle=""),m.className&&(spanStyle+=" "+m.className),m.startStyle&&sp.from==pos&&(spanStartStyle+=" "+m.startStyle),m.endStyle&&sp.to==nextChange&&(spanEndStyle+=" "+m.endStyle),m.collapsed&&(!collapsed||collapsed.marker.size<m.size)&&(collapsed=sp)):sp.from>pos&&nextChange>sp.from&&(nextChange=sp.from),"bookmark"==m.type&&sp.from==pos&&m.replacedWith&&(foundBookmark=m.replacedWith)}if(collapsed&&(collapsed.from||0)==pos&&(buildCollapsedSpan(builder,(null==collapsed.to?len:collapsed.to)-pos,null!=collapsed.from&&collapsed.marker.replacedWith),null==collapsed.to))return collapsed.marker.find();foundBookmark&&!collapsed&&buildCollapsedSpan(builder,0,foundBookmark)}if(pos>=len)break;for(var upto=Math.min(len,nextChange);;){if(text){var end=pos+text.length;if(!collapsed){var tokenText=end>upto?text.slice(0,upto-pos):text;builder.addToken(builder,tokenText,style?style+spanStyle:spanStyle,spanStartStyle,pos+tokenText.length==nextChange?spanEndStyle:"")}if(end>=upto){text=text.slice(upto-pos),pos=upto;break}pos=end,spanStartStyle=""}text=allText.slice(at,at=styles[i++]),style=styleToClass(styles[i++])}}else for(var i=1;i<styles.length;i+=2)builder.addToken(builder,allText.slice(at,at=styles[i]),styleToClass(styles[i+1]))}function updateDoc(doc,change,markedSpans,selAfter,estimateHeight){function spansFor(n){return markedSpans?markedSpans[n]:null}function update(line,text,spans){updateLine(line,text,spans,estimateHeight),signalLater(line,"change",line,change)}var from=change.from,to=change.to,text=change.text,firstLine=getLine(doc,from.line),lastLine=getLine(doc,to.line),lastText=lst(text),lastSpans=spansFor(text.length-1),nlines=to.line-from.line;if(0==from.ch&&0==to.ch&&""==lastText){for(var i=0,e=text.length-1,added=[];e>i;++i)added.push(makeLine(text[i],spansFor(i),estimateHeight));update(lastLine,lastLine.text,lastSpans),nlines&&doc.remove(from.line,nlines),added.length&&doc.insert(from.line,added)}else if(firstLine==lastLine)if(1==text.length)update(firstLine,firstLine.text.slice(0,from.ch)+lastText+firstLine.text.slice(to.ch),lastSpans);
else{for(var added=[],i=1,e=text.length-1;e>i;++i)added.push(makeLine(text[i],spansFor(i),estimateHeight));added.push(makeLine(lastText+firstLine.text.slice(to.ch),lastSpans,estimateHeight)),update(firstLine,firstLine.text.slice(0,from.ch)+text[0],spansFor(0)),doc.insert(from.line+1,added)}else if(1==text.length)update(firstLine,firstLine.text.slice(0,from.ch)+text[0]+lastLine.text.slice(to.ch),spansFor(0)),doc.remove(from.line+1,nlines);else{update(firstLine,firstLine.text.slice(0,from.ch)+text[0],spansFor(0)),update(lastLine,lastText+lastLine.text.slice(to.ch),lastSpans);for(var i=1,e=text.length-1,added=[];e>i;++i)added.push(makeLine(text[i],spansFor(i),estimateHeight));nlines>1&&doc.remove(from.line+1,nlines-1),doc.insert(from.line+1,added)}signalLater(doc,"change",doc,change),setSelection(doc,selAfter.anchor,selAfter.head,null,!0)}function LeafChunk(lines){this.lines=lines,this.parent=null;for(var i=0,e=lines.length,height=0;e>i;++i)lines[i].parent=this,height+=lines[i].height;this.height=height}function BranchChunk(children){this.children=children;for(var size=0,height=0,i=0,e=children.length;e>i;++i){var ch=children[i];size+=ch.chunkSize(),height+=ch.height,ch.parent=this}this.size=size,this.height=height,this.parent=null}function linkedDocs(doc,f,sharedHistOnly){function propagate(doc,skip,sharedHist){if(doc.linked)for(var i=0;i<doc.linked.length;++i){var rel=doc.linked[i];if(rel.doc!=skip){var shared=sharedHist&&rel.sharedHist;(!sharedHistOnly||shared)&&(f(rel.doc,shared),propagate(rel.doc,doc,shared))}}}propagate(doc,null,!0)}function attachDoc(cm,doc){if(doc.cm)throw new Error("This document is already in use.");cm.doc=doc,doc.cm=cm,estimateLineHeights(cm),loadMode(cm),cm.options.lineWrapping||computeMaxLength(cm),cm.options.mode=doc.modeOption,regChange(cm)}function getLine(chunk,n){for(n-=chunk.first;!chunk.lines;)for(var i=0;;++i){var child=chunk.children[i],sz=child.chunkSize();if(sz>n){chunk=child;break}n-=sz}return chunk.lines[n]}function getBetween(doc,start,end){var out=[],n=start.line;return doc.iter(start.line,end.line+1,function(line){var text=line.text;n==end.line&&(text=text.slice(0,end.ch)),n==start.line&&(text=text.slice(start.ch)),out.push(text),++n}),out}function getLines(doc,from,to){var out=[];return doc.iter(from,to,function(line){out.push(line.text)}),out}function updateLineHeight(line,height){for(var diff=height-line.height,n=line;n;n=n.parent)n.height+=diff}function lineNo(line){if(null==line.parent)return null;for(var cur=line.parent,no=indexOf(cur.lines,line),chunk=cur.parent;chunk;cur=chunk,chunk=chunk.parent)for(var i=0;chunk.children[i]!=cur;++i)no+=chunk.children[i].chunkSize();return no+cur.first}function lineAtHeight(chunk,h){var n=chunk.first;outer:do{for(var i=0,e=chunk.children.length;e>i;++i){var child=chunk.children[i],ch=child.height;if(ch>h){chunk=child;continue outer}h-=ch,n+=child.chunkSize()}return n}while(!chunk.lines);for(var i=0,e=chunk.lines.length;e>i;++i){var line=chunk.lines[i],lh=line.height;if(lh>h)break;h-=lh}return n+i}function heightAtLine(cm,lineObj){lineObj=visualLine(cm.doc,lineObj);for(var h=0,chunk=lineObj.parent,i=0;i<chunk.lines.length;++i){var line=chunk.lines[i];if(line==lineObj)break;h+=line.height}for(var p=chunk.parent;p;chunk=p,p=chunk.parent)for(var i=0;i<p.children.length;++i){var cur=p.children[i];if(cur==chunk)break;h+=cur.height}return h}function getOrder(line){var order=line.order;return null==order&&(order=line.order=bidiOrdering(line.text)),order}function makeHistory(startGen){return{done:[],undone:[],undoDepth:1/0,lastTime:0,lastOp:null,lastOrigin:null,generation:startGen||1,maxGeneration:startGen||1}}function attachLocalSpans(doc,change,from,to){var existing=change["spans_"+doc.id],n=0;doc.iter(Math.max(doc.first,from),Math.min(doc.first+doc.size,to),function(line){line.markedSpans&&((existing||(existing=change["spans_"+doc.id]={}))[n]=line.markedSpans),++n})}function historyChangeFromChange(doc,change){var histChange={from:change.from,to:changeEnd(change),text:getBetween(doc,change.from,change.to)};return attachLocalSpans(doc,histChange,change.from.line,change.to.line+1),linkedDocs(doc,function(doc){attachLocalSpans(doc,histChange,change.from.line,change.to.line+1)},!0),histChange}function addToHistory(doc,change,selAfter,opId){var hist=doc.history;hist.undone.length=0;var time=+new Date,cur=lst(hist.done);if(cur&&(hist.lastOp==opId||hist.lastOrigin==change.origin&&change.origin&&("+"==change.origin.charAt(0)&&doc.cm&&hist.lastTime>time-doc.cm.options.historyEventDelay||"*"==change.origin.charAt(0)))){var last=lst(cur.changes);posEq(change.from,change.to)&&posEq(change.from,last.to)?last.to=changeEnd(change):cur.changes.push(historyChangeFromChange(doc,change)),cur.anchorAfter=selAfter.anchor,cur.headAfter=selAfter.head}else for(cur={changes:[historyChangeFromChange(doc,change)],generation:hist.generation,anchorBefore:doc.sel.anchor,headBefore:doc.sel.head,anchorAfter:selAfter.anchor,headAfter:selAfter.head},hist.done.push(cur),hist.generation=++hist.maxGeneration;hist.done.length>hist.undoDepth;)hist.done.shift();hist.lastTime=time,hist.lastOp=opId,hist.lastOrigin=change.origin}function removeClearedSpans(spans){if(!spans)return null;for(var out,i=0;i<spans.length;++i)spans[i].marker.explicitlyCleared?out||(out=spans.slice(0,i)):out&&out.push(spans[i]);return out?out.length?out:null:spans}function getOldSpans(doc,change){var found=change["spans_"+doc.id];if(!found)return null;for(var i=0,nw=[];i<change.text.length;++i)nw.push(removeClearedSpans(found[i]));return nw}function copyHistoryArray(events,newGroup){for(var i=0,copy=[];i<events.length;++i){var event=events[i],changes=event.changes,newChanges=[];copy.push({changes:newChanges,anchorBefore:event.anchorBefore,headBefore:event.headBefore,anchorAfter:event.anchorAfter,headAfter:event.headAfter});for(var j=0;j<changes.length;++j){var m,change=changes[j];if(newChanges.push({from:change.from,to:change.to,text:change.text}),newGroup)for(var prop in change)(m=prop.match(/^spans_(\d+)$/))&&indexOf(newGroup,Number(m[1]))>-1&&(lst(newChanges)[prop]=change[prop],delete change[prop])}}return copy}function rebaseHistSel(pos,from,to,diff){to<pos.line?pos.line+=diff:from<pos.line&&(pos.line=from,pos.ch=0)}function rebaseHistArray(array,from,to,diff){for(var i=0;i<array.length;++i){for(var sub=array[i],ok=!0,j=0;j<sub.changes.length;++j){var cur=sub.changes[j];if(sub.copied||(cur.from=copyPos(cur.from),cur.to=copyPos(cur.to)),to<cur.from.line)cur.from.line+=diff,cur.to.line+=diff;else if(from<=cur.to.line){ok=!1;break}}sub.copied||(sub.anchorBefore=copyPos(sub.anchorBefore),sub.headBefore=copyPos(sub.headBefore),sub.anchorAfter=copyPos(sub.anchorAfter),sub.readAfter=copyPos(sub.headAfter),sub.copied=!0),ok?(rebaseHistSel(sub.anchorBefore),rebaseHistSel(sub.headBefore),rebaseHistSel(sub.anchorAfter),rebaseHistSel(sub.headAfter)):(array.splice(0,i+1),i=0)}}function rebaseHist(hist,change){var from=change.from.line,to=change.to.line,diff=change.text.length-(to-from)-1;rebaseHistArray(hist.done,from,to,diff),rebaseHistArray(hist.undone,from,to,diff)}function stopMethod(){e_stop(this)}function addStop(event){return event.stop||(event.stop=stopMethod),event}function e_preventDefault(e){e.preventDefault?e.preventDefault():e.returnValue=!1}function e_stopPropagation(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}function e_defaultPrevented(e){return null!=e.defaultPrevented?e.defaultPrevented:0==e.returnValue}function e_stop(e){e_preventDefault(e),e_stopPropagation(e)}function e_target(e){return e.target||e.srcElement}function e_button(e){var b=e.which;return null==b&&(1&e.button?b=1:2&e.button?b=3:4&e.button&&(b=2)),mac&&e.ctrlKey&&1==b&&(b=3),b}function on(emitter,type,f){if(emitter.addEventListener)emitter.addEventListener(type,f,!1);else if(emitter.attachEvent)emitter.attachEvent("on"+type,f);else{var map=emitter._handlers||(emitter._handlers={}),arr=map[type]||(map[type]=[]);arr.push(f)}}function off(emitter,type,f){if(emitter.removeEventListener)emitter.removeEventListener(type,f,!1);else if(emitter.detachEvent)emitter.detachEvent("on"+type,f);else{var arr=emitter._handlers&&emitter._handlers[type];if(!arr)return;for(var i=0;i<arr.length;++i)if(arr[i]==f){arr.splice(i,1);break}}}function signal(emitter,type){var arr=emitter._handlers&&emitter._handlers[type];if(arr)for(var args=Array.prototype.slice.call(arguments,2),i=0;i<arr.length;++i)arr[i].apply(null,args)}function signalLater(emitter,type){function bnd(f){return function(){f.apply(null,args)}}var arr=emitter._handlers&&emitter._handlers[type];if(arr){var args=Array.prototype.slice.call(arguments,2);delayedCallbacks||(++delayedCallbackDepth,delayedCallbacks=[],setTimeout(fireDelayed,0));for(var i=0;i<arr.length;++i)delayedCallbacks.push(bnd(arr[i]))}}function signalDOMEvent(cm,e){return signal(cm,e.type,cm,e),e_defaultPrevented(e)}function fireDelayed(){--delayedCallbackDepth;var delayed=delayedCallbacks;delayedCallbacks=null;for(var i=0;i<delayed.length;++i)delayed[i]()}function hasHandler(emitter,type){var arr=emitter._handlers&&emitter._handlers[type];return arr&&arr.length>0}function Delayed(){this.id=null}function countColumn(string,end,tabSize,startIndex,startValue){null==end&&(end=string.search(/[^\s\u00a0]/),-1==end&&(end=string.length));for(var i=startIndex||0,n=startValue||0;end>i;++i)"	"==string.charAt(i)?n+=tabSize-n%tabSize:++n;return n}function spaceStr(n){for(;spaceStrs.length<=n;)spaceStrs.push(lst(spaceStrs)+" ");return spaceStrs[n]}function lst(arr){return arr[arr.length-1]}function selectInput(node){if(ios)node.selectionStart=0,node.selectionEnd=node.value.length;else try{node.select()}catch(_e){}}function indexOf(collection,elt){if(collection.indexOf)return collection.indexOf(elt);for(var i=0,e=collection.length;e>i;++i)if(collection[i]==elt)return i;return-1}function createObj(base,props){function Obj(){}Obj.prototype=base;var inst=new Obj;return props&&copyObj(props,inst),inst}function copyObj(obj,target){target||(target={});for(var prop in obj)obj.hasOwnProperty(prop)&&(target[prop]=obj[prop]);return target}function emptyArray(size){for(var a=[],i=0;size>i;++i)a.push(void 0);return a}function bind(f){var args=Array.prototype.slice.call(arguments,1);return function(){return f.apply(null,args)}}function isWordChar(ch){return/\w/.test(ch)||ch>""&&(ch.toUpperCase()!=ch.toLowerCase()||nonASCIISingleCaseWordChar.test(ch))}function isEmpty(obj){for(var n in obj)if(obj.hasOwnProperty(n)&&obj[n])return!1;return!0}function elt(tag,content,className,style){var e=document.createElement(tag);if(className&&(e.className=className),style&&(e.style.cssText=style),"string"==typeof content)setTextContent(e,content);else if(content)for(var i=0;i<content.length;++i)e.appendChild(content[i]);return e}function removeChildren(e){for(var count=e.childNodes.length;count>0;--count)e.removeChild(e.firstChild);return e}function removeChildrenAndAdd(parent,e){return removeChildren(parent).appendChild(e)}function setTextContent(e,str){ie_lt9?(e.innerHTML="",e.appendChild(document.createTextNode(str))):e.textContent=str}function getRect(node){return node.getBoundingClientRect()}function spanAffectsWrapping(){return!1}function scrollbarWidth(measure){if(null!=knownScrollbarWidth)return knownScrollbarWidth;var test=elt("div",null,null,"width: 50px; height: 50px; overflow-x: scroll");return removeChildrenAndAdd(measure,test),test.offsetWidth&&(knownScrollbarWidth=test.offsetHeight-test.clientHeight),knownScrollbarWidth||0}function zeroWidthElement(measure){if(null==zwspSupported){var test=elt("span","");removeChildrenAndAdd(measure,elt("span",[test,document.createTextNode("x")])),0!=measure.firstChild.offsetHeight&&(zwspSupported=test.offsetWidth<=1&&test.offsetHeight>2&&!ie_lt8)}return zwspSupported?elt("span",""):elt("span","",null,"display: inline-block; width: 1px; margin-right: -1px")}function iterateBidiSections(order,from,to,f){if(!order)return f(from,to,"ltr");for(var i=0;i<order.length;++i){var part=order[i];(part.from<to&&part.to>from||from==to&&part.to==from)&&f(Math.max(part.from,from),Math.min(part.to,to),1==part.level?"rtl":"ltr")}}function bidiLeft(part){return part.level%2?part.to:part.from}function bidiRight(part){return part.level%2?part.from:part.to}function lineLeft(line){var order=getOrder(line);return order?bidiLeft(order[0]):0}function lineRight(line){var order=getOrder(line);return order?bidiRight(lst(order)):line.text.length}function lineStart(cm,lineN){var line=getLine(cm.doc,lineN),visual=visualLine(cm.doc,line);visual!=line&&(lineN=lineNo(visual));var order=getOrder(visual),ch=order?order[0].level%2?lineRight(visual):lineLeft(visual):0;return Pos(lineN,ch)}function lineEnd(cm,lineN){for(var merged,line;merged=collapsedSpanAtEnd(line=getLine(cm.doc,lineN));)lineN=merged.find().to.line;var order=getOrder(line),ch=order?order[0].level%2?lineLeft(line):lineRight(line):line.text.length;return Pos(lineN,ch)}function compareBidiLevel(order,a,b){var linedir=order[0].level;return a==linedir?!0:b==linedir?!1:b>a}function getBidiPartAt(order,pos){for(var found,i=0;i<order.length;++i){var cur=order[i];if(cur.from<pos&&cur.to>pos)return bidiOther=null,i;if(cur.from==pos||cur.to==pos){if(null!=found)return compareBidiLevel(order,cur.level,order[found].level)?(bidiOther=found,i):(bidiOther=i,found);found=i}}return bidiOther=null,found}function moveInLine(line,pos,dir,byUnit){if(!byUnit)return pos+dir;do pos+=dir;while(pos>0&&isExtendingChar.test(line.text.charAt(pos)));return pos}function moveVisually(line,start,dir,byUnit){var bidi=getOrder(line);if(!bidi)return moveLogically(line,start,dir,byUnit);for(var pos=getBidiPartAt(bidi,start),part=bidi[pos],target=moveInLine(line,start,part.level%2?-dir:dir,byUnit);;){if(target>part.from&&target<part.to)return target;if(target==part.from||target==part.to)return getBidiPartAt(bidi,target)==pos?target:(part=bidi[pos+=dir],dir>0==part.level%2?part.to:part.from);if(part=bidi[pos+=dir],!part)return null;target=dir>0==part.level%2?moveInLine(line,part.to,-1,byUnit):moveInLine(line,part.from,1,byUnit)}}function moveLogically(line,start,dir,byUnit){var target=start+dir;if(byUnit)for(;target>0&&isExtendingChar.test(line.text.charAt(target));)target+=dir;return 0>target||target>line.text.length?null:target}var gecko=/gecko\/\d/i.test(navigator.userAgent),ie=/MSIE \d/.test(navigator.userAgent),ie_lt8=ie&&(null==document.documentMode||document.documentMode<8),ie_lt9=ie&&(null==document.documentMode||document.documentMode<9),webkit=/WebKit\//.test(navigator.userAgent),qtwebkit=webkit&&/Qt\/\d+\.\d+/.test(navigator.userAgent),chrome=/Chrome\//.test(navigator.userAgent),opera=/Opera\//.test(navigator.userAgent),safari=/Apple Computer/.test(navigator.vendor),khtml=/KHTML\//.test(navigator.userAgent),mac_geLion=/Mac OS X 1\d\D([7-9]|\d\d)\D/.test(navigator.userAgent),mac_geMountainLion=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(navigator.userAgent),phantom=/PhantomJS/.test(navigator.userAgent),ios=/AppleWebKit/.test(navigator.userAgent)&&/Mobile\/\w+/.test(navigator.userAgent),mobile=ios||/Android|webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(navigator.userAgent),mac=ios||/Mac/.test(navigator.platform),windows=/windows/i.test(navigator.platform),opera_version=opera&&navigator.userAgent.match(/Version\/(\d*\.\d*)/);opera_version&&(opera_version=Number(opera_version[1]));var measureText,lastClick,lastDoubleClick,flipCtrlCmd=mac&&(qtwebkit||opera&&(null==opera_version||12.11>opera_version)),captureMiddleClick=gecko||ie&&!ie_lt9,sawReadOnlySpans=!1,sawCollapsedSpans=!1,nextOpId=0,lastDrop=0,wheelSamples=0,wheelPixelsPerUnit=null;ie?wheelPixelsPerUnit=-.53:gecko?wheelPixelsPerUnit=15:chrome?wheelPixelsPerUnit=-.7:safari&&(wheelPixelsPerUnit=-1/3);var maybeTransition,detectingSelectAll,lastStoppedKey=null,changeEnd=CodeMirror.changeEnd=function(change){return change.text?Pos(change.from.line+change.text.length-1,lst(change.text).length+(1==change.text.length?change.from.ch:0)):change.to};CodeMirror.Pos=Pos,CodeMirror.prototype={constructor:CodeMirror,focus:function(){window.focus(),focusInput(this),onFocus(this),fastPoll(this)},setOption:function(option,value){var options=this.options,old=options[option];(options[option]!=value||"mode"==option)&&(options[option]=value,optionHandlers.hasOwnProperty(option)&&operation(this,optionHandlers[option])(this,value,old))},getOption:function(option){return this.options[option]},getDoc:function(){return this.doc},addKeyMap:function(map,bottom){this.state.keyMaps[bottom?"push":"unshift"](map)},removeKeyMap:function(map){for(var maps=this.state.keyMaps,i=0;i<maps.length;++i)if(("string"==typeof map?maps[i].name:maps[i])==map)return maps.splice(i,1),!0},addOverlay:operation(null,function(spec,options){var mode=spec.token?spec:CodeMirror.getMode(this.options,spec);if(mode.startState)throw new Error("Overlays may not be stateful.");this.state.overlays.push({mode:mode,modeSpec:spec,opaque:options&&options.opaque}),this.state.modeGen++,regChange(this)}),removeOverlay:operation(null,function(spec){for(var overlays=this.state.overlays,i=0;i<overlays.length;++i){var cur=overlays[i].modeSpec;if(cur==spec||"string"==typeof spec&&cur.name==spec)return overlays.splice(i,1),this.state.modeGen++,void regChange(this)}}),indentLine:operation(null,function(n,dir,aggressive){"string"!=typeof dir&&"number"!=typeof dir&&(dir=null==dir?this.options.smartIndent?"smart":"prev":dir?"add":"subtract"),isLine(this.doc,n)&&indentLine(this,n,dir,aggressive)}),indentSelection:operation(null,function(how){var sel=this.doc.sel;if(posEq(sel.from,sel.to))return indentLine(this,sel.from.line,how);for(var e=sel.to.line-(sel.to.ch?0:1),i=sel.from.line;e>=i;++i)indentLine(this,i,how)}),getTokenAt:function(pos,precise){var doc=this.doc;pos=clipPos(doc,pos);for(var state=getStateBefore(this,pos.line,precise),mode=this.doc.mode,line=getLine(doc,pos.line),stream=new StringStream(line.text,this.options.tabSize);stream.pos<pos.ch&&!stream.eol();){stream.start=stream.pos;var style=mode.token(stream,state)}return{start:stream.start,end:stream.pos,string:stream.current(),className:style||null,type:style||null,state:state}},getTokenTypeAt:function(pos){pos=clipPos(this.doc,pos);for(var styles=getLineStyles(this,getLine(this.doc,pos.line)),before=0,after=(styles.length-1)/2,ch=pos.ch;;){var mid=before+after>>1;if((mid?styles[2*mid-1]:0)>=ch)after=mid;else{if(!(styles[2*mid+1]<ch))return styles[2*mid+2];before=mid+1}}},getStateAfter:function(line,precise){var doc=this.doc;return line=clipLine(doc,null==line?doc.first+doc.size-1:line),getStateBefore(this,line+1,precise)},cursorCoords:function(start,mode){var pos,sel=this.doc.sel;return pos=null==start?sel.head:"object"==typeof start?clipPos(this.doc,start):start?sel.from:sel.to,cursorCoords(this,pos,mode||"page")},charCoords:function(pos,mode){return charCoords(this,clipPos(this.doc,pos),mode||"page")},coordsChar:function(coords,mode){return coords=fromCoordSystem(this,coords,mode||"page"),coordsChar(this,coords.left,coords.top)},lineAtHeight:function(height,mode){return height=fromCoordSystem(this,{top:height,left:0},mode||"page").top,lineAtHeight(this.doc,height+this.display.viewOffset)},heightAtLine:function(line,mode){var end=!1,last=this.doc.first+this.doc.size-1;line<this.doc.first?line=this.doc.first:line>last&&(line=last,end=!0);var lineObj=getLine(this.doc,line);return intoCoordSystem(this,getLine(this.doc,line),{top:0,left:0},mode||"page").top+(end?lineObj.height:0)},defaultTextHeight:function(){return textHeight(this.display)},defaultCharWidth:function(){return charWidth(this.display)},setGutterMarker:operation(null,function(line,gutterID,value){return changeLine(this,line,function(line){var markers=line.gutterMarkers||(line.gutterMarkers={});return markers[gutterID]=value,!value&&isEmpty(markers)&&(line.gutterMarkers=null),!0})}),clearGutter:operation(null,function(gutterID){var cm=this,doc=cm.doc,i=doc.first;doc.iter(function(line){line.gutterMarkers&&line.gutterMarkers[gutterID]&&(line.gutterMarkers[gutterID]=null,regChange(cm,i,i+1),isEmpty(line.gutterMarkers)&&(line.gutterMarkers=null)),++i})}),addLineClass:operation(null,function(handle,where,cls){return changeLine(this,handle,function(line){var prop="text"==where?"textClass":"background"==where?"bgClass":"wrapClass";if(line[prop]){if(new RegExp("(?:^|\\s)"+cls+"(?:$|\\s)").test(line[prop]))return!1;line[prop]+=" "+cls}else line[prop]=cls;return!0})}),removeLineClass:operation(null,function(handle,where,cls){return changeLine(this,handle,function(line){var prop="text"==where?"textClass":"background"==where?"bgClass":"wrapClass",cur=line[prop];if(!cur)return!1;if(null==cls)line[prop]=null;else{var found=cur.match(new RegExp("(?:^|\\s+)"+cls+"(?:$|\\s+)"));if(!found)return!1;var end=found.index+found[0].length;line[prop]=cur.slice(0,found.index)+(found.index&&end!=cur.length?" ":"")+cur.slice(end)||null}return!0})}),addLineWidget:operation(null,function(handle,node,options){return addLineWidget(this,handle,node,options)}),removeLineWidget:function(widget){widget.clear()},lineInfo:function(line){if("number"==typeof line){if(!isLine(this.doc,line))return null;var n=line;if(line=getLine(this.doc,line),!line)return null}else{var n=lineNo(line);if(null==n)return null}return{line:n,handle:line,text:line.text,gutterMarkers:line.gutterMarkers,textClass:line.textClass,bgClass:line.bgClass,wrapClass:line.wrapClass,widgets:line.widgets}},getViewport:function(){return{from:this.display.showingFrom,to:this.display.showingTo}},addWidget:function(pos,node,scroll,vert,horiz){var display=this.display;pos=cursorCoords(this,clipPos(this.doc,pos));var top=pos.bottom,left=pos.left;if(node.style.position="absolute",display.sizer.appendChild(node),"over"==vert)top=pos.top;else if("above"==vert||"near"==vert){var vspace=Math.max(display.wrapper.clientHeight,this.doc.height),hspace=Math.max(display.sizer.clientWidth,display.lineSpace.clientWidth);("above"==vert||pos.bottom+node.offsetHeight>vspace)&&pos.top>node.offsetHeight?top=pos.top-node.offsetHeight:pos.bottom+node.offsetHeight<=vspace&&(top=pos.bottom),left+node.offsetWidth>hspace&&(left=hspace-node.offsetWidth)}node.style.top=top+"px",node.style.left=node.style.right="","right"==horiz?(left=display.sizer.clientWidth-node.offsetWidth,node.style.right="0px"):("left"==horiz?left=0:"middle"==horiz&&(left=(display.sizer.clientWidth-node.offsetWidth)/2),node.style.left=left+"px"),scroll&&scrollIntoView(this,left,top,left+node.offsetWidth,top+node.offsetHeight)},triggerOnKeyDown:operation(null,onKeyDown),execCommand:function(cmd){return commands[cmd](this)},findPosH:function(from,amount,unit,visually){var dir=1;0>amount&&(dir=-1,amount=-amount);for(var i=0,cur=clipPos(this.doc,from);amount>i&&(cur=findPosH(this.doc,cur,dir,unit,visually),!cur.hitSide);++i);return cur},moveH:operation(null,function(dir,unit){var pos,sel=this.doc.sel;pos=sel.shift||sel.extend||posEq(sel.from,sel.to)?findPosH(this.doc,sel.head,dir,unit,this.options.rtlMoveVisually):0>dir?sel.from:sel.to,extendSelection(this.doc,pos,pos,dir)}),deleteH:operation(null,function(dir,unit){var sel=this.doc.sel;posEq(sel.from,sel.to)?replaceRange(this.doc,"",sel.from,findPosH(this.doc,sel.head,dir,unit,!1),"+delete"):replaceRange(this.doc,"",sel.from,sel.to,"+delete"),this.curOp.userSelChange=!0}),findPosV:function(from,amount,unit,goalColumn){var dir=1,x=goalColumn;0>amount&&(dir=-1,amount=-amount);for(var i=0,cur=clipPos(this.doc,from);amount>i;++i){var coords=cursorCoords(this,cur,"div");if(null==x?x=coords.left:coords.left=x,cur=findPosV(this,coords,dir,unit),cur.hitSide)break}return cur},moveV:operation(null,function(dir,unit){var sel=this.doc.sel,pos=cursorCoords(this,sel.head,"div");null!=sel.goalColumn&&(pos.left=sel.goalColumn);var target=findPosV(this,pos,dir,unit);"page"==unit&&addToScrollPos(this,0,charCoords(this,target,"div").top-pos.top),extendSelection(this.doc,target,target,dir),sel.goalColumn=pos.left}),toggleOverwrite:function(value){(null==value||value!=this.state.overwrite)&&((this.state.overwrite=!this.state.overwrite)?this.display.cursor.className+=" CodeMirror-overwrite":this.display.cursor.className=this.display.cursor.className.replace(" CodeMirror-overwrite",""))},hasFocus:function(){return this.state.focused},scrollTo:operation(null,function(x,y){updateScrollPos(this,x,y)}),getScrollInfo:function(){var scroller=this.display.scroller,co=scrollerCutOff;return{left:scroller.scrollLeft,top:scroller.scrollTop,height:scroller.scrollHeight-co,width:scroller.scrollWidth-co,clientHeight:scroller.clientHeight-co,clientWidth:scroller.clientWidth-co}},scrollIntoView:operation(null,function(pos,margin){"number"==typeof pos&&(pos=Pos(pos,0)),margin||(margin=0);var coords=pos;pos&&null==pos.line||(this.curOp.scrollToPos=pos?clipPos(this.doc,pos):this.doc.sel.head,this.curOp.scrollToPosMargin=margin,coords=cursorCoords(this,this.curOp.scrollToPos));var sPos=calculateScrollPos(this,coords.left,coords.top-margin,coords.right,coords.bottom+margin);updateScrollPos(this,sPos.scrollLeft,sPos.scrollTop)}),setSize:function(width,height){function interpret(val){return"number"==typeof val||/^\d+$/.test(String(val))?val+"px":val}null!=width&&(this.display.wrapper.style.width=interpret(width)),null!=height&&(this.display.wrapper.style.height=interpret(height)),this.refresh()},on:function(type,f){on(this,type,f)},off:function(type,f){off(this,type,f)},operation:function(f){return runInOp(this,f)},refresh:operation(null,function(){clearCaches(this),updateScrollPos(this,this.doc.scrollLeft,this.doc.scrollTop),regChange(this)}),swapDoc:operation(null,function(doc){var old=this.doc;return old.cm=null,attachDoc(this,doc),clearCaches(this),resetInput(this,!0),updateScrollPos(this,doc.scrollLeft,doc.scrollTop),old}),getInputField:function(){return this.display.input},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}};var optionHandlers=CodeMirror.optionHandlers={},defaults=CodeMirror.defaults={},Init=CodeMirror.Init={toString:function(){return"CodeMirror.Init"}};option("value","",function(cm,val){cm.setValue(val)},!0),option("mode",null,function(cm,val){cm.doc.modeOption=val,loadMode(cm)},!0),option("indentUnit",2,loadMode,!0),option("indentWithTabs",!1),option("smartIndent",!0),option("tabSize",4,function(cm){loadMode(cm),clearCaches(cm),regChange(cm)},!0),option("electricChars",!0),option("rtlMoveVisually",!windows),option("theme","default",function(cm){themeChanged(cm),guttersChanged(cm)},!0),option("keyMap","default",keyMapChanged),option("extraKeys",null),option("onKeyEvent",null),option("onDragEvent",null),option("lineWrapping",!1,wrappingChanged,!0),option("gutters",[],function(cm){setGuttersForLineNumbers(cm.options),guttersChanged(cm)},!0),option("fixedGutter",!0,function(cm,val){cm.display.gutters.style.left=val?compensateForHScroll(cm.display)+"px":"0",cm.refresh()},!0),option("coverGutterNextToScrollbar",!1,updateScrollbars,!0),option("lineNumbers",!1,function(cm){setGuttersForLineNumbers(cm.options),guttersChanged(cm)},!0),option("firstLineNumber",1,guttersChanged,!0),option("lineNumberFormatter",function(integer){return integer},guttersChanged,!0),option("showCursorWhenSelecting",!1,updateSelection,!0),option("readOnly",!1,function(cm,val){"nocursor"==val?(onBlur(cm),cm.display.input.blur()):val||resetInput(cm,!0)}),option("dragDrop",!0),option("cursorBlinkRate",530),option("cursorScrollMargin",0),option("cursorHeight",1),option("workTime",100),option("workDelay",100),option("flattenSpans",!0),option("pollInterval",100),option("undoDepth",40,function(cm,val){cm.doc.history.undoDepth=val}),option("historyEventDelay",500),option("viewportMargin",10,function(cm){cm.refresh()},!0),option("maxHighlightLength",1e4,function(cm){loadMode(cm),cm.refresh()},!0),option("moveInputWithCursor",!0,function(cm,val){val||(cm.display.inputDiv.style.top=cm.display.inputDiv.style.left=0)}),option("tabindex",null,function(cm,val){cm.display.input.tabIndex=val||""}),option("autofocus",null);var modes=CodeMirror.modes={},mimeModes=CodeMirror.mimeModes={};CodeMirror.defineMode=function(name,mode){if(CodeMirror.defaults.mode||"null"==name||(CodeMirror.defaults.mode=name),arguments.length>2){mode.dependencies=[];for(var i=2;i<arguments.length;++i)mode.dependencies.push(arguments[i])}modes[name]=mode},CodeMirror.defineMIME=function(mime,spec){mimeModes[mime]=spec},CodeMirror.resolveMode=function(spec){if("string"==typeof spec&&mimeModes.hasOwnProperty(spec))spec=mimeModes[spec];else if(spec&&"string"==typeof spec.name&&mimeModes.hasOwnProperty(spec.name)){var found=mimeModes[spec.name];spec=createObj(found,spec),spec.name=found.name}else if("string"==typeof spec&&/^[\w\-]+\/[\w\-]+\+xml$/.test(spec))return CodeMirror.resolveMode("application/xml");return"string"==typeof spec?{name:spec}:spec||{name:"null"}},CodeMirror.getMode=function(options,spec){spec=CodeMirror.resolveMode(spec);var mfactory=modes[spec.name];if(!mfactory)return CodeMirror.getMode(options,"text/plain");var modeObj=mfactory(options,spec);if(modeExtensions.hasOwnProperty(spec.name)){var exts=modeExtensions[spec.name];for(var prop in exts)exts.hasOwnProperty(prop)&&(modeObj.hasOwnProperty(prop)&&(modeObj["_"+prop]=modeObj[prop]),modeObj[prop]=exts[prop])}return modeObj.name=spec.name,modeObj},CodeMirror.defineMode("null",function(){return{token:function(stream){stream.skipToEnd()}}}),CodeMirror.defineMIME("text/plain","null");var modeExtensions=CodeMirror.modeExtensions={};CodeMirror.extendMode=function(mode,properties){var exts=modeExtensions.hasOwnProperty(mode)?modeExtensions[mode]:modeExtensions[mode]={};copyObj(properties,exts)},CodeMirror.defineExtension=function(name,func){CodeMirror.prototype[name]=func},CodeMirror.defineDocExtension=function(name,func){Doc.prototype[name]=func},CodeMirror.defineOption=option;var initHooks=[];CodeMirror.defineInitHook=function(f){initHooks.push(f)},CodeMirror.copyState=copyState,CodeMirror.startState=startState,CodeMirror.innerMode=function(mode,state){for(;mode.innerMode;){var info=mode.innerMode(state);state=info.state,mode=info.mode}return info||{mode:mode,state:state}};var commands=CodeMirror.commands={selectAll:function(cm){cm.setSelection(Pos(cm.firstLine(),0),Pos(cm.lastLine()))},killLine:function(cm){var from=cm.getCursor(!0),to=cm.getCursor(!1),sel=!posEq(from,to);sel||cm.getLine(from.line).length!=from.ch?cm.replaceRange("",from,sel?to:Pos(from.line),"+delete"):cm.replaceRange("",from,Pos(from.line+1,0),"+delete")},deleteLine:function(cm){var l=cm.getCursor().line;cm.replaceRange("",Pos(l,0),Pos(l),"+delete")},delLineLeft:function(cm){var cur=cm.getCursor();cm.replaceRange("",Pos(cur.line,0),cur,"+delete")},undo:function(cm){cm.undo()},redo:function(cm){cm.redo()},goDocStart:function(cm){cm.extendSelection(Pos(cm.firstLine(),0))},goDocEnd:function(cm){cm.extendSelection(Pos(cm.lastLine()))},goLineStart:function(cm){cm.extendSelection(lineStart(cm,cm.getCursor().line))},goLineStartSmart:function(cm){var cur=cm.getCursor(),start=lineStart(cm,cur.line),line=cm.getLineHandle(start.line),order=getOrder(line);if(order&&0!=order[0].level)cm.extendSelection(start);else{var firstNonWS=Math.max(0,line.text.search(/\S/)),inWS=cur.line==start.line&&cur.ch<=firstNonWS&&cur.ch;cm.extendSelection(Pos(start.line,inWS?0:firstNonWS))}},goLineEnd:function(cm){cm.extendSelection(lineEnd(cm,cm.getCursor().line))},goLineRight:function(cm){var top=cm.charCoords(cm.getCursor(),"div").top+5;cm.extendSelection(cm.coordsChar({left:cm.display.lineDiv.offsetWidth+100,top:top},"div"))},goLineLeft:function(cm){var top=cm.charCoords(cm.getCursor(),"div").top+5;cm.extendSelection(cm.coordsChar({left:0,top:top},"div"))},goLineUp:function(cm){cm.moveV(-1,"line")},goLineDown:function(cm){cm.moveV(1,"line")},goPageUp:function(cm){cm.moveV(-1,"page")},goPageDown:function(cm){cm.moveV(1,"page")},goCharLeft:function(cm){cm.moveH(-1,"char")
},goCharRight:function(cm){cm.moveH(1,"char")},goColumnLeft:function(cm){cm.moveH(-1,"column")},goColumnRight:function(cm){cm.moveH(1,"column")},goWordLeft:function(cm){cm.moveH(-1,"word")},goGroupRight:function(cm){cm.moveH(1,"group")},goGroupLeft:function(cm){cm.moveH(-1,"group")},goWordRight:function(cm){cm.moveH(1,"word")},delCharBefore:function(cm){cm.deleteH(-1,"char")},delCharAfter:function(cm){cm.deleteH(1,"char")},delWordBefore:function(cm){cm.deleteH(-1,"word")},delWordAfter:function(cm){cm.deleteH(1,"word")},delGroupBefore:function(cm){cm.deleteH(-1,"group")},delGroupAfter:function(cm){cm.deleteH(1,"group")},indentAuto:function(cm){cm.indentSelection("smart")},indentMore:function(cm){cm.indentSelection("add")},indentLess:function(cm){cm.indentSelection("subtract")},insertTab:function(cm){cm.replaceSelection("	","end","+input")},defaultTab:function(cm){cm.somethingSelected()?cm.indentSelection("add"):cm.replaceSelection("	","end","+input")},transposeChars:function(cm){var cur=cm.getCursor(),line=cm.getLine(cur.line);cur.ch>0&&cur.ch<line.length-1&&cm.replaceRange(line.charAt(cur.ch)+line.charAt(cur.ch-1),Pos(cur.line,cur.ch-1),Pos(cur.line,cur.ch+1))},newlineAndIndent:function(cm){operation(cm,function(){cm.replaceSelection("\n","end","+input"),cm.indentLine(cm.getCursor().line,null,!0)})()},toggleOverwrite:function(cm){cm.toggleOverwrite()}},keyMap=CodeMirror.keyMap={};keyMap.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite"},keyMap.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Alt-Up":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Down":"goDocEnd","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore",fallthrough:"basic"},keyMap.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineStart","Cmd-Right":"goLineEnd","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delLineLeft",fallthrough:["basic","emacsy"]},keyMap["default"]=mac?keyMap.macDefault:keyMap.pcDefault,keyMap.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-D":"delWordAfter","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars"},CodeMirror.lookupKey=lookupKey,CodeMirror.isModifierKey=isModifierKey,CodeMirror.keyName=keyName,CodeMirror.fromTextArea=function(textarea,options){function save(){textarea.value=cm.getValue()}if(options||(options={}),options.value=textarea.value,!options.tabindex&&textarea.tabindex&&(options.tabindex=textarea.tabindex),!options.placeholder&&textarea.placeholder&&(options.placeholder=textarea.placeholder),null==options.autofocus){var hasFocus=document.body;try{hasFocus=document.activeElement}catch(e){}options.autofocus=hasFocus==textarea||null!=textarea.getAttribute("autofocus")&&hasFocus==document.body}if(textarea.form&&(on(textarea.form,"submit",save),!options.leaveSubmitMethodAlone)){var form=textarea.form,realSubmit=form.submit;try{var wrappedSubmit=form.submit=function(){save(),form.submit=realSubmit,form.submit(),form.submit=wrappedSubmit}}catch(e){}}textarea.style.display="none";var cm=CodeMirror(function(node){textarea.parentNode.insertBefore(node,textarea.nextSibling)},options);return cm.save=save,cm.getTextArea=function(){return textarea},cm.toTextArea=function(){save(),textarea.parentNode.removeChild(cm.getWrapperElement()),textarea.style.display="",textarea.form&&(off(textarea.form,"submit",save),"function"==typeof textarea.form.submit&&(textarea.form.submit=realSubmit))},cm},StringStream.prototype={eol:function(){return this.pos>=this.string.length},sol:function(){return 0==this.pos},peek:function(){return this.string.charAt(this.pos)||void 0},next:function(){return this.pos<this.string.length?this.string.charAt(this.pos++):void 0},eat:function(match){var ch=this.string.charAt(this.pos);if("string"==typeof match)var ok=ch==match;else var ok=ch&&(match.test?match.test(ch):match(ch));return ok?(++this.pos,ch):void 0},eatWhile:function(match){for(var start=this.pos;this.eat(match););return this.pos>start},eatSpace:function(){for(var start=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>start},skipToEnd:function(){this.pos=this.string.length},skipTo:function(ch){var found=this.string.indexOf(ch,this.pos);return found>-1?(this.pos=found,!0):void 0},backUp:function(n){this.pos-=n},column:function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=countColumn(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue},indentation:function(){return countColumn(this.string,null,this.tabSize)},match:function(pattern,consume,caseInsensitive){if("string"!=typeof pattern){var match=this.string.slice(this.pos).match(pattern);return match&&match.index>0?null:(match&&consume!==!1&&(this.pos+=match[0].length),match)}var cased=function(str){return caseInsensitive?str.toLowerCase():str},substr=this.string.substr(this.pos,pattern.length);return cased(substr)==cased(pattern)?(consume!==!1&&(this.pos+=pattern.length),!0):void 0},current:function(){return this.string.slice(this.start,this.pos)}},CodeMirror.StringStream=StringStream,CodeMirror.TextMarker=TextMarker,TextMarker.prototype.clear=function(){if(!this.explicitlyCleared){var cm=this.doc.cm,withOp=cm&&!cm.curOp;withOp&&startOperation(cm);for(var min=null,max=null,i=0;i<this.lines.length;++i){var line=this.lines[i],span=getMarkedSpanFor(line.markedSpans,this);null!=span.to&&(max=lineNo(line)),line.markedSpans=removeMarkedSpan(line.markedSpans,span),null!=span.from?min=lineNo(line):this.collapsed&&!lineIsHidden(this.doc,line)&&cm&&updateLineHeight(line,textHeight(cm.display))}if(cm&&this.collapsed&&!cm.options.lineWrapping)for(var i=0;i<this.lines.length;++i){var visual=visualLine(cm.doc,this.lines[i]),len=lineLength(cm.doc,visual);len>cm.display.maxLineLength&&(cm.display.maxLine=visual,cm.display.maxLineLength=len,cm.display.maxLineChanged=!0)}null!=min&&cm&&regChange(cm,min,max+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,cm&&reCheckSelection(cm)),withOp&&endOperation(cm),signalLater(this,"clear")}},TextMarker.prototype.find=function(){for(var from,to,i=0;i<this.lines.length;++i){var line=this.lines[i],span=getMarkedSpanFor(line.markedSpans,this);if(null!=span.from||null!=span.to){var found=lineNo(line);null!=span.from&&(from=Pos(found,span.from)),null!=span.to&&(to=Pos(found,span.to))}}return"bookmark"==this.type?from:from&&{from:from,to:to}},TextMarker.prototype.changed=function(){var pos=this.find(),cm=this.doc.cm;if(pos&&cm){var line=getLine(this.doc,pos.from.line);if(clearCachedMeasurement(cm,line),pos.from.line>=cm.display.showingFrom&&pos.from.line<cm.display.showingTo){for(var node=cm.display.lineDiv.firstChild;node;node=node.nextSibling)if(node.lineObj==line){node.offsetHeight!=line.height&&updateLineHeight(line,node.offsetHeight);break}runInOp(cm,function(){cm.curOp.selectionChanged=!0})}}},TextMarker.prototype.attachLine=function(line){if(!this.lines.length&&this.doc.cm){var op=this.doc.cm.curOp;op.maybeHiddenMarkers&&-1!=indexOf(op.maybeHiddenMarkers,this)||(op.maybeUnhiddenMarkers||(op.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(line)},TextMarker.prototype.detachLine=function(line){if(this.lines.splice(indexOf(this.lines,line),1),!this.lines.length&&this.doc.cm){var op=this.doc.cm.curOp;(op.maybeHiddenMarkers||(op.maybeHiddenMarkers=[])).push(this)}},CodeMirror.SharedTextMarker=SharedTextMarker,SharedTextMarker.prototype.clear=function(){if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var i=0;i<this.markers.length;++i)this.markers[i].clear();signalLater(this,"clear")}},SharedTextMarker.prototype.find=function(){return this.primary.find()};var LineWidget=CodeMirror.LineWidget=function(cm,node,options){for(var opt in options)options.hasOwnProperty(opt)&&(this[opt]=options[opt]);this.cm=cm,this.node=node};LineWidget.prototype.clear=widgetOperation(function(){var ws=this.line.widgets,no=lineNo(this.line);if(null!=no&&ws){for(var i=0;i<ws.length;++i)ws[i]==this&&ws.splice(i--,1);ws.length||(this.line.widgets=null),updateLineHeight(this.line,Math.max(0,this.line.height-widgetHeight(this))),regChange(this.cm,no,no+1)}}),LineWidget.prototype.changed=widgetOperation(function(){var oldH=this.height;this.height=null;var diff=widgetHeight(this)-oldH;if(diff){updateLineHeight(this.line,this.line.height+diff);var no=lineNo(this.line);regChange(this.cm,no,no+1)}});var styleToClassCache={},tokenSpecialChars=/[\t\u0000-\u0019\u00ad\u200b\u2028\u2029\uFEFF]/g;LeafChunk.prototype={chunkSize:function(){return this.lines.length},removeInner:function(at,n){for(var i=at,e=at+n;e>i;++i){var line=this.lines[i];this.height-=line.height,cleanUpLine(line),signalLater(line,"delete")}this.lines.splice(at,n)},collapse:function(lines){lines.splice.apply(lines,[lines.length,0].concat(this.lines))},insertInner:function(at,lines,height){this.height+=height,this.lines=this.lines.slice(0,at).concat(lines).concat(this.lines.slice(at));for(var i=0,e=lines.length;e>i;++i)lines[i].parent=this},iterN:function(at,n,op){for(var e=at+n;e>at;++at)if(op(this.lines[at]))return!0}},BranchChunk.prototype={chunkSize:function(){return this.size},removeInner:function(at,n){this.size-=n;for(var i=0;i<this.children.length;++i){var child=this.children[i],sz=child.chunkSize();if(sz>at){var rm=Math.min(n,sz-at),oldHeight=child.height;if(child.removeInner(at,rm),this.height-=oldHeight-child.height,sz==rm&&(this.children.splice(i--,1),child.parent=null),0==(n-=rm))break;at=0}else at-=sz}if(this.size-n<25){var lines=[];this.collapse(lines),this.children=[new LeafChunk(lines)],this.children[0].parent=this}},collapse:function(lines){for(var i=0,e=this.children.length;e>i;++i)this.children[i].collapse(lines)},insertInner:function(at,lines,height){this.size+=lines.length,this.height+=height;for(var i=0,e=this.children.length;e>i;++i){var child=this.children[i],sz=child.chunkSize();if(sz>=at){if(child.insertInner(at,lines,height),child.lines&&child.lines.length>50){for(;child.lines.length>50;){var spilled=child.lines.splice(child.lines.length-25,25),newleaf=new LeafChunk(spilled);child.height-=newleaf.height,this.children.splice(i+1,0,newleaf),newleaf.parent=this}this.maybeSpill()}break}at-=sz}},maybeSpill:function(){if(!(this.children.length<=10)){var me=this;do{var spilled=me.children.splice(me.children.length-5,5),sibling=new BranchChunk(spilled);if(me.parent){me.size-=sibling.size,me.height-=sibling.height;var myIndex=indexOf(me.parent.children,me);me.parent.children.splice(myIndex+1,0,sibling)}else{var copy=new BranchChunk(me.children);copy.parent=me,me.children=[copy,sibling],me=copy}sibling.parent=me.parent}while(me.children.length>10);me.parent.maybeSpill()}},iterN:function(at,n,op){for(var i=0,e=this.children.length;e>i;++i){var child=this.children[i],sz=child.chunkSize();if(sz>at){var used=Math.min(n,sz-at);if(child.iterN(at,used,op))return!0;if(0==(n-=used))break;at=0}else at-=sz}}};var nextDocId=0,Doc=CodeMirror.Doc=function(text,mode,firstLine){if(!(this instanceof Doc))return new Doc(text,mode,firstLine);null==firstLine&&(firstLine=0),BranchChunk.call(this,[new LeafChunk([makeLine("",null)])]),this.first=firstLine,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.history=makeHistory(),this.cleanGeneration=1,this.frontier=firstLine;var start=Pos(firstLine,0);this.sel={from:start,to:start,head:start,anchor:start,shift:!1,extend:!1,goalColumn:null},this.id=++nextDocId,this.modeOption=mode,"string"==typeof text&&(text=splitLines(text)),updateDoc(this,{from:start,to:start,text:text},null,{head:start,anchor:start})};Doc.prototype=createObj(BranchChunk.prototype,{constructor:Doc,iter:function(from,to,op){op?this.iterN(from-this.first,to-from,op):this.iterN(this.first,this.first+this.size,from)},insert:function(at,lines){for(var height=0,i=0,e=lines.length;e>i;++i)height+=lines[i].height;this.insertInner(at-this.first,lines,height)},remove:function(at,n){this.removeInner(at-this.first,n)},getValue:function(lineSep){var lines=getLines(this,this.first,this.first+this.size);return lineSep===!1?lines:lines.join(lineSep||"\n")},setValue:function(code){var top=Pos(this.first,0),last=this.first+this.size-1;makeChange(this,{from:top,to:Pos(last,getLine(this,last).text.length),text:splitLines(code),origin:"setValue"},{head:top,anchor:top},!0)},replaceRange:function(code,from,to,origin){from=clipPos(this,from),to=to?clipPos(this,to):from,replaceRange(this,code,from,to,origin)},getRange:function(from,to,lineSep){var lines=getBetween(this,clipPos(this,from),clipPos(this,to));return lineSep===!1?lines:lines.join(lineSep||"\n")},getLine:function(line){var l=this.getLineHandle(line);return l&&l.text},setLine:function(line,text){isLine(this,line)&&replaceRange(this,text,Pos(line,0),clipPos(this,Pos(line)))},removeLine:function(line){line?replaceRange(this,"",clipPos(this,Pos(line-1)),clipPos(this,Pos(line))):replaceRange(this,"",Pos(0,0),clipPos(this,Pos(1,0)))},getLineHandle:function(line){return isLine(this,line)?getLine(this,line):void 0},getLineNumber:function(line){return lineNo(line)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(pos){return clipPos(this,pos)},getCursor:function(start){var pos,sel=this.sel;return pos=null==start||"head"==start?sel.head:"anchor"==start?sel.anchor:"end"==start||start===!1?sel.to:sel.from,copyPos(pos)},somethingSelected:function(){return!posEq(this.sel.head,this.sel.anchor)},setCursor:docOperation(function(line,ch,extend){var pos=clipPos(this,"number"==typeof line?Pos(line,ch||0):line);extend?extendSelection(this,pos):setSelection(this,pos,pos)}),setSelection:docOperation(function(anchor,head){setSelection(this,clipPos(this,anchor),clipPos(this,head||anchor))}),extendSelection:docOperation(function(from,to){extendSelection(this,clipPos(this,from),to&&clipPos(this,to))}),getSelection:function(lineSep){return this.getRange(this.sel.from,this.sel.to,lineSep)},replaceSelection:function(code,collapse,origin){makeChange(this,{from:this.sel.from,to:this.sel.to,text:splitLines(code),origin:origin},collapse||"around")},undo:docOperation(function(){makeChangeFromHistory(this,"undo")}),redo:docOperation(function(){makeChangeFromHistory(this,"redo")}),setExtending:function(val){this.sel.extend=val},historySize:function(){var hist=this.history;return{undo:hist.done.length,redo:hist.undone.length}},clearHistory:function(){this.history=makeHistory(this.history.maxGeneration)},markClean:function(){this.cleanGeneration=this.changeGeneration()},changeGeneration:function(){return this.history.lastOp=this.history.lastOrigin=null,this.history.generation},isClean:function(gen){return this.history.generation==(gen||this.cleanGeneration)},getHistory:function(){return{done:copyHistoryArray(this.history.done),undone:copyHistoryArray(this.history.undone)}},setHistory:function(histData){var hist=this.history=makeHistory(this.history.maxGeneration);hist.done=histData.done.slice(0),hist.undone=histData.undone.slice(0)},markText:function(from,to,options){return markText(this,clipPos(this,from),clipPos(this,to),options,"range")},setBookmark:function(pos,options){var realOpts={replacedWith:options&&(null==options.nodeType?options.widget:options),insertLeft:options&&options.insertLeft};return pos=clipPos(this,pos),markText(this,pos,pos,realOpts,"bookmark")},findMarksAt:function(pos){pos=clipPos(this,pos);var markers=[],spans=getLine(this,pos.line).markedSpans;if(spans)for(var i=0;i<spans.length;++i){var span=spans[i];(null==span.from||span.from<=pos.ch)&&(null==span.to||span.to>=pos.ch)&&markers.push(span.marker.parent||span.marker)}return markers},getAllMarks:function(){var markers=[];return this.iter(function(line){var sps=line.markedSpans;if(sps)for(var i=0;i<sps.length;++i)null!=sps[i].from&&markers.push(sps[i].marker)}),markers},posFromIndex:function(off){var ch,lineNo=this.first;return this.iter(function(line){var sz=line.text.length+1;return sz>off?(ch=off,!0):(off-=sz,void++lineNo)}),clipPos(this,Pos(lineNo,ch))},indexFromPos:function(coords){coords=clipPos(this,coords);var index=coords.ch;return coords.line<this.first||coords.ch<0?0:(this.iter(this.first,coords.line,function(line){index+=line.text.length+1}),index)},copy:function(copyHistory){var doc=new Doc(getLines(this,this.first,this.first+this.size),this.modeOption,this.first);return doc.scrollTop=this.scrollTop,doc.scrollLeft=this.scrollLeft,doc.sel={from:this.sel.from,to:this.sel.to,head:this.sel.head,anchor:this.sel.anchor,shift:this.sel.shift,extend:!1,goalColumn:this.sel.goalColumn},copyHistory&&(doc.history.undoDepth=this.history.undoDepth,doc.setHistory(this.getHistory())),doc},linkedDoc:function(options){options||(options={});var from=this.first,to=this.first+this.size;null!=options.from&&options.from>from&&(from=options.from),null!=options.to&&options.to<to&&(to=options.to);var copy=new Doc(getLines(this,from,to),options.mode||this.modeOption,from);return options.sharedHist&&(copy.history=this.history),(this.linked||(this.linked=[])).push({doc:copy,sharedHist:options.sharedHist}),copy.linked=[{doc:this,isParent:!0,sharedHist:options.sharedHist}],copy},unlinkDoc:function(other){if(other instanceof CodeMirror&&(other=other.doc),this.linked)for(var i=0;i<this.linked.length;++i){var link=this.linked[i];if(link.doc==other){this.linked.splice(i,1),other.unlinkDoc(this);break}}if(other.history==this.history){var splitIds=[other.id];linkedDocs(other,function(doc){splitIds.push(doc.id)},!0),other.history=makeHistory(),other.history.done=copyHistoryArray(this.history.done,splitIds),other.history.undone=copyHistoryArray(this.history.undone,splitIds)}},iterLinkedDocs:function(f){linkedDocs(this,f)},getMode:function(){return this.mode},getEditor:function(){return this.cm}}),Doc.prototype.eachLine=Doc.prototype.iter;var dontDelegate="iter insert remove copy getEditor".split(" ");for(var prop in Doc.prototype)Doc.prototype.hasOwnProperty(prop)&&indexOf(dontDelegate,prop)<0&&(CodeMirror.prototype[prop]=function(method){return function(){return method.apply(this.doc,arguments)}}(Doc.prototype[prop]));CodeMirror.e_stop=e_stop,CodeMirror.e_preventDefault=e_preventDefault,CodeMirror.e_stopPropagation=e_stopPropagation;var delayedCallbacks,delayedCallbackDepth=0;CodeMirror.on=on,CodeMirror.off=off,CodeMirror.signal=signal;var scrollerCutOff=30,Pass=CodeMirror.Pass={toString:function(){return"CodeMirror.Pass"}};Delayed.prototype={set:function(ms,f){clearTimeout(this.id),this.id=setTimeout(f,ms)}},CodeMirror.countColumn=countColumn;var spaceStrs=[""],nonASCIISingleCaseWordChar=/[\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/,isExtendingChar=/[\u0300-\u036F\u0483-\u0487\u0488-\u0489\u0591-\u05BD\u05BF\u05C1-\u05C2\u05C4-\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7-\u06E8\u06EA-\u06ED\uA66F\uA670-\uA672\uA674-\uA67D\uA69F\udc00-\udfff]/;CodeMirror.replaceGetRect=function(f){getRect=f};var dragAndDrop=function(){if(ie_lt9)return!1;var div=elt("div");return"draggable"in div||"dragDrop"in div}();gecko?spanAffectsWrapping=function(str,i){return 36==str.charCodeAt(i-1)&&39==str.charCodeAt(i)}:safari&&!/Version\/([6-9]|\d\d)\b/.test(navigator.userAgent)?spanAffectsWrapping=function(str,i){return/\-[^ \-?]|\?[^ !\'\"\),.\-\/:;\?\]\}]/.test(str.slice(i-1,i+1))}:webkit&&(spanAffectsWrapping=function(str,i){return i>1&&45==str.charCodeAt(i-1)&&/\w/.test(str.charAt(i-2))&&/[^\-?\.]/.test(str.charAt(i))?!0:/[~!#%&*)=+}\]|\"\.>,:;][({[<]|-[^\-?\.\u2010-\u201f\u2026]|\?[\w~`@#$%\^&*(_=+{[|><]|[\w~`@#$%\^&*(_=+{[><]/.test(str.slice(i-1,i+1))});var knownScrollbarWidth,zwspSupported,splitLines=3!="\n\nb".split(/\n/).length?function(string){for(var pos=0,result=[],l=string.length;l>=pos;){var nl=string.indexOf("\n",pos);-1==nl&&(nl=string.length);var line=string.slice(pos,"\r"==string.charAt(nl-1)?nl-1:nl),rt=line.indexOf("\r");-1!=rt?(result.push(line.slice(0,rt)),pos+=rt+1):(result.push(line),pos=nl+1)}return result}:function(string){return string.split(/\r\n?|\n/)};CodeMirror.splitLines=splitLines;var hasSelection=window.getSelection?function(te){try{return te.selectionStart!=te.selectionEnd}catch(e){return!1}}:function(te){try{var range=te.ownerDocument.selection.createRange()}catch(e){}return range&&range.parentElement()==te?0!=range.compareEndPoints("StartToEnd",range):!1},hasCopyEvent=function(){var e=elt("div");return"oncopy"in e?!0:(e.setAttribute("oncopy","return;"),"function"==typeof e.oncopy)}(),keyNames={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",91:"Mod",92:"Mod",93:"Mod",109:"-",107:"=",127:"Delete",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63276:"PageUp",63277:"PageDown",63275:"End",63273:"Home",63234:"Left",63232:"Up",63235:"Right",63233:"Down",63302:"Insert",63272:"Delete"};CodeMirror.keyNames=keyNames,function(){for(var i=0;10>i;i++)keyNames[i+48]=String(i);for(var i=65;90>=i;i++)keyNames[i]=String.fromCharCode(i);for(var i=1;12>=i;i++)keyNames[i+111]=keyNames[i+63235]="F"+i}();var bidiOther,bidiOrdering=function(){function charType(code){return 255>=code?lowTypes.charAt(code):code>=1424&&1524>=code?"R":code>=1536&&1791>=code?arabicTypes.charAt(code-1536):code>=1792&&2220>=code?"r":"L"}var lowTypes="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLL",arabicTypes="rrrrrrrrrrrr,rNNmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmrrrrrrrnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmNmmmmrrrrrrrrrrrrrrrrrr",bidiRE=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,isNeutral=/[stwN]/,isStrong=/[LRr]/,countsAsLeft=/[Lb1n]/,countsAsNum=/[1n]/,outerType="L";return function(str){if(!bidiRE.test(str))return!1;for(var type,len=str.length,types=[],i=0;len>i;++i)types.push(type=charType(str.charCodeAt(i)));for(var i=0,prev=outerType;len>i;++i){var type=types[i];"m"==type?types[i]=prev:prev=type}for(var i=0,cur=outerType;len>i;++i){var type=types[i];"1"==type&&"r"==cur?types[i]="n":isStrong.test(type)&&(cur=type,"r"==type&&(types[i]="R"))}for(var i=1,prev=types[0];len-1>i;++i){var type=types[i];"+"==type&&"1"==prev&&"1"==types[i+1]?types[i]="1":","!=type||prev!=types[i+1]||"1"!=prev&&"n"!=prev||(types[i]=prev),prev=type}for(var i=0;len>i;++i){var type=types[i];if(","==type)types[i]="N";else if("%"==type){for(var end=i+1;len>end&&"%"==types[end];++end);for(var replace=i&&"!"==types[i-1]||len-1>end&&"1"==types[end]?"1":"N",j=i;end>j;++j)types[j]=replace;i=end-1}}for(var i=0,cur=outerType;len>i;++i){var type=types[i];"L"==cur&&"1"==type?types[i]="L":isStrong.test(type)&&(cur=type)}for(var i=0;len>i;++i)if(isNeutral.test(types[i])){for(var end=i+1;len>end&&isNeutral.test(types[end]);++end);for(var before="L"==(i?types[i-1]:outerType),after="L"==(len-1>end?types[end]:outerType),replace=before||after?"L":"R",j=i;end>j;++j)types[j]=replace;i=end-1}for(var m,order=[],i=0;len>i;)if(countsAsLeft.test(types[i])){var start=i;for(++i;len>i&&countsAsLeft.test(types[i]);++i);order.push({from:start,to:i,level:0})}else{var pos=i,at=order.length;for(++i;len>i&&"L"!=types[i];++i);for(var j=pos;i>j;)if(countsAsNum.test(types[j])){j>pos&&order.splice(at,0,{from:pos,to:j,level:1});var nstart=j;for(++j;i>j&&countsAsNum.test(types[j]);++j);order.splice(at,0,{from:nstart,to:j,level:2}),pos=j}else++j;i>pos&&order.splice(at,0,{from:pos,to:i,level:1})}return 1==order[0].level&&(m=str.match(/^\s+/))&&(order[0].from=m[0].length,order.unshift({from:0,to:m[0].length,level:0})),1==lst(order).level&&(m=str.match(/\s+$/))&&(lst(order).to-=m[0].length,order.push({from:len-m[0].length,to:len,level:0})),order[0].level!=lst(order).level&&order.push({from:len,to:len,level:order[0].level}),order}}();return CodeMirror.version="3.14.0",CodeMirror}(),CodeMirror.defineMode("xml",function(config,parserConfig){function inText(stream,state){function chain(parser){return state.tokenize=parser,parser(stream,state)}var ch=stream.next();if("<"==ch){if(stream.eat("!"))return stream.eat("[")?stream.match("CDATA[")?chain(inBlock("atom","]]>")):null:stream.match("--")?chain(inBlock("comment","-->")):stream.match("DOCTYPE",!0,!0)?(stream.eatWhile(/[\w\._\-]/),chain(doctype(1))):null;if(stream.eat("?"))return stream.eatWhile(/[\w\._\-]/),state.tokenize=inBlock("meta","?>"),"meta";var isClose=stream.eat("/");tagName="";for(var c;c=stream.eat(/[^\s\u00a0=<>\"\'\/?]/);)tagName+=c;return tagName?(type=isClose?"closeTag":"openTag",state.tokenize=inTag,"tag"):"error"}if("&"==ch){var ok;return ok=stream.eat("#")?stream.eat("x")?stream.eatWhile(/[a-fA-F\d]/)&&stream.eat(";"):stream.eatWhile(/[\d]/)&&stream.eat(";"):stream.eatWhile(/[\w\.\-:]/)&&stream.eat(";"),ok?"atom":"error"}return stream.eatWhile(/[^&<]/),null}function inTag(stream,state){var ch=stream.next();return">"==ch||"/"==ch&&stream.eat(">")?(state.tokenize=inText,type=">"==ch?"endTag":"selfcloseTag","tag"):"="==ch?(type="equals",null):"<"==ch?"error":/[\'\"]/.test(ch)?(state.tokenize=inAttribute(ch),state.tokenize(stream,state)):(stream.eatWhile(/[^\s\u00a0=<>\"\']/),"word")}function inAttribute(quote){return function(stream,state){for(;!stream.eol();)if(stream.next()==quote){state.tokenize=inTag;break}return"string"}}function inBlock(style,terminator){return function(stream,state){for(;!stream.eol();){if(stream.match(terminator)){state.tokenize=inText;break}stream.next()}return style}}function doctype(depth){return function(stream,state){for(var ch;null!=(ch=stream.next());){if("<"==ch)return state.tokenize=doctype(depth+1),state.tokenize(stream,state);if(">"==ch){if(1==depth){state.tokenize=inText;break}return state.tokenize=doctype(depth-1),state.tokenize(stream,state)}}return"meta"}}function pass(){for(var i=arguments.length-1;i>=0;i--)curState.cc.push(arguments[i])}function cont(){return pass.apply(null,arguments),!0}function pushContext(tagName,startOfLine){var noIndent=Kludges.doNotIndent.hasOwnProperty(tagName)||curState.context&&curState.context.noIndent;curState.context={prev:curState.context,tagName:tagName,indent:curState.indented,startOfLine:startOfLine,noIndent:noIndent}}function popContext(){curState.context&&(curState.context=curState.context.prev)}function element(type){if("openTag"==type)return curState.tagName=tagName,curState.tagStart=curStream.column(),cont(attributes,endtag(curState.startOfLine));if("closeTag"==type){var err=!1;return curState.context?curState.context.tagName!=tagName&&(Kludges.implicitlyClosed.hasOwnProperty(curState.context.tagName.toLowerCase())&&popContext(),err=!curState.context||curState.context.tagName!=tagName):err=!0,err&&(setStyle="error"),cont(endclosetag(err))}return cont()}function endtag(startOfLine){return function(type){var tagName=curState.tagName;return curState.tagName=curState.tagStart=null,"selfcloseTag"==type||"endTag"==type&&Kludges.autoSelfClosers.hasOwnProperty(tagName.toLowerCase())?(maybePopContext(tagName.toLowerCase()),cont()):"endTag"==type?(maybePopContext(tagName.toLowerCase()),pushContext(tagName,startOfLine),cont()):cont()}}function endclosetag(err){return function(type){return err&&(setStyle="error"),"endTag"==type?(popContext(),cont()):(setStyle="error",cont(arguments.callee))}}function maybePopContext(nextTagName){for(var parentTagName;;){if(!curState.context)return;if(parentTagName=curState.context.tagName.toLowerCase(),!Kludges.contextGrabbers.hasOwnProperty(parentTagName)||!Kludges.contextGrabbers[parentTagName].hasOwnProperty(nextTagName))return;popContext()}}function attributes(type){return"word"==type?(setStyle="attribute",cont(attribute,attributes)):"endTag"==type||"selfcloseTag"==type?pass():(setStyle="error",cont(attributes))}function attribute(type){return"equals"==type?cont(attvalue,attributes):(Kludges.allowMissing?"word"==type&&(setStyle="attribute"):setStyle="error","endTag"==type||"selfcloseTag"==type?pass():cont())}function attvalue(type){return"string"==type?cont(attvaluemaybe):"word"==type&&Kludges.allowUnquoted?(setStyle="string",cont()):(setStyle="error","endTag"==type||"selfCloseTag"==type?pass():cont())}function attvaluemaybe(type){return"string"==type?cont(attvaluemaybe):pass()}var tagName,type,curState,curStream,setStyle,indentUnit=config.indentUnit,multilineTagIndentFactor=parserConfig.multilineTagIndentFactor||1,Kludges=parserConfig.htmlMode?{autoSelfClosers:{area:!0,base:!0,br:!0,col:!0,command:!0,embed:!0,frame:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0},implicitlyClosed:{dd:!0,li:!0,optgroup:!0,option:!0,p:!0,rp:!0,rt:!0,tbody:!0,td:!0,tfoot:!0,th:!0,tr:!0},contextGrabbers:{dd:{dd:!0,dt:!0},dt:{dd:!0,dt:!0},li:{li:!0},option:{option:!0,optgroup:!0},optgroup:{optgroup:!0},p:{address:!0,article:!0,aside:!0,blockquote:!0,dir:!0,div:!0,dl:!0,fieldset:!0,footer:!0,form:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,header:!0,hgroup:!0,hr:!0,menu:!0,nav:!0,ol:!0,p:!0,pre:!0,section:!0,table:!0,ul:!0},rp:{rp:!0,rt:!0},rt:{rp:!0,rt:!0},tbody:{tbody:!0,tfoot:!0},td:{td:!0,th:!0},tfoot:{tbody:!0},th:{td:!0,th:!0},thead:{tbody:!0,tfoot:!0},tr:{tr:!0}},doNotIndent:{pre:!0},allowUnquoted:!0,allowMissing:!0}:{autoSelfClosers:{},implicitlyClosed:{},contextGrabbers:{},doNotIndent:{},allowUnquoted:!1,allowMissing:!1},alignCDATA=parserConfig.alignCDATA;return{startState:function(){return{tokenize:inText,cc:[],indented:0,startOfLine:!0,tagName:null,tagStart:null,context:null}},token:function(stream,state){if(!state.tagName&&stream.sol()&&(state.startOfLine=!0,state.indented=stream.indentation()),stream.eatSpace())return null;setStyle=type=tagName=null;var style=state.tokenize(stream,state);if(state.type=type,(style||type)&&"comment"!=style)for(curState=state,curStream=stream;;){var comb=state.cc.pop()||element;if(comb(type||style))break}return state.startOfLine=!1,setStyle||style},indent:function(state,textAfter,fullLine){var context=state.context;if(state.tokenize!=inTag&&state.tokenize!=inText||context&&context.noIndent)return fullLine?fullLine.match(/^(\s*)/)[0].length:0;if(state.tagName)return state.tagStart+indentUnit*multilineTagIndentFactor;if(alignCDATA&&/<!\[CDATA\[/.test(textAfter))return 0;for(context&&/^<\//.test(textAfter)&&(context=context.prev);context&&!context.startOfLine;)context=context.prev;return context?context.indent+indentUnit:0},electricChars:"/",blockCommentStart:"<!--",blockCommentEnd:"-->",configuration:parserConfig.htmlMode?"html":"xml"}
}),CodeMirror.defineMIME("text/xml","xml"),CodeMirror.defineMIME("application/xml","xml"),CodeMirror.mimeModes.hasOwnProperty("text/html")||CodeMirror.defineMIME("text/html",{name:"xml",htmlMode:!0}),function(undefined){function usesSuper(obj){return!probe_super||/\B\$super\b/.test(obj.toString())}function setOrUnset(obj,key,value){value===undefined?delete obj[key]:obj[key]=value}function getOwnProperty(obj,name){return Object.prototype.hasOwnProperty.call(obj,name)?obj[name]:undefined}function cheapNew(cls){disable_constructor=!0;var rv=new cls;return disable_constructor=!1,rv}var CLASSY_VERSION="1.4",root=this,old_class=root.Class,disable_constructor=!1,probe_super=function(){$super()}.toString().indexOf("$super")>0,Class=function(){};Class.$noConflict=function(){try{setOrUnset(root,"Class",old_class)}catch(e){root.Class=old_class}return Class},Class.$classyVersion=CLASSY_VERSION,Class.$extend=function(properties){var super_prototype=this.prototype,prototype=cheapNew(this);if(properties.__include__)for(var i=0,n=properties.__include__.length;i!=n;++i){var mixin=properties.__include__[i];for(var name in mixin){var value=getOwnProperty(mixin,name);value!==undefined&&(prototype[name]=mixin[name])}}if(properties.__classvars__=properties.__classvars__||{},prototype.__classvars__)for(var key in prototype.__classvars__)if(!properties.__classvars__[key]){var value=getOwnProperty(prototype.__classvars__,key);properties.__classvars__[key]=value}for(var name in properties){var value=getOwnProperty(properties,name);"__include__"!==name&&value!==undefined&&(prototype[name]="function"==typeof value&&usesSuper(value)?function(meth,name){return function(){var old_super=getOwnProperty(this,"$super");this.$super=super_prototype[name];try{return meth.apply(this,arguments)}finally{setOrUnset(this,"$super",old_super)}}}(value,name):value)}var rv=function(){if(!disable_constructor){var proper_this=root===this?cheapNew(arguments.callee):this;return proper_this.__init__&&proper_this.__init__.apply(proper_this,arguments),proper_this.$class=rv,proper_this}};for(var key in properties.__classvars__){var value=getOwnProperty(properties.__classvars__,key);value!==undefined&&(rv[key]=value)}return rv.prototype=prototype,rv.constructor=rv,rv.$extend=Class.$extend,rv.$withData=Class.$withData,rv},Class.$withData=function(data){var rv=cheapNew(this);for(var key in data){var value=getOwnProperty(data,key);value!==undefined&&(rv[key]=value)}return rv},root.Class=Class}(),RESERVED_ITEXT_CONTENT_TYPES=["default","short","long","audio","video","image"],ItextItem.prototype={getForms:function(){return this.forms},getFormNames:function(){return this.forms.map(function(form){return form.name})},hasForm:function(name){return-1!==this.getFormNames().indexOf(name)},getForm:function(name){return formdesigner.util.reduceToOne(this.forms,function(form){return form.name===name},"form name = "+name)},getOrCreateForm:function(name){try{return this.getForm(name)}catch(err){return this.addForm(name)}},addForm:function(name){if(!this.hasForm(name)){var newForm=new ItextForm({name:name});return this.forms.push(newForm),newForm}},removeForm:function(name){var names=this.getFormNames(),index=names.indexOf(name);-1!==index&&this.forms.splice(index,1)},getValue:function(form,language){return this.hasForm(form)?this.getForm(form).getValue(language):void 0},defaultValue:function(){return this.getValue("default",formdesigner.pluginManager.javaRosa.Itext.getDefaultLanguage())},setDefaultValue:function(val){this.getOrCreateForm("default").setValue(formdesigner.pluginManager.javaRosa.Itext.getDefaultLanguage(),val)},isEmpty:function(){if(this.forms){var nonEmptyItems=_(this.forms).filter(function(form){return!form.isEmpty()});return 0===nonEmptyItems.length}return!0},hasHumanReadableItext:function(){return Boolean(this.hasForm("default")||this.hasForm("long")||this.hasForm("short"))}};var ItextForm=function(options){var form={};return form.data=options.data||{},form.name=options.name||"default",form.getValue=function(lang){return this.data[lang]},form.setValue=function(lang,value){this.data[lang]=value},form.getValueOrDefault=function(lang){if(this.data[lang])return this.data[lang];var defLang=formdesigner.pluginManager.javaRosa.Itext.getDefaultLanguage();if(lang!==defLang&&this.data[defLang])return this.data[defLang];for(var i in this.data)if(this.data.hasOwnProperty(i))return this.data[i];return""},form.isEmpty=function(){for(var lang in this.data)if(this.data.hasOwnProperty(lang)&&this.data[lang])return!1;return!0},form},ItextModel=function(){var itext={};itext.languages=[],itext.getLanguages=function(){return this.languages},itext.hasLanguage=function(lang){return-1!==this.languages.indexOf(lang)},itext.addLanguage=function(lang){this.hasLanguage(lang)||this.languages.push(lang)},itext.removeLanguage=function(lang){this.hasLanguage(lang)&&this.languages.splice(this.languages.indexOf(lang),1),this.getDefaultLanguage()===lang&&this.setDefaultLanguage(this.languages.length>0?this.languages[0]:"")},itext.setDefaultLanguage=function(lang){this.defaultLanguage=lang},itext.getDefaultLanguage=function(){return this.defaultLanguage?this.defaultLanguage:this.languages.length>0?this.languages[0]:""},itext.items=[],itext.getItems=function(){return this.items},itext.getNonEmptyItems=function(){return _(this.items).filter(function(item){return!item.isEmpty()})},itext.getNonEmptyItemIds=function(){return this.getNonEmptyItems().map(function(item){return item.id})},itext.deduplicateIds=function(){for(var counter,item,origId,nonEmpty=this.getNonEmptyItems(),found=[],i=0;i<nonEmpty.length;i++){for(item=nonEmpty[i],origId=item.id,counter=2;-1!==found.indexOf(item.id);)item.id=origId+counter,counter+=1;found.push(item.id)}},itext.hasItem=function(item){return-1!==this.items.indexOf(item)},itext.addItem=function(item){this.hasItem(item)||this.items.push(item)},itext.createItem=function(id){var item=new ItextItem({id:id,forms:[new ItextForm({name:"default"})]});return this.addItem(item),item},itext.getItem=function(iID){try{return formdesigner.util.reduceToOne(this.items,function(item){return item.id===iID},"itext id = "+iID)}catch(e){throw"NoItextItemFound"}},itext.getOrCreateItem=function(id){try{return this.getItem(id)}catch(err){return this.createItem(id)}},itext.removeItem=function(item){var index=this.items.indexOf(item);-1!==index&&this.items.splice(index,1)},itext.getAllItemIDs=function(){return this.items.map(function(item){return item.id})},itext.validateItext=function(){var dLang=this.getDefaultLanguage();if(!dLang)throw"No Default Language set! Aborting validation. You should set one!";if(!this.hasLanguage(dLang))throw"Default language is set to a language that does not exist in the Itext DB!";return!0},itext.clear=function(){delete this.languages,delete this.items,this.languages=[],this.items=[]},itext.resetItext=function(langs){if(this.clear(),langs&&langs.length>0)for(var i=0;i<langs.length;i++)this.addLanguage(langs[i])};var resetItextList=function(validIDList){this.items=[];for(var i=0;i<validIDList.length;i++)this.items.push(validIDList[i])};return itext.resetItextList=resetItextList,itext.removeMugItext=function(mug){var labelItext,hintItext,constraintItext,mug=mug;mug&&(mug.controlElement&&(labelItext=mug.controlElement.labelItextID,hintItext=mug.controlElement.hintItextID,labelItext&&this.removeItem(labelItext),hintItext&&this.removeItem(hintItext)),mug.bindElement&&(constraintItext=mug.bindElement.constraintMsgItextID,constraintItext&&this.removeItem(constraintItext)))},itext.updateForNewMug=function(mug){return this.updateForMug(mug,mug.getDefaultLabelValue())},itext.updateForExistingMug=function(mug){return this.updateForMug(mug,mug.getLabelValue())},itext.updateForMug=function(mug,defaultLabelValue){mug.controlElement&&(mug.controlElement.labelItextID||(mug.controlElement.labelItextID=mug.getDefaultLabelItext(defaultLabelValue),this.addItem(mug.controlElement.labelItextID)),"notallowed"===mug.controlElement.__spec.hintItextID.presence||mug.controlElement.hintItextID||(mug.controlElement.hintItextID=this.createItem(""))),mug.bindElement&&("notallowed"===mug.bindElement.__spec.constraintMsgItextID.presence||mug.bindElement.constraintMsgItextID||(mug.bindElement.constraintMsgItextID=this.createItem("")))},itext},iTextIDWidget=function(mug,options){var widget=formdesigner.widgets.textWidget(mug,options);widget.isSelectItem="Item"===mug.__className,widget.parentMug=widget.isSelectItem?widget.mug.parentMug:null,widget.langs=formdesigner.pluginManager.javaRosa.Itext.getLanguages();var $input=widget.getControl();widget.getRootId=function(){return widget.isSelectItem&&" "!=widget.parentMug?widget.parentMug.getDefaultItextRoot()+"-":""},widget.getNodeId=function(){if(widget.isSelectItem){var val=widget.mug.controlElement.defaultValue;return val?val:"null"}return widget.mug.getDefaultItextRoot()},widget.getItextType=function(){return widget.propName.replace("ItextID","")},widget.autoGenerateId=function(nodeId){return widget.getRootId()+nodeId+"-"+widget.getItextType()},widget.setUIValue=function(val){$input.val(val)},widget.updateAutoId=function(){widget.setUIValue(widget.autoGenerateId(widget.getNodeId()))},widget.setValue=function(value){widget.setUIValue(value.id)},widget.getValue=function(){return $input.val()};var autoBoxId=widget.getID()+"-auto-itext",$autoBox=$("<input />").attr("type","checkbox").attr("id",autoBoxId);$autoBox.change(function(){$(this).prop("checked")&&(widget.updateAutoId(),widget.updateValue())}),widget.setAutoMode=function(autoMode){$autoBox.prop("checked",autoMode)},widget.getAutoMode=function(){return $autoBox.prop("checked")},widget.currentValue&&widget.currentValue.id===widget.autoGenerateId(widget.getNodeId())&&widget.setAutoMode(!0);var _getUIElement=widget.getUIElement;return widget.getUIElement=function(){var $uiElem=_getUIElement(),$autoBoxContainer=$("<div />").addClass("pull-right fd-itextID-checkbox-container"),$autoBoxLabel=$("<label />").text("auto?").attr("for",autoBoxId).addClass("checkbox");return $autoBoxLabel.prepend($autoBox),$autoBoxContainer.append($autoBoxLabel),$uiElem.find(".controls").addClass("fd-itextID-controls").before($autoBoxContainer),$uiElem},widget.save=function(){var oldItext=widget.mug.getPropertyValue(this.path),val=widget.getValue();oldItext.id!==val&&(oldItext.id=val,formdesigner.controller.setMugPropertyValue(widget.mug,widget.groupName,widget.propName,oldItext,widget.mug))},widget.mug.on("property-changed",function(e){if(widget.getAutoMode()&&("nodeID"===e.property||widget.isSelectItem&&"defaultValue"===e.property)){var newVal=widget.autoGenerateId(e.val);newVal!==widget.getValue()&&(widget.setUIValue(newVal),widget.updateValue())}}),widget.getControl().keyup(function(){var newVal=$(this).val();newVal!==widget.autoGenerateId(widget.getNodeId())&&widget.setAutoMode(!1)}),widget.handleItextLabelChange=function(e){var currentVal=widget.getValue(),isItextPresent=!1,itextItem=e.itextItem;if(itextItem){var currentForms=itextItem.getForms();isItextPresent=function(){for(var form,f=0;form=currentForms[f];f++)for(var lang,l=0;lang=widget.langs[l];l++)if(form.getValue(lang))return!0;return!1}()}isItextPresent&&!currentVal?(widget.setAutoMode(!0),widget.updateAutoId(),widget.updateValue()):!isItextPresent&&currentVal&&(widget.setAutoMode(!1),widget.setValue({id:""}),widget.updateValue())},widget.mug.on("update-question-itextid",function(e){e.itextType===widget.getItextType()&&widget.handleItextLabelChange(e)}),widget},baseItextBlock=function(mug,options){var Itext=formdesigner.pluginManager.javaRosa.Itext,block={};block.mug=mug,block.itextType=options.itextType,block.languages=Itext.getLanguages(),block.defaultLang=Itext.getDefaultLanguage(),block.getItextByMug=options.getItextByMug,block.forms=options.forms||["default"],block.getItextItem=function(){return block.getItextByMug(block.mug)},block.setValue=function(){},block.getValue=function(){},block.getID=function(){return"itext-block-"+block.itextType},block.getItextWidget=function(){throw"getItextWidget should be overridden"};var $blockUI=$("<div />").attr("id",block.getID()).addClass("itext-block-container");return block.getContainerElement=function(){return $blockUI},block.getFormGroupID=function(form){return"itext-block-"+block.itextType+"-group-"+form},block.getFormGroupContainer=function(form){return $("<div />").attr("id",block.getFormGroupID(form)).addClass("itext-lang-group")},block.getForms=function(){return block.forms},block.getUIElement=function(){var itextWidgetFn=block.getItextWidget();return _.each(block.getForms(),function(form){var $formGroup=block.getFormGroupContainer(form);_.each(block.languages,function(lang){var itextWidget=itextWidgetFn(block.mug,lang,form,options);itextWidget.init(),$formGroup.append(itextWidget.getUIElement())}),$blockUI.append($formGroup)}),$blockUI},block},itextLabelBlock=function(mug,options){var block=baseItextBlock(mug,options);return block.getItextWidget=function(){return itextLabelWidget},block},itextConfigurableBlock=function(mug,options){var block=baseItextBlock(mug,options);block.isCustomAllowed=options.isCustomAllowed,block.activeForms=block.getItextItem().getFormNames(),block.displayName=options.displayName,block.formToIcon=options.formToIcon||{},block.getItextWidget=function(){return itextFormWidget},block.getForms=function(){var customForms=_.difference(block.activeForms,RESERVED_ITEXT_CONTENT_TYPES),relevantForms=_.intersection(block.activeForms,block.forms);return _.union(customForms,relevantForms)};var _getFormGroupContainer=block.getFormGroupContainer;block.getFormGroupContainer=function(form){var $formGroup=_getFormGroupContainer(form);return $formGroup.addClass("itext-lang-group-config").data("formtype",form),$formGroup},block.getAddFormButtonID=function(form){return"itext-block-"+block.itextType+"-add-form-"+form},block.getAddFormButtons=function(){var $buttonGroup=$("<div />").addClass("btn-group itext-options");return _.each(block.forms,function(form){var $btn=$("<div />");$btn.text(form).attr("id",block.getAddFormButtonID(form)).addClass("btn itext-option").click(function(){block.getAddItextFn(form)()});var iconClass=block.formToIcon[form];iconClass&&$btn.prepend($("<i />").addClass(iconClass).after(" ")),-1!=block.activeForms.indexOf(form)&&$btn.addClass("disabled"),$buttonGroup.append($btn)}),block.isCustomAllowed&&$buttonGroup.append(block.getAddCustomItextButton()),$buttonGroup},block.getAddCustomItextButton=function(){var $customButton=$("<button />").text("custom...").addClass("btn").attr("type","button"),newItextBtnId="fd-new-itext-button",newItextInputId="fd-new-itext-input";return $customButton.click(function(){var $modal,$newItemForm,$newItemInput;$modal=formdesigner.ui.generateNewModal("New Content Type",[{id:newItextBtnId,title:"Add",cssClasses:"disabled",attributes:{disabled:"disabled"}}]),$newItemForm=formdesigner.ui.getTemplateObject("#fd-template-control-group",{controlId:newItextInputId,label:"Content Type"}),$newItemInput=$("<input />").attr("type","text").attr("id",newItextInputId),$newItemInput.keyup(function(){var currentValue=$(this).val(),$addButton=$("#"+newItextBtnId);currentValue&&-1==RESERVED_ITEXT_CONTENT_TYPES.indexOf(currentValue)&&-1==block.activeForms.indexOf(currentValue)?$addButton.removeClass("disabled").addClass("btn-primary").removeAttr("disabled"):$addButton.addClass("disabled").removeClass("btn-primary").attr("disabled","disabled")}),$newItemForm.find(".controls").append($newItemInput),$modal.find(".modal-body").append($newItemForm),$("#"+newItextBtnId).click(function(){var newItemType=$newItemInput.val();newItemType&&(block.getAddItextFn($newItemInput.val())(),$modal.modal("hide"))}),$modal.modal("show"),$modal.on("shown",function(){$newItemInput.focus()})}),$customButton},block.deleteItextForm=function(form){var itextItem=block.getItextItem();itextItem&&itextItem.removeForm(form),block.activeForms=_.without(block.activeForms,form)},block.getDeleteFormButton=function(form){var $deleteButton=$($("#fd-template-button-remove").html());return $deleteButton.addClass("pull-right").click(function(){var $formGroup=$("#"+block.getFormGroupID(form));block.deleteItextForm(form),block.mug.fire({type:"question-itext-deleted",form:form}),$formGroup.remove(),$(this).remove(),$("#"+block.getAddFormButtonID(form)).removeClass("disabled")}),$deleteButton},block.getAddItextFn=function(form){var itextWidgetFn=block.getItextWidget();return function(){if(-1==block.activeForms.indexOf(form)){block.activeForms.push(form),$("#"+block.getAddFormButtonID(form)).addClass("disabled");var $groupContainer=block.getFormGroupContainer(form);_.each(block.languages,function(lang){var itextWidget=itextWidgetFn(block.mug,lang,form,options);itextWidget.init(!0),$groupContainer.append(itextWidget.getUIElement())}),$blockUI.find(".new-itext-control-group").after($groupContainer),$groupContainer.before(block.getDeleteFormButton(form))}}};var $blockUI=$("<div />"),_getParentUIElement=block.getUIElement;return block.getUIElement=function(){$blockUI=_getParentUIElement();var $addFormControls=formdesigner.ui.getTemplateObject("#fd-template-control-group",{label:block.displayName,controlId:null});$addFormControls.addClass("new-itext-control-group").find(".controls").append(block.getAddFormButtons()),$blockUI.prepend($addFormControls);var $formGroup=$blockUI.find(".itext-lang-group");return $formGroup.each(function(){$(this).before(block.getDeleteFormButton($(this).data("formtype")))}),$blockUI},block},itextMediaBlock=function(mug,options){var block=itextConfigurableBlock(mug,options);return block.getForms=function(){return _.intersection(block.activeForms,block.forms)},block.getItextWidget=function(){return itextMediaWidget},block},itextLabelWidget=function(mug,language,form,options){var Itext=formdesigner.pluginManager.javaRosa.Itext,widget=formdesigner.widgets.baseWidget(mug);widget.displayName=options.displayName,widget.itextType=options.itextType,widget.form=form||"default",widget.language=language,widget.languageName=formdesigner.langCodeToName[widget.language]||widget.language,widget.showOneLanguage=Itext.getLanguages().length<2,widget.defaultLang=Itext.getDefaultLanguage(),widget.isDefaultLang=widget.language===widget.defaultLang,widget.isSyncedWithDefaultLang=!1,widget.getItextItem=function(){return options.getItextByMug(widget.mug)},widget.getLangDesc=function(){return widget.showOneLanguage?"":" ("+widget.languageName+")"},widget.getDisplayName=function(){return widget.displayName+widget.getLangDesc()},widget.getIDByLang=function(lang){return"itext-"+lang+"-"+widget.itextType},widget.getID=function(){return widget.getIDByLang(widget.language)},widget.init=function(loadDefaults){if(loadDefaults){var defaultValue=widget.getDefaultValue();widget.getItextItem().getOrCreateForm(widget.form),widget.setValue(defaultValue),widget.updateValue()}else{var currentLangValue,defaultLangValue,itextItem=widget.getItextItem();if(!itextItem)return void widget.setValue("");defaultLangValue=itextItem.getValue(widget.form,widget.defaultLang),currentLangValue=itextItem.getValue(widget.form,widget.language),widget.isDefaultLang||widget.setPlaceholder(defaultLangValue),widget.setValue(!widget.isDefaultLang&&defaultLangValue===currentLangValue||!currentLangValue?"":currentLangValue)}};var _updateValue=widget.updateValue;widget.updateValue=function(){if(_updateValue(),!widget.getValue()&&!widget.isDefaultLang){var defaultLangValue=widget.getItextItem().getValue(widget.form,widget.defaultLang);widget.setItextFormValue(defaultLangValue)}},widget.destroy=function(e){e.form===widget.form&&widget.fireChangeEvents()};var $input=$("<input />").attr("id",widget.getID()).attr("type","text").addClass("input-block-level itext-widget-input").on("change keyup",widget.updateValue);return widget.mug.on("question-itext-deleted",widget.destroy),widget.getControl=function(){return $input},widget.toggleDefaultLangSync=function(val){widget.isSyncedWithDefaultLang=!val&&!widget.isDefaultLang},widget.setValue=function(val){$input.val(val)},widget.setPlaceholder=function(val){$input.attr("placeholder",val)},widget.getValue=function(){return $input.val()},widget.getDefaultValue=function(){return null},widget.isDefaultLang||widget.mug.on("defaultLanguage-itext-changed",function(e){if(e.form==widget.form&&e.itextType==widget.itextType){var defaultLangValue,currentLangValue,itextItem=widget.getItextItem();defaultLangValue=itextItem.getValue(widget.form,widget.defaultLang),currentLangValue=itextItem.getValue(widget.form,widget.language),widget.setPlaceholder(e.value),(currentLangValue===e.prevValue&&!widget.getValue()||!currentLangValue)&&widget.setItextFormValue(e.value)}}),widget.fireChangeEvents=function(){var itextItem=widget.getItextItem();itextItem&&(formdesigner.controller.fire({type:"question-itext-changed",language:widget.language,item:itextItem,form:widget.form,value:itextItem.getValue(widget.form,widget.language)}),formdesigner.controller.form.fire({type:"form-property-changed"}),widget.mug.fire({type:"update-question-itextid",itextType:widget.itextType,itextItem:itextItem}))},widget.save=function(){widget.setItextFormValue(widget.getValue())},widget.setItextFormValue=function(value){var itextItem=widget.getItextItem();if(itextItem){widget.isDefaultLang&&widget.mug.fire({type:"defaultLanguage-itext-changed",form:widget.form,prevValue:itextItem.getValue(widget.form,widget.language),value:value,itextType:widget.itextType});var itextForm=itextItem.getForm(widget.form);itextForm.setValue(widget.language,value),widget.fireChangeEvents()}},widget},itextFormWidget=function(mug,language,form,options){var widget=itextLabelWidget(mug,language,form,options);widget.getDisplayName=function(){return form+widget.getLangDesc()};var _getID=widget.getID;return widget.getID=function(){return _getID()+"-"+form},widget},itextMediaWidget=function(mug,language,form,options){var widget=itextFormWidget(mug,language,form,options);widget.mediaRef=formdesigner.multimedia.multimediaReference(form);var $input=widget.getControl();widget.getDefaultValue=function(){if(-1!=formdesigner.multimedia.SUPPORTED_MEDIA_TYPES.indexOf(form)){var extension=formdesigner.multimedia.DEFAULT_EXTENSIONS[form];return"jr://file/commcare/"+form+"/"+formdesigner.controller.form.formID+"/"+widget.mug.getDefaultItextRoot()+"."+extension}return null},widget.getPreviewUI=function(){var $preview,currentPath=widget.getValue();if(currentPath||widget.isDefaultLang||(currentPath=widget.getItextItem().getValue(widget.form,widget.defaultLang)),currentPath in formdesigner.multimedia.objectMap){var linkedObject=formdesigner.multimedia.objectMap[currentPath];$preview=_.template($(formdesigner.multimedia.PREVIEW_TEMPLATES[form]).text(),{url:linkedObject.url})}else $preview=_.template($("#fd-template-multimedia-nomedia").text(),{iconClass:formdesigner.multimedia.ICONS[form]});return $preview},widget.getUploadButtonUI=function(){var $uploadBtn,currentPath=widget.getValue();return $uploadBtn=formdesigner.ui.getTemplateObject("#fd-template-multimedia-upload-trigger",{multimediaExists:currentPath in formdesigner.multimedia.objectMap,uploaderId:formdesigner.multimedia.SLUG_TO_CONTROL[form].uploaderSlug,mediaType:form}),$uploadBtn.click(function(){widget.mediaRef.updateController()}),$uploadBtn},widget.getPreviewID=function(){return widget.getID()+"-preview-block"},widget.getUploadID=function(){return widget.getID()+"-upload-block"};var $uiElem=$("<div />"),_getParentUIElement=widget.getUIElement;return widget.getUIElement=function(){$uiElem=_getParentUIElement();var $controlBlock=$uiElem.find(".controls"),$previewContainer=$("<div />").attr("id",widget.getPreviewID()).addClass("fd-mm-preview-container"),$uploadContainer=$("<div />").attr("id",widget.getUploadID()).addClass("fd-mm-upload-container");return $controlBlock.empty().addClass("control-row").attr("data-form",form),widget.updateReference(),$previewContainer.attr("id",widget.getPreviewID()).html(widget.getPreviewUI()),$controlBlock.append($previewContainer),formdesigner.multimedia.isUploadEnabled?($uploadContainer.html($("#fd-template-multimedia-block").html()),$uploadContainer.find(".fd-mm-upload-trigger").append(widget.getUploadButtonUI()),$uploadContainer.find(".fd-mm-path-input").append($input),$uploadContainer.find(".fd-mm-path-show").click(function(e){var $showBtn=$(this);$showBtn.addClass("hide"),$("#"+widget.getUploadID()).find(".fd-mm-path").removeClass("hide"),e.preventDefault()}),$uploadContainer.find(".fd-mm-path-hide").click(function(e){var $hideBtn=$(this);$hideBtn.parent().addClass("hide"),$("#"+widget.getUploadID()).find(".fd-mm-path-show").removeClass("hide"),e.preventDefault()})):$uploadContainer.append($input),$controlBlock.append($uploadContainer),$uiElem.on("mediaUploadComplete",widget.handleUploadComplete),$input.bind("change keyup",widget.updateValue),$input.bind("change keyup",widget.updateMultimediaBlockUI),$uiElem},widget.updateReference=function(){var currentPath=widget.getValue();$uiElem.attr("data-hqmediapath",currentPath),widget.mediaRef.updateRef(currentPath)},widget.updateMultimediaBlockUI=function(){$("#"+widget.getPreviewID()).html(widget.getPreviewUI()).find(".existing-media").tooltip(),$uiElem.find(".fd-mm-upload-trigger").empty().append(widget.getUploadButtonUI()),widget.updateReference()},widget.handleUploadComplete=function(event,data){data.ref&&data.ref.path&&(formdesigner.multimedia.objectMap[data.ref.path]=data.ref),widget.updateMultimediaBlockUI()},widget},parseXLSItext=function(str,Itext){var i,j,k,cells,lang,iID,form,val,rows=str.split("\n"),exportCols=["default","audio","image","video"],languages=Itext.getLanguages();for(i=1;i<rows.length;i++)for(cells=rows[i].split("	"),iID=cells[0],j=0;j<exportCols.length;j++){var form=exportCols[j];for(k=0;k<languages.length;k++)cells[1+j*languages.length+k]&&(lang=languages[k],val=cells[1+j*languages.length+k],Itext.getOrCreateItem(iID).getOrCreateForm(form).setValue(lang,val))}formdesigner.controller.fire({type:"global-itext-changed"});var currentMug=formdesigner.controller.getCurrentlySelectedMug();currentMug&&formdesigner.ui.displayMugProperties(currentMug)},generateItextXLS=function(Itext){function getItemFormValues(item,languages,form){for(var ret=[],i=0;i<languages.length;i++){var language=languages[i],value=item.hasForm(form)?item.getForm(form).getValueOrDefault(language):"";ret.push(value)}return ret.join("	")}function makeRow(languages,item,forms){var questions=getItemFormValues(item,languages,forms[0]),audios=getItemFormValues(item,languages,forms[1]),images=getItemFormValues(item,languages,forms[2]),videos=getItemFormValues(item,languages,forms[3]),row=[item.id,questions,audios,images,videos];return row.join("	")}function makeHeadings(languages,exportCols){var header_row=["label"];for(i=0;i<exportCols.length;i++)for(j=0;j<languages.length;j++)header_row.push(exportCols[i]+"-"+languages[j]);return header_row.join("	")}formdesigner.pluginManager.call("preSerialize");var item,i,j,ret=[],exportCols=["default","audio","image","video"],languages=Itext.getLanguages(),allItems=Itext.getNonEmptyItems();if(languages.length>0)for(ret.push(makeHeadings(languages,exportCols)),i=0;i<allItems.length;i++)item=allItems[i],ret.push(makeRow(languages,item,exportCols));return ret.join("\n")},showItextDialog=function(Itext){var $modal,$updateForm,$textarea;$modal=formdesigner.ui.generateNewModal("Edit Bulk Translations",[{id:"fd-update-translations-button",title:"Update Translations",cssClasses:"btn-primary"}]),$updateForm=formdesigner.ui.getTemplateObject("#fd-template-form-edit-source",{description:"Copy these translations into a spreadsheet program like Excel. You can edit them there and then paste them back here when you're done. These will update the translations used in your form. Press 'Update Translations' to save changes, or 'Close' to cancel."}),$modal.find(".modal-body").html($updateForm),$textarea=$updateForm.find("textarea"),$textarea.val(generateItextXLS(Itext)),$modal.find("#fd-update-translations-button").click(function(){parseXLSItext($textarea.val(),Itext),formdesigner.controller.form.fire("form-property-changed"),$modal.modal("hide")}),$modal.modal("show")};if("undefined"==typeof formdesigner)var formdesigner={};if(formdesigner.plugins=formdesigner.plugins||{},formdesigner.plugins.javaRosa=function(options){this.options=options,this.Itext=ItextModel();var Itext=this.Itext;this.beforeParse=function(xml){function eachLang(){function eachText(){function eachValue(){var valEl=$(this),curForm=valEl.attr("form");curForm||(curForm="default"),item.getOrCreateForm(curForm).setValue(lang,formdesigner.util.getXLabelValue(valEl))}var textEl=$(this),id=textEl.attr("id"),item=Itext.getOrCreateItem(id);textEl.children().each(eachValue)}var el=$(this),lang=el.attr("lang");Itext.addLanguage(lang),void 0!==el.attr("default")&&Itext.setDefaultLanguage(lang),el.children().each(eachText)}var head=xml.find("h\\:head, head"),itextBlock=head.find("itext");if(Itext.clear(),formdesigner.opts.langs&&formdesigner.opts.langs.length>0){for(var i=0;i<formdesigner.opts.langs.length;i++)Itext.addLanguage(formdesigner.opts.langs[i]);Itext.setDefaultLanguage(formdesigner.opts.langs[0])}return $(itextBlock).children().each(eachLang),0===Itext.getLanguages().length&&(Itext.addLanguage("en"),Itext.setDefaultLanguage("en")),formdesigner.currentItextDisplayLanguage||(formdesigner.currentItextDisplayLanguage=Itext.getDefaultLanguage()),xml},this.contributeToModelXML=function(xmlWriter){var lang,val,form,i,item,forms,form,languages=Itext.getLanguages(),allItems=Itext.getNonEmptyItems();if(languages.length>0){xmlWriter.writeStartElement("itext");for(var i=0;i<languages.length;i++){lang=languages[i],xmlWriter.writeStartElement("translation"),xmlWriter.writeAttributeStringSafe("lang",lang),Itext.getDefaultLanguage()===lang&&xmlWriter.writeAttributeStringSafe("default","");for(var j=0;j<allItems.length;j++){item=allItems[j],xmlWriter.writeStartElement("text"),xmlWriter.writeAttributeStringSafe("id",item.id),forms=item.getForms();for(var k=0;k<forms.length;k++)form=forms[k],val=form.getValueOrDefault(lang),xmlWriter.writeStartElement("value"),"default"!==form.name&&xmlWriter.writeAttributeStringSafe("form",form.name),xmlWriter.writeString(val),xmlWriter.writeEndElement();xmlWriter.writeEndElement()}xmlWriter.writeEndElement()}xmlWriter.writeEndElement()}},this.onMugUpdateOrCreate=function(){},this.preSerialize=function(){Itext.deduplicateIds();var validIds=formdesigner.controller.getAllNonEmptyItextItemsFromMugs();Itext.resetItextList(validIds)},this.contributeToMugClass=function(){};var validateItextItem=function(itextItem,name){if(itextItem){var val=itextItem.defaultValue();if(itextItem.id&&!val)return"Question has "+name+" ID but no "+name+" label!";if(val&&!itextItem.id)return"Question has "+name+" label but no "+name+" ID!"}return"pass"};this.contributeToDataElementSpec=function(spec){return spec.keyAttr={editable:"w",visibility:"visible",presence:"optional",lstring:"JR:Preload key value"},spec},this.contributeToBindElementSpec=function(spec,mug){return spec.preload={editable:"w",visibility:"visible",presence:"optional",lstring:"JR Preload"},spec.preloadParams={editable:"w",visibility:"visible",presence:"optional",lstring:"JR Preload Param"},spec.constraintMsgAttr.visibility="visible_if_present",spec.constraintMsgItextID={editable:"w",visibility:"visible",presence:"optional",lstring:"Validation Error Message ID",uiType:iTextIDWidget,validationFunc:function(mug){var bindElement=mug.bindElement,constraintItext=bindElement.constraintMsgItextID;return constraintItext&&constraintItext.id&&!formdesigner.util.isValidAttributeValue(constraintItext.id)?constraintItext.id+" is not a valid ID":constraintItext&&constraintItext.id&&!bindElement.constraintAttr?"Can't have a Validation Message ID without a Validation Condition":validateItextItem(constraintItext,"Validation Error Message")}},mug.isSpecialGroup&&(spec.constraintMsgItextID.presence="notallowed"),spec
},this.contributeToControlElementSpec=function(spec,mug){return spec.label.visibility="visible_if_present",spec.hintLabel.visibility="visible_if_present",spec.labelItext={editable:"w",visibility:"controlElement/labelItextID",presence:"optional",uiType:itextLabelBlock,widgetOptions:{itextType:"label",getItextByMug:function(mug){return mug.controlElement.labelItextID},displayName:"Label"},lstring:"Label"},spec.labelItextID={editable:"w",visibility:"visible",presence:"optional",lstring:"Question Itext ID",uiType:iTextIDWidget,validationFunc:spec.label.validationFunc,widgetOptions:{displayName:"Add Other Content",itextType:"label",getItextByMug:function(mug){return mug.controlElement.labelItextID},forms:["long","short"],isCustomAllowed:!0}},spec.hintItext={editable:"w",visibility:"controlElement/hintItextID",uiType:itextLabelBlock,widgetOptions:{itextType:"hint",getItextByMug:function(mug){return mug.controlElement.hintItextID},displayName:"Hint Message"}},spec.hintItextID={editable:"w",visibility:"visible",presence:"optional",lstring:"Hint Itext ID",uiType:iTextIDWidget,validationFunc:function(mug){var hintItext,controlElement;return controlElement=mug.controlElement,hintItext=controlElement.hintItextID,hintItext&&hintItext.id&&!formdesigner.util.isValidAttributeValue(hintItext.id)?hintItext.id+" is not a valid ID":"required"!==mug.controlElement.__spec.hintItextID.presence||hintItext.id?validateItextItem(hintItext,"Hint"):"Hint ID is required but not present in this question!"},widgetOptions:{itextType:"hint",getItextByMug:function(mug){return mug.controlElement.hintItextID},displayName:"Hint Message"}},spec.constraintMsgItext={editable:"w",visibility:"bindElement/constraintMsgItextID",presence:"optional",uiType:itextLabelBlock,widgetOptions:{itextType:"constraintMsg",getItextByMug:function(mug){return mug.bindElement.constraintMsgItextID},displayName:"Validation Message"},lstring:"Validation Message"},spec.otherItext={editable:"w",visibility:"controlElement/labelItextID",presence:"optional",lstring:"Add Other Content",uiType:itextConfigurableBlock,widgetOptions:{displayName:"Add Other Content",itextType:"label",getItextByMug:function(mug){return mug.controlElement.labelItextID},forms:["long","short"],isCustomAllowed:!0}},spec.mediaItext={editable:"w",visibility:"controlElement/labelItextID",presence:"optional",lstring:"Add Multimedia",uiType:itextMediaBlock,widgetOptions:{displayName:"Add Multimedia",itextType:"label",getItextByMug:function(mug){return mug.controlElement.labelItextID},forms:formdesigner.multimedia.SUPPORTED_MEDIA_TYPES,formToIcon:formdesigner.multimedia.ICONS}},mug.isSpecialGroup&&(spec.hintItextID.presence="notallowed",delete spec.otherItext,delete spec.mediaItext),spec},this.contributeToMainProperties=function(properties){return properties.splice(1+properties.indexOf("controlElement/label"),0,"controlElement/labelItext"),properties},this.contributeToLogicProperties=function(properties){return properties.splice(1+properties.indexOf("bindElement/constraintAttr"),0,"controlElement/constraintMsgItext"),properties},this.contributeToAdvancedProperties=function(properties){return properties.splice(1+properties.indexOf("dataElement/xmlnsAttr"),0,"dataElement/keyAttr","bindElement/preload","bindElement/preloadParams"),properties=properties.concat(["controlElement/labelItextID","bindElement/constraintMsgItextID","controlElement/hintItextID","controlElement/hintItext","controlElement/otherItext"])},this.getAccordions=function(){},this.getAboveTreeWidgets=function(){},this.getToolsMenuItems=function(){return[{name:"Edit Bulk Translations",action:function(){showItextDialog(Itext)}}]},this.getFormErrors=function(){var itextValidation=Itext.validateItext();return itextValidation!==!0?itextValidation:void 0},this.reset=function(){}},formdesigner.plugins=formdesigner.plugins||{},formdesigner.plugins.ignoreButRetain=function(){function prependChild(element,child){element.firstElementChild?$(element).prepend($(child)):$(element).append($(child))}function getPathAndPosition(node){var position,origNode=node,path=[];for(position=getPreviousSiblingSelector(node),node=node.parentElement;node;)path.unshift(getNodeIdentifierSelector(node)),node=node.parentElement;var nodeXML=xmls.serializeToString(origNode).replace(/xmlns="(.*?)"/,"");return{position:position,path:path.join(" > "),nodeXML:"\n"+nodeXML}}function getPreviousSiblingSelector(node){return node.previousElementSibling?getNodeIdentifierSelector(node.previousElementSibling):!1}function getNodeIdentifierSelector(node){var $node=$(node),nodeset=$node.attr("nodeset"),ref=$node.attr("ref"),tagName=$node.prop("tagName").toLowerCase();return"setvalue"==tagName?'[event="'+$node.attr("event")+'"][ref="'+ref+'"]':nodeset?'[nodeset="'+nodeset+'"]':ref?'[ref="'+ref+'"]':node.nodeName.replace(":","\\:")}var ignoredNodes,xmls=new XMLSerializer;this.beforeParse=function(xml){ignoredNodes=[];var ignoredEls=[];return xml.find('[vellum\\:ignore="retain"]').each(function(i,el){ignoredNodes.push(getPathAndPosition(el)),ignoredEls.push(el)}),_.each(ignoredEls,function(el){el.parentElement.removeChild(el)}),xml},this.afterSerialize=function(xmlStr){if(!ignoredNodes.length)return xmlStr;var xml=$($.parseXML(xmlStr));_.each(ignoredNodes,function(node){"h\\:html > h\\:body"===node.path&&(node.path="h\\:html > body, h\\:html > h\\:body");var parentNode=xml.find(node.path),appendNode=$.parseXML(node.nodeXML).children[0];if(node.position){var target=parentNode.find(node.position);target.length?target.after($(appendNode)):prependChild(parentNode[0],appendNode)}else prependChild(parentNode[0],appendNode)});var count=0;return xmls.serializeToString(xml[0]).replace(/ xmlns=""/g,"").replace(/ xmlns:vellum="(.+?)"/g,function(match){return count++?"":match})},this.onMugRename=function(newID,oldID,newPath,oldPath){var pathRegex=new RegExp(oldPath,"g"),idNameRegex=new RegExp("(> )?"+oldID+"( >)?","g"),idRegex=new RegExp("('|\")"+oldID+"(-label)?('|\")","g"),replaceIdInSelector=function(val){var replaced=!1;return val=val.replace(idNameRegex,function(match){return-1!==match.indexOf(oldID)&&-1===match.indexOf(newID)?(replaced=!0,match.replace(oldID,newID)):match}),val=val.replace(idRegex,function(match){return replaced||-1===match.indexOf(oldID)||-1!==match.indexOf(newID)?match:match.replace(oldID,newID)})};_.each(ignoredNodes,function(node){node.position&&(node.position=replaceIdInSelector(node.position)),node.path=replaceIdInSelector(node.path),node.nodeXML=node.nodeXML.replace(pathRegex,newPath)})}},formdesigner.plugins=formdesigner.plugins||{},formdesigner.plugins.lock=function(){var locks;this.beforeParse=function(){locks={}},this.parseBindElement=function(el,path){var locked=el.attr("vellum:lock");return locked&&"none"!==locked&&(locks[path]=locked),el},this.isPropertyLocked=function(mugPath,propertyPath){var lock=locks[mugPath];return lock?"node"!==lock&&"value"!==lock||"dataElement/nodeID"!==propertyPath?"value"===lock&&-1===propertyPath.indexOf("ItextID")?!0:!1:!0:!1},this.isMugPathMoveable=function(mugPath){return!locks[mugPath]},this.isMugRemoveable=function(mugPath){return!locks[mugPath]},this.isMugTypeChangeable=function(mugPath){return"value"!==locks[mugPath]}},"undefined"==typeof formdesigner)var formdesigner={};if(formdesigner.windowManager=function(){"use strict";var that={};return that.init=function(){formdesigner.windowConfig=formdesigner.windowConfig||{},$(window).resize(that.adjustToWindow),$(document).scroll(that.adjustToWindow),that.minHeight=formdesigner.windowConfig.minHeight||200,that.offset={top:formdesigner.windowConfig.topOffset||$("#formdesigner").offset().top-1,bottom:formdesigner.windowConfig.bottomOffset||0,left:formdesigner.windowConfig.leftOffset||$("#formdesigner").offset().left},that.adjustToWindow()},that.adjustToWindow=function(){var $fd=$("#formdesigner");if($fd.is(":visible")){var availableHorizSpace,availableVertSpace=$(window).height()-that.getCurrentTopOffset(),position=0===that.getCurrentTopOffset()?"fixed":"static",$formdesigner=$("#fd-ui-container");$formdesigner.parent().css("height",availableVertSpace+"px"),availableVertSpace-=that.getCurrentBottomOffset(),$formdesigner.css("height",availableVertSpace+"px"),$formdesigner.css("width",$formdesigner.parent().width()).css("position",position).css("left",that.getCurrentLeftOffset()+"px"),availableHorizSpace=$fd.width();var panelHeight,columnHeight,treeHeight,availableColumnSpace=availableVertSpace-$(".fd-toolbar").outerHeight();panelHeight=Math.max(availableColumnSpace-5,that.minHeight),columnHeight=panelHeight-$(".fd-head").outerHeight(),treeHeight=columnHeight,$formdesigner.find(".fd-content").css("height",panelHeight+"px"),$formdesigner.find(".fd-content-left").find(".fd-scrollable").css("height",treeHeight+"px"),$formdesigner.find(".fd-content-right").css("width",availableHorizSpace-that.geLeftWidth()+"px").find(".fd-scrollable.full").css("height",columnHeight+"px"),$formdesigner.find("#fd-props-scrollable").css("height",columnHeight-$("#fd-props-toolbar").outerHeight(!0)+"px")}},that.geLeftWidth=function(){return $(".fd-content-left").outerWidth()+$(".fd-content-divider").outerWidth(!0)+2},that.getCurrentTopOffset=function(){var scrollPosition=$(window).scrollTop(),topOffset="function"==typeof that.offset.top?that.offset.top():that.offset.top;return Math.min(Math.max(topOffset-scrollPosition,0),topOffset)},that.getCurrentBottomOffset=function(){return"function"==typeof that.offset.bottom?that.offset.bottom():that.offset.bottom},that.getCurrentLeftOffset=function(){var scrollLeft=$(window).scrollLeft(),offsetLeft="function"==typeof that.offset.left?that.offset.left():that.offset.left;return Math.min(offsetLeft-scrollLeft,offsetLeft)},that}(),function($){$.fn.popAttr=function(name){var val=this.attr(name);try{this.removeAttr(name)}catch(e){}return val}}(jQuery),"function"!=typeof Object.create&&(Object.create=function(obj){var Blank_Function=function(){};return Blank_Function.prototype=obj,new Blank_Function}),"undefined"==typeof String.prototype.trim&&(String.prototype.trim=function(){return String(this).replace(/^\s+|\s+$/g,"")}),"undefined"==typeof formdesigner)var formdesigner={};if(formdesigner.util=function(){function fromCamelToRegularCase(myString){var ret;return ret=myString.replace(/([A-Z])/g," $1").replace(/^./,function(str){return str.toUpperCase()})}function getNodeIDFromPath(path){if(!path)return null;var arr=path.split("/");return arr[arr.length-1]}function getPathFromControlElement(el){if(!el)return null;el=$(el);var path=el.attr("ref");return path||(path=el.attr("nodeset")),path||null}function clone(obj){var copy,i;if(null===obj||"object"!=typeof obj)return obj;if(obj instanceof Date)return copy=new Date,copy.setTime(obj.getTime()),copy;if(obj instanceof Array){var len;for(copy=[],i=0,len=obj.length;len>i;++i)copy[i]=clone(obj[i]);return copy}if(obj instanceof Object){copy={};for(var attr in obj)obj.hasOwnProperty(attr)&&(copy[attr]=clone(obj[attr]));return copy}throw new Error("Unable to copy obj! Its type isn't supported.")}var that={},VERIFY_CODES={VERIFY_SUCCESS:0,VERIFY_FAIL:1,VERIFY_NO_DEFINITION:2,VERIFY_ERROR:3};that.VERIFY_CODES=VERIFY_CODES,that.XPATH_REFERENCES=["bindElement/relevantAttr","bindElement/calculateAttr","bindElement/constraintAttr"],that.isValidAttributeValue=function(value){return/^[^<&'"]*$/.test(value)};var xmls=new XMLSerializer;that.getXLabelValue=function(el){function getEndTag(str){var res,reo,last;for(reo=/<\/(?:"[^"]*"['"]*|'[^']*'['"]*|[^'">])+>/g,res=reo.exec(str),last=res;null!==res;)last=res,res=reo.exec(str);return last?last[0]:null}function getStartTag(str){var re,res;return re=/<(?:"[^"]*"['"]*|'[^']*'['"]*|[^'">])+>/,res=re.exec(str),res[0]}var resStr,resEl;return(resEl=$(el)[0])?(resStr=xmls.serializeToString(resEl),resStr=resStr.replace(getStartTag(resStr),"").replace(getEndTag(resStr),""),resStr=resStr.replace(new RegExp(String.fromCharCode(10),"g"),"&#10;")):void 0},that.fromCamelToRegularCase=fromCamelToRegularCase;var mergeArray=function(arrA,arrB){var i,result=[];for(i in arrA)arrA.hasOwnProperty(i)&&-1===arrA.slice(0,arrA.indexOf(i)).indexOf(i)&&result.push(arrA[i]);for(i in arrB)arrB.hasOwnProperty(i)&&-1===result.indexOf(arrB[i])&&result.push(arrB[i]);return result};that.mergeArray=mergeArray,that.getNodeIDFromPath=getNodeIDFromPath,that.getPathFromControlElement=getPathFromControlElement,that.clone=clone,that.question_counter=1;var label_maker=function(prefixStr){var ret=prefixStr+that.question_counter;return that.question_counter+=1,ret};that.generate_question_id=function(question_id){if(!question_id)return label_maker("question");var match=/^copy-(\d+)-of-(.+)$/.exec(question_id);match&&(question_id=match[2]);for(var i=1;;i++){var new_id="copy-"+i+"-of-"+question_id;if(!formdesigner.model.questionIdCount(new_id))return new_id}};var generate_item_label=function(){return label_maker("item")};that.generate_item_label=generate_item_label,that.getAttributes=function(element){for(var attributes=$(element)[0].attributes,attrMap={},i=0;i<attributes.length;i++)attrMap[attributes[i].nodeName]=attributes[i].nodeValue;return attrMap},that.eventuality=function(that){var registry={};return that.fire=function(event){var array,func,handler,i,type="string"==typeof event?event:event.type;if(registry.hasOwnProperty(type))for(array=registry[type],i=0;i<array.length;i+=1)handler=array[i],func=handler.method,"string"==typeof func&&(func=this[func]),func.apply(this,handler.parameters||[event]);return this},that.on=function(type,method,parameters){var handler={method:method,parameters:parameters};return registry.hasOwnProperty(type)?registry[type].push(handler):registry[type]=[handler],this},that},that.pluralize=function(noun,n){return noun+(1!==n?"s":"")};var generate_guid=function(){var S4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return S4()+S4()+S4()+S4()+S4()+S4()+S4()+S4()};return that.generate_xmlns_uuid=function(){var r,i,CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",uuid=[];for(uuid[8]=uuid[13]=uuid[18]=uuid[23]="-",uuid[14]="4",i=0;36>i;i++)uuid[i]||(r=Math.floor(16*Math.random()),uuid[i]=CHARS[19==i?3&r|8:15&r]);return uuid.toString().replace(/,/g,"")},that.give_ufid=function(that){that.ufid=generate_guid()},that.setStandardMugEventResponses=function(mug){mug.on("property-changed",function(e){"nodeID"===e.property&&(this.dataElement&&(this.dataElement.nodeID=e.val),this.bindElement&&(this.bindElement.nodeID=e.val));var mug=formdesigner.controller.getMugFromFormByUFID(e.mugUfid);if(formdesigner.ui.showVisualValidation(mug),formdesigner.ui.setTreeValidationIcon(mug),e.previous!==e.val){var mug=formdesigner.controller.getMugFromFormByUFID(e.mugUfid);if("nodeID"===e.property){var currentPath=formdesigner.controller.form.dataTree.getAbsolutePath(mug),parsed=xpath.parse(currentPath);parsed.steps[parsed.steps.length-1].name=e.previous;var oldPath=parsed.toXPath();formdesigner.model.LogicManager.updatePath(mug.ufid,oldPath,currentPath),formdesigner.pluginManager.call("onMugRename",e.val,e.previous,currentPath,oldPath)}else{var propertyPath=[e.element,e.property].join("/");mug.getPropertyDefinition(propertyPath).uiType===formdesigner.widgets.xPathWidget&&formdesigner.model.LogicManager.updateReferences(mug,propertyPath)}}if("nodeID"===e.property&&("Select"===mug.__className||"MSelect"===mug.__className))for(var node=formdesigner.controller.form.controlTree.getNodeFromMug(mug),children=node.getChildrenMugs(),mug=this,setNodeID=function(val){mug.dataElement.nodeID=val,mug.bindElement.nodeID=val},i=0;i<children.length;i++){var child=children[i];setNodeID(e.previous),child.controlElement.labelItextID.id===child.getDefaultLabelItextId()?(setNodeID(e.val),child.setItextID(child.getDefaultLabelItextId())):setNodeID(e.val)}})},that.setStandardFormEventResponses=function(form){form.on("form-property-changed",function(){var mug=formdesigner.controller.getCurrentlySelectedMug();mug&&(formdesigner.ui.showVisualValidation(mug),formdesigner.ui.setTreeValidationIcon(mug))}),form.on("form-property-changed",function(){formdesigner.controller.setFormChanged()})},that.getMugDisplayName=function(mug){var itextItem,cEl,dEl,bEl,disp,lang,Itext;if(!mug)return"No Name!";if("ReadOnly"===mug.__className)return"Unknown (read-only) question type";cEl=mug.controlElement,dEl=mug.dataElement,bEl=mug.bindElement,Itext=formdesigner.pluginManager.javaRosa.Itext,cEl&&(itextItem=cEl.labelItextID);var getNodeID=function(){var nodeID;return bEl&&(nodeID=bEl.nodeID),nodeID||dEl&&(nodeID=dEl.nodeID),nodeID=nodeID||cEl.defaultValue,nodeID?"["+nodeID+"]":void 0};return itextItem?(lang=formdesigner.currentItextDisplayLanguage||Itext.getDefaultLanguage())?(disp=itextItem.getValue("default",lang),disp?disp:getNodeID()):"No Translation Data":getNodeID()},that.isValidElementName=function(name){var elementNameRegex=/^(?!XML)[a-zA-Z][\w0-9-]*$/;return elementNameRegex.test(name)},that.escapeQuotedXML=function(text,options){if(text=""+text,!text)return"";var escapeQuotes=options&&options.hasOwnProperty("escapeQuotes")?options.escapeQuotes:!0;return options&&options.escapeAmpersands&&(text=text.replace(/&/,"&amp;")),text=text.replace(/</g,"&lt;"),text=text.replace(/>/g,"&gt;"),options&&options.escapeApostrophes&&(text=text.replace(/'/g,"&apos;")),escapeQuotes&&(text=text.replace(/"/g,"&quot;")),text},XMLWriter.prototype.writeAttributeStringSafe=function(name,value,options){return this.writeAttributeString(name,that.escapeQuotedXML(value,options))},that.tabSeparate=function(list){var cleanVal=function(val){return val.replace(/\n/g," ")};return list.map(cleanVal).join("	")},that.mugToXPathReference=function(mug){return"Item"===mug.__className?'"'+mug.controlElement.defaultValue+'"':mug.ufid===formdesigner.controller.getCurrentlySelectedMug().ufid?".":formdesigner.controller.form.dataTree.getAbsolutePath(mug)},that.parseBoolAttributeValue=function(attrString){if(!attrString)return null;var str=attrString.toLowerCase().replace(/\s/g,"");return"true()"===str?!0:"false()"===str?!1:null},that.createXPathBoolFromJS=function(req){return req===!0||"true"===req?"true()":req===!1||"false"===req?"false()":null},that.getOneOrFail=function(list,infoMsg){if(0===list.length)throw"No match for "+infoMsg+" found!";if(list.length>1)throw"Multiple matches for "+infoMsg+" found!";return list[0]},that.reduceToOne=function(list,func,infoMsg){return that.getOneOrFail(_(list).filter(func),infoMsg)},that}(),$.fn.stopLink=function(){return this.click(function(e){e.preventDefault()}),this},$.fn.fdHelp=function(){return this.append($("<i />").addClass("icon-question-sign")).popout({trigger:"hover",html:!0}),this},"undefined"==typeof formdesigner)var formdesigner={};if(formdesigner.multimedia=function(){"use strict";function MultimediaController(uploaderSlug,mediaTypeSlug,sessionid){var media=this;media.uploaderSlug=uploaderSlug,media.mediaType=mediaTypeSlug,media.getUploadModal=function(){return _.template($("#fd-template-multimedia-modal").text(),{mediaType:media.mediaType,modalId:media.uploaderSlug})},media.initUploadController=function(){var $uploaderModal=$(media.getUploadModal());$("#fd-multimedia-modal-container").append($uploaderModal),media.uploadController=new formdesigner.multimediaConfig.uploadControllerClass(media.uploaderSlug,media.mediaType,{fileFilters:that.SUPPORTED_EXTENSIONS[media.mediaType],uploadURL:formdesigner.multimediaConfig.uploadUrls[media.mediaType],swfURL:formdesigner.multimediaConfig.swfURL,isMultiFileUpload:!1,queueTemplate:$("#fd-template-multimedia-queue").text(),errorsTemplate:$("#fd-template-multimedia-errors").text(),existingFileTemplate:$(that.PREVIEW_TEMPLATES[media.mediaType]).text(),licensingParams:["shared","license","author","attribution-notes"],uploadParams:{},sessionid:sessionid}),media.uploadController.init()}}var that={};return that.SUPPORTED_MEDIA_TYPES=["image","audio","video"],that.SUPPORTED_EXTENSIONS={image:[{description:"Images",extensions:"*.jpg;*.png;*.gif"}],audio:[{description:"Audio",extensions:"*.mp3;*.wav"}],video:[{description:"Video",extensions:"*.3gp"}]},that.DEFAULT_EXTENSIONS={image:"png",audio:"mp3",video:"3gp"},that.ICONS={image:"icon-picture",audio:"icon-volume-up",video:"icon-facetime-video"},that.PREVIEW_TEMPLATES={image:"#fd-template-multimedia-existing-image",audio:"#fd-template-multimedia-existing-audio",video:"#fd-template-multimedia-existing-video"},that.SLUG_TO_CLASS={image:"CommCareImage",audio:"CommCareAudio",video:"CommCareVideo"},that.objectMap={},that.initControllers=function(sessionid){that.isUploadEnabled=_.isObject(formdesigner.multimediaConfig),that.isUploadEnabled&&(that.imageControl=new MultimediaController("fd_hqimage","image",sessionid),that.imageControl.initUploadController(),that.audioControl=new MultimediaController("fd_hqaudio","audio",sessionid),that.audioControl.initUploadController(),that.videoControl=new MultimediaController("fd_hqvideo","video",sessionid),that.videoControl.initUploadController(),that.SLUG_TO_CONTROL={image:that.imageControl,audio:that.audioControl,video:that.videoControl},that.objectMap=formdesigner.multimediaConfig.objectMap)},that.multimediaReference=function(mediaType){var ref={};return ref.mediaType=mediaType,ref.updateRef=function(path){ref.path=path,ref.linkedObj=that.objectMap[path]},ref.getUrl=function(){return ref.linkedObj.url},ref.isMediaMatched=function(){return _.isObject(ref.linkedObj)},ref.updateController=function(){var uploadController=formdesigner.multimedia.SLUG_TO_CONTROL[ref.mediaType].uploadController;uploadController.resetUploader(),uploadController.currentReference=ref,uploadController.uploadParams={path:ref.path,media_type:formdesigner.multimedia.SLUG_TO_CLASS[ref.mediaType],old_ref:ref.isMediaMatched()?ref.linkedObj.m_id:"",replace_attachment:!0},uploadController.updateUploadFormUI()},ref},that}(),"undefined"==typeof formdesigner)var formdesigner={};if(formdesigner.widgets=function(){var that={};return that.getGroupName=function(path){return path.split("/")[0]},that.getPropertyName=function(path){return path.split("/")[1]},that.baseWidget=function(mug){var widget={};return widget.mug=mug,widget.isDisabled=function(){if(!widget.path)return!1;var mugPath=formdesigner.controller.form.dataTree.getAbsolutePath(widget.mug);return _.any(formdesigner.pluginManager.call("isPropertyLocked",mugPath,widget.path))},widget.getDisplayName=function(){return this.definition.lstring?this.definition.lstring:this.propName},widget.getLabel=function(){var displayName=widget.getDisplayName();return displayName?$("<label />").text(displayName).attr("for",widget.getID()):null},widget.getControl=function(){throw"must be overridden"},widget.getID=function(){throw"must be overridden"},widget.setValue=function(){},widget.getValue=function(){},widget.updateValue=function(){var isID=-1!==["nodeID","defaultValue"].indexOf(widget.propName),val=widget.getValue();isID&&-1!==val.indexOf(" ")&&widget.setValue(val.replace(/\s/g,"_")),isID&&""===val||widget.save()},widget.save=function(){throw"Not Implemented"},widget.getUIElement=function(){var $controls,$label,uiElem=$("<div />").addClass("widget control-group");return $label=widget.getLabel(),$label.addClass("control-label"),uiElem.append($label),$controls=$('<div class="controls" />'),$controls.append(widget.getControl()),uiElem.append($controls),uiElem},widget},that.normalWidget=function(mug,options){var widget=that.baseWidget(mug),path=options.path;return widget.path=path,widget.definition=mug.getPropertyDefinition(path),widget.currentValue=mug.getPropertyValue(path),widget.groupName=that.getGroupName(widget.path),widget.propName=that.getPropertyName(widget.path),widget.getID=function(){return this.path.split("/").join("-")},widget.save=function(){formdesigner.controller.setMugPropertyValue(this.mug,this.groupName,this.propName,this.getValue(),this.mug)},widget},that.textWidget=function(mug,options){var widget=that.normalWidget(mug,options),input=$("<input />").attr("id",widget.getID()).attr("type","text").addClass("input-block-level");return widget.getControl=function(){return widget.isDisabled()&&input.prop("disabled",!0),input},widget.setValue=function(value){input.val(value)},widget.getValue=function(){return input.val()},input.bind("change keyup",widget.updateValue),widget},that.droppableTextWidget=function(mug,options){var widget=that.textWidget(mug,options);return widget.getControl().addClass("jstree-drop").attr("placeholder","Hint: drag a question here.").change(widget.updateValue),widget},that.checkboxWidget=function(mug,options){var widget=that.normalWidget(mug,options),input=$("<input />").attr("id",widget.getID());return input.attr("type","checkbox"),widget.getControl=function(){return widget.isDisabled()&&input.prop("disabled",!0),input},widget.setValue=function(value){input.prop("checked",value)},widget.getValue=function(){return input.prop("checked")},input.change(widget.updateValue),widget},that.xPathWidget=function(mug,options){var widget=that.textWidget(mug,options),xPathButton=$("<button />").addClass("xpath-edit-button pull-right").text("Edit").stopLink().addClass("btn").attr("type","button");return xPathButton.data("group",widget.groupName).data("prop",widget.propName).data("inputControlID",widget.getID()),xPathButton.click(function(){formdesigner.controller.displayXPathEditor({group:$(this).data("group"),property:$(this).data("prop"),xpathType:widget.definition.xpathType,value:$("#"+$(this).data("inputControlID")).val()})}),widget.getUIElement=function(){widget.isDisabled()&&xPathButton.prop("disabled",!0);var $label,uiElem=$("<div />").addClass("widget control-group"),$controls=$("<div />").addClass("controls");return $label=this.getLabel(),$label.addClass("control-label"),uiElem.append($label).append(xPathButton),$controls.append(this.getControl()).css("margin-right","60px"),uiElem.append($controls),uiElem},widget},that.androidIntentAppIdWidget=function(mug){var widget=that.baseWidget(mug);widget.definition={},widget.currentValue=mug.intentTag?mug.intentTag.path:"",widget.propName="Intent ID",widget.getID=function(){return"intent-app-id"};var input=$("<input />").attr("id",widget.getID()).attr("type","text").attr("placeholder","Insert Android Application ID");return widget.getControl=function(){return widget.isDisabled()&&input.prop("disabled",!0),input},widget.setValue=function(value){input.val(value)},widget.getValue=function(){return input.val()},widget.updateValue=function(){formdesigner.controller.setFormChanged(),widget.mug.intentTag.path=widget.getValue()},input.bind("change keyup",widget.updateValue),widget},that.baseKeyValueWidget=function(mug){var widget=that.baseWidget(mug);return widget.definition={},widget.kvInput=$('<div class="control-row" />'),widget.getControl=function(){return widget.isDisabled(),widget.kvInput},widget.setValue=function(value){var kvTemplate=$("#fd-template-widget-control-keyvalue");widget.kvInput.html(_.template(kvTemplate.text(),{pairs:value})),widget.kvInput.find("input").bind("change keyup",widget.updateValue),widget.kvInput.find(".fd-kv-add-pair").click(function(e){widget.refreshControl(),e.preventDefault()}),widget.kvInput.find(".fd-kv-remove-pair").click(function(e){$(this).parent().parent().remove(),widget.refreshControl(),widget.save(),e.preventDefault()})},widget.getValue=function(){var currentValues={};return _.each(widget.kvInput.find(".fd-kv-pair"),function(kvPair){var $pair=$(kvPair);currentValues[$pair.find(".fd-kv-key").val()]=$pair.find(".fd-kv-val").val()}),currentValues},widget.getValidValues=function(){var values=_.clone(widget.getValue());return values[""]&&delete values[""],values},widget.updateValue=function(){var currentValues=widget.getValue();""in currentValues||(widget.kvInput.find(".btn").removeClass("hide"),widget.kvInput.find(".fd-kv-remove-pair").removeClass("hide")),widget.save()},widget.refreshControl=function(){widget.setValue(widget.getValue())},widget},that.androidIntentExtraWidget=function(mug){var widget=that.baseKeyValueWidget(mug);return widget.currentValue=mug.intentTag?mug.intentTag.extra:{},widget.propName="Extra",widget.getID=function(){return"intent-extra"},widget.save=function(){widget.mug.intentTag&&(widget.mug.intentTag.extra=widget.getValidValues(),formdesigner.controller.setFormChanged())},widget},that.androidIntentResponseWidget=function(mug){var widget=that.baseKeyValueWidget(mug);return widget.currentValue=mug.intentTag?mug.intentTag.response:{},widget.propName="Response",widget.getID=function(){return"intent-response"},widget.save=function(){widget.mug.intentTag&&(widget.mug.intentTag.response=widget.getValidValues(),formdesigner.controller.setFormChanged())},widget},that.readOnlyControlWidget=function(mug){var widget=that.baseWidget(mug);return widget.definition={},widget.currentValue=$("<div>").append(mug.controlElementRaw).clone().html(),widget.propName="Raw XML: ",widget.getID=function(){return"readonly-control"},widget.getControl=function(){var control=$("<p />").text(this.currentValue);return control},widget},that.questionSection=function(mug,options){var section={};return section.mug=mug,section.slug=options.slug||"anon",section.displayName=options.displayName,section.properties=options.properties,section.isCollapsed=!!options.isCollapsed,section.help=options.help||{},section.getId=function(){return"fd-question-edit-"+this.slug},section.getBaseTemplate=function(){return formdesigner.ui.getTemplateObject("#fd-template-question-fieldset",{fieldsetId:section.getId(),fieldsetTitle:section.displayName,isCollapsed:section.isCollapsed,help:section.help})},section.getSectionDisplay=function(){var $fieldsetContent,$sec=section.getBaseTemplate();return $fieldsetContent=$sec.find(".fd-fieldset-content"),section.properties.map(function(prop){var elemWidget=prop.widgetClass(section.mug,prop.options);elemWidget.setValue(elemWidget.currentValue),$fieldsetContent.append(elemWidget.getUIElement())}),$sec},section},that.getToolbarForMug=function(mug){var $baseToolbar=formdesigner.ui.getTemplateObject("#fd-template-question-toolbar",{isDeleteable:_.all(formdesigner.pluginManager.call("isMugRemoveable",formdesigner.controller.form.dataTree.getAbsolutePath(mug)))});return $baseToolbar.find("#fd-button-remove").click(formdesigner.controller.removeCurrentQuestion),$baseToolbar.find("#fd-button-copy").click(function(){formdesigner.controller.duplicateCurrentQuestion({itext:"copy"})}),$baseToolbar.find(".btn-toolbar.pull-left").prepend(this.getQuestionTypeChanger(mug)),$baseToolbar},that.getQuestionTypeChanger=function(mug){var getQuestionList=function(mug){for(var questions=formdesigner.ui.QUESTIONS_IN_TOOLBAR,ret=[],i=0;i<questions.length;i++){var q=mugs[questions[i]];q.prototype.isTypeChangeable&&mug.$class.prototype!==q.prototype&&ret.push({slug:questions[i],name:q.prototype.typeName,icon:q.prototype.icon})}return ret},changeable=formdesigner.pluginManager.call("isMugTypeChangeable",formdesigner.controller.form.dataTree.getAbsolutePath(mug)),$questionTypeChanger=formdesigner.ui.getTemplateObject("#fd-template-question-type-changer",{canChangeType:_.all(changeable)&&mug.isTypeChangeable,currentQuestionIcon:mug.getIcon(),currentTypeName:mug.typeName,questions:getQuestionList(mug)});return $questionTypeChanger.find(".change-question").click(function(e){try{formdesigner.controller.changeQuestionType(mug,$(this).data("qtype"))}catch(err){alert("Sorry, you can't do that because: "+err),input.val(mug.__className)}e.preventDefault()}),$questionTypeChanger.attr("id","fd-question-changer"),$questionTypeChanger},that.getSectionListForMug=function(mug){return[{slug:"main",displayName:"Basic",properties:that.getMainProperties(mug),help:{title:"Basic",text:"<p>The <strong>Question ID</strong> is a unique identifier for a question. It does not appear on the phone. It is the name of the question in data exports.</p><p>The <strong>Label</strong> is text that appears in the application. This text will not appear in data exports.</p> <p>Click through for more info.</p>",link:"https://confluence.dimagi.com/display/commcarepublic/Form+Builder"}},{slug:"logic",displayName:"Logic",properties:that.getLogicProperties(mug),help:{title:"Logic",text:"Use logic to control when questions are asked and what answers are valid. You can add logic to display a question based on a previous answer, to make the question required or ensure the answer is in a valid range.",link:"https://confluence.dimagi.com/display/commcarepublic/Common+Logic+and+Calculations"}},{displayName:"Media",slug:"content",properties:that.getMediaProperties(mug),isCollapsed:!1,help:{title:"Media",text:"This will allow you to add images, audio or video media to a question, or other custom content.",link:"https://confluence.dimagi.com/display/commcarepublic/Multimedia+in+CommCare"}},{slug:"advanced",type:"accordion",displayName:"Advanced",properties:that.getAdvancedProperties(mug),isCollapsed:!0,help:{title:"Advanced",text:"These are advanced settings and are not needed for most applications.  Please only change these if you have a specific need!",link:"https://confluence.dimagi.com/display/commcarepublic/Application+Building"}}]
},that.getMainProperties=function(){return formdesigner.pluginManager.call("contributeToMainProperties",["dataElement/nodeID","controlElement/defaultValue","controlElement/label","controlElement/readOnlyControl","controlElement/androidIntentAppId","controlElement/androidIntentExtra","controlElement/androidIntentResponse"])},that.getMediaProperties=function(){return["controlElement/mediaItext"]},that.getLogicProperties=function(){return formdesigner.pluginManager.call("contributeToLogicProperties",["bindElement/calculateAttr","bindElement/requiredAttr","bindElement/relevantAttr","bindElement/constraintAttr","controlElement/repeat_count","controlElement/no_add_remove"])},that.getAdvancedProperties=function(){return formdesigner.pluginManager.call("contributeToAdvancedProperties",["dataElement/dataValue","dataElement/xmlnsAttr","controlElement/label","controlElement/hintLabel","bindElement/constraintMsgAttr"])},that}(),"undefined"==typeof formdesigner)var formdesigner={};var Tree=function(tType){var rootNode,that={},treeType=tType;treeType||(treeType="data");{var Node=function(children,value){var that={},nodeValue=value;that.value=value,children=children||[],that.children=children,that.getChildren=function(){return children},that.getValue=function(){return nodeValue},that.setValue=function(val){nodeValue=val,_(that.children).each(function(child){child.getValue().parentMug=val})},that.addChild=function(node){children||(children=[]),children.push(node)},that.insertChild=function(node,index){return null===node?null:(0>index&&(index=0),void children.splice(index,0,node))},that.getNodeFromValue=function(value){if(null===value)return null;var retVal,valueIsFn=_.isFunction(value),thisVal=this.getValue();if(!valueIsFn&&thisVal===value&&" "!==thisVal||valueIsFn&&value(thisVal))return this;for(var i=0;i<children.length;i++)if(retVal=children[i].getNodeFromValue(value))return retVal;return null},that.getNodeFromMug=that.getNodeFromValue,that.getMugFromUFID=function(ufid){var node=that.getNodeFromValue(function(value){return value.ufid===ufid});return node?node.getValue():null},that.removeChild=function(node){var childIdx=children.indexOf(node);return-1!==childIdx&&children.splice(childIdx,1),node},that.findParentNode=function(node){var i,parent=null;if(!children||0===children.length)return null;if(-1!==children.indexOf(node))return this;for(i in children)if(children.hasOwnProperty(i)&&(parent=children[i].findParentNode(node),null!==parent))return parent;return parent},that.getID=function(){var id;if(this.isRootNode)return id=formdesigner.controller.form.formID,id?id:"RootNode";this.getValue();if("data"===treeType)return this.getValue().getDataElementID();if("control"===treeType)return formdesigner.util.getMugDisplayName(this.getValue());throw'Tree does not have a specified treeType! Default is "data" so must have been forcibly removed!'},that.getChildrenMugs=function(){var i,retList=[];for(i in children)children.hasOwnProperty(i)&&retList.push(children[i].getValue());return retList},that.getStructure=function(){var ret={};return ret[this.getID()]=_.map(children,function(c){return c.getStructure()}),ret},that.treeMap=function(nodeFunc,store,afterChildFunc){var result,child;result=nodeFunc(this),result&&store.push(result);for(child in this.getChildren())this.getChildren().hasOwnProperty(child)&&this.getChildren()[child].treeMap(nodeFunc,store,afterChildFunc);return afterChildFunc&&afterChildFunc(this,result),store};var validateTree=function(){var i,childResult;if(!this.getValue())throw"Tree contains node with no values!";if(!this.getValue().isValid())return!1;for(i in this.getChildren())if(this.getChildren().hasOwnProperty(i)&&(childResult=this.getChildren()[i].validateTree(),!childResult))return!1;return!0};return that.validateTree=validateTree,that};!function(type){rootNode=new Node(null," "),rootNode.isRootNode=!0,treeType=type||"data"}(treeType)}that.rootNode=rootNode,that.getParentNode=function(node){return this.rootNode===node?this.rootNode:this.rootNode.findParentNode(node)},that.getStructure=function(){return this.rootNode.getStructure()},that.getNodeFromMug=function(mug){return rootNode.getNodeFromMug(mug)};var removeNodeFromTree=function(node){if(!node)return null;if(!that.getNodeFromMug(node.getValue()))return null;var parent=that.getParentNode(node);return parent?(parent.removeChild(node),node):null};that.insertMug=function(mug,position,refMug){var refNode,refNodeSiblings,refNodeIndex,refNodeParent,node;if(null!==position&&"string"!=typeof position)throw"position argument must be a string or null! Can be 'after', 'before' or 'into'";switch(position||(position="after"),!refMug||" "===refMug||!refMug.controlElement&&"control"===treeType?(refNode=rootNode,refMug=refNode.getValue(),position="into"):refNode=this.getNodeFromMug(refMug),node=removeNodeFromTree(this.getNodeFromMug(mug)),node||(node=new Node(null,mug)),"into"!==position?(refNodeParent=that.getParentNode(refNode),refNodeSiblings=refNodeParent.getChildren(),refNodeIndex=refNodeSiblings.indexOf(refNode),mug.parentMug=refNodeParent.getValue()):mug.parentMug=refMug,position){case"before":refNodeParent.insertChild(node,refNodeIndex);break;case"after":refNodeParent.insertChild(node,refNodeIndex+1);break;case"into":refNode.addChild(node);break;case"first":refNode.insertChild(node,0);break;case"last":refNode.insertChild(node,refNodeSiblings.length+1);break;default:throw"in insertMug() position argument MUST be null, 'before', 'after', 'into', 'first' or 'last'.  Argument was: "+position}};return that.getAbsolutePath=function(mug){var output,nodeParent,node=this.getNodeFromMug(mug);if(!node)return null;for(nodeParent=this.getParentNode(node),output="/"+node.getID();nodeParent&&(output="/"+nodeParent.getID()+output,!nodeParent.isRootNode);)nodeParent=this.getParentNode(nodeParent);return output},that.removeMug=function(mug){var node=this.getNodeFromMug(mug);if(mug&&node)return removeNodeFromTree(node),node},that.getMugFromUFID=function(ufid){return rootNode.getMugFromUFID(ufid)},that.getRootChildren=function(){return rootNode.getChildrenMugs()},that.treeMap=function(func,afterChildFunc){return rootNode.treeMap(func,[],afterChildFunc)},that.isTreeValid=function(){var i,retVal,rChildren=rootNode.getChildren();for(i in rChildren)if(rChildren.hasOwnProperty(i)&&(retVal=rChildren[i].validateTree(),!retVal))return!1;return!0},that.getRootNode=function(){return rootNode},that};formdesigner.model=function(){var that={};that.questionIdCount=function(qId){for(var allMugs=formdesigner.controller.getMugList(),count=0,i=0;i<allMugs.length;i++){var mug=allMugs[i];mug.dataElement&&qId===mug.dataElement.nodeID&&count++}return count};var InstanceMetadata=function(attributes,children){var that={};return that.attributes=attributes,that.children=children,that};that.InstanceMetadata=InstanceMetadata;var FormError=function(options){var that={};return that.message=options.message,that.key=options.key,that.level=options.level||"form-warning",that.options=options,that.isMatch=function(other){return this.key&&other.key?this.key===other.key:!1},that};that.FormError=FormError;var Form=function(){var dataTree,controlTree,that={};that.formName="New Form",that.formID="data",that.dataTree=dataTree=new Tree("data"),that.controlTree=controlTree=new Tree("control"),that.instanceMetadata=[InstanceMetadata({})],that.errors=[],that.getBindList=function(){var dataTree,controlTree,dBindList,cBindList,i,bList=[],getBind=function(node){if(!node.getValue()||node.isRootNode)return null;var bind,mug=node.getValue();return mug.bindElement?bind=mug:null};dataTree=this.dataTree,controlTree=this.controlTree,dBindList=dataTree.treeMap(getBind),cBindList=controlTree.treeMap(getBind);for(i in dBindList)dBindList.hasOwnProperty(i)&&bList.push(dBindList[i]);for(i in cBindList)cBindList.hasOwnProperty(i)&&-1===bList.indexOf(cBindList[i])&&bList.push(cBindList[i]);return bList},that.getMugByUFID=function(ufid){var mug=dataTree.getMugFromUFID(ufid);return mug||(mug=controlTree.getMugFromUFID(ufid)),mug};var getInvalidMugs=function(){var mugListC,mugListD,result,controlTree,dataTree,mapFunc=function(node){if(!node.isRootNode){var mug=node.getValue();return mug.isValid()?null:mug}};return dataTree=this.dataTree,controlTree=this.controlTree,mugListC=controlTree.treeMap(mapFunc),mugListD=dataTree.treeMap(mapFunc),result=formdesigner.util.mergeArray(mugListC,mugListD)};that.getInvalidMugs=getInvalidMugs,that.getInvalidMugUFIDs=function(){var i,badMugs=this.getInvalidMugs(),result={};for(i in badMugs)badMugs.hasOwnProperty(i)&&(result[badMugs[i].ufid]=badMugs[i].getErrors());return result},that.updateError=function(errObj,options){if(options=options||{},errObj.key){for(var removed=null,i=0;i<that.errors.length;i++)errObj.isMatch(that.errors[i])&&(removed=that.errors.splice(i,1,errObj));removed||that.errors.push(errObj)}else that.errors.push(errObj);options.updateUI&&formdesigner.ui.resetMessages(that.errors)},that.clearErrors=function(type,options){options=options||{};for(var i=0;i<that.errors.length;i++)that.errors=that.errors.filter(function(err){return err.level!==type});options.updateUI&&formdesigner.ui.resetMessages(that.errors)},that.clearError=function(errObj,options){options=options||{};for(var removed=null,i=0;i<that.errors.length;i++)if(errObj.isMatch(that.errors[i])){removed=that.errors.splice(i,1);break}removed&&options.updateUI&&formdesigner.ui.resetMessages(that.errors)},that.createXForm=function(){function html_tag_boilerplate(){xmlWriter.writeAttributeStringSafe("xmlns:h","http://www.w3.org/1999/xhtml"),xmlWriter.writeAttributeStringSafe("xmlns:orx","http://openrosa.org/jr/xforms"),xmlWriter.writeAttributeStringSafe("xmlns","http://www.w3.org/2002/xforms"),xmlWriter.writeAttributeStringSafe("xmlns:xsd","http://www.w3.org/2001/XMLSchema"),xmlWriter.writeAttributeStringSafe("xmlns:jr","http://openrosa.org/javarosa"),xmlWriter.writeAttributeStringSafe("xmlns:vellum","http://commcarehq.org/xforms/vellum")}var xmlWriter=new XMLWriter("UTF-8","1.0"),createDataBlock=function(){function mapFunc(node){var defaultVal,extraXMLNS,keyAttr,mug=node.getValue();if(xmlWriter.writeStartElement(node.getID()),node.isRootNode)createModelHeader();else{for(var k in mug.dataElement._rawAttributes)mug.dataElement._rawAttributes.hasOwnProperty(k)&&xmlWriter.writeAttributeStringSafe(k,mug.dataElement._rawAttributes[k]);mug.dataElement.dataValue&&(defaultVal=mug.dataElement.dataValue,xmlWriter.writeString(defaultVal)),mug.dataElement.keyAttr&&(keyAttr=mug.dataElement.keyAttr,xmlWriter.writeAttributeStringSafe("key",keyAttr)),mug.dataElement.xmlnsAttr&&(extraXMLNS=mug.dataElement.xmlnsAttr,xmlWriter.writeAttributeStringSafe("xmlns",extraXMLNS)),"Repeat"===mug.__className&&xmlWriter.writeAttributeStringSafe("jr:template","")}}function afterFunc(){xmlWriter.writeEndElement()}dataTree.treeMap(mapFunc,afterFunc)},createBindList=function(){function populateVariables(mug){return bEl=mug.bindElement,bEl?{nodeset:dataTree.getAbsolutePath(mug),type:bEl.dataType,constraint:bEl.constraintAttr,constraintMsg:bEl.constraintMsgAttr,constraintMsgItextID:bEl.constraintMsgItextID?bEl.constraintMsgItextID.id:void 0,relevant:bEl.relevantAttr,required:formdesigner.util.createXPathBoolFromJS(bEl.requiredAttr),calculate:bEl.calculateAttr,preload:bEl.preload,preloadParams:bEl.preloadParams}:null}var mug,bEl,i,attrs,j,bList=formdesigner.controller.form.getBindList();for(i in bList)if(bList.hasOwnProperty(i)&&(mug=bList[i],attrs=populateVariables(mug),attrs.nodeset)){xmlWriter.writeStartElement("bind");for(j in attrs)attrs.hasOwnProperty(j)&&attrs[j]&&("constraintMsg"===j?xmlWriter.writeAttributeStringSafe("jr:constraintMsg",attrs[j]):"constraintMsgItextID"===j?xmlWriter.writeAttributeStringSafe("jr:constraintMsg","jr:itext('"+attrs[j]+"')"):"preload"===j?xmlWriter.writeAttributeStringSafe("jr:preload",attrs[j]):"preloadParams"===j?xmlWriter.writeAttributeStringSafe("jr:preloadParams",attrs[j]):xmlWriter.writeAttributeStringSafe(j,attrs[j]));_(mug.bindElement._rawAttributes).each(function(v,k){xmlWriter.writeAttributeStringSafe(k,v)}),xmlWriter.writeEndElement()}},createControlBlock=function(){function mapFunc(node){function createOpenControlTag(tagName,elLabel){function createLabel(){(elLabel.ref||elLabel.defText)&&(xmlWriter.writeStartElement("label"),elLabel.ref&&xmlWriter.writeAttributeStringSafe("ref",elLabel.ref),elLabel.defText&&xmlWriter.writeString(elLabel.defText),xmlWriter.writeEndElement())}tagName=tagName.toLowerCase();var isGroupOrRepeat="group"===tagName||"repeat"===tagName,isODKMedia="upload"===tagName;isGroupOrRepeat?(xmlWriter.writeStartElement("group"),createLabel(),"repeat"===tagName&&xmlWriter.writeStartElement("repeat")):xmlWriter.writeStartElement(tagName),"group"!==tagName&&"repeat"!==tagName&&createLabel(),"item"===tagName&&cProps.defaultValue&&(xmlWriter.writeStartElement("value"),xmlWriter.writeString(cProps.defaultValue),xmlWriter.writeEndElement());for(var k in cProps._rawAttributes)cProps._rawAttributes.hasOwnProperty(k)&&xmlWriter.writeAttributeStringSafe(k,cProps._rawAttributes[k]);if("item"!==tagName){var attr,absPath;attr="repeat"===tagName?"nodeset":"ref",absPath=formdesigner.controller.form.dataTree.getAbsolutePath(mug),xmlWriter.writeAttributeStringSafe(attr,absPath)}if("repeat"===tagName){var r_count=cProps.repeat_count,r_noaddrem=cProps.no_add_remove;r_noaddrem=formdesigner.util.createXPathBoolFromJS(r_noaddrem),r_count&&xmlWriter.writeAttributeStringSafe("jr:count",r_count),r_noaddrem&&xmlWriter.writeAttributeStringSafe("jr:noAddRemove",r_noaddrem)}else if(isODKMedia){var mediaType=cProps.mediaType;mediaType&&xmlWriter.writeAttributeStringSafe("mediatype",mediaType)}var appearanceAttr=mug.getAppearanceAttribute();if(appearanceAttr&&xmlWriter.writeAttributeStringSafe("appearance",appearanceAttr),"item"!==tagName&&"repeat"!==tagName&&(cProps.hintLabel||cProps.hintItextID&&cProps.hintItextID.id)){if(xmlWriter.writeStartElement("hint"),cProps.hintLabel&&xmlWriter.writeString(cProps.hintLabel),cProps.hintItextID.id){var ref="jr:itext('"+cProps.hintItextID.id+"')";xmlWriter.writeAttributeStringSafe("ref",ref)}xmlWriter.writeEndElement()}}if(!node.isRootNode){var mug=node.getValue();if("ReadOnly"===mug.__className)return void xmlWriter.writeString($("<div>").append(mug.controlElementRaw).clone().html());var label,isItextOptional,cProps=mug.controlElement;cProps.label&&(label={},label.defText=cProps.label),cProps.labelItextID&&(label||(label={}),label.ref="jr:itext('"+cProps.labelItextID.id+"')",isItextOptional="optional"==mug.controlElement.__spec.labelItextID.presence,cProps.labelItextID.isEmpty()&&isItextOptional&&(label.ref="")),createOpenControlTag(cProps.tagName,label)}}function afterFunc(node){if(!node.isRootNode){var mug=node.getValue();if("ReadOnly"!==mug.__className){var tagName=mug.controlElement.tagName;xmlWriter.writeEndElement(),"repeat"===tagName&&xmlWriter.writeEndElement()}}}var mapFunc,afterFunc;controlTree.treeMap(mapFunc,afterFunc)},createModelHeader=function(){var uuid,uiVersion,version,formName,jrm;jrm=formdesigner.formJRM,jrm||(jrm="http://dev.commcarehq.org/jr/xforms"),uuid=formdesigner.formUuid,uuid||(uuid="http://openrosa.org/formdesigner/"+formdesigner.util.generate_xmlns_uuid()),uiVersion=formdesigner.formUIVersion,uiVersion||(uiVersion=1),version=formdesigner.formVersion,version||(version=1),formName=formdesigner.controller.form.formName,formName||(formName="New Form"),xmlWriter.writeAttributeStringSafe("xmlns:jrm",jrm),xmlWriter.writeAttributeStringSafe("xmlns",uuid),xmlWriter.writeAttributeStringSafe("uiVersion",uiVersion),xmlWriter.writeAttributeStringSafe("version",version),xmlWriter.writeAttributeStringSafe("name",formName)},_writeInstanceAttributes=function(writer,instanceMetadata){for(var attrId in instanceMetadata.attributes)instanceMetadata.attributes.hasOwnProperty(attrId)&&writer.writeAttributeStringSafe(attrId,instanceMetadata.attributes[attrId])},_writeInstance=function(writer,instanceMetadata,manualChildren){writer.writeStartElement("instance"),_writeInstanceAttributes(writer,instanceMetadata),manualChildren&&instanceMetadata.children&&writer.writeString($("<div>").append(instanceMetadata.children).clone().html()),writer.writeEndElement()},generateForm=function(){var docString;formdesigner.pluginManager.call("preSerialize"),xmlWriter.writeStartDocument(),xmlWriter.writeStartElement("h:html"),html_tag_boilerplate(),xmlWriter.writeStartElement("h:head"),xmlWriter.writeStartElement("h:title"),xmlWriter.writeString(formdesigner.controller.form.formName),xmlWriter.writeEndElement(),xmlWriter.writeStartElement("model"),xmlWriter.writeStartElement("instance"),_writeInstanceAttributes(xmlWriter,formdesigner.controller.form.instanceMetadata[0]),createDataBlock(),xmlWriter.writeEndElement();for(var i=1;i<formdesigner.controller.form.instanceMetadata.length;i++)_writeInstance(xmlWriter,formdesigner.controller.form.instanceMetadata[i],!0);return createBindList(),formdesigner.pluginManager.call("contributeToModelXML",xmlWriter),xmlWriter.writeEndElement(),formdesigner.intentManager.writeIntentXML(xmlWriter,dataTree),xmlWriter.writeEndElement(),xmlWriter.writeStartElement("h:body"),createControlBlock(),xmlWriter.writeEndElement(),xmlWriter.writeEndElement(),xmlWriter.writeEndDocument(),docString=xmlWriter.flush(),docString=formdesigner.pluginManager.call("afterSerialize",docString)};return generateForm()},that.isFormValid=function(){return this.dataTree.isTreeValid()&&this.controlTree.isTreeValid()};var getMugByIDFromTree=function(nodeID,treeType){var retVal,mapFunc=function(node){if(!node.isRootNode){var thisDataNodeID,thisBindNodeID,mug=node.getValue();if(mug.dataElement&&(thisDataNodeID=mug.dataElement.nodeID),mug.bindElement&&(thisBindNodeID=mug.bindElement.nodeID),thisDataNodeID||thisBindNodeID)return thisDataNodeID===nodeID||thisBindNodeID===nodeID?mug:void 0}};if("data"===treeType)retVal=dataTree.treeMap(mapFunc);else{if("control"!==treeType)throw'Invalid TreeType specified! Use either "data" or "control"';retVal=controlTree.treeMap(mapFunc)}return retVal};that.getMugByIDFromTree=getMugByIDFromTree;var replaceMug=function(oldMug,newMug,treeType){function treeFunc(node){return node.getValue()===oldMug?(node.setValue(newMug),!0):void 0}var result,tree;return tree="data"===treeType?dataTree:controlTree,result=tree.treeMap(treeFunc),newMug.parentMug=oldMug.parentMug,result.length>0?result[0]:!1};return that.replaceMug=replaceMug,formdesigner.util.eventuality(that),that};return that.Form=Form,that.LogicExpression=function(exprText){var expr={};if(expr._text=exprText||"",expr.valid=!1,exprText)try{expr.parsed=xpath.parse(exprText),expr.valid=!0}catch(err){}else expr.empty=!0;return expr.getPaths=function(){var paths=[];if(this.parsed)for(var node,i,children,queue=[this.parsed];queue.length>0;)for(node=queue.shift(),node instanceof xpathmodels.XPathPathExpr&&paths.push(node),children=node.getChildren(),i=0;i<children.length;i++)queue.push(children[i]);return paths},expr.updatePath=function(from,to){for(var path,paths=this.getPaths(),replacePathInfo=function(source,destination){destination.initial_context=source.initial_context,destination.steps=source.steps,destination.filter=source.filter},i=0;i<paths.length;i++)path=paths[i],path.toXPath()===from&&replacePathInfo(xpath.parse(to),path)},expr.getText=function(){return this.valid?this.parsed.toXPath():this._text},expr},that.LogicManager=function(){var logic={};return logic.all=[],logic.clearReferences=function(mug,property){this.all=this.all.filter(function(elem){return elem.mug!=mug.ufid||elem.property!=property})},logic.addReferences=function(mug,property){var expr=that.LogicExpression(mug.getPropertyValue(property)),paths=expr.getPaths().filter(function(p){return p.initial_context===xpathmodels.XPathInitialContextEnum.ROOT}),errorKey=mug.ufid+"-"+property+"-badpath",errors=!1;this.all=this.all.concat(paths.map(function(path){var pathString=path.pathWithoutPredicates(),pathWithoutRoot=pathString.substring(1+pathString.indexOf("/",1));return refMug=formdesigner.controller.getMugByPath(pathString),refMug||-1!=formdesigner.allowedDataNodeReferences.indexOf(pathWithoutRoot)||(errors=!0,formdesigner.controller.form.updateError(that.FormError({level:"parse-warning",key:errorKey,message:"The question '"+mug.bindElement.nodeID+"' references an unknown question "+path.toXPath()+" in its "+mug.getPropertyDefinition(property).lstring+"."}),{updateUI:!0})),{mug:mug.ufid,ref:refMug?refMug.ufid:"",property:property,path:path.toXPath(),sourcePath:formdesigner.controller.form.dataTree.getAbsolutePath(mug)}})),errors||formdesigner.controller.form.clearError(that.FormError({key:errorKey}),{updateUI:!0})},logic.updateReferences=function(mug,property){this.clearReferences(mug,property),this.addReferences(mug,property)},logic.updateAllReferences=function(mug,clear){if(mug.bindElement)for(var i=0;i<formdesigner.util.XPATH_REFERENCES.length;i++){var property=formdesigner.util.XPATH_REFERENCES[i];clear&&logic.clearReferences(mug,property),logic.addReferences(mug,property)}},logic.updatePath=function(mugId,from,to,subtree){if(from!==to)for(var ref,mug,expr,found=this.all.filter(function(elem){return elem.ref===mugId&&(!subtree||elem.sourcePath===subtree||0===elem.sourcePath.indexOf(subtree+"/"))}),i=0;i<found.length;i++)ref=found[i],mug=formdesigner.controller.getMugFromFormByUFID(ref.mug),expr=that.LogicExpression(mug.getPropertyValue(ref.property)),orig=expr.getText(),expr.updatePath(from,to),orig!==expr.getText()&&formdesigner.controller.setMugPropertyValue(mug,ref.property.split("/")[0],ref.property.split("/")[1],expr.getText(),mug)},logic.reset=function(){this.all=[]},logic}(),that.reset=function(){that.form=new Form,formdesigner.pluginManager.javaRosa.Itext.resetItext(formdesigner.opts.langs),that.LogicManager.reset(),formdesigner.controller.setForm(that.form)},that.init=function(){that.form=new Form,formdesigner.controller.setForm(that.form)},that}();var validateRule=function(ruleKey,ruleValue,testingObj,blockName,mug){var presence=ruleValue.presence,retBlock={result:"pass"};if("required"!==presence||testingObj?"notallowed"===presence&&testingObj&&(retBlock.result="fail",retBlock.resultMessage='"'+ruleKey+'" IS NOT ALLOWED IN THIS OBJECT in:'+blockName):(retBlock.result="fail",retBlock.resultMessage='"'+ruleKey+'" value is required in:'+blockName+", but is NOT present!"),"fail"!==retBlock.result&&ruleValue.validationFunc){var funcRetVal=ruleValue.validationFunc(mug);"pass"!==funcRetVal&&(retBlock.result="fail",retBlock.resultMessage=funcRetVal)}return retBlock},MugElement=Class.$extend({__init__:function(options){this.__spec=options.spec,this.__mug=options.mug,this.__name=options.name},setAttr:function(attr,val,overrideImmutable){var spec=this.__spec[attr];0===attr.indexOf("_")||!spec||!overrideImmutable&&spec.immutable||"notallowed"===spec.presence&&"DataBindOnly"!==this.__mug.__className||(val&&"object"==typeof val&&(val=$.extend(!0,{},val)),this[attr]=val)},setAttrs:function(attrs,overrideImmutable){var self=this;_(attrs).each(function(val,attr){self.setAttr(attr,val,overrideImmutable)})},getErrors:function(){var self=this,errors=[];return _(Object.getOwnPropertyNames(this)).each(function(key){if(0!==key.indexOf("_")&&0!==key.indexOf("$")){var rule=self.__spec[key];if(!rule&&self[key])return void errors.push("{element} has property '"+key+"' but no rule is present for that property.");if(rule){var result=validateRule(key,rule,self[key],self.__name,self.__mug);"fail"===result.result&&errors.push(result.resultMessage)}}}),errors}}),mugs=function(){var validateElementName=function(value,displayName){return formdesigner.util.isValidElementName(value)?"pass":value+" is not a legal "+displayName+". Must start with a letter and contain only letters, numbers, and '-' or '_' characters."},validationFuncs={nodeID:function(mug){var qId=mug.dataElement.nodeID,res=validateElementName(qId,"Question ID");return"pass"!==res?res:formdesigner.model.questionIdCount(qId)>1?qId+" is a duplicate ID in the form. Question IDs must be unique.":"pass"},label:function(mug){var controlBlock,hasLabel,hasLabelItextID,missing,hasItext,Itext;Itext=formdesigner.pluginManager.javaRosa.Itext,controlBlock=mug.controlElement,hasLabel=Boolean(controlBlock.label);var itextBlock=controlBlock?mug.controlElement.labelItextID:null;return hasLabelItextID=itextBlock&&"undefined"!=typeof itextBlock.id,hasLabelItextID&&!formdesigner.util.isValidAttributeValue(itextBlock.id)?itextBlock.id+" is not a valid Itext ID":(hasItext=itextBlock&&itextBlock.hasHumanReadableItext(),hasLabel?"pass":hasLabel||hasItext||"optional"!==mug.controlElement.__spec.label.presence&&"optional"!==mug.controlElement.__spec.labelItextID.presence?hasLabelItextID&&hasItext?"pass":(hasLabelItextID&&!hasItext?missing="a display label":hasLabel||hasLabelItextID?hasLabel?hasLabelItextID||(missing="a display label ID"):missing="a display label":missing="a display label ID","Question is missing "+missing+" value!"):"pass")},defaultValue:function(mug){return/\s/.test(mug.controlElement.defaultValue)?"Whitespace in values is not allowed.":"pass"}},DEFAULT_DATA_ELEMENT_SPEC={nodeID:{editable:"w",visibility:"visible",presence:"required",lstring:"Question ID",validationFunc:validationFuncs.nodeID},dataValue:{editable:"w",visibility:"visible",presence:"optional",lstring:"Default Data Value"},xmlnsAttr:{editable:"w",visibility:"visible",presence:"notallowed",lstring:"Special Hidden Value XMLNS attribute"}},DEFAULT_BIND_ELEMENT_SPEC={nodeID:{editable:"w",visibility:"visible",presence:"optional",lstring:"Bind Node ID"},dataType:{editable:"w",immutable:!0,visibility:"hidden",presence:"optional",lstring:"Data Type"},relevantAttr:{editable:"w",visibility:"visible",presence:"optional",uiType:formdesigner.widgets.xPathWidget,xpathType:"bool",lstring:"Display Condition"},calculateAttr:{editable:"w",visibility:"visible_if_present",presence:"optional",uiType:formdesigner.widgets.xPathWidget,xpathType:"generic",lstring:"Calculate Condition"},constraintAttr:{editable:"w",visibility:"visible",presence:"optional",uiType:formdesigner.widgets.xPathWidget,xpathType:"bool",lstring:"Validation Condition"},constraintMsgAttr:{editable:"w",visibility:"visible",presence:"optional",validationFunc:function(mug){var bindBlock=mug.bindElement,hasConstraint="undefined"!=typeof bindBlock.constraintAttr,hasConstraintMsg=bindBlock.constraintMsgAttr||bindBlock.constraintMsgItextID&&bindBlock.constraintMsgItextID.id;return hasConstraintMsg&&!hasConstraint?"ERROR: You cannot have a Validation Error Message with no Validation COndition!":"pass"},lstring:"Validation Error Message"},requiredAttr:{editable:"w",visibility:"visible",presence:"optional",lstring:"Is this Question Required?",uiType:formdesigner.widgets.checkboxWidget},nodeset:{editable:"r",visibility:"hidden",presence:"optional"}},DEFAULT_CONTROL_ELEMENT_SPEC={tagName:{editable:"r",immutable:!0,visibility:"hidden",presence:"required"},appearance:{editable:"r",visibility:"hidden",presence:"optional",lstring:"Appearance Attribute"},label:{editable:"w",visibility:"visible",presence:"optional",validationFunc:validationFuncs.label,lstring:"Default Label"},hintLabel:{editable:"w",visibility:"visible",presence:"optional",lstring:"Hint Label"}},BaseMug=Class.$extend({isTypeChangeable:!0,isODKOnly:!1,__init__:function(){var self=this;if(this.__spec=this.getSpec(),_(this.__spec).each(function(spec,name){self[name]=spec?new MugElement({spec:spec,mug:self,name:name}):null}),this.dataElement&&this.bindElement&&(!this.dataElement.nodeID||!this.bindElement.nodeID)){var nodeID=this.dataElement.nodeID||this.bindElement.nodeID||formdesigner.util.generate_question_id();this.dataElement.nodeID=this.bindElement.nodeID=nodeID}formdesigner.util.give_ufid(this),formdesigner.util.eventuality(this)},getSpec:function(){return{dataElement:this.getDataElementSpec(),bindElement:this.getBindElementSpec(),controlElement:this.getControlElementSpec()}},getDataElementSpec:function(){return formdesigner.pluginManager.call("contributeToDataElementSpec",$.extend(!0,{},DEFAULT_DATA_ELEMENT_SPEC),this)},getBindElementSpec:function(){return formdesigner.pluginManager.call("contributeToBindElementSpec",$.extend(!0,{},DEFAULT_BIND_ELEMENT_SPEC),this)},getControlElementSpec:function(){return formdesigner.pluginManager.call("contributeToControlElementSpec",$.extend(!0,{},DEFAULT_CONTROL_ELEMENT_SPEC),this)},copyAttrs:function(sourceMug,overrideImmutable){this.dataElement&&sourceMug.dataElement&&(this.dataElement.setAttrs(sourceMug.dataElement,overrideImmutable),this.dataElement._rawAttributes=sourceMug.dataElement._rawAttributes),this.bindElement&&sourceMug.bindElement&&(this.bindElement.setAttrs(sourceMug.bindElement,overrideImmutable),this.bindElement._rawAttributes=sourceMug.bindElement._rawAttributes),this.controlElement&&sourceMug.controlElement&&(this.controlElement.setAttrs(sourceMug.controlElement,overrideImmutable),this.controlElement._rawAttributes=sourceMug.controlElement._rawAttributes)},getBindElementID:function(){return this.bindElement?this.bindElement.nodeID:null},getDataElementID:function(){return this.dataElement?this.dataElement.nodeID:null},getAppearanceAttribute:function(){return this.controlElement&&this.controlElement.appearance?this.controlElement.appearance:null},setAppearanceAttribute:function(attrVal){this.controlElement.appearance=attrVal},getPropertyDefinition:function(index){index instanceof Array||(index=index.split("/"));for(var ret=this.__spec[index[0]],i=1;i<index.length;i++){if(!ret)return null;ret=ret[index[i]]}return ret},getPropertyValue:function(index){index instanceof Array||(index=index.split("/"));for(var ret=this[index[0]],i=1;i<index.length;i++){if(!ret)return null;ret=ret[index[i]]}return ret},getIcon:function(){return this.icon},getErrors:function(){var self=this,errors=[];return _(this.__spec).each(function(spec,name){if(spec){var messages=_(self[name].getErrors()).map(function(message){return message.replace("{element}",name)});errors=errors.concat(messages)}}),errors},isValid:function(){return!this.getErrors().length},getDefaultItextRoot:function(){var nodeID,parent;return this.bindElement?nodeID=this.bindElement.nodeID:this.dataElement?nodeID=this.dataElement.nodeID:"Item"===this.__className&&(parent=this.parentMug,parent&&(nodeID=parent.getDefaultItextRoot()+"-"+this.controlElement.defaultValue)),nodeID||(nodeID=formdesigner.util.generate_item_label()),nodeID},getDefaultLabelItextId:function(){return this.getDefaultItextRoot()+"-label"},getDefaultLabelValue:function(){return this.controlElement&&this.controlElement.label?this.controlElement.label:this.dataElement?this.dataElement.nodeID:this.bindElement?this.bindElement.nodeID:"Item"===this.__className?this.controlElement.defaultValue:formdesigner.util.generate_item_label()},getLabelValue:function(){return this.controlElement.label?this.controlElement.label:""},getDefaultLabelItext:function(defaultValue){var formData={};return formData[formdesigner.pluginManager.javaRosa.Itext.getDefaultLanguage()]=defaultValue,new ItextItem({id:this.getDefaultLabelItextId(),forms:[new ItextForm({name:"default",data:formData})]})},setItextID:function(val){this.controlElement&&(this.controlElement.labelItextID.id=val)},getItext:function(){return this.controlElement?this.controlElement.labelItextID:void 0}}),DataBindOnly=BaseMug.$extend({typeName:"Hidden Value",icon:"icon-vellum-variable",isTypeChangeable:!1,getDataElementSpec:function(){var spec=this.$super();return spec.xmlnsAttr.presence="optional",spec},getControlElementSpec:function(){return null},getBindElementSpec:function(){var spec=this.$super();return spec.requiredAttr.presence="notallowed",spec.constraintAttr.presence="notallowed",spec.calculateAttr.visibility="visible",spec}}),ControlOnly=BaseMug.$extend({getDataElementSpec:function(){return null},getBindElementSpec:function(){return null}}),ReadOnly=BaseMug.$extend({getDataElementSpec:function(){return null
},getBindElementSpec:function(){return null},getControlElementSpec:function(){return{readonlyControl:{uiType:formdesigner.widgets.readOnlyControlWidget}}}}),TextQuestion=BaseMug.$extend({typeName:"Text",icon:"icon-vellum-text",__init__:function(options){this.$super(options),this.controlElement.tagName="input",this.bindElement.dataType="xsd:string"}}),PhoneNumber=TextQuestion.$extend({typeName:"Phone Number or Numeric ID",icon:"icon-signal",__init__:function(options){this.$super(options),this.controlElement.appearance="numeric"}}),Secret=BaseMug.$extend({typeName:"Password",icon:"icon-key",__init__:function(options){this.$super(options),this.controlElement.tagName="secret",this.bindElement.dataType="xsd:string"}}),Int=BaseMug.$extend({typeName:"Integer",icon:"icon-vellum-numeric",__init__:function(options){this.$super(options),this.controlElement.tagName="input",this.bindElement.dataType="xsd:int"}}),Audio=BaseMug.$extend({typeName:"Audio Capture",icon:"icon-vellum-audio-capture",isODKOnly:!0,__init__:function(options){this.$super(options),this.controlElement.tagName="upload",this.controlElement.mediaType="audio/*",this.bindElement.dataType="binary"},getControlElementSpec:function(){return $.extend(!0,{},this.$super(),{mediaType:{lstring:"Media Type",visibility:"visible",editable:"w",presence:"required"}})}}),Image=Audio.$extend({typeName:"Image Capture",icon:"icon-camera",isODKOnly:!0,__init__:function(options){this.$super(options),this.controlElement.tagName="upload",this.controlElement.mediaType="image/*",this.bindElement.dataType="binary"}}),Video=Audio.$extend({typeName:"Video Capture",icon:"icon-facetime-video",isODKOnly:!0,__init__:function(options){this.$super(options),this.controlElement.tagName="upload",this.controlElement.mediaType="video/*",this.bindElement.dataType="binary"}}),Geopoint=BaseMug.$extend({typeName:"GPS",icon:"icon-map-marker",isODKOnly:!0,__init__:function(options){this.$super(options),this.controlElement.tagName="input",this.bindElement.dataType="geopoint"}}),AndroidIntent=BaseMug.$extend({typeName:"Android App Callout",icon:"icon-vellum-android-intent",isODKOnly:!0,isTypeChangeable:!1,intentTag:null,__init__:function(options){this.$super(options),this.controlElement.tagName="input",this.bindElement.dataType="intent"},getControlElementSpec:function(){var spec=this.$super();return spec.controlElement=$.extend(spec,{androidIntentAppId:{visibility:"visible",uiType:formdesigner.widgets.androidIntentAppIdWidget},androidIntentExtra:{visibility:"visible",uiType:formdesigner.widgets.androidIntentExtraWidget},androidIntentResponse:{visibility:"visible",uiType:formdesigner.widgets.androidIntentResponseWidget}}),spec},getAppearanceAttribute:function(){return"intent:"+this.dataElement.nodeID}}),Barcode=BaseMug.$extend({typeName:"Barcode Scan",icon:"icon-vellum-android-intent",isODKOnly:!0,__init__:function(options){this.$super(options),this.controlElement.tagName="input",this.bindElement.dataType="barcode"}}),Date=BaseMug.$extend({typeName:"Date",icon:"icon-calendar",__init__:function(options){this.$super(options),this.controlElement.tagName="input",this.bindElement.dataType="xsd:date"}}),DateTime=BaseMug.$extend({typeName:"Date and Time",icon:"icon-vellum-datetime",__init__:function(options){this.$super(options),this.controlElement.tagName="input",this.bindElement.dataType="xsd:dateTime"}}),Time=BaseMug.$extend({typeName:"Time",icon:"icon-time",__init__:function(options){this.$super(options),this.controlElement.tagName="input",this.bindElement.dataType="xsd:time"}}),Long=Int.$extend({typeName:"Long",icon:"icon-vellum-long",__init__:function(options){this.$super(options),this.bindElement.dataType="xsd:long"}}),Double=Int.$extend({typeName:"Decimal",icon:"icon-vellum-decimal",__init__:function(options){this.$super(options),this.bindElement.dataType="xsd:double"}}),Item=ControlOnly.$extend({typeName:"Choice",icon:"icon-circle-blank",isTypeChangeable:!1,getIcon:function(){return"Select"===this.parentMug.__className?"icon-circle-blank":"icon-check-empty"},__init__:function(options){this.$super(options),this.controlElement.tagName="item",this.controlElement.defaultValue=formdesigner.util.generate_item_label()},getControlElementSpec:function(){var spec=this.$super();return spec.defaultValue={lstring:"Choice Value",visibility:"hidden",editable:"w",presence:"optional",validationFunc:validationFuncs.defaultValue},spec.hintLabel.presence="notallowed",spec.hintItextID.presence="notallowed",spec.defaultValue.visibility="visible",spec.defaultValue.presence="required",spec}}),Trigger=BaseMug.$extend({typeName:"Label",icon:"icon-tag",isTypeChangeable:!1,__init__:function(options){this.$super(options),this.controlElement.tagName="trigger"},getBindElementSpec:function(){var spec=this.$super();return spec.dataType.presence="notallowed",spec},getDataElementSpec:function(){var spec=this.$super();return spec.dataValue.presence="optional",spec}}),BaseSelect=BaseMug.$extend({}),MSelect=BaseSelect.$extend({typeName:"Multiple Answer",icon:"icon-vellum-multi-select",__init__:function(options){this.$super(options),this.controlElement.tagName="select"},getBindElementSpec:function(){var spec=this.$super();return spec.dataType.visibility="hidden",spec}}),Select=MSelect.$extend({typeName:"Single Answer",icon:"icon-vellum-single-select",__init__:function(options){this.$super(options),this.controlElement.tagName="select1"}}),Group=BaseMug.$extend({typeName:"Group",icon:"icon-folder-open",isSpecialGroup:!0,isTypeChangeable:!1,__init__:function(options){this.$super(options),this.controlElement.tagName="group"},getControlElementSpec:function(){var spec=this.$super();return spec.hintLabel.presence="notallowed",spec},getBindElementSpec:function(){var spec=this.$super();return spec.dataType.presence="notallowed",spec.calculateAttr.presence="notallowed",spec.constraintAttr.presence="notallowed",spec},getDataElementSpec:function(){var spec=this.$super();return spec.dataValue.presence="notallowed",spec}}),FieldList=Group.$extend({typeName:"Question List",icon:"icon-reorder",isSpecialGroup:!0,isTypeChangeable:!1,__init__:function(options){this.$super(options),this.controlElement.tagName="group",this.setAppearanceAttribute("field-list")}}),Repeat=Group.$extend({typeName:"Repeat Group",icon:"icon-retweet",isSpecialGroup:!0,isTypeChangeable:!1,__init__:function(options){this.$super(options),this.controlElement.tagName="repeat"},getControlElementSpec:function(){return $.extend(!0,{},this.$super(),{repeat_count:{lstring:"Repeat Count",visibility:"visible",editable:"w",presence:"optional",uiType:formdesigner.widgets.droppableTextWidget},no_add_remove:{lstring:"Disallow Repeat Add and Remove?",visibility:"visible",editable:"w",presence:"optional",uiType:formdesigner.widgets.checkboxWidget}})}}),exportedMugTypes={AndroidIntent:AndroidIntent,Audio:Audio,Barcode:Barcode,DataBindOnly:DataBindOnly,Date:Date,DateTime:DateTime,Double:Double,FieldList:FieldList,Geopoint:Geopoint,Group:Group,Image:Image,Int:Int,Item:Item,Long:Long,MSelect:MSelect,PhoneNumber:PhoneNumber,ReadOnly:ReadOnly,Repeat:Repeat,Secret:Secret,Select:Select,Text:TextQuestion,Time:Time,Trigger:Trigger,Video:Video},allTypes=_.keys(exportedMugTypes),innerChildQuestionTypes=_.without(allTypes,"DataBindOnly","Item"),nonGroupTypes=_.without(innerChildQuestionTypes,"Group","Repeat","FieldList");return _(exportedMugTypes).each(function(Mug,name){var validChildTypes;validChildTypes="Group"==name||"Repeat"==name?innerChildQuestionTypes:"FieldList"==name?nonGroupTypes:"Select"==name||"MSelect"==name?["Item"]:[],Mug.prototype.__className=name,Mug.prototype.validChildTypes=validChildTypes}),exportedMugTypes}();if("undefined"==typeof formdesigner)var formdesigner={};if(formdesigner.controller=function(){"use strict";function parseDataTree(dataEl){function parseDataElement(el){var nodeID,nodeVal,mug,parentMug,extraXMLNS,keyAttr,parentNodeName,rootNodeName,dataTree;nodeID=el.nodeName,mug=new mugs.DataBindOnly,parentNodeName=$(el).parent()[0].nodeName,rootNodeName=$(dataEl)[0].nodeName,dataTree=that.form.dataTree,nodeVal=0===$(el).children().length?$(el).text():null,extraXMLNS=$(el).attr("xmlns"),keyAttr=$(el).attr("key"),mug.dataElement.nodeID=nodeID,mug.dataElement.dataValue=nodeVal,mug.bindElement.nodeID=nodeID,extraXMLNS&&extraXMLNS!==formdesigner.formUuid&&(mug.dataElement.xmlnsAttr=extraXMLNS),keyAttr&&(mug.dataElement.keyAttr=keyAttr),mug.dataElement._rawAttributes=formdesigner.util.getAttributes(el),parentMug=parentNodeName===rootNodeName?null:that.form.getMugByIDFromTree(parentNodeName,"data")[0],dataTree.insertMug(mug,"into",parentMug)}var recFunc,root=$(dataEl);recFunc=function(){parseDataElement(this),$(this).children().each(recFunc)},0===root.children().length&&that.addParseErrorMsg("Data block has no children elements! Please make sure your form is a valid JavaRosa XForm and try again!"),root.children().each(recFunc),formdesigner.formUuid=root.attr("xmlns"),formdesigner.formJRM=root.attr("xmlns:jrm"),formdesigner.formUIVersion=root.attr("uiVersion"),formdesigner.formVersion=root.attr("version"),formdesigner.formName=root.attr("name"),that.form.formID=$(root)[0].tagName,formdesigner.formUuid||that.addParseWarningMsg("Form does not have a unique xform XMLNS (in data block). Will be added automatically"),formdesigner.formJRM||that.addParseWarningMsg("Form JRM namespace attribute was not found in data block. One will be added automatically"),formdesigner.formUIVersion||that.addParseWarningMsg("Form does not have a UIVersion attribute, one will be generated automatically"),formdesigner.formVersion||that.addParseWarningMsg("Form does not have a Version attribute (in the data block), one will be added automatically"),formdesigner.formName||that.addParseWarningMsg("Form does not have a Name! The default form name will be used")}function getLabelRef($lEl){var ref=$lEl.attr("ref");return ref?getITextReference(ref):null}function parseLabel(lEl,mug){var labelItext,Itext=formdesigner.pluginManager.javaRosa.Itext,$lEl=$(lEl),labelVal=formdesigner.util.getXLabelValue($lEl),labelRef=getLabelRef($lEl),cProps=mug.controlElement;cProps.label=labelVal;var newLabelItext=function(mug){var item=new ItextItem({id:mug.getDefaultLabelItextId()});return Itext.addItem(item),item};labelItext=labelRef?Itext.getOrCreateItem(labelRef):newLabelItext(mug),cProps.labelItextID=labelItext,cProps.labelItextID.isEmpty()&&cProps.labelItextID.setDefaultValue(labelVal?labelVal:mug.getDefaultLabelValue())}function parseHint(hEl,mug){var Itext=formdesigner.pluginManager.javaRosa.Itext,$hEl=$(hEl),hintVal=formdesigner.util.getXLabelValue($hEl),hintRef=getLabelRef($hEl),cProps=mug.controlElement;cProps.hintItextID=hintRef?Itext.getOrCreateItem(hintRef):Itext.createItem(""),cProps.hintLabel=hintVal}function parseDefaultValue(dEl,mug){var dVal=formdesigner.util.getXLabelValue($(dEl)),cProps=mug.controlElement;dVal&&(cProps.defaultValue=dVal)}function parseRepeatVals(r_count,r_noaddremove,mug){r_count&&(mug.controlElement.repeat_count=r_count),r_noaddremove&&(mug.controlElement.no_add_remove=r_noaddremove)}function mugTypeFromInput(dataType,appearance){return dataType?"long"===dataType?mugs.Long:"int"===dataType?mugs.Int:"double"===dataType?mugs.Double:"geopoint"===dataType?mugs.Geopoint:"barcode"===dataType?mugs.Barcode:"intent"===dataType?mugs.AndroidIntent:"string"===dataType?"numeric"===appearance?mugs.PhoneNumber:mugs.Text:"date"===dataType?mugs.Date:"datetime"===dataType?mugs.DateTime:"time"===dataType?mugs.Time:mugs.Text:mugs.Text}function mugTypeFromGroup(cEl){return"field-list"===$(cEl).attr("appearance")?mugs.FieldList:$(cEl).children("repeat").length>0?mugs.Repeat:mugs.Group}function mugTypeFromUpload(mediaType,nodePath){if(!mediaType)throw"Unable to parse binary question type. Path: "+that.form.dataTree.getAbsolutePath(oldMug)+"The question has no MediaType attribute assigned to it!";if("video/*"===mediaType)return mugs.Video;if("image/*"===mediaType)return mugs.Image;if("audio/*"===mediaType)return mugs.Audio;throw"Unrecognized upload question type for Element: "+nodePath+"!"}function classifyAndCreateMug(nodePath,cEl){var mug,tagName,bindEl,dataType,appearance,MugClass,mediaType,oldMug=that.getMugByPath(nodePath,"data");return tagName=$(cEl)[0].nodeName,oldMug&&(bindEl=oldMug.bindElement,bindEl&&(dataType=bindEl.dataType,appearance=cEl.attr("appearance"),mediaType=cEl.attr("mediatype")?cEl.attr("mediatype"):null,dataType&&(dataType=dataType.replace("xsd:",""),dataType=dataType.toLowerCase()),mediaType&&(mediaType=mediaType.toLowerCase()))),tagName=tagName.toLowerCase(),"select"===tagName?MugClass=mugs.MSelect:"select1"===tagName?MugClass=mugs.Select:"trigger"===tagName?MugClass=mugs.Trigger:"input"===tagName?"true()"===cEl.attr("readonly")?(MugClass=mugs.Trigger,cEl.removeAttr("readonly")):MugClass=mugTypeFromInput(dataType,appearance):"item"===tagName?MugClass=mugs.Item:"group"===tagName?(MugClass=mugTypeFromGroup(cEl),MugClass===mugs.Repeat&&(tagName="repeat")):MugClass="secret"===tagName?mugs.Secret:"upload"===tagName?mugTypeFromUpload(mediaType,nodePath):mugs.ReadOnly,mug=new MugClass,oldMug&&(mug.copyAttrs(oldMug),mug.ufid=oldMug.ufid,that.form.replaceMug(oldMug,mug,"data")),appearance&&mug.setAppearanceAttribute(appearance),mug}function populateMug(mug,cEl){var labelEl,hintEl,repeat_count,repeat_noaddremove;if("ReadOnly"===mug.__className)return void(mug.controlElementRaw=cEl);var tag=mug.controlElement.tagName;"repeat"===tag?(labelEl=$($(cEl).parent().children("label")),hintEl=$(cEl).parent().children("hint"),repeat_count=$(cEl).popAttr("jr:count"),repeat_noaddremove=formdesigner.util.parseBoolAttributeValue($(cEl).popAttr("jr:noAddRemove"))):(labelEl=$(cEl).children("label"),hintEl=$(cEl).children("hint")),labelEl.length>0&&parseLabel(labelEl,mug),hintEl.length>0&&parseHint(hintEl,mug),"item"===tag&&parseDefaultValue($(cEl).children("value"),mug),"repeat"===tag&&parseRepeatVals(repeat_count,repeat_noaddremove,mug),formdesigner.intentManager.syncMugWithIntent(mug),mug.controlElement._rawAttributes=formdesigner.util.getAttributes(cEl)}function isRepeatTest(groupEl){return"group"!==$(groupEl)[0].tagName?!1:1===$(groupEl).children("repeat").length}function parseControlTree(controlsTree){function eachFunc(){var oldEl,path,mug,parentNode,parentMug,tagName,children,isRepeat,el=$(this),couldHaveChildren=["repeat","group","fieldlist","select","select1"];if(isRepeat=isRepeatTest(el),isRepeat&&(oldEl=el,el=$(el.children("repeat")[0])),parentNode=oldEl?oldEl.parent():el.parent(),"h:body"===$(parentNode)[0].nodeName&&(parentNode=null),parentNode&&(parentMug=mugFromControlEl(parentNode)),path=formdesigner.util.getPathFromControlElement(el),!path){var existingMug=mugFromControlEl(el);existingMug&&(path=that.form.dataTree.getAbsolutePath(existingMug))}mug=oldEl?classifyAndCreateMug(path,oldEl):classifyAndCreateMug(path,el),populateMug(mug,el),that.form.controlTree.insertMug(mug,"into",parentMug),"ReadOnly"!==mug.__className&&(tagName=mug.controlElement.tagName.toLowerCase(),-1!==couldHaveChildren.indexOf(tagName)&&(children=$(el).children().not("label").not("value").not("hint"),children.each(eachFunc)),Itext.updateForExistingMug(mug))}var Itext=formdesigner.pluginManager.javaRosa.Itext;controlsTree.each(eachFunc)}function processPath(path,rootNodeName){var newPath,parsed=xpath.parse(path);return parsed instanceof xpathmodels.XPathPathExpr?(parsed.initial_context==xpathmodels.XPathInitialContextEnum.RELATIVE&&(parsed.steps.splice(0,0,xpathmodels.XPathStep({axis:"child",test:rootNodeName})),parsed.initial_context=xpathmodels.XPathInitialContextEnum.ROOT),newPath=parsed.toXPath()):null}function parseBindList(bindList){var Itext=formdesigner.pluginManager.javaRosa.Itext;bindList.each(function(){var nodeID,oldMug,el=$(this),attrs={},mug=new mugs.DataBindOnly,path=el.popAttr("nodeset"),id=el.popAttr("id");path||(path=el.popAttr("ref")),nodeID=formdesigner.util.getNodeIDFromPath(path),id?(attrs.nodeID=id,attrs.nodeset=path):attrs.nodeID=nodeID,attrs.dataType=el.popAttr("type"),attrs.dataType&&"xsd:integer"===attrs.dataType.toLowerCase()&&(attrs.dataType="xsd:int"),attrs.appearance=el.popAttr("appearance"),attrs.relevantAttr=el.popAttr("relevant"),attrs.calculateAttr=el.popAttr("calculate"),attrs.constraintAttr=el.popAttr("constraint");var constraintMsg=lookForNamespaced(el,"constraintMsg"),constraintItext=getITextReference(constraintMsg);return constraintItext?attrs.constraintMsgItextID=Itext.getOrCreateItem(constraintItext):(attrs.constraintMsgItextID=Itext.createItem(""),attrs.constraintMsgAttr=constraintMsg),attrs.requiredAttr=formdesigner.util.parseBoolAttributeValue(el.popAttr("required")),attrs.preload=lookForNamespaced(el,"preload"),attrs.preloadParams=lookForNamespaced(el,"preloadParams"),path=processPath(path,that.form.dataTree.getRootNode().getID()),el=formdesigner.pluginManager.call("parseBindElement",el,path),oldMug=that.getMugByPath(path,"data"),!oldMug&&attrs.nodeset&&(oldMug=that.form.getMugByIDFromTree(formdesigner.util.getNodeIDFromPath(attrs.nodeset),"data")[0]),oldMug?(mug.ufid=oldMug.ufid,mug.copyAttrs(oldMug),mug.bindElement.setAttrs(attrs,!0),mug.bindElement._rawAttributes=formdesigner.util.getAttributes(el),oldMug.bindElement&&Itext.removeItem(oldMug.bindElement.constraintMsgItextID),void that.form.replaceMug(oldMug,mug,"data")):void that.addParseWarningMsg("Bind Node ["+path+"] found but has no associated Data node. This bind node will be discarded!")})}var that={},DEBUG_MODE=!1,saveButton=SaveButton.init({save:function(){that.validateAndSaveXForm()},unsavedMessage:"Are you sure you want to exit? All unsaved changes will be lost!"});that.saveButton=saveButton;var initFormDesigner=function(sessionid){if(xpathmodels.DEBUG_MODE=DEBUG_MODE,formdesigner.util.question_counter=1,formdesigner.model.init(),formdesigner.ui.init(sessionid),that.setCurrentlySelectedMug(null),formdesigner.opts.langs&&formdesigner.opts.langs.length>0){for(var i=0;i<formdesigner.opts.langs.length;i++)formdesigner.pluginManager.javaRosa.Itext.addLanguage(formdesigner.opts.langs[i]);formdesigner.pluginManager.javaRosa.Itext.setDefaultLanguage(formdesigner.opts.langs[0])}else 0===formdesigner.pluginManager.javaRosa.Itext.languages.length&&formdesigner.pluginManager.javaRosa.Itext.addLanguage("en");formdesigner.currentItextDisplayLanguage=formdesigner.opts.displayLanguage||formdesigner.pluginManager.javaRosa.Itext.getDefaultLanguage(),formdesigner.langCodeToName={},_.each(formdesigner.opts.langs,function(langcode){$.getJSON("/langcodes/langs.json",{term:langcode},function(res){res.length>=1&&(formdesigner.langCodeToName[res[0].code]=res[0].name,that.fire("fd-update-language-name"))})}),that.on("question-creation",function(){that.setFormChanged()}),that.on("question-itext-changed",function(){that.setFormChanged()}),that.on("parse-start",function(){that.resetParseErrorMsgs(),that.resetParseWarningMsgs()}),that.on("parse-finish",function(){var allMugs=that.getMugList(!0);allMugs.map(function(mug){formdesigner.util.setStandardMugEventResponses(mug)});var i;if(that.parseErrorMsgs)for(i=0;i<that.parseErrorMsgs.length;i++)that.form.updateError(formdesigner.model.FormError({level:"error",message:that.parseErrorMsgs[i]}));if(that.parseWarningMsgs)for(i=0;i<that.parseWarningMsgs.length;i++)that.form.updateError(formdesigner.model.FormError({level:"parse-warning",message:that.parseWarningMsgs[i]}));formdesigner.ui.resetMessages(that.form.errors),allMugs.map(formdesigner.model.LogicManager.updateAllReferences)}),that.on("parse-error",function(e){DEBUG_MODE&&console.log("There was a parse error:",e)})};that.initFormDesigner=initFormDesigner,that.setFormChanged=function(){saveButton.fire("change")},that.isFormSaved=function(){return"saved"===saveButton.state},that.setForm=function(aForm){that.form=aForm,formdesigner.util.setStandardFormEventResponses(that.form)};var getAllNonEmptyItextItemsFromMugs=function(){var ret=[],appendItemsIfPresent=function(node){if(!node.isRootNode){var mt=node.getValue();if(!mt)throw"Node in tree without value?!?!";for(var val,thingsToGet=["controlElement/labelItextID","controlElement/hintItextID","bindElement/constraintMsgItextID"],i=0;i<thingsToGet.length;i++)try{val=mt.getPropertyValue(thingsToGet[i]),val&&!val.isEmpty()&&-1===ret.indexOf(val)&&ret.push(val)}catch(err){}}};return that.form.controlTree.treeMap(appendItemsIfPresent),that.form.dataTree.treeMap(appendItemsIfPresent),ret};that.getAllNonEmptyItextItemsFromMugs=getAllNonEmptyItextItemsFromMugs;var getMugByPath=function(path,tree){var recFunc,tokens,targetMug,rootNode;return tree||(tree="data"),path?(recFunc=function(node,recTokens){var currentToken,rest,children,i;if(0===recTokens.length)return node.getValue();currentToken=recTokens[0],rest=recTokens.slice(1),children=node.getChildren();for(i in children)if(children.hasOwnProperty(i)&&children[i].getID()===currentToken)return recFunc(children[i],rest);return null},tokens=path.split("/").slice(1),0===tokens.length?null:("data"===tree?rootNode=that.form.dataTree.getRootNode():"control"===tree&&(rootNode=that.form.controlTree.getRootNode()),rootNode.getID()!==tokens[0]?null:targetMug=recFunc(rootNode,tokens.slice(1)))):null};that.getMugByPath=getMugByPath;var getSingularMugByNodeId=function(nodeId,treeType){if(treeType||(treeType="data"),!nodeId)return null;var nodeMatches=function(node){var mt=node.getValue();return mt&&mt.mug&&mt.mug.getBindElementID()===nodeId?mt:null},tree="data"===treeType?that.form.dataTree:that.form.controlTree,matchList=tree.treeMap(nodeMatches).filter(function(m){return null!==m});if(1!==matchList.length)throw"Expected one result for node "+nodeId+" but found "+matchList.length;return matchList[0]};that.getSingularMugByNodeId=getSingularMugByNodeId,that.getChildren=function(mug){var node=that.form.controlTree.getNodeFromMug(mug),children=node?node.getChildren():[];return children.map(function(item){return item.getValue()})},that.getMugList=function(includeSelectItems){var cTree,dTree,treeFunc,cList,dList;return treeFunc=function(node){if(!node.isRootNode){var mug=node.getValue();if("Item"!==mug.__className||includeSelectItems)return mug}},cTree=that.form.controlTree,dTree=that.form.dataTree,cList=cTree.treeMap(treeFunc),dList=dTree.treeMap(treeFunc),formdesigner.util.mergeArray(cList,dList)},that.setMugPropertyValue=function(myMug,element,property,val){var prev=myMug[element][property];myMug[element][property]=val,myMug.fire({type:"property-changed",property:property,element:element,val:val,previous:prev,mugUfid:myMug.ufid})},that.insertMugIntoForm=function(refMug,newMug,position){var dataTree=that.form.dataTree,controlTree=that.form.controlTree;return newMug.dataElement&&!newMug.controlElement?void dataTree.insertMug(newMug,"after",null):(position=position||"into",newMug.dataElement&&dataTree.insertMug(newMug,position,refMug),void(newMug.controlElement&&controlTree.insertMug(newMug,position,refMug)))},that.reloadUI=function(){var get_rollback=$.jstree._fn.get_rollback;$.jstree._fn.get_rollback=function(){};var treeFunc,dataNodeList;that.setCurrentlySelectedMug(null),formdesigner.ui.skipNodeSelectEvent=!0,treeFunc=function(node){var mug;if(!node.isRootNode){if(mug=node.getValue(),!mug)throw"Node in tree without value?!?!";that.loadMugIntoUI(mug)}},that.form.controlTree.treeMap(treeFunc),dataNodeList=that.getDataNodeList();for(var i=0;i<dataNodeList.length;i++)that.loadMugIntoUI(dataNodeList[i]);formdesigner.ui.setAllTreeValidationIcons(),formdesigner.ui.skipNodeSelectEvent=!1,formdesigner.ui.selectSomethingOrResetUI(!0),that.fire("fd-reload-ui"),$.jstree._fn.get_rollback=get_rollback},that.getDataNodeList=function(){var treeFunc=function(node){if(!node.getValue()||node.isRootNode)return null;var mug=node.getValue();return mug.controlElement?null:mug};return that.form.dataTree.treeMap(treeFunc)},that.createQuestionInUITree=function(mug,position){var objectData,insertPosition;mug.controlElement?insertPosition=position||"into":(formdesigner.ui.jstree("deselect_all"),insertPosition="last"),objectData={data:formdesigner.util.getMugDisplayName(mug),metadata:{mug:mug,mugUfid:mug.ufid,dataID:mug.getDataElementID(),bindID:mug.getBindElementID()},attr:{id:mug.ufid,rel:mug.__className},state:mug.isSpecialGroup?"open":void 0};var oldSelected=that.getCurrentlySelectedMug(),result=formdesigner.ui.jstree("create",null,insertPosition,objectData,null,!0),success=result&&result[0].id!==formdesigner.ui.QUESTION_TREE_DIV;return success&&oldSelected&&formdesigner.ui.jstree("select_node","#"+oldSelected.ufid),success},that.duplicateCurrentQuestion=function(options){function duplicateMug(mug,parentMug,options){var duplicate=new mugs[mug.__className];if(pathReplacements=[],duplicate.copyAttrs(mug),formdesigner.util.give_ufid(duplicate),formdesigner.util.eventuality(duplicate),formdesigner.util.setStandardMugEventResponses(duplicate),mug.bindElement&&mug.bindElement.nodeID){var newQuestionID=formdesigner.util.generate_question_id(mug.bindElement.nodeID);duplicate.bindElement.nodeID=newQuestionID,mug.dataElement&&(duplicate.dataElement.nodeID=newQuestionID)}if(0===depth&&mug.controlElement&&mug.controlElement.defaultValue){var newItemValue=formdesigner.util.generate_question_id(mug.controlElement.defaultValue);duplicate.controlElement.defaultValue=newItemValue}formdesigner.ui.skipNodeSelectEvent="copy"!==options.itext,depth>0?(parentMug&&formdesigner.ui.jstree("select_node","#"+parentMug.ufid),that.initQuestion(duplicate,parentMug)):(formdesigner.ui.jstree("select_node","#"+mug.ufid),that.initQuestion(duplicate,mug,"after"),formdesigner.ui.jstree("deselect_all").jstree("select_node","#"+duplicate.ufid)),formdesigner.model.LogicManager.updateAllReferences(duplicate),"copy"===options.itext&&(formdesigner.ui.displayMugProperties(duplicate),that.unlinkCurrentQuestionItext()),formdesigner.ui.skipNodeSelectEvent=!0;var children=that.getChildren(mug);depth++;for(var i=0;i<children.length;i++)pathReplacements=pathReplacements.concat(duplicateMug(children[i],duplicate,options)[1]);return depth--,parentMug&&formdesigner.ui.jstree("deselect_all").jstree("select_node","#"+parentMug.ufid),pathReplacements.push({mugId:mug.ufid,from:that.form.dataTree.getAbsolutePath(mug),to:that.form.dataTree.getAbsolutePath(duplicate)}),[duplicate,pathReplacements]}options=options||{},options.itext=options.itext||"link";var depth=0,oldSkip=formdesigner.ui.skipNodeSelectEvent,selected=that.getCurrentlySelectedMug(),parent=selected.parentMug,foo=duplicateMug(selected,parent,options),duplicate=foo[0],pathReplacements=foo[1];_gaq&&_gaq.push(["_trackEvent","Form Builder","Copy",foo[0].typeName]);for(var i=0;i<pathReplacements.length;i++){var pr=pathReplacements[i];formdesigner.model.LogicManager.updatePath(pr.mugId,pr.from,pr.to,that.form.dataTree.getAbsolutePath(duplicate))}formdesigner.ui.skipNodeSelectEvent=!1,formdesigner.ui.jstree("deselect_all").jstree("select_node","#"+duplicate.ufid),formdesigner.ui.skipNodeSelectEvent=oldSkip,that.form.fire({type:"form-property-changed"})},that.initQuestion=function(mug,refMug,position){if(formdesigner.util.setStandardMugEventResponses(mug),refMug=refMug||that.getCurrentlySelectedMug(),refMug&&!refMug.controlElement){var lowest=formdesigner.ui.selectLowestQuestionNode();refMug=that.getMugFromFormByUFID($(lowest).prop("id")),position="after"}position=position||"into";var success=!1;for(mug.parentMug="into"===position?refMug:refMug.parentMug;!success&&refMug;)formdesigner.ui.jstree("select_node","#"+refMug.ufid),success=that.createQuestionInUITree(mug,position),success||("after"!==position?position="after":refMug=refMug.parentMug);return success||(formdesigner.ui.selectLowestQuestionNode(),refMug=that.getCurrentlySelectedMug(),position="after",success=that.createQuestionInUITree(mug,position)),success?(that.insertMugIntoForm(refMug,mug,position),formdesigner.pluginManager.javaRosa.Itext.updateForNewMug(mug),formdesigner.intentManager.syncMugWithIntent(mug),formdesigner.ui.jstree("select_node","#"+mug.ufid),this.fire({type:"question-creation",mug:mug}),mug):!1},that.removeCurrentQuestion=function(){that.removeMugFromForm(that.getCurrentlySelectedMug())},that.unlinkCurrentQuestionItext=function(){$("#controlElement-labelItextID-auto-itext").prop("checked",!0).change(),$.trim($("#bindElement-constraintMsgItextID").val())&&$("#bindElement-constraintMsgItextID-auto-itext").prop("checked",!0).change(),$.trim($("#controlElement-hintItextID").val())&&$("#controlElement-hintItextID-auto-itext").prop("checked",!0).change()},that.isCurrentQuestionAutoItextId=function(){return $("#controlElement-labelItextID-auto-itext").prop("checked")},that.changeQuestionType=function(mug,questionType){var $currentChanger=$("#fd-question-changer");if(mug.__className!==questionType){var children=that.getChildren(mug);if(children.length>0&&"Select"!==questionType&&"MSelect"!==questionType)throw"you can't change a Multiple/Single Choice question to a non-Choice question if it has Choices. Please remove all Choices and try again.";var newMug=new mugs[questionType];newMug.ufid=mug.ufid,mug.controlElement&&mug.controlElement.appearance&&(mug.controlElement.appearance=null),newMug.copyAttrs(mug),that.form.replaceMug(mug,newMug,"data"),that.form.replaceMug(mug,newMug,"control"),formdesigner.ui.jstree("set_type",questionType,"#"+mug.ufid),mug=newMug,$currentChanger.after(formdesigner.widgets.getQuestionTypeChanger(newMug)).remove(),that.form.fire({type:"form-property-changed"})}else formdesigner.ui.overrideJSTreeIcon(mug.ufid,mugs[questionType]),$currentChanger.after(formdesigner.widgets.getQuestionTypeChanger(mug)).remove();("Select"===mug.__className||"MSelect"===mug.__className)&&that.updateMugChildren(mug)},that.updateMugChildren=function(parentMug){_.each(that.getChildren(parentMug),function(childMug){that.fire({type:"parent-question-type-changed",mug:childMug})})},that.loadMugIntoUI=function(mug){var controlTree,parentMug;controlTree=that.form.controlTree,parentMug=mug.parentMug,parentMug&&mug.controlElement?formdesigner.ui.jstree("select_node","#"+parentMug.ufid,!0):formdesigner.ui.jstree("deselect_all"),that.createQuestionInUITree(mug)},that.generateExportXLS=function(){formdesigner.pluginManager.call("preSerialize");var languages=formdesigner.pluginManager.javaRosa.Itext.getLanguages(),itextColumns={"default":"Text",audio:"Audio",image:"Image"},columnOrder=["Question","Type"];for(var type in itextColumns)for(var colName=itextColumns[type],i=0;i<languages.length;i++)columnOrder.push(colName+" ("+languages[i]+")");columnOrder=columnOrder.concat(["Display Condition","Validation Condition","Validation Message","Calculate Condition","Required"]);var mugToExportRow=function(mug){for(var row={},itext=mug.controlElement?mug.controlElement.labelItextID:null,defaultLanguage=formdesigner.pluginManager.javaRosa.Itext.getDefaultLanguage(),defaultOrNothing=function(item,language,form){return item&&item.hasForm(form)?item.getForm(form).getValueOrDefault(language):""},i=0;i<columnOrder.length;i++)row[columnOrder[i]]="";if(row.Question=mug.getDefaultItextRoot(),row.Type=mug.typeName,mug.controlElement)for(var type in itextColumns)for(var colName=itextColumns[type],i=0;i<languages.length;i++){var key=colName+" ("+languages[i]+")";row[key]=defaultOrNothing(itext,languages[i],type)}mug.bindElement&&(row["Display Condition"]=mug.bindElement.relevantAttr,row["Calculate Condition"]=mug.bindElement.calculateAttr,row.Required=mug.bindElement.requiredAttr?"yes":"no",row["Validation Condition"]=mug.bindElement.constraintAttr,row["Validation Message"]=defaultOrNothing(mug.bindElement?mug.bindElement.constraintMsgItextID:null,defaultLanguage,"default"));for(var prop in row)row.hasOwnProperty(prop)&&(row[prop]=row[prop]||"");return formdesigner.util.tabSeparate(columnOrder.map(function(column){return row[column]}))},headers=[formdesigner.util.tabSeparate(columnOrder)],rows=headers.concat(that.getMugList(!0).map(mugToExportRow));return rows.join("\n")
},that.showExportDialog=function(){var $modal,$exportForm;$modal=formdesigner.ui.generateNewModal("Export Form Contents",[]),$exportForm=formdesigner.ui.getTemplateObject("#fd-template-form-edit-source",{description:"Copy and paste this content into a spreadsheet program like Excel to easily share your form with others."}),$modal.find(".modal-body").html($exportForm),$exportForm.find("textarea").val(that.generateExportXLS()),$modal.modal("show")},that.showFormPropertiesDialog=function(){function fireFormPropChanged(propName,oldVal,newVal){formdesigner.controller.form.fire({type:"form-property-changed",propName:propName,oldVal:oldVal,newVal:newVal})}var $modal,$modalBody,formProperties;$modal=formdesigner.ui.generateNewModal("Edit Form Properties",[]),$modalBody=$modal.find(".modal-body"),$modalBody.append($("<p />").text("Note: changing the Form ID here will not automatically change the Form ID in existing references in your logic conditions.  If you change the Form ID, you must manually change any existing logic references.")),formProperties=[{label:"Form Name",slug:"formName"},{label:"Form ID",slug:"formID",cleanValue:function(val){return val.replace(/ /g,"_")}}],_.each(formProperties,function(prop){var $propertyInput=formdesigner.ui.getTemplateObject("#fd-template-control-group-stdInput",{label:prop.label,controlId:"fd-form-prop-"+prop.slug+"-input"});$modalBody.append($propertyInput),$propertyInput.find("input").val(formdesigner.controller.form[prop.slug]).on("keyup",function(){var currentVal=$(this).val();"function"==typeof prop.cleanValue&&(currentVal=prop.cleanValue(currentVal),$(this).val(currentVal)),fireFormPropChanged(prop.slug,formdesigner.controller.form[prop.slug],currentVal),formdesigner.controller.form[prop.slug]=currentVal})}),$modal.modal("show")},that.showSourceXMLDialog=function(){function showSourceInModal(){var $modal,$updateForm,$textarea,codeMirror,modalHeaderHeight,modalFooterHeight,modalHeight,modalBodyHeight;$modal=formdesigner.ui.generateNewModal("Edit Form's Source XML",[{id:"fd-update-source-button",title:"Update Source",cssClasses:"btn-primary"}]),$updateForm=formdesigner.ui.getTemplateObject("#fd-template-form-edit-source",{description:"This is the raw XML. You can edit or paste into this box to make changes to your form. Press 'Update Source' to save changes, or 'Close' to cancel."}),modalHeaderHeight=$modal.find(".modal-header").outerHeight(),modalFooterHeight=$modal.find(".modal-footer").outerHeight(),modalHeight=$(window).height()-40,modalBodyHeight=modalHeight-(modalFooterHeight-modalHeaderHeight)-126,$modal.css("height",modalHeight+"px").css("width",$(window).width()-40+"px"),$modal.addClass("fd-source-modal").removeClass("form-horizontal").find(".modal-body").html($updateForm).css("height",modalBodyHeight+"px"),$textarea=$updateForm.find("textarea"),$textarea.val(that.formLoadingFailed?formdesigner.loadMe:that.form.createXForm());try{codeMirror=CodeMirror.fromTextArea($textarea.get(0)),codeMirror.setOption("viewportMargin",1/0),codeMirror.setOption("lineNumbers",!0),codeMirror.setSize("100%","100%")}catch(e){}$modal.find("#fd-update-source-button").click(function(){codeMirror&&codeMirror.save(),that.loadXForm($textarea.val()),that.form.fire("form-property-changed"),$modal.modal("hide")}),$modal.modal("show"),$modal.on("shown",function(){codeMirror&&codeMirror.refresh()})}function onContinue(){formdesigner.ui.hideConfirmDialog(),showSourceInModal()}function onAbort(){formdesigner.ui.hideConfirmDialog()}var msg="There are validation errors in the form.  Do you want to continue anyway? WARNING:The form will not be valid and likely not perform correctly on your device!";formdesigner.ui.setDialogInfo(msg,"Continue",onContinue,"Abort",onAbort),that.form.isFormValid()?showSourceInModal():formdesigner.ui.showConfirmDialog()};var setFormName=function(name){that.form.formName=name};that.setFormName=setFormName,that.loadXForm=function(formString){function formLoadFailed(){var showSourceButton=$("#fd-editsource-button");that.formLoadingFailed=!0,formdesigner.loadMe=formString,formdesigner.ui.disableUI(),showSourceButton.button("enable");var validator_url="https://www.commcarehq.org/formtranslate/",msg='We\'re sorry, Vellum cannot load your form.  You can edit your form directly by clicking the "Edit Source XML" button or go back to download your form. <br>It is likely that your form contains errors.  You can check to see if your form is valid by pasting your entire form into the <a href="'+validator_url+'" target="_blank">Form Validator</a>';formdesigner.model.form.updateError(formdesigner.model.FormError({key:"global-parse-fail",message:msg,level:"error"}),{updateUI:!0})}$.fancybox.showActivity(),that.formLoadingFailed=!1,window.setTimeout(function(){try{that.resetFormDesigner(),formdesigner.pluginManager.javaRosa.Itext.resetItext(),that.parseXML(formString),that.reloadUI()}catch(e){formLoadFailed(e),console.log("E OBJ",e);var msg=e.toString();0===msg.indexOf("Invalid XML")&&(msg="Parsing Error. Please check that your form is valid XML."),formdesigner.ui.setDialogInfo(msg,"ok",function(){formdesigner.ui.hideConfirmDialog()},"cancel",function(){formdesigner.ui.hideConfirmDialog()}),formdesigner.ui.showConfirmDialog()}that.formLoadingFailed||formdesigner.ui.enableUI(),$.fancybox.hideActivity()},500)},that.removeMugByUFID=function(ufid){var mug=that.form.getMugByUFID(ufid);that.removeMugFromForm(mug)},that._removeMugFromForm=function(mug){formdesigner.ui.removeMugFromTree(mug);var fromTree=that.form.controlTree.getNodeFromMug(mug);if(fromTree)for(var children=that.form.controlTree.getNodeFromMug(mug).getChildrenMugs(),i=0;i<children.length;i++)that._removeMugFromForm(children[i]);that.form.dataTree.removeMug(mug),that.form.controlTree.removeMug(mug)},that.removeMugFromForm=function(mug){that._removeMugFromForm(mug),formdesigner.ui.selectSomethingOrResetUI(),that.setFormChanged()},that.parseErrorMsgs=[],that.parseWarningMsgs=[];var addParseErrorMsg=function(msg){that.parseErrorMsgs.push(msg),that.fire({type:"parse-error",exceptionData:msg})};that.addParseErrorMsg=addParseErrorMsg;var addParseWarningMsg=function(msg){that.parseWarningMsgs.push(msg),that.fire({type:"parse-warning",exceptionData:msg})};that.addParseWarningMsg=addParseWarningMsg;var getParseErrorMsgs=function(){return that.parseErrorMsgs};that.getParseErrorMsgs=getParseErrorMsgs;var resetParseErrorMsgs=function(){that.parseErrorMsgs=[],formdesigner.model.form.clearErrors("error",{updateUI:!0})};that.resetParseErrorMsgs=resetParseErrorMsgs;var resetParseWarningMsgs=function(){that.parseWarningMsgs=[],formdesigner.model.form.clearErrors("parse-warning",{updateUI:!0})};that.resetParseWarningMsgs=resetParseWarningMsgs;var getITextReference=function(value){try{var parsed=xpath.parse(value);if(parsed instanceof xpathmodels.XPathFuncExpr&&"jr:itext"===parsed.id)return parsed.args[0].value}catch(err){}return!1},lookForNamespaced=function(element,reference){return element.popAttr("jr:"+reference)||element.popAttr("jr\\:"+reference)},mugFromControlEl=function(el){var nodeId,path=formdesigner.util.getPathFromControlElement(el);if(path)return that.getMugByPath(path,"data");if(nodeId=$(el).attr("bind"))try{return that.getSingularMugByNodeId(nodeId)}catch(err){return null}return null},_getInstances=function(xml){for(var instances=xml.find("instance"),foundMain=!1,ret=[],i=0;i<instances.length;i++)if($(instances[i]).attr("id"))ret.push(instances[i]);else{if(foundMain)throw"multiple unnamed instance elements found in the form! this is not allowed. please add id's to all but 1 instance.";ret.splice(0,0,instances[i]),foundMain=!0}return ret},parseXML=function(xmlString){that.fire("parse-start");try{var xmlDoc=$.parseXML(xmlString),xml=$(xmlDoc);xml=formdesigner.pluginManager.call("beforeParse",xml);var head=xml.find("h\\:head, head"),title=head.children("h\\:title, title"),binds=head.find("bind"),instances=_getInstances(xml),intentTags=["odkx\\:intent, intent"];intentTags.map(function(tag){var foundTags=head.children(tag);formdesigner.intentManager.parseIntentTagsFromHead(foundTags)});var data=$(instances[0]).children();if($(xml).find("parsererror").length>0)throw"PARSE ERROR! Message follows:"+$(xml).find("parsererror").find("div").html();title.length>0&&(that.form.formName=$(title).text()),that.form.instanceMetadata=instances.map(function(instance){return formdesigner.model.InstanceMetadata(formdesigner.util.getAttributes(instance),$(instance).children())}),0===data.length&&that.addParseErrorMsg("No Data block was found in the form.  Please check that your form is valid!"),parseDataTree(data[0]),parseBindList(binds);var controls=xml.find("h\\:body, body").children();parseControlTree(controls),that.fire({type:"parse-finish"})}catch(e){throw that.fire({type:"parse-error",exceptionData:e}),e}};that.parseXML=parseXML,that.moveMug=function(mug,refMug,position){var dataTree=that.form.dataTree,controlTree=that.form.controlTree,preMovePath=dataTree.getAbsolutePath(mug);mug.dataElement&&dataTree.insertMug(mug,position,refMug),mug.controlElement&&controlTree.insertMug(mug,position,refMug),formdesigner.model.LogicManager.updatePath(mug.ufid,preMovePath,dataTree.getAbsolutePath(mug)),that.form.fire({type:"form-property-changed"})};var getTreeLabel=function(mug){var retVal=mug.getBindElementID()?mug.getDataElementID():mug.getBindElementID();return retVal||(retVal=mug.controlElement.label),retVal};that.getTreeLabel=getTreeLabel;that.getCurrentlySelectedMug=function(){var selected=formdesigner.ui.jstree("get_selected");if(selected&&selected[0]){selected=selected[0];var ret=that.getMugFromFormByUFID($(selected).prop("id"))}else var ret=null;return ret},that.setCurrentlySelectedMug=function(ufid){ufid?formdesigner.ui.jstree("select_node","#"+ufid):formdesigner.ui.jstree("deselect_all")},that.getMugFromFormByUFID=function(ufid){return that.form.dataTree.getMugFromUFID(ufid)||that.form.controlTree.getMugFromUFID(ufid)},that.validateAndSaveXForm=function(){var getUrl=function(saveType){return"patch"===saveType?formdesigner.patchUrl:formdesigner.saveUrl},url=getUrl(formdesigner.saveType);url||formdesigner.ui.setDialogInfo("Error: Cannot send form, no save url specified!","OK",function(){$(this).dialog("close")},"Cancel",function(){$(this).dialog("close")});var send=function(formText,saveType){var data;if(saveType=saveType||formdesigner.saveType,$("body").ajaxStart(formdesigner.ui.showWaitingDialog),$("body").ajaxStop(formdesigner.ui.hideConfirmDialog),"patch"===saveType){var dmp=new diff_match_patch,patch=dmp.patch_toText(dmp.patch_make(formdesigner.originalXForm,formText));patch.length>formText.length&&(saveType="full")}var url=getUrl(saveType);data="patch"===saveType?{patch:patch,sha1:CryptoJS.SHA1(formdesigner.originalXForm).toString()}:{xform:formText},saveButton.ajax({type:"POST",url:url,data:data,dataType:"json",success:function(data){if("patch"===saveType){if("conflict"===data.status)return void send(formText,"full");CryptoJS.SHA1(formText).toString()!==data.sha1&&(console.error("sha1's didn't match"),send(formText,"full"))}formdesigner.ui.hideConfirmDialog(),formdesigner.fire({type:"form-saved",response:data}),formdesigner.originalXForm=formText}})},formText=that.form.createXForm(),parsed=!1;try{$.parseXML(formText),parsed=!0}catch(err){var theScaryWarning="It looks like your form is not valid XML. This can often happen if you use a reserved character in one of your questions. Characters to look out for are <, >, and &. You can still save, but Vellum will NOT LOAD THIS FORM again until you fix the XML by hand. What would you like to do?";formdesigner.ui.setDialogInfo(theScaryWarning,"Fix the problem (recommended)",function(){$(this).dialog("close")},"Save Anyways",function(){$(this).dialog("close"),send(formText)},"Form Validation Error"),formdesigner.ui.showConfirmDialog()}parsed&&send(formText)},that.resetFormDesigner=function(){formdesigner.util.question_counter=1,formdesigner.model.reset(),formdesigner.ui.reset()};var handleTreeDrop=function(source,target){var target=$(target),sourceUid=$(source).attr("id");if(target){var mug=that.form.getMugByUFID(sourceUid);target.val(target.val()+formdesigner.util.mugToXPathReference(mug)).change()}};that.handleTreeDrop=handleTreeDrop;var displayXPathEditor=function(options){formdesigner.ui.hideQuestionProperties(),formdesigner.ui.hideTools(),formdesigner.ui.showXPathEditor(options)};that.displayXPathEditor=displayXPathEditor;var doneXPathEditor=function(options){var mug=that.getCurrentlySelectedMug();options.cancel||that.setMugPropertyValue(mug,options.group,options.property,options.value,mug),formdesigner.ui.hideXPathEditor(),formdesigner.ui.showTools(),formdesigner.ui.displayMugProperties(mug)};return that.doneXPathEditor=doneXPathEditor,formdesigner.util.eventuality(that),that}(),formdesigner.intentManager=function(){"use strict";var that={};that.unmappedIntentTags={};var ODKXIntentTag=function(nodeID,path){var self=this;self.initialNodeID=nodeID,self.path=path||"",self.xmlns="http://opendatakit.org/xforms",self.extra={},self.response={},self.parseInnerTags=function(tagObj,innerTag,store){_.each(tagObj.find(innerTag),function(inner){var $innerTag=$(inner);store[$innerTag.attr("key")]=$innerTag.attr("ref")})},self._writeInnerTagXML=function(xmlWriter,innerTag,store){store&&_.each(store,function(ref,key){key&&(xmlWriter.writeStartElement(innerTag),xmlWriter.writeAttributeStringSafe("key",key),xmlWriter.writeAttributeStringSafe("ref",ref),xmlWriter.writeEndElement())})},self.writeXML=function(xmlWriter,currentNodeID){xmlWriter.writeStartElement("odkx:intent"),xmlWriter.writeAttributeStringSafe("xmlns:odkx",self.xmlns),xmlWriter.writeAttributeStringSafe("id",currentNodeID||self.initialNodeID),xmlWriter.writeAttributeStringSafe("class",self.path),self._writeInnerTagXML(xmlWriter,"extra",self.extra),self._writeInnerTagXML(xmlWriter,"response",self.response),xmlWriter.writeEndElement("odkx:intent")}};return that.parseIntentTagsFromHead=function(tags){_.each(tags,function(tagXML){var $tag,tagId,newTag,xmlns;$tag=$(tagXML),tagId=$tag.attr("id"),newTag=new ODKXIntentTag(tagId,$tag.attr("class")),xmlns=$tag.attr("xmlns:odkx"),newTag.xmlns=xmlns||newTag.xmlns,newTag.parseInnerTags($tag,"extra",newTag.extra),newTag.parseInnerTags($tag,"response",newTag.response),that.unmappedIntentTags[tagId]=newTag})},that.getParsedIntentTagWithID=function(nodeID){var intentTag=null;return _.each(that.unmappedIntentTags,function(tag){tag.initialNodeID==nodeID&&(intentTag=tag)}),intentTag},that.syncMugWithIntent=function(mug){if("AndroidIntent"===mug.__className){var nodeID=mug.dataElement.nodeID,tag=that.getParsedIntentTagWithID(nodeID);if(!tag){var path=mug.intentTag?mug.intentTag.path:null;tag=new ODKXIntentTag(nodeID,path)}mug.intentTag=tag,delete that.unmappedIntentTags[tag.initialNodeID]}},that.writeIntentXML=function(xmlWriter,dataTree){_.each(that.unmappedIntentTags,function(tag){tag.writeXML(xmlWriter,null)});var intents,getIntentMugs=function(node){var mug=node.getValue();return!mug||node.isRootNode?null:mug.bindElement&&"intent"==mug.bindElement.dataType?mug:null};intents=dataTree.treeMap(getIntentMugs),intents.length>0&&(xmlWriter.writeComment("Intents inserted by Vellum:"),intents.map(function(intentMug){intentMug.intentTag.writeXML(xmlWriter,intentMug.dataElement.nodeID)}))},that}(),Object.keys||(Object.keys=function(o){if(o!==Object(o))throw new TypeError("Object.keys called on non-object");var p,ret=[];for(p in o)Object.prototype.hasOwnProperty.call(o,p)&&ret.push(p);return ret}),"undefined"==typeof formdesigner)var formdesigner={};formdesigner.ui=function(){"use strict";function init_toolbar(){var $questionGroupContainer=($(".fd-toolbar"),$("#fd-container-question-type-group"));_.each(that.QUESTION_GROUPS,function(groupData){var questionGroup=new formdesigner.ui.QuestionTypeGroup(groupData);questionGroup.init(),$questionGroupContainer.append(questionGroup.getFormattedTemplate()),questionGroup.activateGroup()}),function(){var $saveButtonContainer=$("#fd-save-button");formdesigner.controller.saveButton.ui.appendTo($saveButtonContainer)}()}function getWidgetClassAndOptions(propPath,mug){var propDef=mug.getPropertyDefinition(propPath),propVal=mug.getPropertyValue(propPath);return propDef&&propDef.visibility&&-1!==propDef.visibility.indexOf("/")&&!getWidgetClassAndOptions(propDef.visibility,mug)?null:propDef&&(propVal||"visible_if_present"!==propDef.visibility&&"notallowed"!==propDef.presence)?{widgetClass:propDef.uiType||formdesigner.widgets.textWidget,options:$.extend(!0,{path:propPath},propDef,propDef.widgetOptions)}:null}function setup_fancybox(){$("a#inline").fancybox({hideOnOverlayClick:!1,hideOnContentClick:!1,enableEscapeButton:!1,showCloseButton:!0,onClosed:function(){}})}function init_form_paste(){var tarea=$("#fd-form-paste-textarea");tarea.change(function(){var parser=new controller.Parser,out=parser.parse(tarea.val());$("#fd-form-paste-output").val(out)})}function flipUI(state){var butState;butState=state?"enable":"disable",$("#fd-lang-disp-add-lang-button").button(butState),$("#fd-lang-disp-remove-lang-button").button(butState),state?$("#fd-question-properties").show():$("#fd-question-properties").hide()}function init_modal_dialogs(){$("#fd-dialog-confirm").dialog({resizable:!1,modal:!0,buttons:{Confirm:function(){$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},autoOpen:!1})}var that={QUESTION_TREE_DIV:"fd-question-tree",noTextString:"[no text]"},controller=formdesigner.controller,DEBUG_MODE=!1,MESSAGES_DIV="#fd-messages";that.MESSAGE_TYPES={error:{cssClass:"alert-error",title:"Error",icon:"icon-exclamation-sign"},"parse-warning":{cssClass:"",title:"Parse Warning",icon:"icon-warning-sign"},"form-warning":{cssClass:"",title:"Form Warning",icon:"icon-info-sign"}},that.QUESTION_GROUPS=[{group:["Text","Text"],questions:["Text","Trigger"]},{group:["Select","Multiple Choice"],related:["Item"],questions:["Select","MSelect"]},{group:["Int","Number"],questions:["Int","PhoneNumber","Double","Long"]},{group:["Date","Date"],questions:["Date","Time","DateTime"]},{group:["DataBindOnly","Hidden Value"],showDropdown:!1,questions:["DataBindOnly"]},{group:["Group","Groups"],questions:["Group","Repeat","FieldList"]},{group:["Image","Multimedia Capture"],questions:["Image","Audio","Video"]},{group:["Geopoint","Advanced",""],textOnly:!0,questions:["Geopoint","Barcode","Secret","AndroidIntent"]}],that.getQuestionTypeGroupID=function(slug){return"fd-question-group-"+slug},that.QUESTIONS_IN_TOOLBAR=[],that.QUESTION_TYPE_TO_GROUP={},_.each(that.QUESTION_GROUPS,function(groupData){var groupSlug=groupData.group[0],getQuestionData=function(questionType){var mug=mugs[questionType],questionData=[questionType,mug.prototype.typeName,mug.prototype.icon];return that.QUESTIONS_IN_TOOLBAR.push(questionType),that.QUESTION_TYPE_TO_GROUP[questionType]=groupSlug,questionData};groupData.questions=_.map(groupData.questions,getQuestionData),groupData.related&&groupData.related.length&&(groupData.related=_.map(groupData.related,getQuestionData)),"undefined"==typeof groupData.group[2]&&(groupData.group[2]=mugs[groupData.group[0]].prototype.icon)}),that.CONSTRAINT_ITEXT_BLOCK_SELECTOR="#itext-block-constraintMsg",that.currentErrors=[],that.reset=function(){that.getJSTree().children().children().each(function(i,el){that.jstree("delete_node",el)})},that.showMessage=function(errorObj){var messages=errorObj.message;"string"!=typeof messages&&messages instanceof Array||(messages=[""+messages]),$(MESSAGES_DIV).empty().html(_.template($("#fd-template-alert-global").text(),{messageType:that.MESSAGE_TYPES[errorObj.level],messages:messages})).find(".alert").removeClass("hide").addClass("in")},that.clearMessages=function(){$(MESSAGES_DIV).empty()},that.resetMessages=function(errors){that.clearMessages();for(var i=0;i<errors.length;i++)that.showMessage(errors[i])},that.generateNewModal=function(modalTitle,modalButtons,closeButtonTitle){var $modalContainer=$("#fd-modal-generic-container"),$modal=formdesigner.ui.getTemplateObject("#fd-template-modal-content",{modalTitle:modalTitle,modalButtons:modalButtons||[],closeButtonTitle:closeButtonTitle||"Close"});return $modalContainer.html($modal),$modal},that.getTemplateObject=function(templateSelector,templateParams){return $(_.template($(templateSelector).text(),templateParams))},that.addQuestion=function(qType){if(that.hasXpathEditorChanged)return that.alertUnsavedChangesInXpathEditor(),null;var newMug=new mugs[qType];return formdesigner.controller.initQuestion(newMug),that.jstree("select_node","#"+newMug.ufid,!0),newMug.isODKOnly&&formdesigner.model.form.updateError(formdesigner.model.FormError({message:"This question type will ONLY work with Android phones!",level:"form-warning"}),{updateUI:!0}),newMug},that.QuestionTypeButton=function(buttonSpec){var self=this;self.slug=buttonSpec[0],self.title=buttonSpec[1],self.icon=buttonSpec.length>2?buttonSpec[2]:null},that.QuestionTypeGroup=function(groupData){var self=this;self.groupData=groupData,self.showDropdown=!0,self.textOnly=!1,self.relatedQuestions=[],self.init=function(){self.defaultQuestion=new formdesigner.ui.QuestionTypeButton(self.groupData.group),self.groupID=that.getQuestionTypeGroupID(self.defaultQuestion.slug),"showDropdown"in self.groupData&&(self.showDropdown=self.groupData.showDropdown),"related"in self.groupData&&(self.relatedQuestions=_.map(self.groupData.related,self.makeQuestion)),"textOnly"in self.groupData&&(self.textOnly=self.groupData.textOnly),self.questions=_.map(self.groupData.questions,self.makeQuestion)},self.makeQuestion=function(questionSpec){return new formdesigner.ui.QuestionTypeButton(questionSpec)},self.getFormattedTemplate=function(){var $template=$("#fd-question-type-group-template");return _.template($template.text(),{groupID:self.groupID,showDropdown:self.showDropdown,textOnly:self.textOnly,relatedQuestions:self.relatedQuestions,defaultQuestion:self.defaultQuestion,questions:self.questions})},self.activateGroup=function(){var $questionGroup=$("#"+self.groupID);$questionGroup.find(".fd-question-type").click(function(event){$(this).hasClass("disabled")||that.addQuestion($(this).data("qtype")),event.preventDefault()}),$questionGroup.find(".btn.fd-question-type > span").tooltip({title:function(){var qLabel=$(this).data("qlabel"),$qType=$(this).parent();return qLabel=$qType.hasClass("disabled")?qLabel+" (add "+$($qType.parent().find(".btn:first-child span")).data("qlabel")+" first)":"Add "+qLabel},placement:"bottom"})}},that.activateQuestionTypeGroup=function(mug){var className=mug.__className||mug.prototype.__className,groupSlug=that.QUESTION_TYPE_TO_GROUP[className];if(groupSlug){var $questionGroup=$("#"+that.getQuestionTypeGroupID(groupSlug));$questionGroup.find(".fd-question-type-related").removeClass("disabled")}},that.resetQuestionTypeGroups=function(){var $questionGroupContainer=$("#fd-container-question-type-group");$questionGroupContainer.find(".fd-question-type-related").addClass("disabled")},that.showVisualValidation=function(mug){function setValidationFailedIcon(li,showIcon,message){var exists=$(li).find(".fd-props-validate").length>0;if(exists&&showIcon)$(li).find(".fd-props-validate").attr("title",message).addClass("ui-icon");else if(exists&&!showIcon)$(li).find(".fd-props-validate").removeClass("ui-icon").attr("title","");else if(!exists&&showIcon){var icon=$('<span class="fd-props-validate ui-icon ui-icon-alert"></span>');icon.attr("title",message),li.append(icon)}return li}function findInputByReference(blockName,elementName){return $("#"+blockName+"-"+elementName)}formdesigner.model.form.clearErrors("form-warning",{updateUI:!0});var errors=mug.getErrors().concat(_.filter(_.flatten(formdesigner.pluginManager.call("getFormErrors")),_.identity));_(errors).each(function(error){var input=findInputByReference(name,"foo-id");setValidationFailedIcon(input.parent(),!0,error),formdesigner.model.form.updateError(formdesigner.model.FormError({message:error,level:"form-warning"}))}),that.resetMessages(formdesigner.model.form.errors)},that.displayMugProperties=function(mug){$("#fd-default-panel").addClass("hide"),that.hideXPathEditor(),that.showTools(),$("#fd-question-properties").animate({},200),that.hideQuestionProperties();var $content=$("#fd-props-content").empty(),questionToolbar=formdesigner.widgets.getToolbarForMug(mug),sections=formdesigner.widgets.getSectionListForMug(mug);$("#fd-props-toolbar").html(questionToolbar);for(var i=0;i<sections.length;i++){var section=sections[i];section.mug=mug,section.properties=_(section.properties).map(function(property){var foo=getWidgetClassAndOptions(property,mug);return foo}).filter(_.identity),section.properties.length&&formdesigner.widgets.questionSection(mug,section).getSectionDisplay().appendTo($content)}mug.on("property-changed",function(e){if(formdesigner.controller.setFormChanged(),"nodeID"===e.property&&"dataElement"===e.element){var node=$("#"+e.mugUfid),newNameForTree="["+e.val+"]";e.val&&("DataBindOnly"===mug.__className&&newNameForTree!==that.jstree("get_text",node)||"DataBindOnly"!==mug.__className&&(!mug.controlElement||!mug.controlElement.labelItextID||mug.controlElement.labelItextID&&mug.controlElement.labelItextID.isEmpty()))&&that.jstree("rename_node",node,newNameForTree)}if(mug.bindElement){if("constraintAttr"===e.property&&"DataBindOnly"!==mug.__className){var $constraintItext=$(formdesigner.ui.CONSTRAINT_ITEXT_BLOCK_SELECTOR);e.val?$constraintItext.removeClass("hide"):mug.bindElement.constraintMsgItextID.id||$constraintItext.addClass("hide")}"constraintMsgItextID"!==e.property||e.val.id||mug.bindElement.constraintAttr||$(formdesigner.ui.CONSTRAINT_ITEXT_BLOCK_SELECTOR).addClass("hide")}}),$("#fd-question-properties").show(),$(".fd-help").fdHelp();var $validationCondition=$("#bindElement-constraintAttr");$validationCondition&&!$validationCondition.val()&&$(formdesigner.ui.CONSTRAINT_ITEXT_BLOCK_SELECTOR).addClass("hide"),that.showVisualValidation(mug)},that.handleNodeSelect=function(e,data){if(!that.skipNodeSelectEvent){var ufid=$(data.rslt.obj[0]).prop("id"),mug=formdesigner.controller.getMugFromFormByUFID(ufid);that.displayMugProperties(mug),that.resetQuestionTypeGroups(),that.activateQuestionTypeGroup(mug)}},that.isSelectNodeBlocked=function(){return that.hasXpathEditorChanged?(that.alertUnsavedChangesInXpathEditor(),!0):!1},that.alertUnsavedChangesInXpathEditor=function(){if(!that.isUnsavedAlertVisible){that.isUnsavedAlertVisible=!0;var $modal=formdesigner.ui.generateNewModal("Unsaved Changes in Editor",[],"OK");$modal.removeClass("fade"),$modal.find(".modal-body").append($("<p />").text("You have UNSAVED changes in the Expression Editor. Please save changes before switching questions.")),$modal.modal("show").on("hide",function(){that.isUnsavedAlertVisible=!1})}},that.selectSomethingOrResetUI=function(forceDeselect){forceDeselect&&that.jstree("deselect_all");if(!that.jstree("get_selected").length){var all_nodes=that.getJSTree().find("li");return all_nodes.length>0?(that.jstree("select_node",all_nodes[0]),!0):(that.hideQuestionProperties(),that.jstree("deselect_all"),!1)}return!0},that.selectLowestQuestionNode=function(){that.jstree("deselect_all");var questions=that.getJSTree().children().children().filter("[rel!='DataBindOnly']");if(questions.length>0){var newSelectEl=$(questions[questions.length-1]);return that.jstree("select_node",newSelectEl,!1),newSelectEl}return!1},that.questionTree=null;var generate_scaffolding=function(){var root=$(formdesigner.rootElement);root.empty(),$.ajax({url:formdesigner.staticPrefix+"templates/main.html",async:!1,cache:!1,success:function(html){root.append(html)}})};that.makeLanguageSelectorDropdown=function(){var addLangButton,removeLangButton,langList,langs,str,Itext,$langSelector,fullLangs;Itext=formdesigner.pluginManager.javaRosa.Itext,langs=Itext.getLanguages(),langs.length<2||(fullLangs=_.map(langs,function(lang){return{code:lang,name:formdesigner.langCodeToName[lang]||lang}}),$langSelector=formdesigner.ui.getTemplateObject("#fd-template-language-selector",{languages:fullLangs}),langList=$langSelector.find("select"),langList.change(function(){that.changeTreeDisplayLanguage($(this).val())}),langList.val(formdesigner.currentItextDisplayLanguage),formdesigner.opts.allowLanguageEdits&&(str='<button class="btn btn-primary" id="fd-lang-disp-add-lang-button">Add Language</button>',addLangButton=$(str),addLangButton.button(),addLangButton.click(function(){that.showAddLanguageDialog()}),$langSelector.append(addLangButton),str='<button class="btn btn-warning" id="fd-lang-disp-remove-lang-button">Remove Language</button>',removeLangButton=$(str),removeLangButton.button(),removeLangButton.click(function(){that.showRemoveLanguageDialog()}),$langSelector.append(removeLangButton)),$("#fd-question-tree-lang").html($langSelector))},that.changeTreeDisplayLanguage=function(lang){var itext=formdesigner.pluginManager.javaRosa.Itext;formdesigner.currentItextDisplayLanguage=lang,that.getJSTree().find("li").each(function(i,el){var $el=$(el),mug=formdesigner.controller.form.getMugByUFID($el.prop("id"));if(mug.controlElement)try{var itextID=mug.controlElement.labelItextID.id,text=itext.getItem(itextID).getValue("default",lang);text=text||formdesigner.util.getMugDisplayName(mug),that.jstree("rename_node",$el,text||that.noTextString)}catch(e){if("NoItextItemFound"!==e)throw e}})};var init_extra_tools=function(){that.makeLanguageSelectorDropdown(),formdesigner.controller.on("fd-reload-ui",function(){that.makeLanguageSelectorDropdown()}),formdesigner.controller.on("fd-update-language-name",function(){that.makeLanguageSelectorDropdown()});var menuItems=[{name:"Export Form Contents",action:formdesigner.controller.showExportDialog},{name:"Edit Source XML",action:formdesigner.controller.showSourceXMLDialog},{name:"Form Properties",action:formdesigner.controller.showFormPropertiesDialog}].concat(_.filter(_.flatten(formdesigner.pluginManager.call("getToolsMenuItems")),_.identity)),$toolsMenu=$("#fd-tools-menu");_(menuItems).each(function(menuItem){var $a=$("<a tabindex='-1' href='#'>"+menuItem.name+"</a>").click(function(e){e.preventDefault(),menuItem.action()});$("<li></li>").append($a).appendTo($toolsMenu)})},setTreeNodeInvalid=function(uid,msg){$($("#"+uid)[0]).append('<div class="ui-icon ui-icon-alert fd-tree-valid-alert-icon" title="'+msg+'"></div>')},setTreeNodeValid=function(uid){$($("#"+uid)[0]).find(".fd-tree-valid-alert-icon").remove()};that.setTreeValidationIcon=function(mug){var errors=mug.getErrors();if(errors.length){var message=_(errors).pluck("message").join("<p>").replace(/"/g,"'");setTreeNodeInvalid(mug.ufid,message)}else setTreeNodeValid(mug.ufid)},that.setAllTreeValidationIcons=function(){{var form=controller.form;form.controlTree,form.dataTree}that.getJSTree().find(".fd-tree-valid-alert-icon").remove(),_(form.getInvalidMugUFIDs()).each(function(messages,ufid){var message=messages.join("<p>").replace(/"/g,"'");setTreeNodeInvalid(ufid,message)})},that.removeMugFromTree=function(mug){that.jstree("remove","#"+mug.ufid)},that.disableUI=function(){flipUI(!1)},that.enableUI=function(){flipUI(!0)};var addLanguageDialog=function(){function beforeClose(){$("#fd-new-lang-input").val()&&formdesigner.pluginManager.javaRosa.Itext.addLanguage($("#fd-new-lang-input").val())}var contStr,div=$("#fd-dialog-confirm");div.dialog("destroy"),div.empty(),contStr='<p> <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span><span class="fd-message">Enter name of new Language</span> <div id="fd-new-lang-div"><input id="fd-new-lang-input" /></div></p>',div.append(contStr),div.dialog({autoOpen:!1,modal:!0,buttons:{Create:function(){$(this).dialog("close")},Cancel:function(){$("#fd-new-lang-input").val(""),$(this).dialog("close")}},beforeClose:beforeClose,close:function(){var currentMug=formdesigner.controller.getCurrentlySelectedMug();formdesigner.controller.reloadUI(),currentMug&&(formdesigner.controller.setCurrentlySelectedMug(currentMug.ufid),that.displayMugProperties(currentMug))
}})},removeLanguageDialog=function(){function beforeClose(){""!=$("#fd-remove-lang-input").val()&&(formdesigner.pluginManager.javaRosa.Itext.removeLanguage($("#fd-remove-lang-input").val()),formdesigner.currentItextDisplayLanguage=formdesigner.pluginManager.javaRosa.Itext.getDefaultLanguage())}var contStr,langToBeRemoved,buttons,msg,div=$("#fd-dialog-confirm");div.dialog("destroy"),div.empty(),1==formdesigner.pluginManager.javaRosa.Itext.getLanguages().length?(langToBeRemoved="",msg="You need to have at least one language in the form.  Please add a new language before removing this one."):(langToBeRemoved=formdesigner.currentItextDisplayLanguage,msg="Are you sure you want to permanently remove this language?"),contStr='<p> <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span><span class="fd-message">'+msg+'</span> <div id="fd-new-lang-div"><input id="fd-remove-lang-input" type="hidden"/></div></p>',div.append(contStr),$("#fd-remove-lang-input").val(langToBeRemoved),buttons={},buttons.Cancel=function(){$("#fd-remove-lang-input").val(""),$(this).dialog("close")},""!=langToBeRemoved&&(buttons.Yes=function(){$(this).dialog("close")}),div.dialog({autoOpen:!1,modal:!0,buttons:buttons,beforeClose:beforeClose,close:function(){var currentMug=formdesigner.controller.getCurrentlySelectedMug();formdesigner.controller.reloadUI(),currentMug&&(formdesigner.controller.setCurrentlySelectedMug(currentMug.ufid),that.displayMugProperties(currentMug))}})},showConfirmDialog=function(){$("#fd-dialog-confirm").dialog("open")};that.showConfirmDialog=showConfirmDialog;var hideConfirmDialog=function(){$("#fd-dialog-confirm").dialog("close")};that.hideConfirmDialog=hideConfirmDialog;var showAddLanguageDialog=function(){addLanguageDialog(),showConfirmDialog()};that.showAddLanguageDialog=showAddLanguageDialog;var showRemoveLanguageDialog=function(){removeLanguageDialog(),showConfirmDialog()};that.showRemoveLanguageDialog=showRemoveLanguageDialog;var setDialogInfo=that.setDialogInfo=function(message,confButName,confFunction,cancelButName,cancelButFunction,title){title=title||"";var contentStr,buttons={},dial=$("#fd-dialog-confirm");buttons[confButName]=confFunction,buttons[cancelButName]=cancelButFunction,dial.empty(),contentStr='<p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span><span class="fd-message">These items will be permanently deleted and cannot be recovered. Are you sure?</span></p>',dial.append(contentStr),message&&"string"==typeof message||(message=""),$("#fd-dialog-confirm .fd-message").text(message),$("#fd-dialog-confirm").dialog("option",{buttons:buttons,title:title})};that.setDialogInfo=setDialogInfo;var set_event_listeners=(that.showWaitingDialog=function(msg){var contentStr,dial=$("#fd-dialog-confirm");msg&&"string"==typeof msg||(msg="Saving form to server..."),dial.empty(),dial.dialog("destroy"),dial.dialog({modal:!0,autoOpen:!1,buttons:{},closeOnEscape:!1,open:function(){$(".ui-dialog-titlebar-close").hide()},close:function(){$(".ui-dialog-titlebar-close").show()},title:"Processing..."}),contentStr='<p><span class="fd-message">'+msg+'</span><div id="fd-form-saving-anim"></div></p>',dial.append(contentStr),$("#fd-form-saving-anim").append('<img src="'+formdesigner.staticPrefix+'images/ajax-loader.gif" id="fd-form-saving-img"/>'),showConfirmDialog()},function(){formdesigner.controller.on("question-itext-changed",function(e){var allMugs=formdesigner.controller.getMugList(!0);formdesigner.currentItextDisplayLanguage===e.language&&allMugs.map(function(mug){var node=$("#"+mug.ufid),treeName=e.value||formdesigner.util.getMugDisplayName(mug),it=mug.controlElement?mug.controlElement.labelItextID:null;it&&it.id===e.item.id&&"default"===e.form&&treeName!==that.jstree("get_text",node)&&that.jstree("rename_node",node,treeName)})}),formdesigner.controller.on("global-itext-changed",function(){var allMugs=formdesigner.controller.getMugList(!0),currLang=formdesigner.currentItextDisplayLanguage;allMugs.map(function(mug){var node=$("#"+mug.ufid),it=mug.controlElement?mug.controlElement.labelItextID:null,treeName=it?it.getValue("default",currLang):formdesigner.util.getMugDisplayName(mug);treeName=treeName||formdesigner.util.getMugDisplayName(mug),treeName!==that.jstree("get_text",node)&&that.jstree("rename_node",node,treeName)})}),formdesigner.controller.on("question-creation",function(e){that.overrideJSTreeIcon(e.mug.ufid,e.mug)}),formdesigner.controller.on("parent-question-type-changed",function(e){that.overrideJSTreeIcon(e.mug.ufid,e.mug)})});return that.hideQuestionProperties=function(){$("#fd-question-properties").hide()},that.hideTools=function(){$("#fd-extra-tools").hide()},that.showTools=function(){$("#fd-extra-tools").show()},that.showXPathEditor=function(options){var expTypes=xpathmodels.XPathExpressionTypeEnum,editorPane=(formdesigner.controller.getMugList(),$("#fd-xpath-editor")),editorContent=$("#fd-xpath-editor-content"),getExpressionInput=function(){return $("#fd-xpath-editor-text")},getValidationSummary=function(){return $("#fd-xpath-validation-summary")},getExpressionPane=function(){return $("#fd-xpath-editor-expressions")},getTopLevelJoinSelect=function(){return $(editorPane.find("#top-level-join-select")[0])},getExpressionFromSimpleMode=function(){var pane=getExpressionPane(),expressionParts=[],joinType=getTopLevelJoinSelect().val();pane.children().each(function(){var left=$($(this).find(".left-question")[0]),right=$($(this).find(".right-question")[0]);if(""!==left.val()||""!==right.val()){var op=$($(this).find(".op-select")[0]),exprPath="("+left.val()+") "+xpathmodels.expressionTypeEnumToXPathLiteral(op.val())+" ("+right.val()+")";expressionParts.push(exprPath)}});var preparsed=expressionParts.join(" "+joinType+" "),results=validate(preparsed);return results[0]&&results[1]?results[1].toXPath():preparsed},getExpressionFromUI=function(){return $("#xpath-simple").hasClass("hide")?getExpressionInput().val():getExpressionFromSimpleMode()},validate=function(expr){if(expr)try{var parsed=xpath.parse(expr);return[!0,parsed]}catch(err){return[!1,err]}return[!0,null]},tryAddExpression=function(parsedExpression,joiningOp){parsedExpression&&DEBUG_MODE&&console.log("trying to add",parsedExpression.toString());var expressionUIElem,leftUIElem,rightUIElem,isJoiningOp=function(subElement){return subElement instanceof xpathmodels.XPathBoolExpr},isExpressionOp=function(subElement){return subElement instanceof xpathmodels.XPathCmpExpr||subElement instanceof xpathmodels.XPathEqExpr},newExpressionUIElement=function(expOp){var $expUI=formdesigner.ui.getTemplateObject("#fd-template-xpath-expression",{operationOpts:[["is equal to",expTypes.EQ],["is not equal to",expTypes.NEQ],["is less than",expTypes.LT],["is less than or equal to",expTypes.LTE],["is greater than",expTypes.GT],["is greater than or equal to",expTypes.GTE]]}),getLeftQuestionInput=function(){return $($expUI.find(".left-question")[0])},getRightQuestionInput=function(){return $($expUI.find(".right-question")[0])},validateExpression=function(){formdesigner.ui.hasXpathEditorChanged=!0;var le=getLeftQuestionInput().val(),re=getRightQuestionInput().val();$expUI.find(".validation-results").addClass("hide"),le&&validate(le)[0]&&re&&validate(re)[0]?$expUI.find(".validation-results.alert-success").removeClass("hide"):$expUI.find(".validation-results.alert-error").removeClass("hide")},populateQuestionInputBox=function(input,expr){input.val(expr.toXPath())};return $expUI.find(".xpath-edit-node").on("keyup change",validateExpression),$expUI.find(".xpath-delete-expression").click(function(){$expUI.remove()}),expOp&&(DEBUG_MODE&&console.log("populating",expOp.toString()),populateQuestionInputBox(getLeftQuestionInput(),expOp.left),$expUI.find(".op-select").val(xpathmodels.expressionTypeEnumToXPathLiteral(expOp.type)),populateQuestionInputBox(getRightQuestionInput(),expOp.right,expOp.left)),$expUI},failAndClear=function(){return getExpressionPane().empty(),DEBUG_MODE&&console.log("fail",parsedExpression),!1},expressionPane=getExpressionPane();return parsedExpression?isExpressionOp(parsedExpression)?newExpressionUIElement(parsedExpression).appendTo(expressionPane):isJoiningOp(parsedExpression)?joiningOp&&parsedExpression.type!=joiningOp?failAndClear():(leftUIElem=tryAddExpression(parsedExpression.left,parsedExpression.type),rightUIElem=tryAddExpression(parsedExpression.right,parsedExpression.type),leftUIElem&&rightUIElem?(leftUIElem.appendTo(expressionPane),rightUIElem.appendTo(expressionPane),getTopLevelJoinSelect().val(parsedExpression.type),rightUIElem):failAndClear()):failAndClear():(expressionUIElem=newExpressionUIElement(),expressionUIElem.appendTo(expressionPane))},setUIForExpression=function(xpathstring){DEBUG_MODE&&console.log("setting ui for",xpathstring);var results=validate(xpathstring);if(results[0]){var parsed=results[1];tryAddExpression(parsed)||showAdvancedMode(parsed.toXPath(),!0)}else showAdvancedMode(xpathstring,!0)},updateXPathEditor=function(options){editorPane.data("group",options.group).data("property",options.property),getValidationSummary().text("").addClass("hide");var expressionPane=getExpressionPane();expressionPane.empty(),"bool"===options.xpathType?(showSimpleMode(options.value),options.value||$("#fd-add-exp").click()):showAdvancedMode(options.value),$("#fd-xpath-editor-text").val(options.value)},showAdvancedMode=function(text,showNotice){getExpressionInput().val(text),getExpressionPane().empty(),$("#xpath-advanced").removeClass("hide"),$("#xpath-simple").addClass("hide"),$("#fd-xpath-actions").removeClass("form-actions-condensed"),showNotice?$("#xpath-advanced-notice").removeClass("hide"):$("#xpath-advanced-notice").addClass("hide")},showSimpleMode=function(text){$("#xpath-simple").removeClass("hide"),$("#fd-xpath-actions").addClass("form-actions-condensed"),$("#xpath-advanced").addClass("hide"),getExpressionPane().empty(),text&&setUIForExpression(text)},initXPathEditor=function(){var $xpathUI=formdesigner.ui.getTemplateObject("#fd-template-xpath",{topLevelJoinOpts:[["True when ALL of the expressions are true.",expTypes.AND],["True when ANY of the expressions are true.",expTypes.OR]]});editorContent.append($xpathUI),$xpathUI.find("#fd-xpath-show-advanced-button").click(function(){showAdvancedMode(getExpressionFromSimpleMode())}),$xpathUI.find("#fd-xpath-show-simple-button").click(function(){showSimpleMode(getExpressionInput().val())}),$xpathUI.find("#fd-add-exp").click(function(){tryAddExpression()}),$xpathUI.find("#fd-xpath-editor-text").on("change keyup",function(){formdesigner.ui.hasXpathEditorChanged=!0});var saveExpression=function(expression){formdesigner.controller.doneXPathEditor({group:$("#fd-xpath-editor").data("group"),property:$("#fd-xpath-editor").data("property"),value:expression}),formdesigner.controller.form.fire("form-property-changed")};$xpathUI.find("#fd-xpath-save-button").click(function(){var uiExpression=getExpressionFromUI();getExpressionInput().val(uiExpression);var results=validate(uiExpression);results[0]?saveExpression(uiExpression):uiExpression.match("instance\\(")?(saveExpression(uiExpression),alert("This expression is too complex for us to verify; specifically, it makes use of the 'instance' construct. Please be aware that if you use this construct you're on your own in verifying that your expression is correct.")):getValidationSummary().html(formdesigner.ui.getTemplateObject("#fd-template-xpath-validation-errors",{errors:results[1]})).removeClass("hide")}),$xpathUI.find("#fd-xpath-cancel-button").click(function(){formdesigner.controller.doneXPathEditor({cancel:!0})})};0===editorContent.children().length&&initXPathEditor(),updateXPathEditor(options),editorPane.show()},that.hideXPathEditor=function(){formdesigner.ui.hasXpathEditorChanged=!1,$("#fd-xpath-editor").hide()},that.createJSTree=function(){$.jstree._themes=formdesigner.staticPrefix+"themes/",that.questionTree=$("#"+that.QUESTION_TREE_DIV),that.questionTree.jstree({json_data:{data:[]},core:{strings:{new_node:that.noTextString}},ui:{select_limit:1},crrm:{move:{always_copy:!1,check_move:function(m){var form=formdesigner.controller.form,source=$(m.o),target=$(m.r),position=m.p,refIsData="DataBindOnly"===target.attr("rel"),nodeIsData="DataBindOnly"===source.attr("rel");if(refIsData+nodeIsData==1)return!1;var sourceMug=form.getMugByUFID(source.attr("id")),isMoveable=_.all(formdesigner.pluginManager.call("isMugPathMoveable",sourceMug));if(!isMoveable){var id=target.attr("id"),targetMug=form.getMugByUFID(id);return"inside"===position||"last"===position?sourceMug.parentMug===targetMug:sourceMug.parentMug===targetMug.parentMug}return!0}}},dnd:{drop_finish:function(data){formdesigner.controller.handleTreeDrop(data.o,data.r)}},types:{max_children:-1,valid_children:mugs.Group.prototype.validChildTypes.concat(["DataBindOnly"]),types:function(){var types={};return _(mugs).each(function(Mug,typeName){types[typeName]={valid_children:Mug.prototype.validChildTypes.length?Mug.prototype.validChildTypes:"none"}}),types}()},plugins:["themes","json_data","ui","crrm","types","dnd"]}).bind("select_node.jstree",that.handleNodeSelect).bind("move_node.jstree",function(e,data){var controller=formdesigner.controller,mug=controller.getMugFromFormByUFID($(data.rslt.o).attr("id")),refMug=controller.getMugFromFormByUFID($(data.rslt.r).attr("id")),position=data.rslt.p;controller.moveMug(mug,refMug,position),that.displayMugProperties(controller.getCurrentlySelectedMug())}).bind("deselect_all.jstree",function(){that.resetQuestionTypeGroups()}).bind("deselect_node.jstree",function(){that.resetQuestionTypeGroups()}).bind("before.jstree",function(e,data){return"select_node"===data.func&&that.isSelectNodeBlocked(e,data)?(e.stopImmediatePropagation(),!1):void 0}).bind("create_node.jstree",function(e,data){that.overrideJSTreeIcon(data.args[2].attr.id,data.args[2].metadata.mug)}).bind("set_type.jstree",function(e,data){that.overrideJSTreeIcon(data.args[1].replace("#",""),mugs[data.args[0]])}),$("#fd-expand-all").click(function(){that.questionTree.jstree("open_all")}),$("#fd-collapse-all").click(function(){that.questionTree.jstree("close_all")})},that.overrideJSTreeIcon=function(node_id,mug){var iconClass,$questionNode=$("#"+node_id);mug||(mug=formdesigner.controller.getMugFromFormByUFID(node_id));try{iconClass=mug.getIcon()}catch(e){if(-1===e.message.indexOf("__className")&&-1===e.message.indexOf("getIcon"))throw e;iconClass=mug.constructor.prototype.icon}iconClass=iconClass||"icon-circle",$questionNode.find("> a > ins").hasClass(iconClass)||$questionNode.find("> a > ins").attr("class","jstree-icon").addClass(iconClass),that.resetQuestionTypeGroups(),that.activateQuestionTypeGroup(mug)},that.getJSTree=function(){return that.questionTree},that.jstree=function(){var tree=that.getJSTree(),retval=tree.jstree.apply(tree,arguments);return DEBUG_MODE&&console.error(arguments,retval),retval},that.init=function(sessionid){formdesigner.pluginManager.call("init"),controller=formdesigner.controller,generate_scaffolding(),init_toolbar(),init_extra_tools(),formdesigner.multimedia.initControllers(sessionid),that.createJSTree(),init_form_paste(),init_modal_dialogs(),set_event_listeners(),setup_fancybox(),formdesigner.windowManager.init()},that}();var PluginManager=function(options){this._methods=options.methods||{},this._plugins=[],this.register=function(name,plugin){this._plugins.push(plugin),this[name]=plugin},this.call=function(methodName){var methodArguments=Array.prototype.slice.call(arguments,1),methodType=this._methods[methodName];if("return_all"===methodType){var ret=[];return _(this._plugins).each(function(plugin){var fn=plugin[methodName];fn&&ret.push(fn.apply(plugin,methodArguments))}),ret}if("process_sequentially"===methodType){var retval=methodArguments[0],otherArguments=methodArguments.slice(1);return _(this._plugins).each(function(plugin){var fn=plugin[methodName];if(fn){var returned=fn.apply(plugin,[retval].concat(otherArguments));"undefined"!=typeof returned&&(retval=returned)}}),retval}throw methodName+" must have its type defined"}};formdesigner.launch=function(opts){formdesigner.util.eventuality(formdesigner),formdesigner.pluginManager=new PluginManager({methods:{getToolsMenuItems:"return_all",init:"return_all",beforeParse:"process_sequentially",parseBindElement:"process_sequentially",contributeToModelXML:"return_all",contributeToDataElementSpec:"process_sequentially",contributeToBindElementSpec:"process_sequentially",contributeToControlElementSpec:"process_sequentially",contributeToMainProperties:"process_sequentially",contributeToLogicProperties:"process_sequentially",contributeToAdvancedProperties:"process_sequentially",onMugRename:"return_all",isPropertyLocked:"return_all",isMugPathMoveable:"return_all",isMugRemoveable:"return_all",isMugTypeChangeable:"return_all",getFormErrors:"return_all",preSerialize:"return_all",afterSerialize:"process_sequentially"}}),formdesigner.pluginManager.register("ignoreButRetain",new formdesigner.plugins.ignoreButRetain),formdesigner.pluginManager.register("lock",new formdesigner.plugins.lock),formdesigner.pluginManager.register("javaRosa",new formdesigner.plugins.javaRosa),opts||(opts={}),formdesigner.rootElement=opts.rootElement||"#formdesigner",formdesigner.saveType=opts.saveType||"full",formdesigner.staticPrefix=opts.staticPrefix?opts.staticPrefix:"",formdesigner.saveUrl=opts.saveUrl,formdesigner.patchUrl=opts.patchUrl,formdesigner.allowedDataNodeReferences=opts.allowedDataNodeReferences||[],formdesigner.multimediaConfig=opts.multimediaConfig,formdesigner.windowConfig=opts.windowConfig||{},formdesigner.loadMe=opts.form,formdesigner.originalXForm=opts.form,opts.allowLanguageEdits=!(opts.langs&&opts.langs.length>0&&""!==opts.langs[0]),opts.langs=opts.allowLanguageEdits?null:opts.langs,formdesigner.opts=opts,formdesigner.ui.controller=formdesigner.controller,formdesigner.controller.initFormDesigner(opts.sessionid),formdesigner.loadMe?formdesigner.controller.loadXForm(formdesigner.loadMe):$("#fd-default-panel").removeClass("hide"),opts.formName&&formdesigner.controller.on("parse-finish",function(){formdesigner.controller.setFormName(formdesigner.opts.formName)})},formdesigner.rootElement="";
//# sourceMappingURL=vellum.min.map